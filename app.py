# app.py
import os
import json
import uuid
from datetime import datetime, timezone
from pathlib import Path
import streamlit as st

# –í–ê–ñ–ù–û: set_page_config –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–∞–º—ã–º –ø–µ—Ä–≤—ã–º –≤—ã–∑–æ–≤–æ–º Streamlit
st.set_page_config(
    page_title="NEO –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ (MVP)",
    page_icon="üí†",
    layout="centered",
)

# ==============
# –ö–æ–Ω—Ñ–∏–≥/–ø—É—Ç–∏
# ==============
DATA_DIR = Path("data")
SESSIONS_DIR = DATA_DIR / "sessions"
SESSIONS_DIR.mkdir(parents=True, exist_ok=True)

APP_VERSION = "mvp-6.0"

# –ú–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å: –ª—É—á—à–µ –¥–µ—Ä–∂–∞—Ç—å –≤ secrets (Streamlit Cloud)
# [secrets]
# MASTER_PASSWORD="..."
MASTER_PASSWORD = st.secrets.get("MASTER_PASSWORD", os.getenv("MASTER_PASSWORD", ""))

# OpenAI
OPENAI_API_KEY = st.secrets.get("OPENAI_API_KEY", os.getenv("OPENAI_API_KEY", ""))
DEFAULT_MODEL = st.secrets.get("OPENAI_MODEL", os.getenv("OPENAI_MODEL", "gpt-4.1-mini"))

# ===================
# OpenAI helper
# ===================
def get_openai_client():
    if not OPENAI_API_KEY:
        return None
    try:
        from openai import OpenAI
        return OpenAI(api_key=OPENAI_API_KEY)
    except Exception:
        return None

def safe_model_name(model: str) -> str:
    # –£ —Ç–µ–±—è –±—ã–ª–∞ –æ—à–∏–±–∫–∞ 404 –Ω–∞ "gpt-5.2-thinking" ‚Äî –∑–Ω–∞—á–∏—Ç –≤ —Ç–≤–æ—ë–º –∞–∫–∫–∞—É–Ω—Ç–µ/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞.
    # –ü–æ—ç—Ç–æ–º—É –∑–¥–µ—Å—å: –µ—Å–ª–∏ –≤–≤–æ–¥—è—Ç "gpt-5..." ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–∞–¥–∞–µ–º –Ω–∞ DEFAULT_MODEL.
    if not model:
        return DEFAULT_MODEL
    m = model.strip()
    if m.startswith("gpt-5"):
        return DEFAULT_MODEL
    return m

# ===================
# –í–æ–ø—Ä–æ—Å–Ω–∏–∫ (30)
# ===================
def question_plan():
    # NOTE: –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –±–µ–∑ ‚Äú–≤—ã–±–µ—Ä–∏ –∏–∑ 3‚Äù.
    # –¢–∏–ø—ã:
    # - text: —Ç–µ–∫—Å—Ç
    # - single: –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç
    # - multi: –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
    return [
        # ---- intake
        {"id": "intake.ask_name", "stage": "intake", "intent": "ask_name", "type": "text",
         "text": "–ö–∞–∫ –º–Ω–µ –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è? (–∏–º—è/–∫–∞–∫ —É–¥–æ–±–Ω–æ)"},
        {"id": "intake.ask_request", "stage": "intake", "intent": "ask_request", "type": "text",
         "text": "–° –∫–∞–∫–∏–º –∑–∞–ø—Ä–æ—Å–æ–º —Ç—ã –ø—Ä–∏—à—ë–ª(–ø—Ä–∏—à–ª–∞) –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É? –ß—Ç–æ —Ö–æ—á–µ—à—å –ø–æ–Ω—è—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å? (1‚Äì2 —Ñ—Ä–∞–∑—ã)"},
        {"id": "intake.contact", "stage": "intake", "intent": "contact", "type": "text",
         "text": "–û—Å—Ç–∞–≤—å —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email (–∫—É–¥–∞ –º–∞—Å—Ç–µ—Ä —Å–º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç). –ú–æ–∂–Ω–æ –æ–¥–Ω–æ –ø–æ–ª–µ."},
        {"id": "intake.current_state", "stage": "intake", "intent": "current_state", "type": "text",
         "text": "–ï—Å–ª–∏ –∫–æ—Ä–æ—Ç–∫–æ: —á—Ç–æ —Å–µ–π—á–∞—Å –≤ –∂–∏–∑–Ω–∏ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ù–ï —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏–ª–∏ –∑–∞–±–∏—Ä–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é?"},
        {"id": "intake.goal_3m", "stage": "intake", "intent": "goal_3m", "type": "text",
         "text": "–ü—Ä–µ–¥—Å—Ç–∞–≤—å: –ø—Ä–æ—à–ª–æ 3 –º–µ—Å—è—Ü–∞ –∏ —Å—Ç–∞–ª–æ –ª—É—á—à–µ. –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –±—ã –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å?"},
        {"id": "intake.priority_area", "stage": "intake", "intent": "priority_area", "type": "single",
         "text": "–ß—Ç–æ –≤–∞–∂–Ω–µ–µ –≤—Å–µ–≥–æ –ø—Ä–æ—è—Å–Ω–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è?",
         "options": ["–†–µ–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ–ª–æ", "–î–µ–Ω—å–≥–∏/–¥–æ—Ö–æ–¥", "–û—Ç–Ω–æ—à–µ–Ω–∏—è/–ª—é–¥–∏", "–≠–Ω–µ—Ä–≥–∏—è/—Å–∏–ª—ã", "–°–º—ã—Å–ª/–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"]},

        # ---- now
        {"id": "now.easy_tasks", "stage": "now", "intent": "easy_tasks", "type": "text",
         "text": "–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —Ç–µ–±–µ –æ–±—ã—á–Ω–æ –¥–∞—é—Ç—Å—è –ª–µ–≥–∫–æ (–∫–∞–∫ –±—É–¥—Ç–æ —Å–∞–º–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è)?"},
        {"id": "now.praise_for", "stage": "now", "intent": "praise_for", "type": "text",
         "text": "–ó–∞ —á—Ç–æ —Ç–µ–±—è —á–∞—â–µ –≤—Å–µ–≥–æ —Ö–≤–∞–ª—è—Ç –ª—é–¥–∏? (1‚Äì3 –ø—É–Ω–∫—Ç–∞)"},
        {"id": "now.time_flow", "stage": "now", "intent": "time_flow", "type": "text",
         "text": "–í –∫–∞–∫–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ç—ã —Ç–µ—Ä—è–µ—à—å —Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏?"},
        {"id": "now.attention_first", "stage": "now", "intent": "attention_first", "type": "single",
         "text": "–ö–æ–≥–¥–∞ –ø–æ–ø–∞–¥–∞–µ—à—å –≤ –Ω–æ–≤—É—é —Å–∏—Ç—É–∞—Ü–∏—é, —á—Ç–æ —Ç—ã –∑–∞–º–µ—á–∞–µ—à—å –ø–µ—Ä–≤—ã–º?",
         "options": ["–õ—é–¥–µ–π/—ç–º–æ—Ü–∏–∏", "–°–º—ã—Å–ª/–∏–¥–µ—é/–ø–æ—á–µ–º—É —Ç–∞–∫", "–î–µ–Ω—å–≥–∏/–≤—ã–≥–æ–¥—É/—Ä–µ—Å—É—Ä—Å—ã", "–†–∏—Å–∫–∏/—Å–∏—Å—Ç–µ–º—É/–ø–æ—Ä—è–¥–æ–∫", "–ö—Ä–∞—Å–æ—Ç—É/–∞—Ç–º–æ—Å—Ñ–µ—Ä—É"]},
        {"id": "now.best_result_example", "stage": "now", "intent": "best_result_example", "type": "text",
         "text": "–î–∞–π 1 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏–∑ –∂–∏–∑–Ω–∏: —Å–∏—Ç—É–∞—Ü–∏—è ‚Üí —á—Ç–æ —Ç—ã —Å–¥–µ–ª–∞–ª(–∞) ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Ç–æ, —á—Ç–æ —É —Ç–µ–±—è –ø–æ–ª—É—á–∞–µ—Ç—Å—è –ª—É—á—à–µ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞)."},
        {"id": "now.motivation_trigger", "stage": "now", "intent": "motivation_trigger", "type": "single",
         "text": "–ß—Ç–æ —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ —Ç–µ–±—è –∑–∞–≤–æ–¥–∏—Ç/–≤–∫–ª—é—á–∞–µ—Ç?",
         "options": ["–¶–µ–ª—å/—Å—Ç—Ä–∞—Ç–µ–≥–∏—è/–≤–µ–∫—Ç–æ—Ä", "–õ—é–¥–∏/—Å–≤—è–∑—å/–≤–ª–∏—è–Ω–∏–µ", "–ö—Ä–∞—Å–æ—Ç–∞/—É—é—Ç/—ç—Å—Ç–µ—Ç–∏–∫–∞", "–°–º—ã—Å–ª/–∏–¥–µ—è/–≥–ª—É–±–∏–Ω–∞", "–î—Ä–∞–π–≤/—Å—Ü–µ–Ω–∞/—ç–º–æ—Ü–∏–∏", "–î–µ–Ω—å–≥–∏/—Ä–µ–∑—É–ª—å—Ç–∞—Ç/—Å–∫–æ—Ä–æ—Å—Ç—å"]},
        {"id": "now.stress_pattern", "stage": "now", "intent": "stress_pattern", "type": "single",
         "text": "–ö–æ–≥–¥–∞ —Å—Ç—Ä–µ—Å—Å/–¥–∞–≤–ª–µ–Ω–∏–µ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–∞—â–µ –≤—Å–µ–≥–æ?",
         "options": ["–£—Å–∫–æ—Ä—è—é—Å—å –∏ —Å—Ç–∞–Ω–æ–≤–ª—é—Å—å —Ä–µ–∑–∫–æ–π(–∏–º)", "–£—Ö–æ–∂—É –≤ —Å–µ–±—è –∏ –º–æ–ª—á—É", "–ù–∞—á–∏–Ω–∞—é –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë", "–°—Ç–∞–Ω–æ–≤–ª—é—Å—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π(—ã–º)", "–ü—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è/–∑–∞–º–∏—Ä–∞–Ω–∏–µ"]},
        {"id": "now.energy_fill", "stage": "now", "intent": "energy_fill", "type": "multi",
         "text": "–ß—Ç–æ —Ç–µ–±—è —Ä–µ–∞–ª—å–Ω–æ –Ω–∞–ø–æ–ª–Ω—è–µ—Ç (–≤—ã–±–µ—Ä–∏ 1‚Äì4)?",
         "options": ["–û–±—â–µ–Ω–∏–µ –∏ –±–ª–∏–∑–∫–∏–µ –ª—é–¥–∏", "–ö—Ä–∞—Å–∏–≤—ã–µ –º–µ—Å—Ç–∞/—ç—Å—Ç–µ—Ç–∏–∫–∞/—É—é—Ç", "–¢–∏—à–∏–Ω–∞/—á—Ç–µ–Ω–∏–µ/–º—ã—Å–ª–∏", "–£—á—ë–±–∞/–æ–±—É—á–µ–Ω–∏–µ/–Ω–æ–≤—ã–µ –∑–Ω–∞–Ω–∏—è", "–°–ø–æ—Ä—Ç/–¥–≤–∏–∂–µ–Ω–∏–µ/—Ç–µ–ª–æ", "–°—Ü–µ–Ω–∞/–∏–≤–µ–Ω—Ç—ã/–≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è"]},

        # ---- childhood
        {"id": "childhood.child_play", "stage": "childhood", "intent": "child_play", "type": "multi",
         "text": "–í –¥–µ—Ç—Å—Ç–≤–µ (–ø—Ä–∏–º–µ—Ä–Ω–æ 6‚Äì12) —á—Ç–æ –ª—é–±–∏–ª(–∞) –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ? (1‚Äì3)",
         "options": ["–°—Ç—Ä–æ–∏—Ç—å/–æ—Ä–≥–∞–Ω–∏–∑–æ–≤—ã–≤–∞—Ç—å/—Ä—É–∫–æ–≤–æ–¥–∏—Ç—å", "–£—á–∏—Ç—å—Å—è/—á–∏—Ç–∞—Ç—å/–æ–±—ä—è—Å–Ω—è—Ç—å", "–í—ã—Å—Ç—É–ø–∞—Ç—å/–±—ã—Ç—å –∑–∞–º–µ—Ç–Ω—ã–º(–æ–π)", "–î—Ä—É–∂–∏—Ç—å/–æ–±—â–∞—Ç—å—Å—è/–º–∏—Ä–∏—Ç—å", "–†–∏—Å–æ–≤–∞—Ç—å/—É–∫—Ä–∞—à–∞—Ç—å/–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ", "–ë–µ–≥–∞—Ç—å/—Å–æ—Ä–µ–≤–Ω–æ–≤–∞—Ç—å—Å—è/–¥–≤–∏–∂"]},
        {"id": "childhood.teen_dream", "stage": "childhood", "intent": "teen_dream", "type": "text",
         "text": "–ü–æ–¥—Ä–æ—Å—Ç–∫–æ–º (12‚Äì16) –∫–µ–º —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã—Ç—å –∏–ª–∏ —á–µ–º –∑–∞–Ω–∏–º–∞—Ç—å—Å—è?"},
        {"id": "childhood.first_success", "stage": "childhood", "intent": "first_success", "type": "text",
         "text": "–ö–∞–∫–æ–µ —Ä–∞–Ω–Ω–µ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ/—Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –≤—Å–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º?"},
        {"id": "childhood.family_role", "stage": "childhood", "intent": "family_role", "type": "single",
         "text": "–í —Å–µ–º—å–µ/–∫–ª–∞—Å—Å–µ —Ç—ã —á–∞—â–µ –±—ã–ª(–∞) –∫–µ–º?",
         "options": ["–õ–∏–¥–µ—Ä/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä", "–î—É—à–∞ –∫–æ–º–ø–∞–Ω–∏–∏/–∫–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä", "–£–º–Ω–∏–∫/–∞–Ω–∞–ª–∏—Ç–∏–∫", "–¢–≤–æ—Ä—á–µ—Å–∫–∏–π/—ç—Å—Ç–µ—Ç", "–°–æ—Ä–µ–≤–Ω–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π/—Å–ø–æ—Ä—Ç", "–¢–∏—Ö–∏–π –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å"]},
        {"id": "childhood.child_aversion", "stage": "childhood", "intent": "child_aversion", "type": "text",
         "text": "–ê —á—Ç–æ –≤ –¥–µ—Ç—Å—Ç–≤–µ/—à–∫–æ–ª–µ –±—ã–ª–æ –ø—Ä—è–º —Ç—è–∂–µ–ª–æ/–Ω–µ —Ö–æ—Ç–µ–ª–æ—Å—å –∏ —Ç—ã –∏–∑–±–µ–≥–∞–ª(–∞)? (1‚Äì2 –≤–µ—â–∏)"},
        {"id": "childhood.parent_expect", "stage": "childhood", "intent": "parent_expect", "type": "text",
         "text": "–ß—Ç–æ –æ—Ç —Ç–µ–±—è ‚Äò–æ–∂–∏–¥–∞–ª–∏‚Äô –≤–∑—Ä–æ—Å–ª—ã–µ (–∫–∞–∫–∏–º(–æ–π) –Ω–∞–¥–æ –±—ã—Ç—å)? –ò –∫–∞–∫ —Ç—ã –∫ —ç—Ç–æ–º—É –æ—Ç–Ω–æ—Å–∏–ª—Å—è(–ª–∞—Å—å)?"},
        {"id": "childhood.child_energy", "stage": "childhood", "intent": "child_energy", "type": "text",
         "text": "–ì–¥–µ —Ç—ã —á—É–≤—Å—Ç–≤–æ–≤–∞–ª(–∞) —Å–µ–±—è ‚Äò–∂–∏–≤—ã–º(–æ–π)‚Äô –≤ –¥–µ—Ç—Å—Ç–≤–µ —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ? (—Å–∏—Ç—É–∞—Ü–∏—è)"},
        {"id": "childhood.child_pride", "stage": "childhood", "intent": "child_pride", "type": "text",
         "text": "–ó–∞ —á—Ç–æ —Ç—ã —Å–æ–±–æ–π –≤ –¥–µ—Ç—Å—Ç–≤–µ —Ä–µ–∞–ª—å–Ω–æ –≥–æ—Ä–¥–∏–ª—Å—è(–ª–∞—Å—å)? (1 –ø—Ä–∏–º–µ—Ä)"},

        # ---- behavior
        {"id": "behavior.free_time", "stage": "behavior", "intent": "free_time", "type": "text",
         "text": "–ï—Å–ª–∏ –µ—Å—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ 2 —á–∞—Å–∞ –±–µ–∑ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤ ‚Äî —á—Ç–æ —Ç—ã —á–∞—â–µ –≤—Å–µ–≥–æ –¥–µ–ª–∞–µ—à—å?"},
        {"id": "behavior.money_spend", "stage": "behavior", "intent": "money_spend", "type": "multi",
         "text": "–ù–∞ —á—Ç–æ —Ç—ã –∏–º–ø—É–ª—å—Å–∏–≤–Ω–æ —Ç—Ä–∞—Ç–∏—à—å –¥–µ–Ω—å–≥–∏/—Å–∏–ª—ã? (1‚Äì3)",
         "options": ["–ù–∞ –æ–±—É—á–µ–Ω–∏–µ/–∫—É—Ä—Å—ã/–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é", "–ù–∞ –ø—Ä–æ–µ–∫—Ç—ã/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã/—Ä–∞–±–æ—Ç—É", "–ù–∞ –∫—Ä–∞—Å–æ—Ç—É/–æ–¥–µ–∂–¥—É/–¥–æ–º/—É—é—Ç", "–ù–∞ –ª—é–¥–µ–π/–ø–æ–¥–∞—Ä–∫–∏/—Å–µ–º—å—é", "–ù–∞ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è/–≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è", "–ù–∞ –∑–¥–æ—Ä–æ–≤—å–µ/—Å–ø–æ—Ä—Ç"]},
        {"id": "behavior.group_role_now", "stage": "behavior", "intent": "group_role_now", "type": "single",
         "text": "–í –≥—Ä—É–ø–ø–µ/–∫–æ–º–∞–Ω–¥–µ —Ç—ã –æ–±—ã—á–Ω–æ –∫—Ç–æ?",
         "options": ["–û–±—ä–µ–¥–∏–Ω—è—é –ª—é–¥–µ–π", "–ü—Ä–æ–¥–∞–≤–ª–∏–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç", "–ü—Ä–∏–¥—É–º—ã–≤–∞—é —Å–º—ã—Å–ª/–∏–¥–µ—é", "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É—é/–ø–æ—Ä—è–¥–æ–∫", "–î–µ–ª–∞—é –∫—Ä–∞—Å–∏–≤–æ/–∞—Ç–º–æ—Å—Ñ–µ—Ä—É", "–í–¥–æ—Ö–Ω–æ–≤–ª—è—é/–∑–∞–∂–∏–≥–∞—é"]},
        {"id": "behavior.decision_style", "stage": "behavior", "intent": "decision_style", "type": "single",
         "text": "–ö–∞–∫ —Ç—ã –ø—Ä–∏–Ω–∏–º–∞–µ—à—å —Ä–µ—à–µ–Ω–∏—è —á–∞—â–µ –≤—Å–µ–≥–æ?",
         "options": ["–ß–µ—Ä–µ–∑ –≤—ã–≥–æ–¥—É/—Ü–∏—Ñ—Ä—ã", "–ß–µ—Ä–µ–∑ —á—É–≤—Å—Ç–≤–æ/–∏–Ω—Ç—É–∏—Ü–∏—é", "–ß–µ—Ä–µ–∑ —Å–º—ã—Å–ª/—Ü–µ–Ω–Ω–æ—Å—Ç–∏", "–ß–µ—Ä–µ–∑ –ª—é–¥–µ–π/–æ—Ç–Ω–æ—à–µ–Ω–∏—è", "–ß–µ—Ä–µ–∑ –ø–æ—Ä—è–¥–æ–∫/–ø—Ä–∞–≤–∏–ª–∞"]},
        {"id": "behavior.long_focus", "stage": "behavior", "intent": "long_focus", "type": "text",
         "text": "–ù–∞ —á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –¥–æ–ª–≥–æ –∏ –±–µ–∑ –Ω–∞—Å–∏–ª–∏—è –Ω–∞–¥ —Å–æ–±–æ–π?"},
        {"id": "behavior.fast_win", "stage": "behavior", "intent": "fast_win", "type": "text",
         "text": "–ß—Ç–æ —Ç—ã —É–º–µ–µ—à—å –¥–µ–ª–∞—Ç—å –±—ã—Å—Ç—Ä–æ –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∫–æ–≥–¥–∞ –Ω–∞–¥–æ ‚Äò—Å–æ–±—Ä–∞—Ç—å—Å—è –∏ —Å–¥–µ–ª–∞—Ç—å‚Äô? (1‚Äì3 –ø—Ä–∏–º–µ—Ä–∞)"},
        {"id": "behavior.teach_people", "stage": "behavior", "intent": "teach_people", "type": "text",
         "text": "–ï—Å–ª–∏ –±—ã —Ç—ã —É—á–∏–ª(–∞) –ª—é–¥–µ–π –æ–¥–Ω–æ–º—É –Ω–∞–≤—ã–∫—É, –∫–æ—Ç–æ—Ä—ã–π —É —Ç–µ–±—è —Å–∏–ª—å–Ω—ã–π ‚Äî —á—Ç–æ —ç—Ç–æ –±—ã–ª–æ –±—ã?"},

        # ---- antipattern
        {"id": "antipattern.avoid", "stage": "antipattern", "intent": "avoid", "type": "text",
         "text": "–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —Ç—ã —Å—Ç–∞–±–∏–ª—å–Ω–æ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—à—å (–∏ –ø—Ä—è–º–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è–µ—à—å—Å—è)?"},
        {"id": "antipattern.hate_task", "stage": "antipattern", "intent": "hate_task", "type": "single",
         "text": "–ß—Ç–æ –¥–ª—è —Ç–µ–±—è —Å–∞–º–æ–µ ‚Äò–Ω–µ–ª—é–±–∏–º–æ–µ‚Äô –∏–∑ —Å–ø–∏—Å–∫–∞?",
         "options": ["–†—É—Ç–∏–Ω–∞/–ø–æ—Ä—è–¥–æ–∫/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã", "–î–æ–ª–≥–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –Ω–∏ –æ —á—ë–º", "–ü—Ä–æ–¥–∞–∂–∏/–∑–∞—è–≤–ª—è—Ç—å –æ —Å–µ–±–µ", "–£—á—ë–±–∞/–∑—É–±—Ä—ë–∂–∫–∞", "–§–∏–∑–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞", "–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã/–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ"]},
        {"id": "antipattern.energy_leak", "stage": "antipattern", "intent": "energy_leak", "type": "text",
         "text": "–ì–¥–µ —Ç—ã —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ ‚Äò—Å–ª–∏–≤–∞–µ—à—å‚Äô —ç–Ω–µ—Ä–≥–∏—é —Å–µ–π—á–∞—Å? (–ª—é–¥–∏/–¥–µ–ª–∞/–º—ã—Å–ª–∏/—Ç–µ–ª–æ/—Ö–∞–æ—Å/–∫–æ–Ω—Ç—Ä–æ–ª—å ‚Äî –∫–∞–∫ —É —Ç–µ–±—è)"},
    ]

# ===================
# –°–∫–æ—Ä–∏–Ω–≥ (–ª–µ–≥–∫–∏–π, –≥–∏–±—Ä–∏–¥–Ω—ã–π)
# ===================
POTS = ["–Ø–Ω—Ç–∞—Ä—å","–®—É–Ω–≥–∏—Ç","–¶–∏—Ç—Ä–∏–Ω","–ò–∑—É–º—Ä—É–¥","–†—É–±–∏–Ω","–ì—Ä–∞–Ω–∞—Ç","–°–∞–ø—Ñ–∏—Ä","–ì–µ–ª–∏–æ–¥–æ—Ä","–ê–º–µ—Ç–∏—Å—Ç"]

KEYWORDS = {
    "–Ø–Ω—Ç–∞—Ä—å": ["–ø–æ—Ä—è–¥–æ–∫","—Å—Ç—Ä—É–∫—Ç—É—Ä","—Ä–µ–≥–ª–∞–º–µ–Ω—Ç","–¥–æ–∫—É–º–µ–Ω—Ç","—Å–∏—Å—Ç–µ–º–∞","—É—á–µ—Ç","–ø–ª–∞–Ω–µ—Ä","–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü"],
    "–®—É–Ω–≥–∏—Ç": ["—Ç–µ–ª–æ","—Å–ø–æ—Ä—Ç","–¥–≤–∏–∂","–≤—ã–Ω–æ—Å–ª–∏–≤","—Ç—Ä–µ–Ω","—Ñ–∏–∑–∫—É–ª—å—Ç"],
    "–¶–∏—Ç—Ä–∏–Ω": ["–¥–µ–Ω—å–≥","–¥–æ—Ö–æ–¥","—Ä–µ–∑—É–ª—å—Ç–∞—Ç","–±—ã—Å—Ç—Ä–æ","–≤—ã–≥–æ–¥–∞","—Ü–∏—Ñ—Ä","—ç—Ñ—Ñ–µ–∫—Ç–∏–≤","–ø—Ä–æ–¥–∞–∂"],
    "–ò–∑—É–º—Ä—É–¥": ["–∫—Ä–∞—Å–æ—Ç","—ç—Å—Ç–µ—Ç","—É—é—Ç","–¥–∏–∑–∞–π–Ω","–∞—Ç–º–æ—Å—Ñ–µ—Ä","—Å—Ç–∏–ª—å","–≥–∞—Ä–º–æ–Ω–∏"],
    "–†—É–±–∏–Ω": ["–¥—Ä–∞–π–≤","—Å—Ü–µ–Ω–∞","–∏–≤–µ–Ω—Ç","–≤–ø–µ—á–∞—Ç","–ø—Ä–∏–∫–ª—é—á","—ç–º–æ—Ü","–∞–¥—Ä–µ–Ω–∞–ª"],
    "–ì—Ä–∞–Ω–∞—Ç": ["–ª—é–¥","–∫–æ–º–∞–Ω–¥","–æ–±—â–µ–Ω","–ø–æ–¥–¥–µ—Ä–∂","–∑–∞–±–æ—Ç","–æ—Ç–Ω–æ—à–µ–Ω","–æ–±—ä–µ–¥–∏–Ω","–¥—É—à–∞ –∫–æ–º–ø–∞–Ω–∏–∏"],
    "–°–∞–ø—Ñ–∏—Ä": ["—Å–º—ã—Å–ª","–∏–¥–µ—è","–ø–æ—á–µ–º—É","–≥–ª—É–±–∏–Ω","—Ñ–∏–ª–æ—Å–æ—Ñ","–∫–æ–Ω—Ü–µ–ø—Ü","–∫–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–æ"],
    "–ì–µ–ª–∏–æ–¥–æ—Ä": ["—É—á","–æ–±—É—á","–∑–Ω–∞–Ω","–∫—É—Ä—Å","–æ–±—ä—è—Å–Ω","–Ω–∞—Å—Ç–∞–≤","—Ä–∞–∑–±–æ—Ä","—É—á–∏—Ç—å—Å—è"],
    "–ê–º–µ—Ç–∏—Å—Ç": ["—Ü–µ–ª—å","—Å—Ç—Ä–∞—Ç–µ–≥","–≤–µ–∫—Ç–æ—Ä","—É–ø—Ä–∞–≤–ª–µ–Ω","–ª–∏–¥–µ—Ä","–∫–æ–æ—Ä–¥–∏–Ω–∞—Ü","–ø—Ä–æ–µ–∫—Ç","–ø–ª–∞–Ω"],
}

# ‚Äú–ê–Ω—Ç–∏-–Ø–Ω—Ç–∞—Ä—å‚Äù: –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø—Ä—è–º–æ –ø–∏—à–µ—Ç —á—Ç–æ –ù–ï –ª—é–±–∏—Ç –ø–æ—Ä—è–¥–æ–∫/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã ‚Äî –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º —ç—Ç–æ –≤ —Å–∏–ª—ã
ANTI_AMBER = ["–Ω–µ –ª—é–±–ª—é –ø–æ—Ä—è–¥–æ–∫","–Ω–µ–Ω–∞–≤–∏–∂—É –ø–æ—Ä—è–¥–æ–∫","—Ä—É—Ç–∏–Ω–∞ –±–µ—Å–∏—Ç","—Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã –±–µ—Å–∏—Ç","–Ω–µ –ª—é–±–ª—é —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã","–Ω–µ –ª—é–±–ª—é –¥–æ–∫—É–º–µ–Ω—Ç—ã"]

def text_hits(text: str, pot: str) -> int:
    t = (text or "").lower()
    return sum(1 for kw in KEYWORDS.get(pot, []) if kw in t)

def score_all(answers: dict):
    scores = {p: 0.0 for p in POTS}
    evidence = {p: [] for p in POTS}

    def add(p, v, note):
        scores[p] += float(v)
        evidence[p].append(note)

    # 1) keyword scoring
    for qid, ans in answers.items():
        if isinstance(ans, list):
            joined = " ".join(ans)
            for p in POTS:
                h = text_hits(joined, p)
                if h:
                    add(p, 0.25 * h, f"{qid}: kw({p})")
        else:
            txt = str(ans or "")
            for p in POTS:
                h = text_hits(txt, p)
                if h:
                    add(p, 0.35 * h, f"{qid}: kw({p})")

    # 2) option-based bumps
    def bump_if(qid, option_to_pot, amount=0.9):
        a = answers.get(qid)
        if not a:
            return
        if isinstance(a, list):
            for x in a:
                p = option_to_pot.get(x)
                if p:
                    add(p, amount/ max(1, len(a)), f"{qid}: option‚Üí{p}")
        else:
            p = option_to_pot.get(a)
            if p:
                add(p, amount, f"{qid}: option‚Üí{p}")

    bump_if("intake.priority_area", {
        "–†–µ–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ–ª–æ":"–ê–º–µ—Ç–∏—Å—Ç",
        "–î–µ–Ω—å–≥–∏/–¥–æ—Ö–æ–¥":"–¶–∏—Ç—Ä–∏–Ω",
        "–û—Ç–Ω–æ—à–µ–Ω–∏—è/–ª—é–¥–∏":"–ì—Ä–∞–Ω–∞—Ç",
        "–≠–Ω–µ—Ä–≥–∏—è/—Å–∏–ª—ã":"–®—É–Ω–≥–∏—Ç",
        "–°–º—ã—Å–ª/–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ":"–°–∞–ø—Ñ–∏—Ä",
    }, amount=0.8)

    bump_if("now.attention_first", {
        "–õ—é–¥–µ–π/—ç–º–æ—Ü–∏–∏":"–ì—Ä–∞–Ω–∞—Ç",
        "–°–º—ã—Å–ª/–∏–¥–µ—é/–ø–æ—á–µ–º—É —Ç–∞–∫":"–°–∞–ø—Ñ–∏—Ä",
        "–î–µ–Ω—å–≥–∏/–≤—ã–≥–æ–¥—É/—Ä–µ—Å—É—Ä—Å—ã":"–¶–∏—Ç—Ä–∏–Ω",
        "–†–∏—Å–∫–∏/—Å–∏—Å—Ç–µ–º—É/–ø–æ—Ä—è–¥–æ–∫":"–Ø–Ω—Ç–∞—Ä—å",
        "–ö—Ä–∞—Å–æ—Ç—É/–∞—Ç–º–æ—Å—Ñ–µ—Ä—É":"–ò–∑—É–º—Ä—É–¥",
    }, amount=1.0)

    bump_if("now.motivation_trigger", {
        "–¶–µ–ª—å/—Å—Ç—Ä–∞—Ç–µ–≥–∏—è/–≤–µ–∫—Ç–æ—Ä":"–ê–º–µ—Ç–∏—Å—Ç",
        "–õ—é–¥–∏/—Å–≤—è–∑—å/–≤–ª–∏—è–Ω–∏–µ":"–ì—Ä–∞–Ω–∞—Ç",
        "–ö—Ä–∞—Å–æ—Ç–∞/—É—é—Ç/—ç—Å—Ç–µ—Ç–∏–∫–∞":"–ò–∑—É–º—Ä—É–¥",
        "–°–º—ã—Å–ª/–∏–¥–µ—è/–≥–ª—É–±–∏–Ω–∞":"–°–∞–ø—Ñ–∏—Ä",
        "–î—Ä–∞–π–≤/—Å—Ü–µ–Ω–∞/—ç–º–æ—Ü–∏–∏":"–†—É–±–∏–Ω",
        "–î–µ–Ω—å–≥–∏/—Ä–µ–∑—É–ª—å—Ç–∞—Ç/—Å–∫–æ—Ä–æ—Å—Ç—å":"–¶–∏—Ç—Ä–∏–Ω",
    }, amount=1.0)

    bump_if("now.energy_fill", {
        "–û–±—â–µ–Ω–∏–µ –∏ –±–ª–∏–∑–∫–∏–µ –ª—é–¥–∏":"–ì—Ä–∞–Ω–∞—Ç",
        "–ö—Ä–∞—Å–∏–≤—ã–µ –º–µ—Å—Ç–∞/—ç—Å—Ç–µ—Ç–∏–∫–∞/—É—é—Ç":"–ò–∑—É–º—Ä—É–¥",
        "–¢–∏—à–∏–Ω–∞/—á—Ç–µ–Ω–∏–µ/–º—ã—Å–ª–∏":"–°–∞–ø—Ñ–∏—Ä",
        "–£—á—ë–±–∞/–æ–±—É—á–µ–Ω–∏–µ/–Ω–æ–≤—ã–µ –∑–Ω–∞–Ω–∏—è":"–ì–µ–ª–∏–æ–¥–æ—Ä",
        "–°–ø–æ—Ä—Ç/–¥–≤–∏–∂–µ–Ω–∏–µ/—Ç–µ–ª–æ":"–®—É–Ω–≥–∏—Ç",
        "–°—Ü–µ–Ω–∞/–∏–≤–µ–Ω—Ç—ã/–≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è":"–†—É–±–∏–Ω",
    }, amount=0.9)

    bump_if("childhood.child_play", {
        "–°—Ç—Ä–æ–∏—Ç—å/–æ—Ä–≥–∞–Ω–∏–∑–æ–≤—ã–≤–∞—Ç—å/—Ä—É–∫–æ–≤–æ–¥–∏—Ç—å":"–ê–º–µ—Ç–∏—Å—Ç",
        "–£—á–∏—Ç—å—Å—è/—á–∏—Ç–∞—Ç—å/–æ–±—ä—è—Å–Ω—è—Ç—å":"–ì–µ–ª–∏–æ–¥–æ—Ä",
        "–í—ã—Å—Ç—É–ø–∞—Ç—å/–±—ã—Ç—å –∑–∞–º–µ—Ç–Ω—ã–º(–æ–π)":"–†—É–±–∏–Ω",
        "–î—Ä—É–∂–∏—Ç—å/–æ–±—â–∞—Ç—å—Å—è/–º–∏—Ä–∏—Ç—å":"–ì—Ä–∞–Ω–∞—Ç",
        "–†–∏—Å–æ–≤–∞—Ç—å/—É–∫—Ä–∞—à–∞—Ç—å/–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ":"–ò–∑—É–º—Ä—É–¥",
        "–ë–µ–≥–∞—Ç—å/—Å–æ—Ä–µ–≤–Ω–æ–≤–∞—Ç—å—Å—è/–¥–≤–∏–∂":"–®—É–Ω–≥–∏—Ç",
    }, amount=0.8)

    bump_if("childhood.family_role", {
        "–õ–∏–¥–µ—Ä/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä":"–ê–º–µ—Ç–∏—Å—Ç",
        "–î—É—à–∞ –∫–æ–º–ø–∞–Ω–∏–∏/–∫–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä":"–ì—Ä–∞–Ω–∞—Ç",
        "–£–º–Ω–∏–∫/–∞–Ω–∞–ª–∏—Ç–∏–∫":"–°–∞–ø—Ñ–∏—Ä",
        "–¢–≤–æ—Ä—á–µ—Å–∫–∏–π/—ç—Å—Ç–µ—Ç":"–ò–∑—É–º—Ä—É–¥",
        "–°–æ—Ä–µ–≤–Ω–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π/—Å–ø–æ—Ä—Ç":"–®—É–Ω–≥–∏—Ç",
        "–¢–∏—Ö–∏–π –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å":"–°–∞–ø—Ñ–∏—Ä",
    }, amount=0.7)

    bump_if("behavior.group_role_now", {
        "–û–±—ä–µ–¥–∏–Ω—è—é –ª—é–¥–µ–π":"–ì—Ä–∞–Ω–∞—Ç",
        "–ü—Ä–æ–¥–∞–≤–ª–∏–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç":"–¶–∏—Ç—Ä–∏–Ω",
        "–ü—Ä–∏–¥—É–º—ã–≤–∞—é —Å–º—ã—Å–ª/–∏–¥–µ—é":"–°–∞–ø—Ñ–∏—Ä",
        "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É—é/–ø–æ—Ä—è–¥–æ–∫":"–Ø–Ω—Ç–∞—Ä—å",
        "–î–µ–ª–∞—é –∫—Ä–∞—Å–∏–≤–æ/–∞—Ç–º–æ—Å—Ñ–µ—Ä—É":"–ò–∑—É–º—Ä—É–¥",
        "–í–¥–æ—Ö–Ω–æ–≤–ª—è—é/–∑–∞–∂–∏–≥–∞—é":"–†—É–±–∏–Ω",
    }, amount=0.8)

    bump_if("behavior.decision_style", {
        "–ß–µ—Ä–µ–∑ –≤—ã–≥–æ–¥—É/—Ü–∏—Ñ—Ä—ã":"–¶–∏—Ç—Ä–∏–Ω",
        "–ß–µ—Ä–µ–∑ —á—É–≤—Å—Ç–≤–æ/–∏–Ω—Ç—É–∏—Ü–∏—é":"–ì—Ä–∞–Ω–∞—Ç",
        "–ß–µ—Ä–µ–∑ —Å–º—ã—Å–ª/—Ü–µ–Ω–Ω–æ—Å—Ç–∏":"–°–∞–ø—Ñ–∏—Ä",
        "–ß–µ—Ä–µ–∑ –ª—é–¥–µ–π/–æ—Ç–Ω–æ—à–µ–Ω–∏—è":"–ì—Ä–∞–Ω–∞—Ç",
        "–ß–µ—Ä–µ–∑ –ø–æ—Ä—è–¥–æ–∫/–ø—Ä–∞–≤–∏–ª–∞":"–Ø–Ω—Ç–∞—Ä—å",
    }, amount=0.8)

    bump_if("behavior.money_spend", {
        "–ù–∞ –æ–±—É—á–µ–Ω–∏–µ/–∫—É—Ä—Å—ã/–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é":"–ì–µ–ª–∏–æ–¥–æ—Ä",
        "–ù–∞ –ø—Ä–æ–µ–∫—Ç—ã/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã/—Ä–∞–±–æ—Ç—É":"–ê–º–µ—Ç–∏—Å—Ç",
        "–ù–∞ –∫—Ä–∞—Å–æ—Ç—É/–æ–¥–µ–∂–¥—É/–¥–æ–º/—É—é—Ç":"–ò–∑—É–º—Ä—É–¥",
        "–ù–∞ –ª—é–¥–µ–π/–ø–æ–¥–∞—Ä–∫–∏/—Å–µ–º—å—é":"–ì—Ä–∞–Ω–∞—Ç",
        "–ù–∞ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è/–≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è":"–†—É–±–∏–Ω",
        "–ù–∞ –∑–¥–æ—Ä–æ–≤—å–µ/—Å–ø–æ—Ä—Ç":"–®—É–Ω–≥–∏—Ç",
    }, amount=0.7)

    # 3) Anti-amber guard: –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø—Ä—è–º –ø–∏—à–µ—Ç, —á—Ç–æ –Ω–µ–Ω–∞–≤–∏–¥–∏—Ç –ø–æ—Ä—è–¥–æ–∫, —Ç–æ –Ω–µ —Ç—Ä–∞–∫—Ç—É–µ–º —ç—Ç–æ –∫–∞–∫ "—Å–∏–ª–∞ –Ø–Ω—Ç–∞—Ä—è"
    hate = str(answers.get("antipattern.hate_task","") or "").lower()
    if "—Ä—É—Ç–∏–Ω–∞/–ø–æ—Ä—è–¥–æ–∫/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã" in hate:
        # —ç—Ç–æ —Å–ª–∞–±–æ—Å—Ç—å/–∞–Ω—Ç–∏-–ø–∞—Ç—Ç–µ—Ä–Ω, –ø–æ—ç—Ç–æ–º—É –Ø–Ω—Ç–∞—Ä—å –Ω–µ –ø–æ–¥–Ω–∏–º–∞–µ–º.
        # –Ω–∞–æ–±–æ—Ä–æ—Ç ‚Äî —Å–ª–µ–≥–∫–∞ —Å–Ω–∏–∂–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –ª–µ–ø–∏—Ç—å –Ø–Ω—Ç–∞—Ä—å –Ω–∞—Å–∏–ª—å–Ω–æ.
        scores["–Ø–Ω—Ç–∞—Ä—å"] -= 0.6
        evidence["–Ø–Ω—Ç–∞—Ä—å"].append("antipattern: dislikes routines ‚Üí —Å–Ω–∏–∑–∏–ª–∏ –Ø–Ω—Ç–∞—Ä—å")

    # 4) clamp
    for p in POTS:
        if scores[p] < 0:
            scores[p] = 0.0

    return scores, evidence

# ===================
# –°–µ—Å—Å–∏–∏ (—Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
# ===================
def utcnow_iso():
    return datetime.now(timezone.utc).isoformat().replace("+00:00", "Z")

def session_path(session_id: str) -> Path:
    return SESSIONS_DIR / f"{session_id}.json"

def save_session(payload: dict):
    sid = payload["meta"]["session_id"]
    p = session_path(sid)
    p.write_text(json.dumps(payload, ensure_ascii=False, indent=2), encoding="utf-8")

def load_session(sid: str):
    p = session_path(sid)
    if not p.exists():
        return None
    return json.loads(p.read_text(encoding="utf-8"))

def list_sessions():
    out = []
    for p in sorted(SESSIONS_DIR.glob("*.json"), key=lambda x: x.stat().st_mtime, reverse=True):
        try:
            data = json.loads(p.read_text(encoding="utf-8"))
            out.append(data)
        except Exception:
            continue
    return out

# ===================
# Session State
# ===================
def init_state():
    st.session_state.setdefault("session_id", str(uuid.uuid4()))
    st.session_state.setdefault("q_index", 0)
    st.session_state.setdefault("answers", {})
    st.session_state.setdefault("event_log", [])
    st.session_state.setdefault("done", False)
    st.session_state.setdefault("master_authed", False)
    st.session_state.setdefault("master_selected_session", None)
    st.session_state.setdefault("ai_report_text", "")
    st.session_state.setdefault("ai_report_master_text", "")

def reset_state():
    for k in ["q_index","answers","event_log","done","ai_report_text","ai_report_master_text"]:
        if k in st.session_state:
            del st.session_state[k]
    # session_id –Ω–æ–≤—ã–π, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –Ω–µ ‚Äú—Å—Ç–∞—Ä—Ç–æ–≤–∞–ª–æ —Å –∑–∞–≤–µ—Ä—à–µ–Ω–æ‚Äù
    st.session_state["session_id"] = str(uuid.uuid4())
    st.session_state["q_index"] = 0
    st.session_state["answers"] = {}
    st.session_state["event_log"] = []
    st.session_state["done"] = False
    st.session_state["ai_report_text"] = ""
    st.session_state["ai_report_master_text"] = ""

# ===================
# UI helpers
# ===================
def render_question(q, q_key: str):
    st.markdown(f"### {q['text']}")
    st.caption("–û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ. –ú–æ–∂–Ω–æ 1‚Äì5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.")

    qtype = q["type"]
    options = q.get("options", [])

    if qtype == "single":
        if not options:
            # –∑–∞—â–∏—Ç–∞ –æ—Ç "No options to select"
            return st.text_input("–û—Ç–≤–µ—Ç:", key=f"{q_key}_text")
        return st.radio("–í—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç:", options, key=f"{q_key}_radio")
    if qtype == "multi":
        if not options:
            return st.text_area("–û—Ç–≤–µ—Ç:", height=120, key=f"{q_key}_text")
        return st.multiselect("–í—ã–±–µ—Ä–∏ 1‚Äì4:", options, key=f"{q_key}_multi")
    # text
    return st.text_area("–û—Ç–≤–µ—Ç:", height=140, key=f"{q_key}_text")

def require_nonempty(q, ans):
    if q["type"] == "multi":
        return isinstance(ans, list) and len(ans) > 0
    return bool(str(ans or "").strip())

def current_meta_from_answers(answers: dict):
    name = str(answers.get("intake.ask_name","") or "").strip()
    request = str(answers.get("intake.ask_request","") or "").strip()
    contact = str(answers.get("intake.contact","") or "").strip()
    return name, request, contact

def vectors_without_labels(scores: dict):
    # –í–µ–∫—Ç–æ—Ä—ã (–±–µ–∑ —è—Ä–ª—ã–∫–æ–≤ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤) ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    v = []
    # –¥–µ–Ω—å–≥–∏/—Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if scores.get("–¶–∏—Ç—Ä–∏–Ω",0) >= 1.2:
        v.append("—Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –¥–µ–Ω—å–≥–∏ (—Å–∫–æ—Ä–æ—Å—Ç—å, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –≤—ã–≥–æ–¥–∞)")
    # —Å—Ç—Ä–∞—Ç–µ–≥–∏—è/—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    if scores.get("–ê–º–µ—Ç–∏—Å—Ç",0) >= 1.2:
        v.append("—Å—Ç—Ä–∞—Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (—Ü–µ–ª–∏, –ø–ª–∞–Ω, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)")
    # –æ–±—É—á–µ–Ω–∏–µ/—Ä–∞–∑–±–æ—Ä
    if scores.get("–ì–µ–ª–∏–æ–¥–æ—Ä",0) >= 1.2:
        v.append("–∑–Ω–∞–Ω–∏—è –∏ –æ–±—É—á–µ–Ω–∏–µ (—Ä–∞–∑–±–æ—Ä, –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ, —Ä–∞–∑–≤–∏—Ç–∏–µ)")
    # —Å–º—ã—Å–ª/–∏–¥–µ—è
    if scores.get("–°–∞–ø—Ñ–∏—Ä",0) >= 1.1:
        v.append("—Å–º—ã—Å–ª –∏ –≥–ª—É–±–∏–Ω–∞ (–ø–æ—á–µ–º—É —Ç–∞–∫, –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏, –∏–¥–µ–∏)")
    # –ª—é–¥–∏
    if scores.get("–ì—Ä–∞–Ω–∞—Ç",0) >= 1.1:
        v.append("–ª—é–¥–∏ –∏ —Å–≤—è–∑—å (–ø–æ–¥–¥–µ—Ä–∂–∫–∞, –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ, –æ—Ç–Ω–æ—à–µ–Ω–∏—è)")
    # —ç—Å—Ç–µ—Ç–∏–∫–∞
    if scores.get("–ò–∑—É–º—Ä—É–¥",0) >= 1.1:
        v.append("—ç—Å—Ç–µ—Ç–∏–∫–∞ –∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ (–∫—Ä–∞—Å–æ—Ç–∞, —É—é—Ç, —Å—Ç–∏–ª—å)")
    # –¥—Ä–∞–π–≤
    if scores.get("–†—É–±–∏–Ω",0) >= 1.1:
        v.append("—Å—Ü–µ–Ω–∞ –∏ —ç–º–æ—Ü–∏–∏ (–≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è, –ø—Ä–æ—è–≤–ª–µ–Ω–Ω–æ—Å—Ç—å)")
    # —Ç–µ–ª–æ
    if scores.get("–®—É–Ω–≥–∏—Ç",0) >= 1.1:
        v.append("—Ç–µ–ª–æ –∏ —ç–Ω–µ—Ä–≥–∏—è (–¥–≤–∏–∂–µ–Ω–∏–µ, –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å)")
    # –ø–æ—Ä—è–¥–æ–∫ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ –≤ –ø–ª—é—Å, –∞ –Ω–µ ‚Äú–Ω–µ–Ω–∞–≤–∏–∂—É‚Äù)
    if scores.get("–Ø–Ω—Ç–∞—Ä—å",0) >= 1.4:
        v.append("—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —Å–∏—Å—Ç–µ–º–∞ (–ø–æ—Ä—è–¥–æ–∫, —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã, –ø—Ä–æ—Ü–µ—Å—Å—ã)")

    return v[:6]

def build_payload():
    answers = st.session_state["answers"]
    scores, evidence = score_all(answers)

    name, request, contact = current_meta_from_answers(answers)

    payload = {
        "meta": {
            "schema": "ai-neo.master_report.v6",
            "app_version": APP_VERSION,
            "timestamp": utcnow_iso(),
            "session_id": st.session_state["session_id"],
            "name": name,
            "request": request,
            "contact": contact,
            "question_count": len(question_plan()),
            "answered_count": len(st.session_state["event_log"]),
        },
        "answers": answers,
        "scores": scores,
        "evidence": evidence,
        "event_log": st.session_state["event_log"],
        "ai_client_report": st.session_state.get("ai_report_text",""),
        "ai_master_report": st.session_state.get("ai_report_master_text",""),
    }
    return payload

# ===================
# AI report generation (master panel)
# ===================
def build_ai_prompt(payload: dict):
    # –ù–µ–±–æ–ª—å—à–æ–π, —ç–∫–æ–Ω–æ–º–Ω—ã–π –ø–æ —Ç–æ–∫–µ–Ω–∞–º –ø—Ä–æ–º–ø—Ç (—á—Ç–æ–±—ã –Ω–µ –ª–æ–≤–∏—Ç—å 429)
    meta = payload.get("meta", {})
    answers = payload.get("answers", {})
    scores = payload.get("scores", {})
    vectors = vectors_without_labels(scores)

    # –°–∂–∞—Ç—ã–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç: —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ –ø–æ–ª—è + 5-7 –∫–ª—é—á–µ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
    important_keys = [
        "intake.ask_request",
        "intake.current_state",
        "intake.goal_3m",
        "now.easy_tasks",
        "now.praise_for",
        "now.best_result_example",
        "now.energy_fill",
        "antipattern.hate_task",
        "antipattern.energy_leak",
    ]
    excerpt = {k: answers.get(k) for k in important_keys if k in answers}

    return {
        "meta": meta,
        "vectors": vectors,
        "scores_hint": scores,  # –º–∞—Å—Ç–µ—Ä—É –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
        "answers_excerpt": excerpt
    }

def call_openai_for_reports(client, model: str, data: dict):
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º (client_report, master_report)
    sys = (
        "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤. "
        "–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ø–æ –¥–∞–Ω–Ω—ã–º –∫—Ä–∞—Ç–∫–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å 2 –æ—Ç—á—ë—Ç–∞:\n"
        "A) Client report: 10-15 —Å—Ç—Ä–æ–∫, –±–µ–∑ —è—Ä–ª—ã–∫–æ–≤ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ (–Ω–µ –Ω–∞–∑—ã–≤–∞—Ç—å –∫–∞–º–Ω–∏), "
        "–¥–∞—Ç—å —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã, —á—Ç–æ –Ω–∞–ø–æ–ª–Ω—è–µ—Ç, —á—Ç–æ —Å–ª–∏–≤–∞–µ—Ç, –∏ 3 —à–∞–≥–∞ –Ω–∞ 7 –¥–Ω–µ–π + CTA –Ω–∞ –ø–æ–ª–Ω—ã–π —Ä–∞–∑–±–æ—Ä.\n"
        "B) Master report: —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π —Ä–∞–∑–±–æ—Ä: –≥–∏–ø–æ—Ç–µ–∑—ã –ø–æ 3-4 –≤–µ–¥—É—â–∏–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞–º (–º–æ–∂–Ω–æ –Ω–∞–∑—ã–≤–∞—Ç—å –∫–∞–º–Ω–∏), "
        "–∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã/—Å–º–µ—â–µ–Ω–∏—è, —á—Ç–æ —É—Ç–æ—á–Ω–∏—Ç—å, –∫–∞–∫–∏–µ 5 follow-up –≤–æ–ø—Ä–æ—Å–æ–≤, –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏/–º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏.\n"
        "–ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, –±–µ–∑ –≤–æ–¥—ã."
    )

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º Responses API (–∫–∞–∫ —É —Ç–µ–±—è —É–∂–µ –±—ã–ª–æ), –Ω–æ –¥–µ–ª–∞–µ–º –∫–æ—Ä–æ—Ç–∫–æ
    resp = client.responses.create(
        model=model,
        input=[
            {"role": "system", "content": sys},
            {"role": "user", "content": json.dumps(data, ensure_ascii=False)}
        ],
        # –ø—Ä–æ—Å–∏–º JSON, —á—Ç–æ–±—ã —Å—Ç–∞–±–∏–ª—å–Ω–æ –ø–∞—Ä—Å–∏—Ç—å
        response_format={"type": "json_object"},
    )

    # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä
    text = ""
    try:
        text = resp.output_text
    except Exception:
        try:
            # fallback: –Ω–∞–π—Ç–∏ output[0].content[0].text
            text = resp.output[0].content[0].text
                except Exception:
            text = ""

    if not text:
        raise RuntimeError("Empty response from OpenAI")

    # –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON: {"client_report": "...", "master_report": "..."}
    client_report = ""
    master_report = ""
    try:
        obj = json.loads(text)
        client_report = str(obj.get("client_report", "")).strip()
        master_report = str(obj.get("master_report", "")).strip()
    except Exception:
        # Fallback: –µ—Å–ª–∏ –ø—Ä–∏—à—ë–ª –Ω–µ JSON, –ø–æ–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç—å –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º
        t = text.strip()

        # –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
        markers = [
            ("CLIENT_REPORT:", "MASTER_REPORT:"),
            ("–ö–õ–ò–ï–ù–¢:", "–ú–ê–°–¢–ï–†:"),
            ("A)", "B)"),
        ]

        found = False
        for a, b in markers:
            if a in t and b in t:
                left, right = t.split(b, 1)
                client_report = left.replace(a, "").strip()
                master_report = right.strip()
                found = True
                break

        if not found:
            # –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ —Ä–∞–∑–¥–µ–ª–∏–ª–æ—Å—å ‚Äî –≤—Å—ë –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π, –º–∞—Å—Ç–µ—Ä –ø—É—Å—Ç–æ–π
            client_report = t
            master_report = ""

    return client_report, master_report
        
