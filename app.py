import os
import re
import json
import uuid
from datetime import datetime, timezone
from pathlib import Path

import streamlit as st

# --- 0) Page config MUST be the first Streamlit command
st.set_page_config(
    page_title="Индивидуальная диагностика потенциалов",
    layout="centered",
)

# --- Brand palette (ОДИН РАЗ)
BRAND = {
    "primary": "#3B2A4A",  # глубокий сливовый/фиолетовый
    "accent":  "#C58A2D",  # янтарь (тонко)
    "rose":    "#C9A3B5",  # пыльная роза
    "bg":      "#F6F1EA",  # тёплый светлый фон как в отчёте
    "text":    "#1F1A23",
    "muted":   "#6F6677",
}

# --- Path to logo (ОДИН РАЗ)
BASE_DIR = Path(__file__).resolve().parent
LOGO_MARK_PATH = BASE_DIR / "assets" / "logos" / "logo_mark.png"


def inject_brand_css():
    st.markdown(
        f"""
        <style>

        /* Фон страницы */
        [data-testid="stAppViewContainer"] {{
            background: {BRAND["bg"]};
        }}

        /* Контейнер */
        .block-container {{
            padding-top: 0.8rem;
            padding-bottom: 1.2rem;
            max-width: 860px;
        }}

        /* Строка "Ход: вопрос X из Y" */
        div[data-testid="stMarkdownContainer"] p {{
            margin-bottom: 0.4rem;
        }}

        /* Заголовок вопроса */
        h2, h3 {{
            margin-top: 0.5rem !important;
            margin-bottom: 0.5rem !important;
            color: {BRAND["primary"]};
            font-weight: 600;
        }}

        /* Подсказка под вопросом */
        p {{
            margin-top: 0.3rem;
            margin-bottom: 0.4rem;
        }}

        /* Поле ответа */
        div[data-testid="stTextArea"] {{
            margin-top: 0.4rem !important;
        }}

        /* Кнопка Далее */
        .stButton > button {{
            background: {BRAND["primary"]};
            color: white;
            border-radius: 14px;
            padding: 0.75rem 1rem;
            font-weight: 600;
        }}

        </style>
        """,
        unsafe_allow_html=True
    )

def render_brand_header(title: str, subtitle: str = ""):
    # лого слева + заголовок слева (спокойный размер)
    c1, c2 = st.columns([0.14, 0.86], vertical_alignment="center")

    with c1:
        if LOGO_MARK_PATH.exists():
            # читаем в bytes — это надёжнее, чем st.image(path)
            img_bytes = LOGO_MARK_PATH.read_bytes()
            st.image(img_bytes, width=56)  # 48–64 по вкусу

    with c2:
        st.markdown(
            f"""
            <div style="margin:0; padding:0;">
              <div style="
                font-size: 1.55rem;
                line-height: 1.12;
                font-weight: 600;
                letter-spacing: -0.01em;
                color: {BRAND["primary"]};
                margin-top: 0.15rem;
              ">{title}</div>
              {"<div style='margin-top:0.25rem; color:"+BRAND["muted"]+"; font-size:0.98rem;'>" + subtitle + "</div>" if subtitle else ""}
            </div>
            """,
            unsafe_allow_html=True
        )


# --- вызвать ОДИН РАЗ в начале UI
inject_brand_css()
render_brand_header("Индивидуальная диагностика потенциалов")

# =========================================================
# 0) PATHS (надёжно для Streamlit Cloud)
# =========================================================
APP_DIR = Path(__file__).resolve().parent
LOGO_MARK_PATH = APP_DIR / "assets" / "logos" / "logo_mark.png"

# =========================================================
# 1) BRAND PALETTE
# =========================================================
BRAND = {
    "primary": "#3B2A4A",  # глубокий серо-фиолетовый
    "accent":  "#C58A2D",  # янтарный
    "rose":    "#C9A3B5",  # пыльная роза
    "bg":      "#FFFFFF",
    "text":    "#1F1A23",
    "muted":   "#6F6677",
}

# =========================================================
# 3) CSS (премиальнее: вкладки, кнопки, прогресс)
# =========================================================
а

</style>
"""
    css = (css.replace("__PRIMARY__", BRAND["primary"])
              .replace("__ACCENT__", BRAND["accent"])
              .replace("__ROSE__", BRAND["rose"])
              .replace("__TEXT__", BRAND["text"]))
    st.markdown(css, unsafe_allow_html=True)

/* === Сжимаем вертикальные отступы === */

/* Строка "Ход: вопрос X из Y" */
div[data-testid="stMarkdownContainer"] p {
  margin-bottom: 0.4rem;
}

/* Заголовок вопроса */
h3, h2 {
  margin-top: 0.6rem !important;
  margin-bottom: 0.6rem !important;
}

/* Текст-пояснение под вопросом */
p {
  margin-top: 0.3rem;
  margin-bottom: 0.5rem;
}

/* Поле ответа */
div[data-testid="stTextArea"] {
  margin-top: 0.4rem !important;
}

# =========================================================
# 4) HEADER WITH LOGO
# =========================================================
def render_brand_header(title: str = "", subtitle: str = ""):
    cols = st.columns([0.18, 0.82], vertical_alignment="center")
    with cols[0]:
        if LOGO_MARK_PATH.exists():
            st.markdown("<div class='pp-logo'>", unsafe_allow_html=True)
            st.image(str(LOGO_MARK_PATH), width=72)
            st.markdown("</div>", unsafe_allow_html=True)
        else:
            st.caption(f"logo not found: {LOGO_MARK_PATH}")

    with cols[1]:
        if title:
            st.markdown(
                f"<div style='font-size:34px; font-weight:800; line-height:1.05; margin-top:2px'>{title}</div>",
                unsafe_allow_html=True
            )
        if subtitle:
            st.markdown(
                f"<div style='color:{BRAND['muted']}; margin-top:6px'>{subtitle}</div>",
                unsafe_allow_html=True
            )
# =========================================================
# 5) CALL ONCE AT TOP OF PAGE
# =========================================================
inject_brand_css()

CLIENT_MINI_PROMPT_VER = "mini_v4_rows_1_6"

# ======================
# CONFIG / PATHS
# ======================
APP_VERSION = "mvp-7.0-clean"

DATA_DIR = Path("data")
SESSIONS_DIR = DATA_DIR / "sessions"
SESSIONS_DIR.mkdir(parents=True, exist_ok=True)

KNOWLEDGE_DIR = Path("knowledge")  # ожидаем ./knowledge/*.md

# Secrets / env
MASTER_PASSWORD = st.secrets.get("MASTER_PASSWORD", os.getenv("MASTER_PASSWORD", ""))
OPENAI_API_KEY = st.secrets.get("OPENAI_API_KEY", os.getenv("OPENAI_API_KEY", ""))
DEFAULT_MODEL = st.secrets.get("OPENAI_MODEL", os.getenv("OPENAI_MODEL", "gpt-4.1-mini"))

# ======================
# UTILS
# ======================
def utcnow_iso() -> str:
    return datetime.now(timezone.utc).isoformat().replace("+00:00", "Z")

def safe_model_name(model: str) -> str:
    # если введут недоступную модель, можно “прибить” к дефолтной
    m = (model or "").strip()
    if not m:
        return DEFAULT_MODEL
    if m.startswith("gpt-5"):
        return DEFAULT_MODEL
    return m

def get_openai_client():
    if not OPENAI_API_KEY:
        return None
    try:
        from openai import OpenAI
        return OpenAI(api_key=OPENAI_API_KEY)
    except Exception:
        return None

# ======================
# QUESTIONS (25)
# ======================
def question_plan():
    """
    Финальная версия (human + situational).
    Логика: сначала разогрев+контекст -> настоящее -> быстрые ситуации (3 сек) ->
    детство -> поведение -> анти-паттерны.
    """
    return [
        # =========================
        # 0) INTAKE (контекст)
        # =========================
        {"id": "intake.ask_name", "stage": "intake", "intent": "ask_name", "type": "text",
         "text": "Как мне к тебе обращаться? (имя/как удобно)"},
        {"id": "intake.ask_request", "stage": "intake", "intent": "ask_request", "type": "text",
         "text": "С каким запросом ты пришёл(пришла)? Что хочешь понять/изменить? (1–2 фразы)"},
        {"id": "intake.contact", "stage": "intake", "intent": "contact", "type": "text",
         "text": "Оставь телефон или email (куда мастер сможет отправить полный отчёт). Можно одно поле."},
        {"id": "intake.current_state", "stage": "intake", "intent": "current_state", "type": "text",
         "text": "Если коротко: что сейчас в жизни больше всего НЕ устраивает или забирает энергию?"},
        {"id": "intake.goal_3m", "stage": "intake", "intent": "goal_3m", "type": "text",
         "text": "Представь: прошло 3 месяца и стало лучше. Что изменилось бы в первую очередь? (конкретно)"},
        {"id": "intake.priority_area", "stage": "intake", "intent": "priority_area", "type": "single",
         "column": "motivation",
         "text": "Что важнее всего прояснить сегодня?",
         "options": ["Реализация/дело", "Деньги/доход", "Отношения/люди", "Энергия/силы", "Смысл/направление"]},
        # =========================
 
        # =========================
        # 1) NOW (настоящее) — ОБНОВЛЁННЫЙ
        # =========================

        {"id": "now.easy_tasks", "stage": "now", "intent": "easy_tasks", "type": "text",
         "column": "instrument",
         "text": "Что у тебя обычно получается легко и без напряжения, даже если другим с этим сложно?"},

        {"id": "now.praise_for", "stage": "now", "intent": "praise_for", "type": "text",
         "column": "instrument",
         "text": "За что тебя чаще всего хвалят люди? Как они это формулируют?"},

        {"id": "now.time_flow", "stage": "now", "intent": "time_flow", "type": "text",
         "column": "motivation",
         "text": "В чём ты можешь залипать часами и не замечать, как проходит время?"},

        {"id": "now.stress_pattern", "stage": "now", "intent": "stress_pattern", "type": "single",
         "column": "perception",
         "text": "Когда на тебя давят или всё идёт не так, что происходит первым?",
         "options": [
             "Начинаю суетиться и делать быстрее",
             "Замыкаюсь и ухожу в себя",
             "Хочу всё взять под контроль",
             "Эмоции лезут наружу (раздражение, слёзы, смех)",
             "Застываю и не понимаю, за что хвататься"
         ]},

        {"id": "now.energy_fill", "stage": "now", "intent": "energy_fill", "type": "multi",
         "column": "motivation",
         "text": "Что тебя по-настоящему наполняет и возвращает энергию? (1–4 варианта)",
         "options": [
             "Живое общение и разговоры",
             "Говорить, обсуждать, делиться мыслями вслух",
             "Красота, уют, визуал",
             "Тишина, размышления, свои мысли",
             "Учёба, новые идеи, понимание",
             "Движение, тело, активность",
             "Сцена, выступления, впечатления"
         ]},

        {"id": "now.best_result_example", "stage": "now", "intent": "best_result_example", "type": "text",
         "column": "instrument",
         "text": "Вспомни ситуацию, где ты реально сделал(а) что-то круто: что было → что ты сделал(а) → чем всё закончилось?"},

        {"id": "now.motivation_trigger", "stage": "now", "intent": "motivation_trigger", "type": "single",
         "column": "motivation",
         "text": "Что тебя включает сильнее всего?",
         "options": [
             "Чёткая цель и понимание, куда иду",
             "Люди, общение, ощущение влияния",
             "Возможность говорить и быть услышанным(ой)",
             "Красиво сделать, упаковать, создать атмосферу",
             "Понять смысл и глубину происходящего",
             "Драйв, эмоции, сцена, движение",
             "Результат, деньги, ощущение «получилось»"
         ]},
        
                        # =========================
 # =========================
# 2) SCENARIOS (первые 3 секунды) — UPDATED (cover 9 potentials)
# =========================


        {"id": "now.attention_first",
        "stage": "now",
        "intent": "attention_first",
        "type": "single",
        "column": "perception",
        "text": "Ты заходишь в новую ситуацию (люди/место/встреча). Что мозг цепляет первым?",
        "options": [
            "Людей и их эмоции/настроение",                # Гранат
            "Смысл: что тут на самом деле происходит и зачем", # Сапфир
            "Выгоду/ресурсы: что можно получить/потерять",     # Цитрин
            "Порядок/риски: что тут сломано, где хаос, где правила", # Янтарь
            "Красоту/атмосферу: как выглядит, какой вайб",     # Изумруд
            "Тело/энергию: комфортно/не комфортно, усталость/тонус", # Шунгит
            "Звучание/подачу: как говорят, тон, голос, формулировки", # Гелиодор
            "Вектор/управление: кто главный, куда это ведёт, как рулить процессом", # Аметист
            "Драйв/напряжение/сексуальность: искра, риск, адреналин, притяжение"    # Рубин
            ]
        },
        {"id": "scn.listen_focus",
        "stage": "scenarios",
        "intent": "listen_focus",
        "type": "single",
        "column": "perception",
        "text": "Когда ты слушаешь человека 1–2 минуты, что ты считываешь первым?",
        "options": [
            "Его эмоцию и отношение (тепло/холод, напряжение)",         # Гранат
            "Суть/смысл: что он реально хочет сказать",                 # Сапфир
            "Логику и структуру: где причина, где вывод",               # Янтарь
            "Практическую выгоду: что это даст, где польза/результат",   # Цитрин
            "Вкус/эстетику: как упаковано, насколько “красиво звучит”",  # Изумруд
            "Тон/голос/интонацию: как звучит, как подаёт",              # Гелиодор
            "Вектор/намерение: куда он ведёт разговор и зачем",         # Аметист
            "Телесный сигнал: мне комфортно/не комфортно рядом",         # Шунгит
            "Накал/драйв: есть ли там страсть, риск, сексуальная энергия" # Рубин
            ]
        },
        {"id": "scn.taste_marker",
        "stage": "scenarios",
        "intent": "taste_marker",
        "type": "single",
        "column": "motivation",
        "text": "Что тебе по-настоящему приятно и “вкусно” в жизни? (как ты выбираешь удовольствие)",
        "options": [
            "Вкусы/еда/дегустации, люблю слышать нюансы",                 # Гелиодор
            "Красота/уют/визуал, чтобы было гармонично",                  # Изумруд
            "Движение/тело/форма, мне важно физически чувствовать себя",  # Шунгит
            "Смысл/глубина, люблю копать “зачем”",                        # Сапфир
            "Деньги/результат, кайф от роста и цифр",                     # Цитрин
            "Люди/общение, вайб “мы вместе”",                             # Гранат
            "Порядок/системность, чтобы всё работало как часы",           # Янтарь
            "Вектор/стратегия, кайф когда ясно “куда и как”",             # Аметист
            "Адреналин/экстрим/сексуальность, чтобы искрило"              # Рубин
        ]
        },
        {"id": "behavior.decision_style",
        "stage": "behavior",
        "intent": "decision_style",
        "type": "single",
        "column": "instrument",
        "text": "Как ты чаще всего принимаешь решение? (самый привычный способ)",
        "options": [
            "Считаю выгоду/цифры и выбираю самый эффективный вариант",        # Цитрин
            "Сразу вижу вектор: куда ведёт и какой следующий шаг",            # Аметист
            "Проверяю смысл: это “моё” или не моё по ценностям",              # Сапфир
            "Смотрю на людей: как это повлияет на отношения и связь",         # Гранат
            "Делаю через порядок: правила/структура/регламент",               # Янтарь
            "Слушаю голос/тон: проговариваю вслух — так становится ясно",     # Гелиодор
            "Ориентируюсь на эстетику/гармонию: чтобы было красиво и правильно ощущалось", # Изумруд
            "Слушаю тело: комфорт/напряжение сразу говорит “да/нет”",         # Шунгит
            "Выбираю по драйву: где больше искры/адреналина/притяжения"       # Рубин
            ]
        },
        {
        "id": "scn.project_start",
        "stage": "scenarios",
        "intent": "project_start",
        "type": "single",
        "column": "instrument",
        "text": "Тебе дали новый проект. Первый естественный шаг — это…",
        "options": [
            "Ставлю цель и вижу траекторию: куда идём и чем управлять",        # Аметист
            "Считаю результат/метрики/выгоду: что даст и сколько",             # Цитрин
            "Навожу порядок: структура, роли, дедлайны, регламенты",           # Янтарь
            "Собираю людей/связи: кто нужен, кого подключить",                 # Гранат
            "Ищу смысл/концепцию: “зачем мы это делаем”",                      # Сапфир
            "Делаю красиво/упаковываю: чтобы хотелось смотреть/покупать",      # Изумруд
            "Проговариваю/презентую: формулировка, подача, как это звучит",    # Гелиодор
            "Пробую в действии: через тело/практику быстро понимаю, что работает", # Шунгит
            "Добавляю драйва: эмоция, риск, шоу-эффект, чтобы зажечь людей"    # Рубин
        ]
        },
        {
        "id": "scn.conflict_style",
        "stage": "scenarios",
        "intent": "conflict_style",
        "type": "single",
        "column": "instrument",
        "text": "Если появляется конфликт или напряжение, ты чаще всего…",
        "options": [
            "Сглаживаю и объединяю: чтобы всем стало легче и мы не развалились",  # Гранат
            "Ставлю рамки: правила, границы, кто за что отвечает",               # Янтарь
            "Давлю на результат: быстро закрыть и двигаться дальше",             # Цитрин
            "Ухожу в смысл: “что мы вообще пытаемся решить?”",                   # Сапфир
            "Рулю ситуацией: беру управление и веду к решению",                  # Аметист
            "Перевожу в подачу: проговариваю, переформулирую, “как звучит”",     # Гелиодор
            "Стараюсь сделать мягко и красиво: без грязи, чтобы осталось уважение", # Изумруд
            "Реагирую телом: могу замереть/отойти, мне важно восстановить ресурс",  # Шунгит
            "Включаю накал: эмоция, остро, “на грани” — чтобы пробить стену"     # Рубин
        ]
        },
        {
        "id": "scn.feedback_pain",
        "stage": "scenarios",
        "intent": "feedback_pain",
        "type": "single",
        "column": "motivation",
        "text": "Что тебя выбивает сильнее всего, когда что-то не получается?",
        "options": [
            "Нет результата/денег — я бешусь, что нет отдачи",                 # Цитрин
            "Нет смысла — делаю и не понимаю “зачем”",                         # Сапфир
            "Люди не откликаются — будто меня не слышат/не чувствуют",         # Гранат
            "Бардак/хаос — всё разваливается и бесит",                         # Янтарь
            "Некрасиво/не так подано — прям физически неприятно",              # Изумруд
            "Нет драйва — скучно, тухло, нет искры",                           # Рубин
            "Голос/подача не получается — будто не могу донести",              # Гелиодор
            "Тело не тянет — усталость, слабость, нет ресурса",                # Шунгит
            "Нет управления/вектора — не понимаю, кто рулит и куда идём"       # Аметист
        ]
        },
        {
        "id": "scn.ideal_day",
        "stage": "scenarios",
        "intent": "ideal_day",
        "type": "single",
        "column": "motivation",
        "text": "Твой идеальный день — это когда в нём больше всего…",
        "options": [
            "Результата и денег: сделал(а) — получил(а) отдачу",                    # Цитрин
            "Ясного вектора: цели, управление, ощущение “я рулю”",                  # Аметист
            "Смысла и глубины: тишина, мысли, разговоры по делу и по сути",         # Сапфир
            "Людей и тепла: общение, связь, чувство “мы вместе”",                   # Гранат
            "Красоты и гармонии: эстетика, уют, эмоции в балансе",                  # Изумруд
            "Голоса/звучания: разговоры, истории, музыка, когда “приятно слышать”",# Гелиодор
            "Тела и ресурса: движение, форма, ощущение силы",                       # Шунгит
            "Порядка и ясности: всё по полочкам, спокойно и предсказуемо",          # Янтарь
            "Драйва и искры: эмоции, риск, адреналин, сексуальность"                # Рубин
            ]
        },

      # =========================
# 3) CHILDHOOD (проверка природного) — UPDATED (human wording + cover 9)
# =========================
        {
        "id": "childhood.child_play",
        "stage": "childhood",
        "intent": "child_play",
        "type": "multi",
        "column": "motivation",
        "text": "Если вспомнить тебя в 6–12 лет: что ты делал(а) с кайфом? (выбери 1–3)",
        "options": [
            "Командовать/организовывать игры, быть “главным(ой)”",           # Аметист
            "Собирать всё по правилам: порядок, списки, “так правильно”",    # Янтарь
            "Торговаться/собирать “ресурсы”: обмены, копить, выиграть приз", # Цитрин
            "Учиться, читать, объяснять другим, быть “умным(ой)”",           # Сапфир
            "Говорить, рассказывать, петь, быть “голосом” компании",         # Гелиодор
            "Дружить, мирить, объединять, быть про людей",                   # Гранат
            "Рисовать, украшать, делать красиво, придумывать стиль",         # Изумруд
            "Бегать, спорт, соревнования, проверять силу/выносливость",      # Шунгит
            "Драйв: риск, скорость, острые эмоции, “на грани”"               # Рубин
            ]
        },
        {
        "id": "childhood.teen_dream",
        "stage": "childhood",
        "intent": "teen_dream",
        "type": "text",
        "column": "motivation",
        "text": "В 12–16 лет: кем мечтал(а) стать или чем хотелось заниматься? (даже если это звучит странно/детски)"
        },
        {
        "id": "childhood.first_success",
        "stage": "childhood",
        "intent": "first_success",
        "type": "text",
        "column": "instrument",
        "text": "Какой твой первый “вау-момент” в детстве: где получилось лучше других? (1 пример)"
        },
        {
        "id": "childhood.family_role",
        "stage": "childhood",
        "intent": "family_role",
        "type": "single",
        "column": "perception",
        "text": "В семье/классе тебя чаще воспринимали как кого?",
        "options": [
            "Лидер/организатор: задавал(а) направление и “рулил(а)”",                 # Аметист
            "Про порядок: правила, дисциплина, “чтобы всё работало”",                 # Янтарь
            "Про деньги/результат: умел(а) добиваться своего и “выигрывать”",         # Цитрин
            "Про смысл/ум: любил(а) размышлять, задавал(а) вопросы, “почему так?”",   # Сапфир
            "Про голос: рассказывал(а), выступал(а), мог(ла) говорить/петь",          # Гелиодор
            "Про людей: дружба, контакт, миротворец/объединитель",                   # Гранат
            "Про красоту: эстет, вкус, “чтобы было красиво и приятно”",              # Изумруд
            "Про тело: спорт, сила, выносливость, “энергетик”",                      # Шунгит
            "Про драйв: сорвиголова, риск, эмоции, мог(ла) зажечь остальных"         # Рубин
            ]
        },
        {
        "id": "childhood.child_aversion",
        "stage": "childhood",
        "intent": "child_aversion",
        "type": "text",
        "column": "perception",
        "text": "Что в школе/детстве было прям тяжело и хотелось избегать? (1–2 вещи, без правильных ответов)"
        },
        {
        "id": "childhood.parent_expect",
        "stage": "childhood",
        "intent": "parent_expect",
        "type": "text",
        "column": "motivation",
        "text": "Что от тебя чаще всего требовали взрослые (“надо быть…”) — и как ты на это реагировал(а)?"
        },
        {
        "id": "childhood.child_energy",
        "stage": "childhood",
        "intent": "child_energy",
        "type": "text",
        "column": "motivation",
        "text": "Где ты чувствовал(а) себя реально живым(ой) в детстве? (ситуация: с кем/где/что делал(а))"
        },
        {
        "id": "childhood.child_pride",
        "stage": "childhood",
        "intent": "child_pride",
        "type": "text",
        "column": "instrument",
        "text": "За что ты собой в детстве искренне гордился(лась)? (1 конкретный пример)"
        },

        # =========================
        # =========================
# 4) BEHAVIOR (как живёт сейчас) — UPDATED (human wording + cover 9)
# =========================

        {
        "id": "behavior.free_time",
        "stage": "behavior",
        "intent": "free_time",
        "type": "text",
        "column": "motivation",
        "text": "Если вдруг появилось 2 часа полностью для себя (без дел и обязанностей) — что ты чаще всего выбираешь делать?"
        },
        {
        "id": "behavior.money_spend",
        "stage": "behavior",
        "intent": "money_spend",
        "type": "multi",
        "column": "motivation",
        "text": "На что ты чаще всего спонтанно тратишь деньги/силы? (выбери 1–3)",
        "options": [
            "На обучение: курсы, книги, разборы, знания",                         # Сапфир/Гелиодор
            "На голос/подачу/контент: сторис, видео, техника, выступления",        # Гелиодор
            "На бизнес/результат: инструменты, продажи, рост дохода, “быстрее”",   # Цитрин
            "На порядок и систему: сервисы, планирование, вещи “чтобы работало”",  # Янтарь
            "На людей: подарки, встречи, семья, поддержка, комьюнити",             # Гранат/Шунгит
            "На красоту и уют: одежда, дом, эстетика, стиль, атмосфера",           # Изумруд
            "На впечатления и драйв: поездки, события, шоу, “эмоции”",             # Рубин/Гранат
            "На тело и здоровье: спорт, массаж, анализы, восстановление"           # Шунгит
            ]
        },
        {
        "id": "behavior.group_role_now",
        "stage": "behavior",
        "intent": "group_role_now",
        "type": "single",
        "column": "instrument",
        "text": "Когда ты в группе/команде (работа, друзья, проект) — какая роль у тебя включается сама?",
        "options": [
            "Собираю и веду: задаю направление, решаю, “куда идём”",               # Аметист
            "Дожимаю результат: скорость, деньги, KPI, “давайте сделаем”",         # Цитрин
            "Навожу порядок: структура, правила, процессы, чтобы не было хаоса",   # Янтарь
            "Про людей: объединяю, держу контакт, мирю, создаю связь",             # Гранат
            "Про голос/подачу: объясняю, проговариваю, презентую, могу выступить", # Гелиодор
            "Про смысл: вижу идею, “зачем”, могу развернуть концепцию",            # Сапфир
            "Про красоту: делаю атмосферу/упаковку/вкус, чтобы было приятно",      # Изумруд
            "Про тело/практику: беру на себя “сделать руками/в действии”",         # Шунгит
            "Про эмоцию/драйв: зажигаю, добавляю остроты, делаю шоу/движ"          # Рубин
            ]
        },
        {
        "id": "behavior.long_focus",
        "stage": "behavior",
        "intent": "long_focus",
        "type": "text",
        "column": "perception",
        "text": "На чём ты можешь держать внимание долго и легко (без усилия) — что тебя реально затягивает?"
        },
        {
        "id": "behavior.fast_win",
        "stage": "behavior",
        "intent": "fast_win",
        "type": "text",
        "column": "instrument",
        "text": "Что ты умеешь “быстро собрать и сделать качественно”, когда надо? (1–3 примера)"
        },
        {
        "id": "behavior.teach_people",
        "stage": "behavior",
        "intent": "teach_people",
        "type": "text",
        "column": "instrument",
        "text": "Если бы ты мог(ла) научить людей одному навыку, где ты реально сильный(ая), — чему именно?"
        },
       # =========================
# 5) ANTIPATTERN (где ломается энергия) — UPDATED
# =========================

        {
        "id": "antipattern.avoid",
        "stage": "antipattern",
        "intent": "avoid",
        "type": "text",
        "text": "Какие задачи ты чаще всего откладываешь или делаешь через сильное сопротивление? (что прям не хочется делать)"
        },
        {
        "id": "antipattern.hate_task",
        "stage": "antipattern",
        "intent": "hate_task",
        "type": "single",
        "text": "Что из этого для тебя самое тяжёлое и неприятное?",
        "options": [
            "Рутина, регламенты, одно и то же каждый день",                  # Янтарь
            "Долгие пустые разговоры без смысла",                           # Сапфир
            "Продажи, заявлять о себе, быть видимым(ой)",                   # Гелиодор
            "Учёба ради учёбы, зубрёжка без интереса",                      # Аметист (в минусе)
            "Физическая нагрузка, тело, режим, дисциплина",                # Шунгит
            "Конфликты, напряжённые разговоры, жёсткие столкновения",      # Гранат
            "Когда всё некрасиво, неаккуратно, без вкуса",                 # Изумруд
            "Когда нет драйва, скучно, всё слишком спокойно",              # Рубин
            "Когда нет результата и движения вперёд"                       # Цитрин
            ]
        },
        {
        "id": "antipattern.energy_leak",
        "stage": "antipattern",
        "intent": "energy_leak",
        "type": "text",
        "text": "Где сейчас ты больше всего теряешь энергию? (люди, дела, мысли, тело, хаос, контроль — как ощущается у тебя)"
        },
        {
        "id": "antipattern.perfection_trap",
        "stage": "antipattern",
        "intent": "perfection_trap",
        "type": "single",
        "text": "Что чаще всего тебя стопорит и не даёт двигаться дальше?",
        "options": [
            "Хочу идеально — поэтому долго не начинаю",                     # Аметист / Сапфир
            "Слишком много идей и направлений — сложно выбрать",            # Сапфир
            "Нет людей рядом — тяжело одному(одной)",                       # Гранат / Шунгит
            "Не вижу смысла — не включаюсь вообще",                         # Сапфир
            "Рутина и однообразие убивают энергию",                         # Рубин / Гелиодор
            "Страшно быть видимым(ой), говорить, проявляться",              # Гелиодор
            "Нет быстрого результата — пропадает мотивация",               # Цитрин
            "Когда вокруг хаос и нет структуры",                            # Янтарь
            "Когда всё некрасиво и не в моём вкусе"                         # Изумруд
            ]
        }
    ]
# ======================
# SCORING (легкий)
# ======================
# ======================
# SCORING (v1.1 — под новые вопросы)
# ======================
import re

POTS = ["Янтарь","Шунгит","Цитрин","Изумруд","Рубин","Гранат","Сапфир","Гелиодор","Аметист"]

COLUMNS = ["perception", "motivation", "instrument"]

COL_LABELS = {
    "perception": "ВОСПРИЯТИЕ",
    "motivation": "МОТИВАЦИЯ",
    "instrument": "ИНСТРУМЕНТ",
}

# ======================
# CANON (school text) — ONLY FOR REPORT, NOT FOR SCORING
# ======================

def _s(x) -> str:
    return (str(x or "").strip())

POT_CANON_1_3 = {
    "Сапфир": {
        "perception": {
            "title": "Сапфир — 1 потенциал (восприятие/анализ)",
            "lines": [
                "Канал восприятия: **звук / вибрация идеи**. Восприятие через «прислушаться к себе».",
                "Анализирует **работоспособность идеи/теории/убеждения/мышления**: «звучит / не звучит», «в ноту / не в ноту».",
                "Чувствует дисгармонию смыслов и может видеть, **какая мысль не работает** и как её исправить.",
                "Память: **лучше всего запоминает то, что слышит**. Любит тишину, может уставать от шума."
            ],
            "intuition": [
                "Интуиция: **яснослышание** (слышать себя/дух).",
                "Важные решения лучше принимать в тишине/на природе: меньше шума — лучше слышно себя.",
            ],
        },
        "motivation": {
            "title": "Сапфир — 2 потенциал (цель/мотивация/позиционирование)",
            "lines": [
                "Ключевая ценность цели: **создание новых смыслов, идей, философий, концепций, моделей мышления** (и/или музыки).",
                "Зачем творю: **изобрести новый ответ, идею, теорию**.",
                "Позиционирование: **духовный проводник / гуру / поэт / философ**."
            ]
        },
        "instrument": {
            "title": "Сапфир — 3 потенциал (инструмент/как делаю)",
            "lines": [
                "Инструмент: **смысловое изобретение** — создавать недостающий пазл смысла под запрос человека.",
                "Слушает ситуацию → находит недостающую информацию → даёт ясность/идею/объяснение.",
                "Инструменты: систематизация смыслов, создание идей, настройка на внутренний источник."
            ]
        }
    },

    "Гелиодор": {
        "perception": {
            "title": "Гелиодор — 1 потенциал (восприятие/анализ)",
            "lines": [
                "Канал восприятия: **вкус идеи**. Включается через **диалог, спор, проговаривание**.",
                "Анализирует **интерес/популярность смыслового продукта**: зайдёт/не зайдёт, смешно/не смешно, будет ли спрос.",
                "Память: запоминает через **проговаривание**, повторение, рассказ."
            ],
            "intuition": [
                "Интуиция в голосе: обсуждай/рассуждай вслух — так находится правильный ответ.",
                "Практика: задаёшь вопрос → начинаешь рассуждать вслух (можно один) → через голос приходит ясность."
            ]
        },
        "motivation": {
            "title": "Гелиодор — 2 потенциал (цель/мотивация/позиционирование)",
            "lines": [
                "Ключевая ценность цели: **популярность, признание, распространение знаний/смыслов**.",
                "Сильная реализация: сцена/соцсети/ораторство/пение — если не реализуется, может «выговариваться» на близких.",
                "Позиционирование: **яркий голос / диктор / смысловой мотиватор / певец / оратор**."
            ]
        },
        "instrument": {
            "title": "Гелиодор — 3 потенциал (инструмент/как делаю)",
            "lines": [
                "Инструмент: **продвижение смыслов и знаний через голос**.",
                "Навыки: привлечение аудитории, повышение популярности идей, раскрытие человека через речь/подачу.",
                "Помогает делать других более заметными: фишки популярности, вовлечение, импровизация."
            ]
        }
    },

    "Аметист": {
        "perception": {
            "title": "Аметист — 1 потенциал (восприятие/анализ)",
            "lines": [
                "Канал восприятия: **запах / химия идеи** (яснознание). «Я просто знаю».",
                "Анализирует **эффективность знаний/мышления/идеи** под конкретную ситуацию, цель, время.",
                "Видит сценарии решений во времени: к чему приведёт путь мышления, как «упаковать идею», чтобы её купили.",
                "Память: сильная память на запахи, обонятельное восприятие."
            ],
            "intuition": [
                "Интуиция = обоняние (третий глаз): у любой информации есть свой «запах».",
                "Практика: место/люди/решение — если «запах нравится», значит туда."
            ]
        },
        "motivation": {
            "title": "Аметист — 2 потенциал (цель/мотивация/позиционирование)",
            "lines": [
                "Ключевая ценность цели: **продажа смыслов, тайное знание, власть над мышлением/вниманием**.",
                "Мотивирует: знания, секретная информация, механизмы влияния (в светлом ключе — помогать менять мышление).",
                "Позиционирование: **мистика/интрига/тайны/сакральная атмосфера** (школа знаний, эзотерика как оболочка)."
            ]
        },
        "instrument": {
            "title": "Аметист — 3 потенциал (инструмент/как делаю)",
            "lines": [
                "Инструмент: **управление мышлением** — слова/смыслы/сценарии решений.",
                "Воронки продаж идей, распутывание узлов убеждений, настройка мышления под цель.",
                "Сильный текст/слово: когда и какие слова сказать, чтобы изменить траекторию."
            ]
        }
    },

    "Изумруд": {
        "perception": {
            "title": "Изумруд — 1 потенциал (восприятие/анализ)",
            "lines": [
                "Канал восприятия: **визуал + переживание эмоций** (эмпатия).",
                "Анализирует работоспособность эмоции: гармония/дисгармония эмоций, «эмоции как краски».",
                "Память: визуальная — чтобы запомнить, нужно увидеть (цвета, сочетания)."
            ],
            "intuition": [
                "Интуиция через эмоции: представить варианты → почувствовать эмоции → выбирать там, где подъём/приятно."
            ]
        },
        "motivation": {
            "title": "Изумруд — 2 потенциал (цель/мотивация/позиционирование)",
            "lines": [
                "Ключевая ценность цели: **красота, эмоциональная гармония, счастье, исцеление эмоций**.",
                "Мотивирует: делать людей счастливее, добавлять краски, улучшать состояние, создавать экологию эмоций.",
                "Позиционирование: нежность/романтизм/эстетика, чувственный красивый образ."
            ]
        },
        "instrument": {
            "title": "Изумруд — 3 потенциал (инструмент/как делаю)",
            "lines": [
                "Инструмент: **эмоциональное изобретение** — создавать/переливать эмоции, красоту, атмосферу.",
                "Шаблоны красоты/эмоций, систематизация эмоций, обучение красоте/эмоциональным системам.",
                "Пример инструмента: нейрографика (если используется в методе)."
            ]
        }
    },

    "Гранат": {
        "perception": {
            "title": "Гранат — 1 потенциал (восприятие/анализ)",
            "lines": [
                "Канал восприятия: **мимика / выражение эмоций** (тело отражает эмоцию).",
                "Анализирует интерес к эмоциональному продукту: спрос, популярность эмоции/красоты/искусства.",
                "Память: эмоции и роли — чтобы запомнить, нужно повторять/отыгрывать."
            ],
            "intuition": [
                "Интуиция через мимику/игру: проиграть сценарий → смотреть на мимическую реакцию тела."
            ]
        },
        "motivation": {
            "title": "Гранат — 2 потенциал (цель/мотивация/позиционирование)",
            "lines": [
                "Ключевая ценность цели: **эмоции, театр, красота, мероприятия, распространение эмоций**.",
                "Где реализовать: актёрство, сцены, производство красоты/эмоциональных продуктов.",
                "Позиционирование: яркие роли, экспрессия, броские образы, эмоция в кадре."
            ]
        },
        "instrument": {
            "title": "Гранат — 3 потенциал (инструмент/как делаю)",
            "lines": [
                "Инструмент: **мимика / роль / актёрская подача** — выражать эмоцию и вовлекать людей.",
                "Производство эмоциональных продуктов, сбор аудитории вокруг эмоций.",
                "Создаёт состояние группы: рядом «эмоционально хорошо»."
            ]
        }
    },

    "Рубин": {
        "perception": {
            "title": "Рубин — 1 потенциал (восприятие/анализ)",
            "lines": [
                "Канал восприятия: **гормональный отклик / возбуждает–не возбуждает** (внутренние физиологические процессы).",
                "Анализирует продаваемость эмоции, драму, сценарии эмоциональных реакций.",
                "Понимает, где эмоций достаточно, где нужно усилить."
            ],
            "intuition": [
                "Интуиция через гормональный отклик: «правильное» даёт сильный внутренний всплеск/адреналин/желание."
            ]
        },
        "motivation": {
            "title": "Рубин — 2 потенциал (цель/мотивация/позиционирование)",
            "lines": [
                "Ключевая ценность цели: **эмоции, адреналин, управление эмоциями, секс/гормональные всплески**.",
                "Где реализовать: шоу/путешествия/экстрим/режиссура/кино/драйвовые проекты.",
                "Позиционирование: свобода, драйв, сексуальность, путешествия, экстрим."
            ]
        },
        "instrument": {
            "title": "Рубин — 3 потенциал (инструмент/как делаю)",
            "lines": [
                "Инструмент: **драматургия и управление эмоциями** (своими и аудитории).",
                "Работа с эмоциональными травмами (замещение эмоций), сценарии эмоций толпы, продажи через эмоцию.",
                "Режиссура/шоу/вебинары/сторис как эмоциональная подача."
            ]
        }
    },

    "Янтарь": {
        "perception": {
            "title": "Янтарь — 1 потенциал (восприятие/анализ)",
            "lines": [
                "Канал восприятия: **механизм / внутренние ощущения тела (ЖКТ)** — комфорт/дискомфорт.",
                "Анализирует работоспособность физики: тело как механизм, техника, схемы — что сломано и как исправить.",
                "Любит порядок/структуру: чисто/грязно, работает/не работает.",
                "Память: лучше через систематизацию — конспекты, таблицы, разжёванная структура."
            ],
            "intuition": [
                "Интуиция в животе: тело отвечает комфортом/дискомфортом.",
                "Практика выбора: стоять на вариантах (листках) и считывать телесный отклик."
            ]
        },
        "motivation": {
            "title": "Янтарь — 2 потенциал (цель/мотивация/позиционирование)",
            "lines": [
                "Ключевая ценность цели: **создание механизмов/систем** (чтобы работало «как часы»).",
                "Творчество: инструкции, техническая литература «инструкция к применению», программирование/системы.",
                "Позиционирование: учёный/наставник/изобретатель, всё по полочкам."
            ]
        },
        "instrument": {
            "title": "Янтарь — 3 потенциал (инструмент/как делаю)",
            "lines": [
                "Инструмент: **механическое изобретение** — руки/создание функционального/систем.",
                "Системы механизмов, деталей, обучение созданию функциональных объектов.",
                "Пример: массаж/остеопатия/работа руками — как инструмент (если в методике так трактуется)."
            ]
        }
    },

    "Шунгит": {
        "perception": {
            "title": "Шунгит — 1 потенциал (восприятие/анализ)",
            "lines": [
                "Канал восприятия: **форма / плотность / мышцы** (реакция мышц: напряжение/расслабление).",
                "Анализирует форму и «оригинал–подделка», спрос на функциональные продукты (что зайдёт).",
                "Хорошее пространственное мышление (3D/ландшафт/форма).",
                "Память: через **физическое действие** и многократное повторение."
            ],
            "intuition": [
                "Интуиция в действии/мышцах: тело тянет туда, где «моё», и ленится там, где не путь.",
                "Практика выбора: закрыть глаза, прокрутиться и пойти туда, куда ведёт тело."
            ]
        },
        "motivation": {
            "title": "Шунгит — 2 потенциал (цель/мотивация/позиционирование)",
            "lines": [
                "Ключевая ценность цели: **сообщество / близкий круг / форма/физика/механизмы**.",
                "Создаёт комьюнити: спорт, инвестиции, телесные практики, производство функциональных вещей.",
                "Позиционирование: проводник в окружение, телесность, форма, связь с родом/природой."
            ]
        },
        "instrument": {
            "title": "Шунгит — 3 потенциал (инструмент/как делаю)",
            "lines": [
                "Инструмент: **создание сообществ** вокруг телесного/материального, производство физического продукта.",
                "Инструменты выражения формы тела, практические мероприятия, объединение людей.",
                "Сильный эффект: лад в близком круге (семья/партнёры) через общие практические ценности."
            ]
        }
    },

    "Цитрин": {
        "perception": {
            "title": "Цитрин — 1 потенциал (восприятие/анализ)",
            "lines": [
                "Канал восприятия: **кожа / динамика движения**, телесные ощущения (приятно–неприятно).",
                "Анализирует **эффективность и распределение материальных ресурсов**: деньги, логистика, действия, инвестиции.",
                "Видит, что предпринять, чтобы усилить доход/прибыль, оптимизировать процесс.",
            ],
            "intuition": [
                "Интуиция через кожу: приятные/неприятные ощущения, мурашки.",
                "Можно телесно проявиться (движение/танец) и посмотреть, как тело реагирует на решение."
            ]
        },
        "motivation": {
            "title": "Цитрин — 2 потенциал (цель/мотивация/позиционирование)",
            "lines": [
                "Ключевая ценность цели: **деньги, материальный рост, изобилие, власть над материей**.",
                "Где реализовать: бизнес/финансы/инвестиции — там, где можно управлять финансовым ростом.",
                "Позиционирование: предприниматель, статус, деньги, роскошь (и/или развитие функционала тела)."
            ]
        },
        "instrument": {
            "title": "Цитрин — 3 потенциал (инструмент/как делаю)",
            "lines": [
                "Инструмент: **управление действиями/привычками/ресурсами/деньгами**.",
                "Организация, логистика, продажи физических продуктов, управление процессами и ресурсами других людей.",
                "«Самые заботливые»: организовать, обеспечить, разложить по местам, дать системе работать."
            ]
        }
    },
}

# ==============================
# POTENTIAL 4 — PROBLEM / ANALYSIS FIELD (MASTER)
# ==============================

POT_4_CANON = {
    "Аметист": {
        "problems": [
            "навязчивые мысли и идеи",
            "расфокусировка внимания",
            "мысленный беспорядок",
            "отсутствие направления и пути",
            "сложности с управлением мышлением",
            "проблемы с продажей смыслов, идей, философий"
        ],
        "analysis_focus": (
            "Анализ мышления, идей, убеждений, сценариев принятия решений "
            "и их эффективности для конкретной цели и ситуации."
        ),
        "hobby": [
            "ароматерапия",
            "детективные квесты",
            "просмотр триллеров"
        ]
    },

    "Рубин": {
        "problems": [
            "эмоциональные срывы",
            "резкие перепады настроения",
            "неконтролируемая агрессия",
            "истерия",
            "проблемы с управлением эмоциями",
            "сложности с продажей эмоциональных продуктов"
        ],
        "analysis_focus": (
            "Анализ эмоциональных реакций, гормональных состояний "
            "и сценариев эмоционального поведения."
        ),
        "hobby": [
            "экстремальные аттракционы",
            "прыжки с парашютом",
            "гвоздестояние",
            "фокус на телесных ощущениях",
            "сексуальные практики как работа с ощущениями"
        ]
    },

    "Цитрин": {
        "problems": [
            "финансовые долги",
            "неумение управлять деньгами",
            "кассовые разрывы",
            "финансовый потолок",
            "отсутствие роста дохода",
            "проблемы с продажами"
        ],
        "analysis_focus": (
            "Анализ материальных ресурсов, денег, действий "
            "и эффективности финансовых и бизнес-механизмов."
        ),
        "hobby": [
            "баня",
            "массаж",
            "тактильные практики",
            "еда с закрытыми глазами",
            "ретриты с сенсорным фокусом"
        ]
    },

    "Гелиодор": {
        "problems": [
            "проблемы с выражением мыслей",
            "ораторские блоки",
            "тихий или невыразительный голос",
            "отсутствие популярности",
            "низкие охваты",
            "отсутствие среды единомышленников"
        ],
        "analysis_focus": (
            "Анализ передачи смыслов, голоса, речи, "
            "интереса аудитории и популярности идей."
        ),
        "hobby": [
            "дегустация новых вкусов",
            "разговоры и философские обсуждения",
            "обмен мнениями"
        ]
    },

    "Гранат": {
        "problems": [
            "подавленные эмоции",
            "плохая мимика",
            "неумение выражать эмоции",
            "эмоциональные блоки в теле",
            "проблемы с привлекательностью",
            "низкая эмоциональная вовлеченность аудитории"
        ],
        "analysis_focus": (
            "Анализ эмоций, мимики, эмоционального отклика "
            "и выразительности."
        ),
        "hobby": [
            "просмотр мелодрам",
            "эмоциональное проживание ролей",
            "интерактивный театр"
        ]
    },

    "Шунгит": {
        "problems": [
            "проблемы с формой тела",
            "сбои в производстве",
            "проблемы с физическими продуктами",
            "конфликты в близком круге"
        ],
        "analysis_focus": (
            "Анализ формы, физики, тела, производства "
            "и механических процессов."
        ),
        "hobby": [
            "тренажёрный зал",
            "работа с мышечными ощущениями",
            "телесная нагрузка"
        ]
    },

    "Сапфир": {
        "problems": [
            "нехватка знаний",
            "поломки в мышлении",
            "ограниченные убеждения",
            "отсутствие ответов и смыслов"
        ],
        "analysis_focus": (
            "Анализ смыслов, идей, убеждений, "
            "философии и целостности мышления."
        ),
        "hobby": [
            "музыкальные концерты",
            "слушание звуков",
            "поющие чаши",
            "медитация в тишине",
            "астрономия"
        ]
    },

    "Изумруд": {
        "problems": [
            "эмоциональное выгорание",
            "депрессия",
            "отсутствие интереса к жизни",
            "подавленные эмоции",
            "нарушение эмоциональной гармонии",
            "отсутствие чувства красоты"
        ],
        "analysis_focus": (
            "Анализ эмоций, визуальной гармонии, "
            "красоты и эмоционального состояния."
        ),
        "hobby": [
            "фотосессии",
            "выставки",
            "природа",
            "работа с визуальной эстетикой",
            "смена образов"
        ]
    },

    "Янтарь": {
        "problems": [
            "отсутствие системности",
            "поломки тела или техники",
            "проблемы с обучением",
            "нехватка стабильности",
            "отсутствие чувства безопасности"
        ],
        "analysis_focus": (
            "Анализ механизмов, систем, телесных "
            "и структурных процессов."
        ),
        "hobby": [
            "архитектура",
            "выставки машин",
            "изучение механизмов",
            "выставки роботов"
        ]
    }
}

# ==============================
# POTENTIAL 5 — MISSION / CLIENT GOAL (MASTER)
# ==============================

POT_5_CANON = {
    "Аметист": {
        "mission": [
            "рост в смысловых и информационных ресурсах",
            "организация знаний и методологий",
            "трансформация мышления",
            "внедрение идей в массы"
        ]
    },

    "Рубин": {
        "mission": [
            "рост в эмоциональных ресурсах",
            "управление эмоциями толпы",
            "создание эмоциональных мероприятий",
            "продажа эмоций"
        ]
    },

    "Цитрин": {
        "mission": [
            "рост материальных ресурсов",
            "управление деньгами и действиями",
            "создание финансовых источников",
            "выход на новый финансовый уровень"
        ]
    },

    "Гелиодор": {
        "mission": [
            "рост популярности смыслового продукта",
            "распространение идей",
            "создание сообщества вокруг философии",
            "массовая передача знаний"
        ]
    },

    "Гранат": {
        "mission": [
            "популяризация эмоционального продукта",
            "распространение красоты",
            "эмоциональная вовлечённость аудитории"
        ]
    },

    "Шунгит": {
        "mission": [
            "массовое производство физического продукта",
            "формирование спроса на телесные и функциональные решения",
            "создание сообществ"
        ]
    },

    "Сапфир": {
        "mission": [
            "изобретение новых смыслов",
            "расширение границ мышления",
            "систематизация знаний",
            "обучение и передача опыта"
        ]
    },

    "Изумруд": {
        "mission": [
            "создание новых эмоций",
            "гармонизация эмоционального состояния",
            "создание красоты"
        ]
    },

    "Янтарь": {
        "mission": [
            "создание механизмов и систем",
            "исцеление тела",
            "обучение и передача прикладного опыта"
        ]
    }
}

# ==============================
# POTENTIAL 6 — RESULT / PUZZLE (MASTER)
# ==============================

POT_6_CANON = {
    "Аметист": {
        "result": "Рост смысловых ресурсов и изменение мышления",
        "collective_hobby": [
            "детективные игры",
            "мафия",
            "интеллектуальные квесты",
            "совместные размышления"
        ]
    },

    "Цитрин": {
        "result": "Рост материальных ресурсов и финансовой устойчивости",
        "collective_hobby": [
            "организация мероприятий",
            "совместное планирование"
        ]
    },

    "Гелиодор": {
        "result": "Рост популярности и признания",
        "collective_hobby": [
            "рассказывание историй",
            "пение",
            "ведение мероприятий"
        ]
    },

    "Гранат": {
        "result": "Рост эмоциональной вовлеченности и привлекательности",
        "collective_hobby": [
            "вечеринки",
            "эмоциональные шоу",
            "совместные развлечения"
        ]
    },

    "Шунгит": {
        "result": "Рост физических сообществ и производства",
        "collective_hobby": [
            "походы",
            "активный отдых"
        ]
    },

    "Сапфир": {
        "result": "Новые идеи и системное мышление",
        "collective_hobby": [
            "философские обсуждения",
            "создание сценариев",
            "логические игры"
        ]
    },

    "Изумруд": {
        "result": "Эмоциональная гармония и красота",
        "collective_hobby": [
            "стилизация",
            "совместное творчество"
        ]
    },

    "Янтарь": {
        "result": "Создание новых механизмов и телесное восстановление",
        "collective_hobby": [
            "музыка у костра",
            "прикладное творчество"
        ]
    }
}

def canon_cell(pot: str, col: str) -> str:
    """
    Возвращает строго канон. Никаких 'сильных сторон' от модели.
    """
    pot = _s(pot)
    col = _s(col)
    block = (POT_CANON.get(pot) or {}).get(col) or {}
    title = _s(block.get("title")) or f"{pot}"
    lines = block.get("lines") or []
    intuition = block.get("intuition") or []

    out = [f"**{title}**"]
    if lines:
        out += [f"- {x}" for x in lines if _s(x)]
    if intuition:
        out.append("")
        out.append("**Интуиция/решения (как в школе):**")
        out += [f"- {x}" for x in intuition if _s(x)]
    if len(out) == 1:
        out.append("_Каноническое описание будет добавлено._")
    return "\n".join(out)

def row_intro_school(row_id: str) -> str:
    row_id = _s(row_id)
    if row_id == "1":
        return "Это **ядро**: то, где ты сильнее всего и где реализация идёт естественно."
    if row_id == "2":
        return "Это **ряд наполнения**: то, что подпитывает ресурс, вдохновляет, усиливает ядро."
    if row_id == "3":
        return ("⚠️ Это **ряд рисков**: **это НЕ сильные стороны**. "
                "Из этого ряда нельзя строить жизнь/работу — тут быстрее устаёшь. "
                "Задача: **минимум времени / делегировать / автоматизировать**.")
    return "—"

def row_footer_school(row_id: str) -> str:
    row_id = _s(row_id)
    if row_id == "1":
        return "Фокус: опираться на этот ряд при выборе сферы, роли и формата реализации."
    if row_id == "2":
        return "Фокус: использовать как подпитку и социальную/энергетическую поддержку."
    if row_id == "3":
        return "Фокус: не тянуть на себе; вынести в поддержку, регламенты, делегирование."
    return ""

def matrix_markdown_table(m: dict) -> str:
    rows = (m or {}).get("rows", []) or []
    if not rows:
        return "—"
    header = "| Ряд | Восприятие | Мотивация | Инструмент |\n|---|---|---|---|\n"
    body = ""
    for r in rows:
        body += f"| {r.get('row','—')} | {r.get('perception','—')} | {r.get('motivation','—')} | {r.get('instrument','—')} |\n"
    return header + body


# ======================
# HARD GATE: forbid report without full answers
# ======================
def report_ready(payload: dict) -> tuple[bool, str]:
    payload = payload or {}
    answers = payload.get("answers", {}) or {}

    # берём список вопросов из твоего question_plan()
    try:
        plan = question_plan()
    except Exception:
        plan = []

    required = []
    for q in (plan or []):
        qid = q.get("id")
        if not qid:
            continue
        # контакт можно не требовать
        if qid == "intake.contact":
            continue
        required.append(qid)

    if not required:
        return False, "⚠️ Отчёт недоступен: список вопросов не найден. Обнови страницу и попробуй снова."

    missing = []
    for qid in required:
        v = answers.get(qid)
        ok = False
        if isinstance(v, list):
            ok = len([x for x in v if _s(x)]) > 0
        else:
            ok = bool(_s(v))
        if not ok:
            missing.append(qid)

    if missing:
        return False, f"⚠️ Отчёт недоступен: ответь на все вопросы диагностики. Осталось: {len(missing)} из {len(required)}."
    return True, ""

# Веса по вопросам: где вопрос реально диагностический — вес выше
Q_WEIGHTS = {
    # intake
    "intake.priority_area": 1.10,

    # now
    "now.easy_tasks": 0.85,
    "now.praise_for": 0.85,
    "now.time_flow": 0.80,
    "now.stress_pattern": 1.05,
    "now.energy_fill": 1.00,
    "now.best_result_example": 0.95,
    "now.motivation_trigger": 1.05,

    # scenarios
    "now.attention_first": 1.20,
    "scn.listen_focus": 1.10,
    "scn.project_start": 1.15,
    "scn.conflict_style": 1.05,
    "scn.taste_marker": 1.05,

    # antipattern
    "antipattern.avoid": 0.80,
    "antipattern.hate_task": 1.00,
    "antipattern.energy_leak": 0.85,
    "antipattern.perfection_trap": 1.05,
}

def _norm(text: str) -> str:
    t = (text or "").lower().replace("ё", "е")
    t = re.sub(r"[^a-zа-я0-9\s]+", " ", t, flags=re.IGNORECASE)
    t = re.sub(r"\s+", " ", t).strip()
    return t

# Расширенные триггеры — "как говорит человек"
# (стемы/части слов — специально, чтобы ловить разные формы)
# Расширенные триггеры — "как говорит человек"
# (стемы/части слов — специально, чтобы ловить разные формы)
KEYWORDS = {
    "Рубин": [
        # управление эмоциями / сценарий / класс эмоций
        "управл эмоц", "режисс", "сценар", "эмоциональн фон", "поднять эмоц",
        "заменить эмоц", "переключить эмоц", "встроить эмоц", "внедрить эмоц",
        "вести через эмоц", "триумф", "азарт", "вау", "накрыва", "эмоциональн погод",
        "эмоциональн безопасн", "рядом спокойн", "рядом уверенн",

        # ценности: секс / адреналин / свобода / эксклюзив / впечатления
        "секс", "сексу", "влечен", "страст", "желан", "магнет", "флирт",
        "адренал", "драйв", "остры ощущ", "риск", "экстрим", "кайф", "впечатл",
        "приключ", "путешеств", "трип", "тур", "ивент", "шоу", "квест",
        "эксклюзив", "редк", "уникальн", "недоступ", "вау эффект",

        # минус: манипуляция / зависимость / импульс / вспышки
        "манипул", "абьюз", "вина", "давлен", "зависим", "удуш", "тревог", "хаос эмоц",
        "вспышк", "резк", "крик", "натворил", "импульс", "скук", "охота за эмоц",
        "измен", "границ нет"
    ],

    "Гранат": [
        # эмоции вовне / мимика / харизма / контакт / вайб
        "мимик", "лиц", "выраз", "харизм", "настроен", "вайб", "заража",
        "показать эмоц", "выразить", "ярк", "смешн", "юмор", "оживля",
        "легко знаком", "располаг", "свой", "душа компан", "тусовк",

        # сообщество / связи / средний круг
        "связ", "нетворк", "знаком", "сообще", "собрать люд", "объедин",
        "мы вместе", "компан", "движух", "ивент", "публичн", "реклам", "тренд",
        "популяриз", "продвиж", "лицо бренда",

        # триггеры: холод / формальность / невидимость
        "холодн", "формальн", "сдержан", "невидим", "не проявля", "критика за эмоц",
        "стыдно", "зажим"
    ],

    "Изумруд": [
        # красота / гармония / состояние / тонкость
        "красот", "эстет", "уют", "атмосфер", "гармон", "тонко", "нежн",
        "стиль", "вкус", "композиц", "цвет", "детал", "визуал", "дизайн",
        "пространств", "интерьер", "сервис", "качество", "идеал",

        # психология / эмоциональная гармония в отношениях
        "психолог", "эмоц баланс", "эмоц гармони", "внутренн равновес",
        "отношен", "близост", "тепло", "бережн", "поддерж", "мягк",
        "токсич", "исцел", "арт", "терап", "состояние",

        # минус: невроз от некрасивого / критика / гонка за идеалом
        "некрасив", "раздражает визуал", "передел", "идеальн", "пластик",
        "чинить внешн", "жертва", "драма", "ломает самооцен"
    ],

    "Сапфир": [
        # смыслы / идеи / мировоззрение / первопричины
        "смысл", "зачем", "почему", "идея", "концепц", "мировоззрен",
        "философ", "теор", "методолог", "первопричин", "сценар смысл",
        "осознан", "истин", "путь", "картина мира", "размышл", "рефлекс",

        # тишина / ритм / давление
        "тишин", "уедин", "пауз", "мне нужно подумать", "не торопи",
        "шум", "громк", "сует", "давлен", "спешк",

        # слух / музыка / яснослышание (твои маркеры)
        "музык", "инструмент", "пиан", "гитар", "скрип", "флейт",
        "слух", "идеальн слух", "мелод", "нот", "звучит", "не звучит",
        "яснослыш", "слышу", "прислуш"
    ],

    "Гелиодор": [
        # голос / речь / проговаривание / подача / массовость
        "голос", "говор", "речь", "оратор", "подач", "интонац", "дикц",
        "проговор", "думаю вслух", "объясня", "простыми словами",
        "сторис", "рилс", "эфир", "подкаст", "интервью", "шутк", "импров",
        "крылат", "мем", "разлетел", "репутац", "мнение", "влияние словом",

        # вкус / еда / дегустации
        "вкус", "вкусы", "вкусно", "невкус", "дегустац", "пробовать",
        "готов", "готовка", "еда", "рецепт", "специи", "аромат",

        # горло / связки (зона)
        "горло", "осип", "хрип", "связк", "кашель", "першит", "ангин", "ларинг",

        # минус: болтливость / сплетни / искажение / троллинг
        "болта", "лишнее сказал", "сплетн", "тролл", "клевет",
        "исказил", "пересказ", "украш", "инфоцыган"
    ],

    "Аметист": [
        # управление мышлением / информация / стратегия влияния
        "влия", "перепрош", "перенастро", "управл мышл", "управл решен",
        "сценар", "ключев", "пазл", "логик влияния", "тонко", "намек",
        "серый кардин", "советник", "переговор", "маневр",
        "сканир", "что за этим", "скрыт мотив", "просчитать", "ходы",
        "контроль инфо", "информац", "данные", "развед",

        # реализация
        "стратег", "позиционир", "упаков", "продюс", "наставн", "архитект",
        "рычаг", "точка влияния", "фраза решает", "вопросом повернуть"
    ],

    "Цитрин": [
        # цель -> результат / ресурсы / скорость / метрики
        "результ", "цель", "дедлайн", "метрик", "цифр", "план", "эффектив",
        "ускор", "быстрее", "сделать", "продав", "монет", "доход", "выручк",
        "клиент", "заявк", "воронк", "сделк", "бюджет", "рынок", "маржин",
        "окуп", "прибыл", "выгод", "статус", "уровень",

        # контроль ресурсов / дисциплина
        "контрол", "дисциплин", "управл ресурс", "операционк", "процесс",
        "конкретик", "что делаем", "что получ", "план действий", "точка а точка б",

        # триггеры: размазанность / медлительность / без метрик
        "размазан", "медлен", "много разговор", "нет метрик", "нет цели",
        "обесценили вклад", "не признали результат"
    ],

    "Шунгит": [
        # тело / движение / круг / место / безопасность
        "тело", "движ", "шаг", "ход", "спорт", "трен", "вынослив", "сил",
        "форма", "плечом к плечу", "рядом физич", "присутств",
        "дом", "место", "район", "свое", "круг", "свои", "верност",
        "объят", "тактил", "рукопожат",

        # триггеры: отрыв / холод / дистанция / предательство
        "дистанц", "холодн", "формальн", "оторвали", "нет своих",
        "предатель", "не верен", "разрушили круг"
    ],

    "Янтарь": [
        # порядок в материи / методика / качество / комфорт / "работает-не работает"
        "поряд", "чисто", "грязн", "удоб", "неудоб", "комфорт",
        "работает", "не работает", "почин", "чинить", "исправ",
        "детал", "качество", "провер", "настро", "налад", "собрать",
        "технолог", "метод", "инструкц", "по шагам", "как правильно",
        "повтор", "стандар", "сервис", "ремонт",

        # триггеры: спешка / многозадачность / прерывания
        "спешк", "тороп", "перебив", "многозадач", "хаос",
        "ступор", "сабот", "обнул", "раздраж", "упрям"
    ],
}

# Быстрые “смысловые маркеры”, которые часто встречаются без “триггерных слов”
# Быстрые "смысловые маркеры" — как человек обычно говорит в жизни
# (это НЕ стемы, а живые фразы; можно матчить contains по _norm())
SEMANTIC_HINTS = {
    "Рубин": [
        "мне скучно", "мне нужны эмоции", "хочу вау", "хочу драйва", "хочу адреналина",
        "хочу приключений", "хочу впечатлений", "мне нужен движ", "хочу экстрима",
        "мне хочется свободы", "не люблю когда меня ограничивают", "меня бесит контроль",
        "я люблю когда вокруг ярко", "я хочу чтобы было красиво и дорого",
        "не дорого а уникально", "хочу эксклюзив", "хочу редкое", "хочу чтобы это было недоступно всем",
        "я заводюсь когда есть риск", "я люблю риск", "я хочу испытать себя",
        "мне важно чувство триумфа", "хочу победы", "хочу быть на высоте",
        "я чувствую что могу управлять атмосферой", "я могу переключить настроение людей",
        "рядом со мной людям спокойно", "рядом со мной людям увереннее",
        "у меня вспышки", "я могу резко сорваться", "я могу накричать",
        "я потом жалею что натворила", "я делаю импульсивно",
        "меня качает по эмоциям", "у меня тревога внутри и я всех этим накрываю",
        "я не выношу скуку", "когда скучно я начинаю искать эмоции",
        "мне важна сексуальность", "мне важен секс", "мне важно влечение",
        "я хочу нравиться противоположному полу", "я хочу чтобы меня хотели"
    ],

    "Гранат": [
        "мне нужна движуха", "мне нужно общение", "мне нужна тусовка",
        "я люблю людей", "я люблю быть среди людей", "я быстро знакомлюсь",
        "я легко схожусь", "я люблю поболтать", "я люблю когда весело",
        "я люблю когда есть вайб", "я чувствую атмосферу компании",
        "я могу оживить любое место", "я могу разрядить обстановку",
        "я люблю внимание", "мне важно чтобы меня замечали", "я люблю быть заметной",
        "я люблю сцену", "мне нравится выступать", "мне нравится камера",
        "я люблю когда мы вместе", "я люблю собирать людей", "я люблю объединять людей",
        "я решаю вопросы через связи", "я могу найти человека через знакомых",
        "мне тяжело в холодной среде", "меня убивает формальность",
        "мне тяжело быть сдержанной", "я зажимаюсь когда меня критикуют за эмоции",
        "я боюсь выглядеть смешной", "когда меня игнорируют мне больно",
        "мне важно чтобы был контакт", "мне важно чтобы меня чувствовали"
    ],

    "Изумруд": [
        "мне важно чтобы было красиво", "я люблю эстетику", "я люблю уют",
        "мне важна атмосфера", "я чувствую детали", "меня бесит некрасивое",
        "мне важно качество", "я люблю когда все гармонично",
        "мне важно эмоциональное равновесие", "мне важно спокойствие внутри",
        "я тонко чувствую людей", "я чувствую настроение человека",
        "мне нравится психология", "я люблю разбирать эмоции", "я люблю тему отношений",
        "я хочу гармонии в отношениях", "я хочу мягкости и тепла",
        "я хочу чтобы людям рядом было легче", "я хочу давать людям состояние",
        "я люблю создавать красоту руками", "я люблю дизайн", "я люблю стиль",
        "я люблю интерьер", "я люблю визуал", "я люблю композицию",
        "я залипаю на красоте", "я могу долго выбирать чтобы было идеально",
        "я могу застревать потому что не идеально", "я переделываю до идеала",
        "хаос меня расшатывает эмоционально", "мне нужна своя территория",
        "мне нужно побыть одной чтобы восстановиться"
    ],

    "Сапфир": [
        "мне важно понять зачем", "мне важно понять смысл", "мне важно почему так",
        "я ищу идею", "я люблю размышлять", "я люблю тишину", "мне нужна тишина",
        "мне нужно время подумать", "не торопи меня", "я не могу быстро отвечать",
        "я люблю глубину", "мне важны ценности", "мне важно быть честной с собой",
        "я люблю философские разговоры", "я люблю концепции", "я люблю теории",
        "я люблю собирать картину мира", "я люблю первопричины",
        "меня выбивает шум", "мне тяжело в суете", "я не люблю громко",
        "я не люблю крики", "меня раздражает агрессия",
        "я люблю музыку но не люблю громкость", "у меня хороший слух",
        "мне важно как звучит", "у меня идеальный слух",
        "я будто слышу что-то", "я прислушиваюсь", "у меня яснослышание",
        "мне не нужна популярность", "мне важна точность идеи",
        "мне сложно объяснить простыми словами", "я знаю но не могу сразу сказать"
    ],

    "Гелиодор": [
        "мне легче сказать голосом", "когда говорю вслух становится ясно",
        "я думаю через разговор", "мне надо проговорить", "я люблю говорить",
        "я могу говорить часами", "я буду краток но", "я люблю обсуждать",
        "мне важна подача", "мне важен голос", "мне важна интонация",
        "мне важно чтобы меня слушали", "хочу чтобы меня слышали",
        "хочу охваты", "хочу аудиторию", "хочу больше подписчиков",
        "я хочу записывать сторис", "я хочу делать рилс", "я хочу подкаст",
        "мне нравится интервью", "мне нравится выступать", "мне нравится импровизировать",
        "я люблю шутить", "я люблю юмор", "я люблю стендап",
        "я люблю вкусно поесть", "я люблю пробовать новое", "я люблю дегустации",
        "я выбираю по вкусу", "мне важно вкусно", "мне важно сочетание вкусов",
        "если я молчу мне плохо", "если не говорю я начинаю заедать",
        "у меня садится голос", "у меня першит горло", "я хрипну", "у меня ком в горле",
        "я могу ляпнуть лишнее", "я потом жалею что сказала лишнее",
        "меня тянет обсуждать людей", "я могу переборщить с разговорами"
    ],

    "Аметист": [
        "я хочу понять как это работает", "я хочу разобраться", "я хочу докопаться",
        "что за этим стоит", "где слабое место", "какая истинная причина",
        "я вижу мотивы", "я вижу сценарий", "я читаю людей",
        "мне важно иметь информацию", "мне нужны данные", "мне нужно больше фактов",
        "я не люблю неопределенность", "я не люблю когда непонятно",
        "я хочу просчитать ходы", "я хочу стратегию", "мне нужен план влияния",
        "я люблю переговоры", "я люблю договариваться", "я умею убеждать",
        "я влияю словами", "одна фраза может все решить",
        "я не люблю светиться", "я не хочу быть на виду",
        "я не люблю когда меня заставляют публично", "мне легче делать тихо",
        "я боюсь потерять контроль", "я боюсь что не контролирую ситуацию",
        "я учусь только тому что даст рычаг", "мне важно чтобы знание работало",
        "я не знаю с чего начать", "я вижу много вариантов и не могу выбрать",
        "мне нужен вектор", "мне нужно направление"
    ],

    "Цитрин": [
        "мне нужен результат", "мне нужны цифры", "мне важны метрики",
        "что по деньгам", "какая выгода", "сколько принесет", "сколько стоит",
        "как быстро окупится", "мне важна скорость", "давай быстрее",
        "мне важно чтобы было по делу", "меньше разговоров больше действий",
        "мне важно довести до конца", "мне важно победить", "мне важна эффективность",
        "мне нужно поставить цель", "мне нужен дедлайн", "мне нужен план",
        "кто за что отвечает", "давайте распределим ответственность",
        "я не могу когда медленно", "меня бесит медлительность",
        "меня бесит размазанность", "меня бесит хаос",
        "мне сложно без структуры целей", "мне важно контролировать процесс",
        "мне тяжело когда обесценивают мой вклад", "почему никто не видит результат",
        "я не люблю пустые разговоры", "я не люблю нытье",
        "мне сложно продавать", "я не люблю продавать себя", "мне трудно заявлять о себе"
    ],

    "Шунгит": [
        "у меня нет сил", "я устала", "я выгорела", "мне нужно восстановиться",
        "мне нужно поспать", "мне нужно в тело", "мне нужно движение",
        "мне легче думать когда я хожу", "мне легче когда я двигаюсь",
        "мне важно здоровье", "мне важно питание", "мне важно тело",
        "мне важно быть рядом", "мне важно физическое присутствие",
        "мне важны свои", "мне важна верность", "я держусь за свой круг",
        "мне нужен свой дом", "мне важно свое место", "мне важно свое пространство",
        "мне нравится делать руками", "мне нравится практическое",
        "мне нравится повторять и улучшать", "мне нравится тренироваться регулярно",
        "мне тяжело на дистанции", "мне тяжело без контакта",
        "меня ломает когда меня отрывают от своих", "я не могу без своих",
        "я не про разговоры я про дело", "мне важна опора", "мне важно плечо"
    ],

    "Янтарь": [
        "мне нужен порядок", "я хочу чтобы было по полочкам", "я люблю когда все разложено",
        "мне важно чтобы работало", "что-то не работает", "надо починить",
        "давай сделаем по инструкции", "давай по шагам", "давай по чеклисту",
        "мне важна методика", "мне важно качество", "мне важно правильно",
        "я люблю настраивать", "я люблю чинить", "я люблю улучшать",
        "меня выбивает спешка", "не торопи меня", "я так не могу быстро",
        "меня сбивают когда меня прерывают", "я не люблю многозадачность",
        "у меня ступор когда хаос", "все разбросано и я не могу начать",
        "мне важно чтобы было чисто", "мне важно чтобы было удобно",
        "я не могу когда дискомфортно", "я начинаю раздражаться от грязи",
        "я долго готовлюсь", "мне нужно подготовить все заранее",
        "я хочу довести до стандарта", "давай сделаем один раз но качественно"
    ],
}

def text_hits(text: str, pot: str) -> int:
    t = _norm(text)
    if not t:
        return 0
    kws = KEYWORDS.get(pot, [])
    hits = sum(1 for kw in kws if kw in t)

    # семантические подсказки (фразы)
    hints = SEMANTIC_HINTS.get(pot, [])
    hits += sum(2 for ph in hints if ph in t)  # фраза = сильнее, чем слово
    return hits

def score_all(answers: dict):
    scores = {p: 0.0 for p in POTS}
    evidence = {p: [] for p in POTS}
    col_scores = {c: {p: 0.0 for p in POTS} for c in COLUMNS}

    plan = question_plan()
    q_by_id = {q["id"]: q for q in plan}

    def add(p, v, note, qid=None):
        v = float(v)
        scores[p] += v
        evidence[p].append(note)

        if qid and qid in q_by_id:
            col = q_by_id[qid].get("column")
            if col in col_scores:
                col_scores[col][p] += v

    # 1) Keyword / phrase scoring (под ответы человека)
    for qid, ans in answers.items():
        wq = float(Q_WEIGHTS.get(qid, 0.75))
        if isinstance(ans, list):
            joined = " ".join([str(x) for x in ans])
            for p in POTS:
                h = text_hits(joined, p)
                if h:
                    add(p, wq * (0.22 * h), f"{qid}: kw({p})*{h}", qid=qid)
        else:
            txt = str(ans or "")
            for p in POTS:
                h = text_hits(txt, p)
                if h:
                    add(p, wq * (0.30 * h), f"{qid}: kw({p})*{h}", qid=qid)

    # 2) Option-based bumps (самые точные сигналы)
    def bump_if(qid, option_to_pots, amount=1.0):
        a = answers.get(qid)
        if not a:
            return
        wq = float(Q_WEIGHTS.get(qid, 1.0))

        def apply_one(opt, share=1.0):
            pots = option_to_pots.get(opt)
            if not pots:
                return
            # pots может быть строкой, списком или dict pot->weight
            if isinstance(pots, str):
                add(pots, wq * amount * share, f"{qid}: opt→{pots}", qid=qid)
            elif isinstance(pots, list):
                per = (wq * amount * share) / max(1, len(pots))
                for pp in pots:
                    add(pp, per, f"{qid}: opt→{pp}", qid=qid)
            elif isinstance(pots, dict):
                s = sum(abs(float(v)) for v in pots.values()) or 1.0
                for pp, vv in pots.items():
                    add(pp, wq * amount * share * (float(vv) / s), f"{qid}: opt→{pp}({vv})", qid=qid)

        if isinstance(a, list):
            per = 1.0 / max(1, len(a))
            for x in a:
                apply_one(x, share=per)
        else:
            apply_one(a, share=1.0)

    # ---- intake.priority_area
    # ---- intake.priority_area (options: ["Реализация/дело", "Деньги/доход", "Отношения/люди", "Энергия/силы", "Смысл/направление"])
    bump_if("intake.priority_area", {
        "Реализация/дело": {"Аметист": 1.0, "Сапфир": 0.35, "Цитрин": 0.25},
        "Деньги/доход": {"Цитрин": 1.0, "Аметист": 0.25},
        "Отношения/люди": {"Гранат": 1.0, "Изумруд": 0.25},
        "Энергия/силы": {"Шунгит": 1.0, "Янтарь": 0.25},
        "Смысл/направление": {"Сапфир": 1.0, "Аметист": 0.35},
    }, amount=1.15)

# ---- now.stress_pattern (новые options)
    bump_if("now.stress_pattern", {
        "Начинаю суетиться и делать быстрее": {"Цитрин": 0.75, "Аметист": 0.35, "Рубин": 0.25},
        "Замыкаюсь и ухожу в себя": {"Сапфир": 0.85, "Шунгит": 0.25},
        "Хочу всё взять под контроль": {"Янтарь": 1.0, "Аметист": 0.35, "Цитрин": 0.35},
        "Эмоции лезут наружу (раздражение, слёзы, смех)": {"Гранат": 0.55, "Рубин": 0.65},
        "Застываю и не понимаю, за что хвататься": {"Сапфир": 0.35, "Шунгит": 0.35, "Янтарь": 0.25},
    }, amount=1.0)

# ---- now.energy_fill (новые options, тут Гелиодор усиливаем отдельно)
    bump_if("now.energy_fill", {
        "Живое общение и разговоры": {"Гранат": 1.0},
        "Говорить, обсуждать, делиться мыслями вслух": {"Гелиодор": 1.0},  # усиление
        "Красота, уют, визуал": {"Изумруд": 1.0, "Янтарь": 0.3},
        "Тишина, размышления, свои мысли": {"Сапфир": 1.0},
        "Учёба, новые идеи, понимание": {"Сапфир": 0.7, "Аметист": 0.35, "Гелиодор": 0.35},
        "Движение, тело, активность": {"Шунгит": 1.0},
        "Сцена, выступления, впечатления": {"Рубин": 1.0, "Гелиодор": 0.35, "Гранат": 0.25},
    }, amount=1.05)

# ---- now.motivation_trigger (новые options)
    bump_if("now.motivation_trigger", {
        "Чёткая цель и понимание, куда иду": {"Аметист": 1.0},
        "Люди, общение, ощущение влияния": {"Гранат": 1.0},
        "Возможность говорить и быть услышанным(ой)": {"Гелиодор": 1.0},  # ключевая строка
        "Красиво сделать, упаковать, создать атмосферу": {"Изумруд": 1.0, "Рубин": 0.25},
        "Понять смысл и глубину происходящего": {"Сапфир": 1.0},
        "Драйв, эмоции, сцена, движение": {"Рубин": 1.0, "Гранат": 0.25},
        "Результат, деньги, ощущение «получилось»": {"Цитрин": 1.0},
    }, amount=1.05)

# ---- now.attention_first (новые options на 9 потенциалов)
    bump_if("now.attention_first", {
        "Людей и их эмоции/настроение": {"Гранат": 1.0},
        "Смысл: что тут на самом деле происходит и зачем": {"Сапфир": 1.0},
        "Выгоду/ресурсы: что можно получить/потерять": {"Цитрин": 1.0},
        "Порядок/риски: что тут сломано, где хаос, где правила": {"Янтарь": 1.0},
        "Красоту/атмосферу: как выглядит, какой вайб": {"Изумруд": 1.0},
        "Тело/энергию: комфортно/не комфортно, усталость/тонус": {"Шунгит": 1.0},
        "Звучание/подачу: как говорят, тон, голос, формулировки": {"Гелиодор": 1.0},  # важная точка
        "Вектор/управление: кто главный, куда это ведёт, как рулить процессом": {"Аметист": 1.0},
        "Драйв/напряжение/сексуальность: искра, риск, адреналин, притяжение": {"Рубин": 1.0},
    }, amount=1.15)

# ---- scn.listen_focus (9 потенциалов)
    bump_if("scn.listen_focus", {
        "Его эмоцию и отношение (тепло/холод, напряжение)": {"Гранат": 0.8, "Рубин": 0.35},
        "Суть/смысл: что он реально хочет сказать": {"Сапфир": 1.0},
        "Логику и структуру: где причина, где вывод": {"Янтарь": 0.75, "Аметист": 0.25},
        "Практическую выгоду: что это даст, где польза/результат": {"Цитрин": 1.0},
        "Вкус/эстетику: как упаковано, насколько “красиво звучит”": {"Изумруд": 0.85, "Гелиодор": 0.35},
        "Тон/голос/интонацию: как звучит, как подаёт": {"Гелиодор": 1.0},
        "Вектор/намерение: куда он ведёт разговор и зачем": {"Аметист": 1.0},
        "Телесный сигнал: мне комфортно/не комфортно рядом": {"Шунгит": 1.0},
        "Накал/драйв: есть ли там страсть, риск, сексуальная энергия": {"Рубин": 1.0},
    }, amount=1.05)

# ---- scn.taste_marker (9 потенциалов)
    bump_if("scn.taste_marker", {
        "Вкусы/еда/дегустации, люблю слышать нюансы": {"Гелиодор": 1.0},
        "Красота/уют/визуал, чтобы было гармонично": {"Изумруд": 1.0},
        "Движение/тело/форма, мне важно физически чувствовать себя": {"Шунгит": 1.0},
        "Смысл/глубина, люблю копать “зачем”": {"Сапфир": 1.0},
        "Деньги/результат, кайф от роста и цифр": {"Цитрин": 1.0},
        "Люди/общение, вайб “мы вместе”": {"Гранат": 1.0},
        "Порядок/системность, чтобы всё работало как часы": {"Янтарь": 1.0},
        "Вектор/стратегия, кайф когда ясно “куда и как”": {"Аметист": 1.0},
        "Адреналин/экстрим/сексуальность, чтобы искрило": {"Рубин": 1.0},
    }, amount=1.0)

# ---- behavior.decision_style (9 потенциалов)
    bump_if("behavior.decision_style", {
        "Считаю выгоду/цифры и выбираю самый эффективный вариант": {"Цитрин": 1.0},
        "Сразу вижу вектор: куда ведёт и какой следующий шаг": {"Аметист": 1.0},
        "Проверяю смысл: это “моё” или не моё по ценностям": {"Сапфир": 1.0},
        "Смотрю на людей: как это повлияет на отношения и связь": {"Гранат": 1.0},
        "Делаю через порядок: правила/структура/регламент": {"Янтарь": 1.0},
        "Слушаю голос/тон: проговариваю вслух — так становится ясно": {"Гелиодор": 1.0},
        "Ориентируюсь на эстетику/гармонию: чтобы было красиво и правильно ощущалось": {"Изумруд": 1.0},
        "Слушаю тело: комфорт/напряжение сразу говорит “да/нет”": {"Шунгит": 1.0},
        "Выбираю по драйву: где больше искры/адреналина/притяжения": {"Рубин": 1.0},
    }, amount=1.05)

# ---- scn.project_start (9 потенциалов)
    bump_if("scn.project_start", {
        "Ставлю цель и вижу траекторию: куда идём и чем управлять": {"Аметист": 1.0},
        "Считаю результат/метрики/выгоду: что даст и сколько": {"Цитрин": 1.0},
        "Навожу порядок: структура, роли, дедлайны, регламенты": {"Янтарь": 1.0},
        "Собираю людей/связи: кто нужен, кого подключить": {"Гранат": 1.0},
        "Ищу смысл/концепцию: “зачем мы это делаем”": {"Сапфир": 1.0},
        "Делаю красиво/упаковываю: чтобы хотелось смотреть/покупать": {"Изумруд": 1.0},
        "Проговариваю/презентую: формулировка, подача, как это звучит": {"Гелиодор": 1.0},
        "Пробую в действии: через тело/практику быстро понимаю, что работает": {"Шунгит": 1.0},
        "Добавляю драйва: эмоция, риск, шоу-эффект, чтобы зажечь людей": {"Рубин": 1.0},
    }, amount=1.10)

# ---- scn.conflict_style (9 потенциалов)
    bump_if("scn.conflict_style", {
        "Сглаживаю и объединяю: чтобы всем стало легче и мы не развалились": {"Гранат": 1.0, "Изумруд": 0.25},
        "Ставлю рамки: правила, границы, кто за что отвечает": {"Янтарь": 1.0},
        "Давлю на результат: быстро закрыть и двигаться дальше": {"Цитрин": 0.85, "Аметист": 0.25},
        "Ухожу в смысл: “что мы вообще пытаемся решить?”": {"Сапфир": 1.0},
        "Рулю ситуацией: беру управление и веду к решению": {"Аметист": 1.0},
        "Перевожу в подачу: проговариваю, переформулирую, “как звучит”": {"Гелиодор": 1.0},
        "Стараюсь сделать мягко и красиво: без грязи, чтобы осталось уважение": {"Изумруд": 1.0},
        "Реагирую телом: могу замереть/отойти, мне важно восстановить ресурс": {"Шунгит": 1.0},
        "Включаю накал: эмоция, остро, “на грани” — чтобы пробить стену": {"Рубин": 1.0},
    }, amount=1.0)

# ---- scn.feedback_pain (9 потенциалов)
    bump_if("scn.feedback_pain", {
        "Нет результата/денег — я бешусь, что нет отдачи": {"Цитрин": 1.0},
        "Нет смысла — делаю и не понимаю “зачем”": {"Сапфир": 1.0},
        "Люди не откликаются — будто меня не слышат/не чувствуют": {"Гранат": 1.0},
        "Бардак/хаос — всё разваливается и бесит": {"Янтарь": 1.0},
        "Некрасиво/не так подано — прям физически неприятно": {"Изумруд": 1.0},
        "Нет драйва — скучно, тухло, нет искры": {"Рубин": 1.0},
        "Голос/подача не получается — будто не могу донести": {"Гелиодор": 1.0},
        "Тело не тянет — усталость, слабость, нет ресурса": {"Шунгит": 1.0},
        "Нет управления/вектора — не понимаю, кто рулит и куда идём": {"Аметист": 1.0},
    }, amount=1.0)

# ---- scn.ideal_day (9 потенциалов)
    bump_if("scn.ideal_day", {
        "Результата и денег: сделал(а) — получил(а) отдачу": {"Цитрин": 1.0},
        "Ясного вектора: цели, управление, ощущение “я рулю”": {"Аметист": 1.0},
        "Смысла и глубины: тишина, мысли, разговоры по делу и по сути": {"Сапфир": 1.0},
        "Людей и тепла: общение, связь, чувство “мы вместе”": {"Гранат": 1.0},
        "Красоты и гармонии: эстетика, уют, эмоции в балансе": {"Изумруд": 1.0},
        "Голоса/звучания: разговоры, истории, музыка, когда “приятно слышать”": {"Гелиодор": 1.0},
        "Тела и ресурса: движение, форма, ощущение силы": {"Шунгит": 1.0},
        "Порядка и ясности: всё по полочкам, спокойно и предсказуемо": {"Янтарь": 1.0},
        "Драйва и искры: эмоции, риск, адреналин, сексуальность": {"Рубин": 1.0},
    }, amount=1.0)

# ---- antipattern.hate_task (новые options) — мягкие штрафы
    hate = str(answers.get("antipattern.hate_task", "") or "").strip()
    if hate:
        if hate == "Рутина, регламенты, одно и то же каждый день":
            scores["Янтарь"] = max(0.0, scores["Янтарь"] - 0.55)
            evidence["Янтарь"].append("hate_task: рутина/регламенты → -Янтарь")

        elif hate == "Долгие пустые разговоры без смысла":
            scores["Сапфир"] = max(0.0, scores["Сапфир"] - 0.20)
            evidence["Сапфир"].append("hate_task: пустые разговоры → -Сапфир")

        elif hate == "Продажи, заявлять о себе, быть видимым(ой)":
            scores["Гелиодор"] = max(0.0, scores["Гелиодор"] - 0.25)
            scores["Цитрин"] = max(0.0, scores["Цитрин"] - 0.20)
            evidence["Гелиодор"].append("hate_task: заявлять/быть видимым → -Гелиодор")
            evidence["Цитрин"].append("hate_task: продажи → -Цитрин")

        elif hate == "Учёба ради учёбы, зубрёжка без интереса":
            scores["Сапфир"] = max(0.0, scores["Сапфир"] - 0.15)
            evidence["Сапфир"].append("hate_task: учеба ради учебы → -Сапфир")

        elif hate == "Физическая нагрузка, тело, режим, дисциплина":
            scores["Шунгит"] = max(0.0, scores["Шунгит"] - 0.35)
            evidence["Шунгит"].append("hate_task: физнагрузка/режим → -Шунгит")

        elif hate == "Конфликты, напряжённые разговоры, жёсткие столкновения":
            scores["Гранат"] = max(0.0, scores["Гранат"] - 0.20)
            scores["Изумруд"] = max(0.0, scores["Изумруд"] - 0.10)
            evidence["Гранат"].append("hate_task: конфликты → -Гранат")
            evidence["Изумруд"].append("hate_task: жесткость → -Изумруд")

        elif hate == "Когда всё некрасиво, неаккуратно, без вкуса":
            scores["Изумруд"] = max(0.0, scores["Изумруд"] - 0.25)
            evidence["Изумруд"].append("hate_task: некрасиво/без вкуса → -Изумруд")

        elif hate == "Когда нет драйва, скучно, всё слишком спокойно":
            scores["Рубин"] = max(0.0, scores["Рубин"] - 0.25)
            evidence["Рубин"].append("hate_task: скука/нет драйва → -Рубин")

        elif hate == "Когда нет результата и движения вперёд":
            scores["Цитрин"] = max(0.0, scores["Цитрин"] - 0.30)
            evidence["Цитрин"].append("hate_task: нет результата → -Цитрин")

# ---- antipattern.perfection_trap (новые options)
    bump_if("antipattern.perfection_trap", {
        "Хочу идеально — поэтому долго не начинаю": {"Аметист": 0.35, "Сапфир": 0.55, "Янтарь": 0.35},
        "Слишком много идей и направлений — сложно выбрать": {"Сапфир": 0.55, "Аметист": 0.35},
        "Нет людей рядом — тяжело одному(одной)": {"Гранат": 0.55, "Шунгит": 0.35},
        "Не вижу смысла — не включаюсь вообще": {"Сапфир": 0.85},
        "Рутина и однообразие убивают энергию": {"Рубин": 0.45, "Гелиодор": 0.35},
        "Страшно быть видимым(ой), говорить, проявляться": {"Гелиодор": 0.85, "Гранат": 0.25},
        "Нет быстрого результата — пропадает мотивация": {"Цитрин": 0.85},
        "Когда вокруг хаос и нет структуры": {"Янтарь": 0.85},
        "Когда всё некрасиво и не в моём вкусе": {"Изумруд": 0.85},
    }, amount=0.85)

    # 3) clamp
    for p in POTS:
        if scores[p] < 0:
            scores[p] = 0.0

    return scores, evidence, col_scores

def vectors_without_labels(scores: dict):
    v = []
    if scores.get("Цитрин", 0) >= 1.35:
        v.append("результат и деньги (скорость, эффективность, выгода)")
    if scores.get("Аметист", 0) >= 1.30:
        v.append("цель и управление (вектор, стратегия, лидерство)")
    if scores.get("Гелиодор", 0) >= 1.20:
        v.append("знания и обучение (разбор, объяснение, метод)")
    if scores.get("Сапфир", 0) >= 1.20:
        v.append("смысл и глубина (ценности, ‘зачем’, суть)")
    if scores.get("Гранат", 0) >= 1.20:
        v.append("люди и связь (контакт, поддержка, влияние)")
    if scores.get("Изумруд", 0) >= 1.15:
        v.append("эстетика и гармония (красота, атмосфера, вкус)")
    if scores.get("Рубин", 0) >= 1.15:
        v.append("проявленность и эмоции (сцена, драйв, впечатления)")
    if scores.get("Шунгит", 0) >= 1.15:
        v.append("тело и ресурс (энергия, восстановление, выносливость)")
    if scores.get("Янтарь", 0) >= 1.35:
        v.append("порядок и система (структура, процессы, правила)")
    return v[:6]
    
def top_n_from_map(d: dict, n=3):
    items = sorted((d or {}).items(), key=lambda x: float(x[1]), reverse=True)
    return [p for p, v in items if float(v) > 0][:n]

ROW_NAMES = ["1", "2", "3"]
COLS = ["perception", "motivation", "instrument"]

def build_matrix_3x3_unique(scores: dict, col_scores: dict) -> dict:
    """
    Собирает матрицу 3x3 БЕЗ повторов камней.

    Идея:
    - Для каждой колонки берём рейтинг из col_scores (если пусто — fallback на scores)
    - Заполняем 1 ряд: лучшие (ядро)
    - 2 ряд: следующие (соц слой)
    - 3 ряд: оставшиеся (риски/делегировать)
    """

    # 1) нормализуем источники для каждой колонки
    col_rank = {}
    for c in COLS:
        src = (col_scores or {}).get(c) or {}
        if not src:
            src = scores or {}
        col_rank[c] = sorted(src.items(), key=lambda x: float(x[1]), reverse=True)

    used = set()
    rows = []

    # helper: взять лучший камень, которого ещё нет
    def pick_best(col, start_index=0):
        ranked = col_rank[col]
        for p, v in ranked[start_index:]:
            if p not in used:
                used.add(p)
                return p
        # если вдруг всё занято — fallback: любой неиспользованный из POTS
        for p in POTS:
            if p not in used:
                used.add(p)
                return p
        return "—"

    # 2) 1 ряд (ядро) — самые сильные по каждой колонке
    r1 = {
        "row": "1",
        "perception": pick_best("perception"),
        "motivation": pick_best("motivation"),
        "instrument": pick_best("instrument"),
    }
    rows.append(r1)

    # 3) 2 ряд — следующие по силе (берём со смещением в рейтинге)
    # можно мягко сдвигать индекс, чтобы не брать снова тех же “топов”
    r2 = {
        "row": "2",
        "perception": pick_best("perception", start_index=1),
        "motivation": pick_best("motivation", start_index=1),
        "instrument": pick_best("instrument", start_index=1),
    }
    rows.append(r2)

    # 4) 3 ряд — оставшиеся
    r3 = {
        "row": "3",
        "perception": pick_best("perception", start_index=2),
        "motivation": pick_best("motivation", start_index=2),
        "instrument": pick_best("instrument", start_index=2),
    }
    rows.append(r3)

    return {"rows": rows}

def matrix_markdown_table(m: dict) -> str:
    rows = (m or {}).get("rows", [])
    if not rows:
        return ""

    header = "| Ряд | Восприятие | Мотивация | Инструмент |\n|---|---|---|---|\n"
    body = ""
    for r in rows:
        body += (
            f"| {r.get('row','—')} "
            f"| {r.get('perception','—')} "
            f"| {r.get('motivation','—')} "
            f"| {r.get('instrument','—')} |\n"
        )
    return header + body

# ======================
# SESSIONS STORAGE
# ======================
def session_path(session_id: str) -> Path:
    return SESSIONS_DIR / f"{session_id}.json"

def save_session(payload: dict):
    sid = payload["meta"]["session_id"]
    session_path(sid).write_text(json.dumps(payload, ensure_ascii=False, indent=2), encoding="utf-8")

def merge_and_save_session(payload: dict):
    sid = payload["meta"]["session_id"]
    existing = load_session(sid) or {}

    # сохраняем то, что уже было сгенерено и записано в файл
    keep_keys = [
        "ai_client_report",
        "ai_master_report",
        "ai_client_report_ver",
        "ai_master_report_ver",
    ]
    for k in keep_keys:
        if k in existing and k not in payload:
            payload[k] = existing[k]

    save_session(payload)

def load_session(sid: str):
    p = session_path(sid)
    if not p.exists():
        return None
    return json.loads(p.read_text(encoding="utf-8"))

def list_sessions():
    out = []
    for p in sorted(SESSIONS_DIR.glob("*.json"), key=lambda x: x.stat().st_mtime, reverse=True):
        try:
            out.append(json.loads(p.read_text(encoding="utf-8")))
        except Exception:
            continue
    return out

# ======================
# STATE
# ======================
def init_state():
    st.session_state.setdefault("session_id", str(uuid.uuid4()))
    st.session_state.setdefault("q_index", 0)
    st.session_state.setdefault("answers", {})
    st.session_state.setdefault("event_log", [])
    st.session_state.setdefault("master_authed", False)
    st.session_state.setdefault("master_selected_session", None)
    st.session_state.setdefault("hybrid_qs", [])          # список сгенерированных вопросов
    st.session_state.setdefault("hybrid_answers", {})     # id -> answer
    st.session_state.setdefault("hybrid_turn", 0)         # сколько уже спросили
    st.session_state.setdefault("hybrid_done", False)

def reset_diagnostic():
    # новый session_id чтобы не залипало на “завершено”
    st.session_state["session_id"] = str(uuid.uuid4())
    st.session_state["q_index"] = 0
    st.session_state["answers"] = {}
    st.session_state["event_log"] = {}
    st.session_state["event_log"] = []

def is_nonempty(q, ans):
    if q["type"] == "multi":
        return isinstance(ans, list) and len(ans) > 0
    return bool(str(ans or "").strip())

def current_meta(answers: dict):
    name = str(answers.get("intake.ask_name","") or "").strip()
    request = str(answers.get("intake.ask_request","") or "").strip()
    contact = str(answers.get("intake.contact","") or "").strip()
    return name, request, contact

def build_payload(answers: dict, event_log: list, session_id: str):
    scores, evidence, col_scores = score_all(answers)
    name, request, contact = current_meta(answers)

    # --- TOP lists ---
    ranked = sorted(scores.items(), key=lambda x: float(x[1]), reverse=True)
    top3 = [{"pot": p, "score": float(s)} for p, s in ranked[:3]]
    top6 = [{"pot": p, "score": float(s)} for p, s in ranked[:6]]

    # --- excerpt (как в мастер-таблице) ---
    important_keys = [
        "intake.ask_request",
        "intake.current_state",
        "intake.goal_3m",
        "now.easy_tasks",
        "now.praise_for",
        "now.best_result_example",
        "now.energy_fill",
        "behavior.group_role_now",
        "behavior.decision_style",
        "antipattern.avoid",
        "antipattern.hate_task",
        "antipattern.energy_leak",
    ]
    answers_excerpt = {k: answers.get(k) for k in important_keys if k in answers}

    # --- risks (минимально, без AI) ---
    risks = []
    hate = str(answers.get("antipattern.hate_task", "") or "").lower()
    if "рутина" in hate or "регламент" in hate or "порядок" in hate:
        risks.append("не выдерживает рутину/регламенты → нужен делегат/система")
    if not str(answers.get("intake.current_state", "") or "").strip():
        risks.append("не сформулировано, что именно забирает энергию → стоит уточнить на созвоне")

    payload = {
        "meta": {
            "schema": "ai-neo.session.v7",
            "app_version": APP_VERSION,
            "timestamp": utcnow_iso(),
            "session_id": session_id,
            "name": name,
            "request": request,
            "contact": contact,
            "question_count": len(question_plan()),
            "answered_count": len(event_log),
        },
        "answers": answers,
        "scores": scores,
        "evidence": evidence,
        "col_scores": col_scores,
        "vectors_no_labels": vectors_without_labels(scores),
        "top3": top3,
        "top6": top6,
        "answers_excerpt": answers_excerpt,
        "risks": risks,
        "event_log": event_log,
    }
    return payload
    
    
def _get_matrix_rows(payload: dict):
    scores = payload.get("scores", {}) or {}
    col_scores = payload.get("col_scores", {}) or {}

    matrix = payload.get("matrix") or payload.get("matrix_3x3") or {}
    rows = (matrix or {}).get("rows") or []

    if not rows:
        if "build_matrix_3x3_unique" in globals():
            matrix = build_matrix_3x3_unique(scores, col_scores)
        elif "build_matrix_3x3" in globals():
            matrix = build_matrix_3x3(scores, col_scores)
        else:
            matrix = {"rows": []}
        rows = (matrix or {}).get("rows") or []
    return rows


def extract_positions_1_6(rows: list) -> dict:
    """
    Позиции:
    1-3 = ряд 1 (perception/motivation/instrument)
    4-6 = ряд 2 (perception/motivation/instrument)
    """
    def pick(row_idx, key):
        if len(rows) > row_idx and isinstance(rows[row_idx], dict):
            return _s(rows[row_idx].get(key)) or "—"
        return "—"

    return {
        "pos1": pick(0, "perception"),
        "pos2": pick(0, "motivation"),
        "pos3": pick(0, "instrument"),
        "pos4": pick(1, "perception"),
        "pos5": pick(1, "motivation"),
        "pos6": pick(1, "instrument"),
    }


def canon_1_3_text(pot: str, col: str) -> str:
    """
    ТВОЯ существующая логика 1-3.
    Оставляем как есть (использует POT_CANON_1_3).
    """
    return canon_cell(pot, col)  # если у тебя уже есть canon_cell


def canon_4_text(pot: str) -> str:
    d = (POT_4_CANON or {}).get(pot) or {}
    problems = d.get("problems") or []
    analysis_focus = _s(d.get("analysis_focus")) or "—"
    hobby = _s(d.get("hobby")) or _s(d.get("hobby_perception")) or "—"

    ptxt = "\n".join([f"- { _s(x) }" for x in problems if _s(x)]) or "- —"
    return (
        f"**Проблема клиента (4 потенциал):**\n{ptxt}\n\n"
        f"**Сфера анализа / что нравится разбирать:** {analysis_focus}\n\n"
        f"**Хобби восприятия (как отдыхает восприятие):** {hobby}"
    ).strip()


def canon_5_text(pot: str) -> str:
    d = (POT_5_CANON or {}).get(pot) or {}
    desires = d.get("desires") or d.get("requests") or []
    mission = _s(d.get("mission")) or _s(d.get("mission_company")) or "—"
    hobby = _s(d.get("hobby")) or _s(d.get("hobby_creative")) or "—"

    dtxt = "\n".join([f"- { _s(x) }" for x in desires if _s(x)]) or "- —"
    return (
        f"**Цель/запрос клиента (5 потенциал):**\n{dtxt}\n\n"
        f"**Миссия / какая цель продукта:** {mission}\n\n"
        f"**Хобби творческое (в одиночестве):** {hobby}"
    ).strip()


def canon_6_text(pot: str) -> str:
    d = (POT_6_CANON or {}).get(pot) or {}
    results = d.get("results") or d.get("outcomes") or []
    hobby = _s(d.get("hobby")) or _s(d.get("hobby_collective")) or "—"

    rtxt = "\n".join([f"- { _s(x) }" for x in results if _s(x)]) or "- —"
    return (
        f"**Результат для клиента (6 потенциал):**\n{rtxt}\n\n"
        f"**Коллективное хобби (с друзьями):** {hobby}"
    ).strip()


def build_canon_pack_1_6(rows: list) -> dict:
    pos = extract_positions_1_6(rows)

    # 1-3 (ряд 1) по колонкам
    p1, p2, p3 = pos["pos1"], pos["pos2"], pos["pos3"]
    # 4-6 (ряд 2) по колонкам
    p4, p5, p6 = pos["pos4"], pos["pos5"], pos["pos6"]

    pack = {
        "positions": pos,
        "canon": {
            "pos1": canon_1_3_text(p1, "perception") if p1 != "—" else "—",
            "pos2": canon_1_3_text(p2, "motivation") if p2 != "—" else "—",
            "pos3": canon_1_3_text(p3, "instrument") if p3 != "—" else "—",
            "pos4": canon_4_text(p4) if p4 != "—" else "—",
            "pos5": canon_5_text(p5) if p5 != "—" else "—",
            "pos6": canon_6_text(p6) if p6 != "—" else "—",
        }
    }
    return pack
    


# ======================
# INSIGHT TABLE (MASTER)
# ======================
def build_insight_table(payload: dict) -> dict:
    """
    Структура для мастера/LLM:
    - top3/top6 потенциалов
    - vectors_no_labels (для клиентского отчёта без камней)
    - col_scores (ВОСПРИЯТИЕ/МОТИВАЦИЯ/ИНСТРУМЕНТ)
    - answers_excerpt (сжатые ответы)
    - risks (риски/сливы)
    """
    meta = payload.get("meta", {})
    answers = payload.get("answers", {})
    scores = payload.get("scores", {}) or {}
    col_scores = payload.get("col_scores", {}) or {}

    # Векторы — у тебя в payload это обычно vectors_no_labels
    vectors = payload.get("vectors_no_labels", []) or payload.get("vectors_no_labels".replace("_no_labels", ""), [])
    if not vectors:
        vectors = payload.get("vectors_no_labels", []) or []

    ranked = sorted(scores.items(), key=lambda x: float(x[1]), reverse=True)
    top3 = [{"pot": p, "score": round(float(s), 2)} for p, s in ranked[:3]]
    top6 = [{"pot": p, "score": round(float(s), 2)} for p, s in ranked[:6]]

    # Сжатые ответы
    keys = [
        "intake.ask_request",
        "intake.current_state",
        "intake.goal_3m",
        "now.easy_tasks",
        "now.praise_for",
        "now.best_result_example",
        "now.energy_fill",
        "behavior.group_role_now",
        "behavior.decision_style",
        "antipattern.avoid",
        "antipattern.hate_task",
        "antipattern.energy_leak",
    ]
    answers_excerpt = {k: answers.get(k) for k in keys if k in answers}

    # Риски/сливы (простая логика)
    risks = []
    hate = str(answers.get("antipattern.hate_task", "") or "").lower()
    if any(x in hate for x in ["рутина", "порядок", "регламент"]):
        risks.append("не выдерживает рутину/регламенты → нужен делегат/система")
    if "продажи" in hate:
        risks.append("сопротивление продажам/самопрезентации → нужны мягкие сценарии проявленности")
    if "конфликт" in hate:
        risks.append("избегание напряжения → важно учиться держать границы")

    return {
        "meta": meta,
        "vectors_no_labels": vectors,
        "top3": top3,
        "top6": top6,
        "scores": scores,
        "col_scores": col_scores,
        "answers_excerpt": answers_excerpt,
        "risks": risks,
    }
# ======================
# KNOWLEDGE SNIPPETS (simple local retrieval)
# ======================
def _read_knowledge_files():
    docs = []
    if not KNOWLEDGE_DIR.exists():
        return docs
    for p in sorted(KNOWLEDGE_DIR.glob("*.md")):
        try:
            txt = p.read_text(encoding="utf-8", errors="ignore")
            if txt.strip():
                docs.append({"path": str(p), "text": txt})
        except Exception:
            continue
    return docs

def _tokenize(s: str):
    s = (s or "").lower()
    s = re.sub(r"[^a-zа-я0-9ё]+", " ", s, flags=re.IGNORECASE)
    parts = [x for x in s.split() if len(x) >= 3]
    return parts

def get_knowledge_snippets(payload: dict, top_k: int = 6):
    """
    Очень простой retrieval без векторной БД:
    - собираем query из запроса+векторов+нескольких ответов
    - считаем пересечения слов и выбираем лучшие куски
    """
    docs = _read_knowledge_files()
    if not docs:
        return []

    meta = payload.get("meta", {})
    answers = payload.get("answers", {})
    vectors = payload.get("vectors", [])

    query_text = " ".join([
        str(meta.get("request","") or ""),
        " ".join(vectors),
        str(answers.get("now.best_result_example","") or ""),
        str(answers.get("antipattern.energy_leak","") or ""),
        str(answers.get("now.praise_for","") or ""),
    ])

    qwords = set(_tokenize(query_text))
    if not qwords:
        return []

    scored = []
    for d in docs:
        text = d["text"]
        # дробим на “абзацы”
        chunks = [c.strip() for c in re.split(r"\n{2,}", text) if c.strip()]
        for c in chunks:
            words = set(_tokenize(c))
            inter = len(qwords.intersection(words))
            if inter <= 0:
                continue
            score = inter / max(20, len(words))
            scored.append({
                "source": d["path"],
                "score": round(score, 4),
                "excerpt": c[:1800]
            })

    scored.sort(key=lambda x: x["score"], reverse=True)
    return scored[:top_k]

def run_self_test_cases():
    """
    9 эталонных кейсов: ответы написаны человеческим языком (без триггерных слов намеренно).
    Ожидаем: top-1 или хотя бы top-2 совпадает с expected.
    """
    cases = []

    # 1) Янтарь — порядок/регламенты/система
    cases.append({
        "expected": "Янтарь",
        "answers": {
            "now.easy_tasks": "Навожу порядок в хаосе: расписания, таблицы, дедлайны, документация.",
            "now.best_result_example": "Собрала процесс: кто что делает, сроки, контроль, теперь всё работает без сбоев.",
            "behavior.decision_style": "Через порядок/правила",
            "now.attention_first": "Риски/систему/порядок",
            "antipattern.hate_task": "Долгие разговоры ни о чём",
        }
    })

    # 2) Шунгит — тело/движение/выносливость
    cases.append({
        "expected": "Шунгит",
        "answers": {
            "now.easy_tasks": "Мне проще сделать, чем обсуждать. Двигаться, тренироваться, действовать.",
            "now.energy_fill": ["Спорт/движение/тело"],
            "behavior.money_spend": ["На здоровье/спорт"],
            "scn.ideal_day": "Целей и движения к ним",
            "antipattern.hate_task": "Учёба/зубрёжка",
        }
    })

    # 3) Цитрин — деньги/результат/выгода
    cases.append({
        "expected": "Цитрин",
        "answers": {
            "intake.ask_request": "Хочу увеличить доход и быстрее выйти на стабильный результат.",
            "now.motivation_trigger": "Деньги/результат/скорость",
            "behavior.decision_style": "Через выгоду/цифры",
            "scn.feedback_pain": "Нет результата/денег",
            "now.best_result_example": "Поднял продажи: пересобрал оффер, конверсия выросла, выручка поднялась.",
        }
    })

    # 4) Изумруд — эстетика/гармония/уют
    cases.append({
        "expected": "Изумруд",
        "answers": {
            "now.energy_fill": ["Красивые места/эстетика/уют"],
            "now.attention_first": "Красоту/атмосферу",
            "scn.project_start": "Делаю красиво/упаковываю",
            "behavior.money_spend": ["На красоту/одежду/дом/уют"],
            "antipattern.hate_task": "Конфликты/напряжение",
        }
    })

    # 5) Рубин — сцена/эмоции/драйв
    cases.append({
        "expected": "Рубин",
        "answers": {
            "now.energy_fill": ["Сцена/ивенты/впечатления"],
            "scn.ideal_day": "Эмоций и впечатлений",
            "scn.conflict_style": "Перевожу в эмоцию/сцену",
            "now.stress_pattern": "Становлюсь эмоциональной(ым)",
            "antipattern.hate_task": "Рутина/порядок/регламенты",
        }
    })

    # 6) Гранат — люди/связь/забота/объединение
    cases.append({
        "expected": "Гранат",
        "answers": {
            "now.attention_first": "Людей/эмоции",
            "now.energy_fill": ["Общение и близкие люди"],
            "behavior.group_role_now": "Объединяю людей",
            "scn.conflict_style": "Сглаживаю и объединяю",
            "now.praise_for": "За поддержку, умение слышать, создавать связь.",
        }
    })

    # 7) Сапфир — смысл/глубина/почему
    cases.append({
        "expected": "Сапфир",
        "answers": {
            "now.attention_first": "Смысл/идею/почему так",
            "now.time_flow": "Когда разбираю, почему всё устроено именно так, и как это влияет на людей.",
            "scn.listen_focus": "Смысл/мысль",
            "scn.feedback_pain": "Нет смысла",
            "antipattern.perfection_trap": "Нет смысла — не включаюсь",
        }
    })

    # 8) Гелиодор — знания/обучение/объяснение
    cases.append({
        "expected": "Гелиодор",
        "answers": {
            "now.time_flow": "Когда учусь и объясняю другим: могу разжевать сложное простыми словами.",
            "behavior.money_spend": ["На обучение/курсы/информацию"],
            "now.praise_for": "За то, что обучаю, системно объясняю и даю ясность.",
            "scn.project_start": "Ищу смысл/концепцию",
            "antipattern.hate_task": "Физическая нагрузка",
        }
    })

    # 9) Аметист — цель/вектор/стратегия/управление
    cases.append({
        "expected": "Аметист",
        "answers": {
            "now.motivation_trigger": "Цель/стратегия/вектор",
            "scn.project_start": "Ставлю цель и план",
            "now.best_result_example": "Собрала стратегию: приоритеты, этапы, метрики — команда пошла быстрее.",
            "behavior.decision_style": "Через порядок/правила",
            "scn.feedback_pain": "Бардак/хаос",
        }
    })

    results = []
    for i, c in enumerate(cases, start=1):
        scores, evidence, col_scores = score_all(c["answers"])
        ranked = sorted(scores.items(), key=lambda x: float(x[1]), reverse=True)[:3]
        results.append({
            "case": i,
            "expected": c["expected"],
            "top1": ranked[0][0] if ranked else "—",
            "top2": ranked[1][0] if len(ranked) > 1 else "—",
            "top3": ranked[2][0] if len(ranked) > 2 else "—",
            "score_top1": float(ranked[0][1]) if ranked else 0.0
        })

    return results


# ======================
# OPENAI REPORT (MASTER)
# ======================
def build_report_system_prompt():
    return """
Ты — эксперт по методике СПЧ/Потенциалы (матрица 3×3).

ЖЁСТКО:
- Пиши по-русски.
- Не вода. Конкретно.
- Клиентский отчёт — понятный, тёплый, но без эзотерики и пафоса.
- Мастерский отчёт — максимально подробный, технический, с гипотезами, конфликтами и вопросами.
- Матрица 3×3 = 3 ряда × 3 столбца:
  Столбцы: Восприятие / Мотивация / Инструмент (достижение целей)
  Ряды: 1 ряд (ядро/природа/реализация), 2 ряд (энергия наполнения/хобби), 3 ряд (риски/сливы/что делегировать)

ФОРМАТ ВЫВОДА — СТРОГО ТАК (две секции):
<<<CLIENT_REPORT>>>
...текст...
<<<MASTER_REPORT>>>
...текст...
""".strip()

def build_client_report_prompt():
    return """
Ты — мастер системы потенциалов человека (СПЧ).
Сделай РАСШИРЕННЫЙ КЛИЕНТСКИЙ ОТЧЁТ, который:
— читается как про конкретного человека,
— вызывает узнавание,
— даёт ощущение «наконец-то меня поняли»,
— логично подводит к мастер-разбору.

РАЗРЕШЕНО (режим ВАУ):
- Использовать canon_texts как основу.
- Делать человеческую интерпретацию (язык жизни, примеры ощущений).
- Связывать потенциалы между собой.
- Говорить о внутренних конфликтах и причинах застревания.
- Писать тепло, глубоко, без эзотерики и диагнозов.

ЗАПРЕЩЕНО:
- Придумывать новые свойства потенциалов, которых нет в каноне.
- Давать инструкции, задания, чек-листы.
- Использовать терапевтические формулировки.
- Обращаться как «ты писал(а)».

СТРУКТУРА (СТРОГО СОБЛЮДАТЬ):

1) ВСТУПЛЕНИЕ  
«{name}, ниже — твой персональный отчёт по системе потенциалов человека  
по запросу: “{request}”.

Этот отчёт помогает понять:
— как ты устроен(а) изнутри,
— через что ты принимаешь решения,
— где твоя настоящая сила,
— и почему иногда, несмотря на потенциал, движение даётся трудно.»

2) МАТРИЦА ПОТЕНЦИАЛОВ 3×3  
Вставь матрицу как есть из {matrix_3x3_md}.

Короткое пояснение:
Матрица — это не оценка и не «уровни развития».
Это карта твоего внутреннего устройства:
1 ряд — как ты реализуешься и создаёшь ценность,  
2 ряд — откуда берётся энергия и контакт с людьми,  
3 ряд — зоны риска и то, что лучше не тянуть на себе.

3) ПЕРВЫЙ РЯД — ОСНОВА ЛИЧНОСТИ И РЕАЛИЗАЦИИ  

Напиши живое описание первого ряда:
— как человек думает,
— как чувствует, что «правильно»,
— как обычно принимает ключевые решения,
— что для него значит реализация.

Затем ПО ОТДЕЛЬНОСТИ:

### 1 потенциал — Восприятие  
Камень: <pos1>  
(Взять canon_texts.pos1 и перевести в язык ощущений и узнавания:  
«ты замечаешь…», «ты первым делом чувствуешь…», «ты не можешь не видеть…»)

### 2 потенциал — Мотивация и внутренняя цель  
Камень: <pos2>  
(Показать, что реально зажигает человека, без пафоса.  
Через что появляется желание двигаться, проявляться, быть видимым.)

### 3 потенциал — Инструмент реализации  
Камень: <pos3>  
(Как именно человек умеет достигать результата,  
через что у него «получается быстрее всего».)

Короткая связка по 1 ряду:
— как эти три потенциала работают вместе,
— что будет, если жить мимо этого ряда,
— и что чувствует человек, когда он «в своём».

4) ВТОРОЙ РЯД — ЭНЕРГИЯ, НАПОЛНЕНИЕ И ВЗАИМОДЕЙСТВИЕ С ЛЮДЬМИ  

Опиши второй ряд человечно:
— где человек по-настоящему выдыхает,
— что его наполняет, даже если он не считает это «работой»,
— как он чувствует людей и окружение.

Затем:

### 4 потенциал — С какими состояниями и проблемами к тебе приходят  
Камень: <pos4>  
(Какие состояния ты легко считываешь у других,  
какие «узлы» тебе естественно разбирать.)

### 5 потенциал — С каким запросом люди идут к тебе  
Камень: <pos5>  
(Что люди на самом деле хотят получить рядом с тобой.)

### 6 потенциал — Какой результат люди уносят  
Камень: <pos6>  
(Что меняется в их состоянии, жизни, ощущении себя.)

Важно:
Поясни, почему этот ряд нельзя превращать в обязанность  
и как он подпитывает первый.

5) ПОЧЕМУ МОЖЕТ НЕ ПОЛУЧАТЬСЯ ТАК, КАК ХОЧЕТСЯ  

Очень важный блок.
Объясни мягко и честно:
— что проблема не в лени и не в «недостатке дисциплины»,
— где возможен внутренний конфликт между рядами,
— как смещение фокуса приводит к усталости, сомнениям или застою.

Без обвинений. С ощущением: «со мной всё ок, просто я не туда смотрел(а)».

6) ИТОГОВАЯ КАРТИНА  

Собери человека в целостный образ:
— кто он по своей природе,
— как ему лучше проявляться,
— почему именно такой путь для него естественен.

Мягкое приглашение:
«На мастер-разборе эта картина уточняется глубже —  
с опорой на реальные жизненные ситуации и твои ответы.»

Заверши маркером:
<<<END_CLIENT_REPORT>>>
""".strip()

def build_master_report_prompt():
    return """
Ты — мастер СПЧ. Сделай МАСТЕРСКИЙ ОТЧЁТ.
Это аналитический документ для специалиста, а не для клиента.

ЗАДАЧА:
— проверить матрицу по текстовым ответам клиента,
— найти подтверждения и возможные смещения,
— сформулировать позиционирование,
— дать гипотезы реализации и рисков.

СТРУКТУРА:

1) Матрица 3×3 (камни по клеткам).

2) Оценка достоверности матрицы  
— высокая / средняя / требует уточнения  
— кратко почему.

3) Проверка по текстовым ответам клиента  
По каждому ряду:
— что в ответах подтверждает,
— что может быть искажением или компенсацией.

4) Анализ доминирующего и подавленного рядов  
— как это проявляется в жизни,
— к чему ведёт при перекосе.

5) Внутренние конфликты и смещения  
— Восприятие vs Инструмент  
— Мотивация vs Реализация  
— 2–3 типичных сценария застревания.

6) Смысловой портрет и позиционирование  
— в чём суть человека,
— какое обещание он может нести,
— для кого он особенно ценен,
— через какие форматы (контент / продукт / проявленность).

7) Гипотезы монетизации и риски  
— 2–3 направления,
— основные риски.

8) Вопросы для мастер-сессии (8–10)  
Очень конкретные, жизненные.

9) Резюме мастеру: как вести клиента  
— на что не давить,
— где поддерживать,
— где аккуратно расширять зону роста.

Заверши:
<<<END_MASTER_REPORT>>>

""".strip()

def _pot_key(p: str) -> str:
    """Нормализует ключ камня под словари канона."""
    return str(p or "").strip()

def _canon_dict_to_md(d: dict) -> str:
    """
    Универсально превращает словарь канона в красивый markdown.
    Поддерживает любые поля: str, list[str], dict.
    """
    if not d:
        return "—"

    lines = []
    for k, v in d.items():
        if v is None or v == "" or v == [] or v == {}:
            continue

        title = str(k).replace("_", " ").strip().capitalize()

        if isinstance(v, str):
            lines.append(f"**{title}:** {v}")

        elif isinstance(v, list):
            items = [str(x).strip() for x in v if str(x).strip()]
            if items:
                lines.append(f"**{title}:**")
                lines.extend([f"- {x}" for x in items])

        elif isinstance(v, dict):
            lines.append(f"**{title}:**")
            for kk, vv in v.items():
                if vv is None or vv == "" or vv == [] or vv == {}:
                    continue
                kk_t = str(kk).replace("_", " ").strip().capitalize()
                if isinstance(vv, list):
                    vv_items = [str(x).strip() for x in vv if str(x).strip()]
                    if vv_items:
                        lines.append(f"- **{kk_t}:**")
                        lines.extend([f"  - {x}" for x in vv_items])
                else:
                    lines.append(f"- **{kk_t}:** {str(vv).strip()}")

    return "\n".join(lines).strip() or "—"


def build_canon_1_6_bundle(rows: list[dict]) -> dict:
    """
    Собирает:
    - positions pos1..pos6
    - canon_texts.pos1..pos6 (готовый markdown только из твоих канонов)
    Логика выбора:
    pos1..pos3 = из 1 ряда матрицы (ядро)
    pos4..pos6 = из 2 ряда матрицы (в твоей логике — 4–6 как “следующий слой”)
    """

    # --- достаем 1 ряд и 2 ряд ---
    row1 = next((r for r in (rows or []) if str(r.get("row")) == "1"), None)
    row2 = next((r for r in (rows or []) if str(r.get("row")) == "2"), None)

    def pick(r, col):
        return _pot_key((r or {}).get(col))

    pos1 = pick(row1, "perception")
    pos2 = pick(row1, "motivation")
    pos3 = pick(row1, "instrument")

    pos4 = pick(row2, "perception")
    pos5 = pick(row2, "motivation")
    pos6 = pick(row2, "instrument")

    # --- канон 1-3: POT_CANON_1_3[pot][col] ---
    def canon_1_3(pot: str, col: str) -> str:
        if not pot:
            return "—"
        d = (globals().get("POT_CANON_1_3") or {}).get(pot)
        if not d:
            return "—"
        cell = d.get(col)
        if isinstance(cell, str):
            return cell.strip() or "—"
        if isinstance(cell, dict):
            # часто у тебя в 1-3 dict с title/lines/intuition — соберем красиво
            return _canon_dict_to_md(cell)
        return "—"

    # --- канон 4-6: POT_4_CANON / POT_5_CANON / POT_6_CANON[pot] ---
    def canon_pos(pot: str, dict_name: str) -> str:
        if not pot:
            return "—"
        canon_dict = globals().get(dict_name) or {}
        d = canon_dict.get(pot)
        if isinstance(d, str):
            return d.strip() or "—"
        if isinstance(d, dict):
            return _canon_dict_to_md(d)
        return "—"

    canon_texts = {
        "pos1": canon_1_3(pos1, "perception"),
        "pos2": canon_1_3(pos2, "motivation"),
        "pos3": canon_1_3(pos3, "instrument"),
        "pos4": canon_pos(pos4, "POT_4_CANON"),
        "pos5": canon_pos(pos5, "POT_5_CANON"),
        "pos6": canon_pos(pos6, "POT_6_CANON"),
    }

    return {
        "positions": {
            "pos1": pos1 or "—",
            "pos2": pos2 or "—",
            "pos3": pos3 or "—",
            "pos4": pos4 or "—",
            "pos5": pos5 or "—",
            "pos6": pos6 or "—",
        },
        "canon_texts": canon_texts,
    }

def call_openai_for_reports(client, model: str, payload: dict):
    table = build_insight_table(payload)
    snips = get_knowledge_snippets(payload)

    # NEW: матрица 3×3
    scores = payload.get("scores", {}) or {}
    col_scores = payload.get("col_scores", {}) or {}
    matrix = build_matrix_3x3_unique(scores, col_scores)
    matrix_md = matrix_markdown_table(matrix)

    sys = build_report_system_prompt()

    canon_bundle = build_canon_1_6_bundle(matrix.get("rows", []))

    user_payload = {
        "request": payload.get("meta", {}).get("request"),
        "matrix_3x3_md": matrix_md,

        # позиции
        "pos1": canon_bundle["positions"]["pos1"],
        "pos2": canon_bundle["positions"]["pos2"],
        "pos3": canon_bundle["positions"]["pos3"],
        "pos4": canon_bundle["positions"]["pos4"],
        "pos5": canon_bundle["positions"]["pos5"],
        "pos6": canon_bundle["positions"]["pos6"],

        # канон-тексты (ГЛАВНОЕ)
        "canon_texts": canon_bundle["canon_texts"],
    }

    prompt = (
        "Сформируй два текста по правилам.\n\n"
        "CLIENT INSTRUCTIONS:\n" + build_client_report_prompt() + "\n\n"
        "MASTER INSTRUCTIONS:\n" + build_master_report_prompt() + "\n\n"
        "INPUT DATA (json):\n" + json.dumps(user_payload, ensure_ascii=False)
    )

    r = client.responses.create(
        model=model,
        input=[
            {"role": "system", "content": sys},
            {"role": "user", "content": prompt},
        ],
    )

    out = getattr(r, "output_text", "") or ""
    if "<<<CLIENT_REPORT>>>" not in out or "<<<MASTER_REPORT>>>" not in out:
        return ("Не удалось собрать клиентский отчёт (формат).", out or "Пустой ответ модели.")

    client_part = out.split("<<<CLIENT_REPORT>>>", 1)[1].split("<<<MASTER_REPORT>>>", 1)[0].strip()
    master_part = out.split("<<<MASTER_REPORT>>>", 1)[1].strip()
    return client_part, master_part

# ======================
# UI: render question
# ======================
def ui_key_for_question(qid: str, session_id: str) -> str:
    # ключ уникален на вопрос + сессию => текст НЕ переносится
    return f"q_{session_id}_{qid}"

def render_question(q, session_id: str):
    st.markdown(f"### {q['text']}")
    st.caption("Коротко и по делу. Можно 1–5 предложений.")

    qid = q["id"]
    qtype = q["type"]
    opts = q.get("options", [])

    key = ui_key_for_question(qid, session_id)

    if qtype == "single":
        return st.radio("Выбери один вариант:", opts, key=key) if opts else st.text_input("Ответ:", key=key)

    if qtype == "multi":
        return st.multiselect("Выбери 1–4:", opts, key=key) if opts else st.text_area("Ответ:", height=140, key=key)

    # text
    return st.text_area("Ответ:", height=150, key=key)
# ======================
# CLIENT FLOW
# ======================
from pathlib import Path
import json

CONFIG_PATH = Path("config.json")

DEFAULT_CONFIG = {
  "hybrid": {
    "enabled": True,
    "start_after_question_index": 38,
    "max_followup_questions": 8,
    "stop_if_confidence_over": 0.78,
    "min_gap_for_tie_break": 0.45,
    "max_same_intent_repeats": 1,
    "followup_intents_priority": [
      "columns_lock",
      "tie_break_top2",
      "anti_social_desirability",
      "shift_probe",
      "sensory_marker_check"
    ],
    "followup_style": {
      "use_options_when_possible": True,
      "options_count": 4,
      "allow_free_text": True
    }
  }
}

def load_config() -> dict:
    """Читает config.json. Если файла нет/битый — возвращает DEFAULT_CONFIG."""
    try:
        if CONFIG_PATH.exists():
            data = json.loads(CONFIG_PATH.read_text(encoding="utf-8"))
            # мягкий merge: если чего-то нет в файле — добьём дефолтами
            out = DEFAULT_CONFIG.copy()
            out.update(data or {})
            if "hybrid" in DEFAULT_CONFIG:
                out["hybrid"] = (DEFAULT_CONFIG["hybrid"] | (out.get("hybrid") or {}))
            return out
    except Exception:
        pass
    return DEFAULT_CONFIG

def render_client_flow():
    # 1) базовый банк
    plan = question_plan()
    base_total = len(plan)

    # 2) конфиг гибрида
    cfg = load_config()
    hy = cfg.get("hybrid", {})
    hy_enabled = bool(hy.get("enabled", False))
    hy_start_after = int(hy.get("start_after_question_index", base_total))

    # 3) защита session_state
    if "q_index" not in st.session_state:
        st.session_state["q_index"] = 0
    if st.session_state["q_index"] < 0:
        st.session_state["q_index"] = 0

    # если банк поменялся, а индекс остался старый — не падаем
    if st.session_state["q_index"] > base_total:
        st.session_state["q_index"] = base_total

    # 4) done-логика
    base_done = st.session_state["q_index"] >= base_total
    hybrid_done = bool(st.session_state.get("hybrid_done", False))
    done = base_done and (not hy_enabled or hybrid_done)

    # 5) шапка прогресса
    colA, colB = st.columns([3, 1])
    with colA:
        if st.session_state["q_index"] >= base_total:
            stage = "final"
            cur_num = base_total
        else:
            stage = plan[st.session_state["q_index"]].get("stage", "—")
            cur_num = st.session_state["q_index"] + 1
        st.caption(f"Ход: вопрос {cur_num} из {base_total} | фаза: {stage}")

    # 6) основной поток
    if not done:
        # ---------- БАЗОВЫЕ ВОПРОСЫ ----------
        if st.session_state["q_index"] < base_total:
            q = plan[st.session_state["q_index"]]
            ans = render_question(q, st.session_state["session_id"])

            c1, c2 = st.columns([1, 1])
            with c1:
                if st.button("Далее ➜", use_container_width=True):
                    if not is_nonempty(q, ans):
                        st.warning("Заполни ответ.")
                    else:
                        st.session_state["answers"][q["id"]] = ans
                        st.session_state["event_log"].append({
                            "timestamp": utcnow_iso(),
                            "question_id": q["id"],
                            "question_text": q["text"],
                            "answer_type": q["type"],
                            "answer": ans
                        })
                        st.session_state["q_index"] += 1

                        # если дошли до конца базы — сохраняем черновик сессии
                        if st.session_state["q_index"] >= base_total:
                            payload = build_payload(
                                st.session_state["answers"],
                                st.session_state["event_log"],
                                st.session_state["session_id"]
                            )
                            merge_and_save_session(payload)

                        st.rerun()

                    save_session(payload)

                    # форсируем конец базы
                    st.session_state["q_index"] = base_total
                    # если гибрид выключен — считаем всё завершенным
                    if not hy_enabled:
                        st.session_state["hybrid_done"] = True
                    st.rerun()

        # ---------- ГИБРИДНЫЙ БЛОК (ПОСЛЕ БАЗЫ) ----------
        else:
            # База уже пройдена, но гибрид ещё не завершен
            if hy_enabled and not hybrid_done:
                st.info("Мы получили предварительные результаты и уточним пару моментов (короткий блок).")

                # тут должен быть твой вызов гибридного вопроса
                # например: q = build_hybrid_question(...)
                # ans = render_hybrid_question(...)
                # и по кнопке увеличивать hybrid_turn и ставить hybrid_done=True

                st.warning("Гибридный блок включён, но обработчик вопросов ещё не подключён в коде.")
                if st.button("Пропустить гибрид и завершить", use_container_width=True):
                    st.session_state["hybrid_done"] = True
                    st.rerun()
            else:
                # гибрид не нужен — всё
                st.session_state["hybrid_done"] = True
                st.rerun()

    # 7) финальный экран
    else:
        payload = build_payload(
            st.session_state["answers"],
            st.session_state["event_log"],
            st.session_state["session_id"]
        )
        try:
            merge_and_save_session(payload)
        except Exception:
            pass

        # === ОБЯЗАТЕЛЬНАЯ ПРОВЕРКА ГОТОВНОСТИ ОТЧЁТА ===
        ok, msg = report_ready(payload)
        if not ok:
            st.warning(msg)
            st.stop()

        st.success("Диагностика завершена")

        # Всегда сохраняем актуальную сессию
        try:
            merge_and_save_session(payload)
        except Exception:
            pass

        # 1) Сначала покажем матрицу (чтобы сразу “вау”)
        scores = payload.get("scores", {}) or {}
        col_scores = payload.get("col_scores", {}) or {}
        m = build_matrix_3x3_unique(scores, col_scores)

        st.markdown("## Твоя матрица потенциалов 3×3 (предварительно)")
        st.markdown(matrix_markdown_table(m))

        # 2) Дальше — большой AI-отчёт (авто-генерация 1 раз и кэш в JSON)
        # Берём сохранённую версию (если уже генерили)
        saved = load_session(payload["meta"]["session_id"])

        ai_client = saved.get("ai_client_report")
        ai_ver = saved.get("ai_client_report_ver")

        # если версия промпта изменилась — пересобираем отчёт
        if ai_ver != CLIENT_MINI_PROMPT_VER:
            ai_client = None
        if not ai_client:
            st.markdown("## Твой расширенный отчёт")
            client = get_openai_client()
            if not client:
                st.warning("AI-отчёт недоступен: не найден OPENAI_API_KEY.")
            else:
                with st.spinner("Готовлю твой отчёт…"):
                    model = safe_model_name(DEFAULT_MODEL)
                    cr, mr = call_openai_for_reports(client, model, payload)

                    # сохраняем в сессию, чтобы не генерить повторно
                    saved["ai_client_report"] = cr
                    # мастерский тоже можно сохранить, но клиенту не показываем
                    saved["ai_master_report"] = mr
                    saved["ai_client_report_ver"] = CLIENT_MINI_PROMPT_VER
                    try:
                        save_session(saved)
                    except Exception:
                        pass

                    st.markdown(cr)
                    # ---- PDF download (после вывода клиентского отчёта) ----
                    try:
                        from pdf_report import build_client_report_pdf_bytes
                    except Exception as e:
                        st.warning(f"PDF временно недоступен: {e}")
                        build_client_report_pdf_bytes = None

                    if build_client_report_pdf_bytes:
                        meta = payload.get("meta", {}) or {}
                        client_name = (meta.get("name") or "Клиент").strip()
                        request = (meta.get("request") or "").strip()

                        pdf_bytes = build_client_report_pdf_bytes(
                            cr,
                            client_name=client_name,
                            request=request,
                            brand_name="Personal Potentials",
                        )

                        st.download_button(
                            label="📄 Скачать отчёт PDF",
                            data=pdf_bytes,
                            file_name=f"SPCH_Report_{client_name.replace(' ', '_')}.pdf",
                            mime="application/pdf",
                            use_container_width=True,
                        )
        else:
            st.markdown("## Твой расширенный отчёт")
            st.markdown(ai_client)

        with st.expander("Показать мои ответы (для проверки)"):
            st.json(payload.get("answers", {}))
# ======================
# MASTER PANEL
# ======================
def render_master_panel():
    st.subheader("🛠️ Мастер-панель")

    # ---- auth
    if not st.session_state.get("master_authed", False):
        pwd = st.text_input("Пароль мастера", type="password", key="master_pwd")
        if st.button("Войти", use_container_width=True):
            if not MASTER_PASSWORD:
                st.error("MASTER_PASSWORD не задан в secrets/env.")
            elif pwd == MASTER_PASSWORD:
                st.session_state["master_authed"] = True
                st.success("Ок ✅")
                st.rerun()
            else:
                st.error("Неверный пароль")
        st.stop()

    # ---- sessions
    sessions = list_sessions()
    if not sessions:
        st.info("Пока нет сохранённых сессий.")
        st.stop()

    labels, ids = [], []
    for s in sessions:
        sid = s.get("meta", {}).get("session_id", "")
        name = s.get("meta", {}).get("name", "—")
        req = s.get("meta", {}).get("request", "—")
        ts = s.get("meta", {}).get("timestamp", "—")
        labels.append(f"{name} | {req} | {ts} | {sid[:8]}")
        ids.append(sid)

    pick = st.selectbox("Сессии:", labels, index=0, key="master_pick")
    chosen_id = ids[labels.index(pick)]

    selected_payload = load_session(chosen_id)
    if not selected_payload:
        st.error("Не удалось загрузить сессию.")
        st.stop()

    # ---- header meta
    meta = selected_payload.get("meta", {})
    st.markdown(
        f"**Имя:** {meta.get('name','—')}\n\n"
        f"**Контакт:** {meta.get('contact','—')}\n\n"
        f"**Запрос:** {meta.get('request','—')}\n\n"
        f"**Вопросов:** {meta.get('question_count','—')} | **Ответов:** {meta.get('answered_count','—')}\n"
    )

    # ---- download json
    st.download_button(
        "⬇️ Скачать JSON (сессия)",
        data=json.dumps(selected_payload, ensure_ascii=False, indent=2).encode("utf-8"),
        file_name=f"session_{chosen_id[:8]}.json",
        mime="application/json",
        use_container_width=True
    )

    # ---- build table + snippets (ONLY INSIDE MASTER)
    with st.expander("📌 Таблица инсайтов (для мастера)"):
        table = build_insight_table(selected_payload)
        st.json(table)
        col_scores = table.get("col_scores", {})
        if col_scores:
            st.markdown("### 🧭 Колонки (Восприятие / Мотивация / Инструмент)")
            for c_key in ["perception","motivation","instrument"]:
                cs = col_scores.get(c_key, {})
                top = sorted(cs.items(), key=lambda x: float(x[1]), reverse=True)[:3]
                st.write(f"**{COL_LABELS[c_key]}**: " + ", ".join([f"{p} ({float(v):.2f})" for p, v in top]))
        else:
            st.info("col_scores пуст — колонки ещё не рассчитаны.")

    with st.expander("📚 Knowledge snippets (что подмешали)"):
        snips = get_knowledge_snippets(selected_payload, top_k=6)
        if not snips:
            st.info("Нет knowledge snippets. Проверь папку knowledge/ и наличие .md файлов.")
        else:
            for s in snips:
                st.markdown(f"**{s['source']}** (score={s['score']})")
                st.code(s["excerpt"][:1200])

    # ---- generate report
    st.markdown("---")
    st.subheader("🧠 AI-отчёт (для мастера)")

    model_in = st.text_input("Модель (оставь как есть)", value=DEFAULT_MODEL, key="master_model")

    if st.button("Сгенерировать AI-отчёт", use_container_width=True):
        client = get_openai_client()
        if not client:
            st.error("Нет OPENAI_API_KEY в secrets/env")
        else:
            try:
                model = safe_model_name(model_in)
                cr, mr = call_openai_for_reports(client, model, selected_payload)

                st.markdown("### Клиентский AI-отчёт")
                st.write(cr)

                st.markdown("### Мастерский AI-отчёт")
                st.write(mr)

                # сохранить в сессию
                selected_payload["ai_client_report"] = cr
                selected_payload["ai_master_report"] = mr
                save_session(selected_payload)

                st.success("Готово ✅ Отчёт сохранён в сессии.")
            except Exception as e:
                st.error(f"Ошибка генерации: {e}")

    # ---- show saved reports
    if selected_payload.get("ai_client_report") or selected_payload.get("ai_master_report"):
        with st.expander("🗂️ Показать сохранённые AI-отчёты"):
            if selected_payload.get("ai_client_report"):
                st.markdown("#### Клиентский")
                st.write(selected_payload["ai_client_report"])
            if selected_payload.get("ai_master_report"):
                st.markdown("#### Мастерский")
                st.write(selected_payload["ai_master_report"])


# ======================
# MAIN
# ======================
init_state()

tab1, tab2 = st.tabs(["Гость", "Мастер"])

with tab1:
    render_client_flow()

with tab2:
    render_master_panel()
