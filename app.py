import os
import re
import json
import uuid
from datetime import datetime, timezone
from pathlib import Path
import streamlit as st

# –í–ê–ñ–ù–û: set_page_config –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–∞–º—ã–º –ø–µ—Ä–≤—ã–º Streamlit-–≤—ã–∑–æ–≤–æ–º
st.set_page_config(
    page_title="NEO –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ (MVP)",
    page_icon="üí†",
    layout="centered",
)

# ======================
# CONFIG / PATHS
# ======================
APP_VERSION = "mvp-7.0-clean"

DATA_DIR = Path("data")
SESSIONS_DIR = DATA_DIR / "sessions"
SESSIONS_DIR.mkdir(parents=True, exist_ok=True)

KNOWLEDGE_DIR = Path("knowledge")  # –æ–∂–∏–¥–∞–µ–º ./knowledge/*.md

# Secrets / env
MASTER_PASSWORD = st.secrets.get("MASTER_PASSWORD", os.getenv("MASTER_PASSWORD", ""))
OPENAI_API_KEY = st.secrets.get("OPENAI_API_KEY", os.getenv("OPENAI_API_KEY", ""))
DEFAULT_MODEL = st.secrets.get("OPENAI_MODEL", os.getenv("OPENAI_MODEL", "gpt-4.1-mini"))

# ======================
# UTILS
# ======================
def utcnow_iso() -> str:
    return datetime.now(timezone.utc).isoformat().replace("+00:00", "Z")

def safe_model_name(model: str) -> str:
    # –µ—Å–ª–∏ –≤–≤–µ–¥—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—É—é –º–æ–¥–µ–ª—å, –º–æ–∂–Ω–æ ‚Äú–ø—Ä–∏–±–∏—Ç—å‚Äù –∫ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π
    m = (model or "").strip()
    if not m:
        return DEFAULT_MODEL
    if m.startswith("gpt-5"):
        return DEFAULT_MODEL
    return m

def get_openai_client():
    if not OPENAI_API_KEY:
        return None
    try:
        from openai import OpenAI
        return OpenAI(api_key=OPENAI_API_KEY)
    except Exception:
        return None

# ======================
# QUESTIONS (25)
# ======================
def question_plan():
    """
    –§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è (human + situational).
    –õ–æ–≥–∏–∫–∞: —Å–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–æ–≥—Ä–µ–≤+–∫–æ–Ω—Ç–µ–∫—Å—Ç -> –Ω–∞—Å—Ç–æ—è—â–µ–µ -> –±—ã—Å—Ç—Ä—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏ (3 —Å–µ–∫) ->
    –¥–µ—Ç—Å—Ç–≤–æ -> –ø–æ–≤–µ–¥–µ–Ω–∏–µ -> –∞–Ω—Ç–∏-–ø–∞—Ç—Ç–µ—Ä–Ω—ã.
    """
    return [
        # =========================
        # 0) INTAKE (–∫–æ–Ω—Ç–µ–∫—Å—Ç)
        # =========================
        {"id": "intake.ask_name", "stage": "intake", "intent": "ask_name", "type": "text",
         "text": "–ö–∞–∫ –º–Ω–µ –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è? (–∏–º—è/–∫–∞–∫ —É–¥–æ–±–Ω–æ)"},
        {"id": "intake.ask_request", "stage": "intake", "intent": "ask_request", "type": "text",
         "text": "–° –∫–∞–∫–∏–º –∑–∞–ø—Ä–æ—Å–æ–º —Ç—ã –ø—Ä–∏—à—ë–ª(–ø—Ä–∏—à–ª–∞)? –ß—Ç–æ —Ö–æ—á–µ—à—å –ø–æ–Ω—è—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å? (1‚Äì2 —Ñ—Ä–∞–∑—ã)"},
        {"id": "intake.contact", "stage": "intake", "intent": "contact", "type": "text",
         "text": "–û—Å—Ç–∞–≤—å —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email (–∫—É–¥–∞ –º–∞—Å—Ç–µ—Ä —Å–º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç). –ú–æ–∂–Ω–æ –æ–¥–Ω–æ –ø–æ–ª–µ."},
        {"id": "intake.current_state", "stage": "intake", "intent": "current_state", "type": "text",
         "text": "–ï—Å–ª–∏ –∫–æ—Ä–æ—Ç–∫–æ: —á—Ç–æ —Å–µ–π—á–∞—Å –≤ –∂–∏–∑–Ω–∏ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ù–ï —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏–ª–∏ –∑–∞–±–∏—Ä–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é?"},
        {"id": "intake.goal_3m", "stage": "intake", "intent": "goal_3m", "type": "text",
         "text": "–ü—Ä–µ–¥—Å—Ç–∞–≤—å: –ø—Ä–æ—à–ª–æ 3 –º–µ—Å—è—Ü–∞ –∏ —Å—Ç–∞–ª–æ –ª—É—á—à–µ. –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –±—ã –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å? (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ)"},
        {"id": "intake.priority_area", "stage": "intake", "intent": "priority_area", "type": "single",
         "column": "motivation",
         "text": "–ß—Ç–æ –≤–∞–∂–Ω–µ–µ –≤—Å–µ–≥–æ –ø—Ä–æ—è—Å–Ω–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è?",
         "options": ["–†–µ–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ–ª–æ", "–î–µ–Ω—å–≥–∏/–¥–æ—Ö–æ–¥", "–û—Ç–Ω–æ—à–µ–Ω–∏—è/–ª—é–¥–∏", "–≠–Ω–µ—Ä–≥–∏—è/—Å–∏–ª—ã", "–°–º—ã—Å–ª/–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"]},
        # =========================
        # 1) NOW (–Ω–∞—Å—Ç–æ—è—â–µ–µ)
        # =========================
        {"id": "now.easy_tasks", "stage": "now", "intent": "easy_tasks", "type": "text",
         "column": "instrument",
         "text": "–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —Ç–µ–±–µ –æ–±—ã—á–Ω–æ –¥–∞—é—Ç—Å—è –ª–µ–≥–∫–æ (–∫–∞–∫ –±—É–¥—Ç–æ —Å–∞–º–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è)?"},
        {"id": "now.praise_for", "stage": "now", "intent": "praise_for", "type": "text",
         "column": "instrument",
         "text": "–ó–∞ —á—Ç–æ —Ç–µ–±—è —á–∞—â–µ –≤—Å–µ–≥–æ —Ö–≤–∞–ª—è—Ç –ª—é–¥–∏? (1‚Äì3 –ø—É–Ω–∫—Ç–∞)"},
         {"id": "now.time_flow", "stage": "now", "intent": "time_flow", "type": "text",
         "column": "motivation",
         "text": "–í –∫–∞–∫–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ç—ã —Ç–µ—Ä—è–µ—à—å —Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏?"},
        {"id": "now.stress_pattern", "stage": "now", "intent": "stress_pattern", "type": "single",
         "text": "–ö–æ–≥–¥–∞ —Å—Ç—Ä–µ—Å—Å/–¥–∞–≤–ª–µ–Ω–∏–µ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–∞—â–µ –≤—Å–µ–≥–æ?",
         "options": ["–£—Å–∫–æ—Ä—è—é—Å—å –∏ —Å—Ç–∞–Ω–æ–≤–ª—é—Å—å —Ä–µ–∑–∫–æ–π(–∏–º)", "–£—Ö–æ–∂—É –≤ —Å–µ–±—è –∏ –º–æ–ª—á—É", "–ù–∞—á–∏–Ω–∞—é –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë", "–°—Ç–∞–Ω–æ–≤–ª—é—Å—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π(—ã–º)", "–ó–∞–º–∏—Ä–∞—é/–ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∏—Ä—É—é"]},
         {"id": "now.energy_fill", "stage": "now", "intent": "energy_fill", "type": "multi",
         "column": "motivation",
         "text": "–ß—Ç–æ —Ç–µ–±—è —Ä–µ–∞–ª—å–Ω–æ –Ω–∞–ø–æ–ª–Ω—è–µ—Ç (–≤—ã–±–µ—Ä–∏ 1‚Äì4)?",
         "options": ["–û–±—â–µ–Ω–∏–µ –∏ –±–ª–∏–∑–∫–∏–µ –ª—é–¥–∏", "–ö—Ä–∞—Å–∏–≤—ã–µ –º–µ—Å—Ç–∞/—ç—Å—Ç–µ—Ç–∏–∫–∞/—É—é—Ç", "–¢–∏—à–∏–Ω–∞/—á—Ç–µ–Ω–∏–µ/–º—ã—Å–ª–∏", "–£—á—ë–±–∞/–æ–±—É—á–µ–Ω–∏–µ/–Ω–æ–≤—ã–µ –∑–Ω–∞–Ω–∏—è", "–°–ø–æ—Ä—Ç/–¥–≤–∏–∂–µ–Ω–∏–µ/—Ç–µ–ª–æ", "–°—Ü–µ–Ω–∞/–∏–≤–µ–Ω—Ç—ã/–≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è"]},
          {"id": "now.best_result_example", "stage": "now", "intent": "best_result_example", "type": "text",
         "column": "instrument",
         "text": "–î–∞–π 1 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏–∑ –∂–∏–∑–Ω–∏: —Å–∏—Ç—É–∞—Ü–∏—è ‚Üí —á—Ç–æ —Ç—ã —Å–¥–µ–ª–∞–ª(–∞) ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Ç–æ, —á—Ç–æ —É —Ç–µ–±—è –ø–æ–ª—É—á–∞–µ—Ç—Å—è –ª—É—á—à–µ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞)."},
        {"id": "now.motivation_trigger", "stage": "now", "intent": "motivation_trigger", "type": "single",
         "column": "motivation",
         "text": "–ß—Ç–æ —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ —Ç–µ–±—è –∑–∞–≤–æ–¥–∏—Ç/–≤–∫–ª—é—á–∞–µ—Ç?",
         "options": ["–¶–µ–ª—å/—Å—Ç—Ä–∞—Ç–µ–≥–∏—è/–≤–µ–∫—Ç–æ—Ä", "–õ—é–¥–∏/—Å–≤—è–∑—å/–≤–ª–∏—è–Ω–∏–µ", "–ö—Ä–∞—Å–æ—Ç–∞/—É—é—Ç/—ç—Å—Ç–µ—Ç–∏–∫–∞", "–°–º—ã—Å–ª/–∏–¥–µ—è/–≥–ª—É–±–∏–Ω–∞", "–î—Ä–∞–π–≤/—Å—Ü–µ–Ω–∞/—ç–º–æ—Ü–∏–∏", "–î–µ–Ω—å–≥–∏/—Ä–µ–∑—É–ª—å—Ç–∞—Ç/—Å–∫–æ—Ä–æ—Å—Ç—å"]},
        # =========================
        # 2) SCENARIOS (–ø–µ—Ä–≤—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã)
        # =========================
        {"id": "now.attention_first", "stage": "now", "intent": "attention_first", "type": "single",
         "column": "perception",
         "text": "–ö–æ–≥–¥–∞ –ø–æ–ø–∞–¥–∞–µ—à—å –≤ –Ω–æ–≤—É—é —Å–∏—Ç—É–∞—Ü–∏—é, —á—Ç–æ —Ç—ã –∑–∞–º–µ—á–∞–µ—à—å –ø–µ—Ä–≤—ã–º?",
         "options": ["–õ—é–¥–µ–π/—ç–º–æ—Ü–∏–∏", "–°–º—ã—Å–ª/–∏–¥–µ—é/–ø–æ—á–µ–º—É —Ç–∞–∫", "–î–µ–Ω—å–≥–∏/–≤—ã–≥–æ–¥—É/—Ä–µ—Å—É—Ä—Å—ã", "–†–∏—Å–∫–∏/—Å–∏—Å—Ç–µ–º—É/–ø–æ—Ä—è–¥–æ–∫", "–ö—Ä–∞—Å–æ—Ç—É/–∞—Ç–º–æ—Å—Ñ–µ—Ä—É"]},
        {"id": "scn.listen_focus", "stage": "scenarios", "intent": "listen_focus", "type": "single",
         "text": "–ö–æ–≥–¥–∞ —Ç—ã —Å–ª—É—à–∞–µ—à—å —á–µ–ª–æ–≤–µ–∫–∞, —á—Ç–æ —Ç—ã –ª–æ–≤–∏—à—å –ø–µ—Ä–≤—ã–º?",
         "options": ["–≠–º–æ—Ü–∏—é/–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", "–°–º—ã—Å–ª/–º—ã—Å–ª—å", "–õ–æ–≥–∏–∫—É/—Å—Ç—Ä—É–∫—Ç—É—Ä—É", "–í—ã–≥–æ–¥—É/—Ä–µ—Å—É—Ä—Å—ã", "–ü–æ–¥–∞—á—É/–≤–∫—É—Å/—ç—Å—Ç–µ—Ç–∏–∫—É"]},
        {"id": "behavior.decision_style", "stage": "behavior", "intent": "decision_style", "type": "single",
         "column": "instrument",
         "text": "–ö–∞–∫ —Ç—ã –ø—Ä–∏–Ω–∏–º–∞–µ—à—å —Ä–µ—à–µ–Ω–∏—è —á–∞—â–µ –≤—Å–µ–≥–æ?",
         "options": ["–ß–µ—Ä–µ–∑ –≤—ã–≥–æ–¥—É/—Ü–∏—Ñ—Ä—ã", "–ß–µ—Ä–µ–∑ —á—É–≤—Å—Ç–≤–æ/–∏–Ω—Ç—É–∏—Ü–∏—é", "–ß–µ—Ä–µ–∑ —Å–º—ã—Å–ª/—Ü–µ–Ω–Ω–æ—Å—Ç–∏", "–ß–µ—Ä–µ–∑ –ª—é–¥–µ–π/–æ—Ç–Ω–æ—à–µ–Ω–∏—è", "–ß–µ—Ä–µ–∑ –ø–æ—Ä—è–¥–æ–∫/–ø—Ä–∞–≤–∏–ª–∞"]},
        {"id": "scn.project_start", "stage": "scenarios", "intent": "project_start", "type": "single",
         "text": "–¢–µ–±–µ –¥–∞–ª–∏ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç. –ß—Ç–æ —Ç—ã –¥–µ–ª–∞–µ—à—å –ø–µ—Ä–≤—ã–º —à–∞–≥–æ–º?",
         "options": ["–°—Ç–∞–≤–ª—é —Ü–µ–ª—å –∏ –ø–ª–∞–Ω", "–°–æ–±–∏—Ä–∞—é –ª—é–¥–µ–π/—Å–≤—è–∑–∏", "–ò—â—É —Å–º—ã—Å–ª/–∫–æ–Ω—Ü–µ–ø—Ü–∏—é",
                     "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É—é/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∏—Ä—É—é", "–î–µ–ª–∞—é –∫—Ä–∞—Å–∏–≤–æ/—É–ø–∞–∫–æ–≤—ã–≤–∞—é", "–î–∞–≤–ª—é –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç"]},
        {"id": "scn.conflict_style", "stage": "scenarios", "intent": "conflict_style", "type": "single",
         "text": "–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç/–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, —Ç—ã —á–∞—â–µ‚Ä¶",
         "options": ["–°–≥–ª–∞–∂–∏–≤–∞—é –∏ –æ–±—ä–µ–¥–∏–Ω—è—é", "–î–∞–≤–ª—é –∏ –ø—Ä–æ–±–∏–≤–∞—é", "–£—Ö–æ–∂—É –≤ –≥–ª—É–±–∏–Ω—É: ¬´–≤ —á—ë–º —Å–º—ã—Å–ª?¬ª",
                     "–°—Ç–∞–≤–ª—é —Ä–∞–º–∫–∏/–ø—Ä–∞–≤–∏–ª–∞", "–ü–µ—Ä–µ–≤–æ–∂—É –≤ —ç–º–æ—Ü–∏—é/—Å—Ü–µ–Ω—É", "–°—Ç–∞—Ä–∞—é—Å—å –±—ã—Å—Ç—Ä–æ –∑–∞–∫—Ä—ã—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ –¥–µ–ª—É"]},
        {"id": "scn.feedback_pain", "stage": "scenarios", "intent": "feedback_pain", "type": "single",
         "text": "–ß—Ç–æ —Ç–µ–±—è —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ –≤—ã–±–∏–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ —á—Ç–æ-—Ç–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è?",
         "options": ["–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞/–¥–µ–Ω–µ–≥", "–ù–µ—Ç —Å–º—ã—Å–ª–∞", "–õ—é–¥–∏ –Ω–µ –æ—Ç–∫–ª–∏–∫–∞—é—Ç—Å—è", "–ë–∞—Ä–¥–∞–∫/—Ö–∞–æ—Å", "–ù–µ –∫—Ä–∞—Å–∏–≤–æ/–Ω–µ —Ç–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç", "–ù–µ—Ç –¥—Ä–∞–π–≤–∞/—Å–∫—É—á–Ω–æ"]},
        {"id": "scn.ideal_day", "stage": "scenarios", "intent": "ideal_day", "type": "single",
         "text": "–ò–¥–µ–∞–ª—å–Ω—ã–π –¥–µ–Ω—å –¥–ª—è —Ç–µ–±—è ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ –≤ –Ω—ë–º –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ‚Ä¶",
         "options": ["–¶–µ–ª–µ–π –∏ –¥–≤–∏–∂–µ–Ω–∏—è –∫ –Ω–∏–º", "–õ—é–¥–µ–π –∏ –æ–±—â–µ–Ω–∏—è", "–ö—Ä–∞—Å–æ—Ç—ã –∏ —É—é—Ç–∞", "–°–º—ã—Å–ª–∞ –∏ –≥–ª—É–±–∏–Ω—ã",
                     "–≠–º–æ—Ü–∏–π –∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–π", "–†–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏ –¥–µ–Ω–µ–≥"]},

        # =========================
        # 3) CHILDHOOD (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏—Ä–æ–¥–Ω–æ–≥–æ)
        # =========================
        {"id": "childhood.child_play", "stage": "childhood", "intent": "child_play", "type": "multi",
         "text": "–í –¥–µ—Ç—Å—Ç–≤–µ (6‚Äì12) —á—Ç–æ —Ç—ã –ª—é–±–∏–ª(–∞) –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ? 1‚Äì3 –≤–∞—Ä–∏–∞–Ω—Ç–∞.",
         "options": ["–ö–æ–º–∞–Ω–¥–æ–≤–∞—Ç—å/–æ—Ä–≥–∞–Ω–∏–∑–æ–≤—ã–≤–∞—Ç—å", "–£—á–∏—Ç—å—Å—è/—á–∏—Ç–∞—Ç—å/–æ–±—ä—è—Å–Ω—è—Ç—å", "–í—ã—Å—Ç—É–ø–∞—Ç—å/–±—ã—Ç—å –∑–∞–º–µ—Ç–Ω—ã–º(–æ–π)",
                     "–î—Ä—É–∂–∏—Ç—å/–æ–±—â–∞—Ç—å—Å—è/–º–∏—Ä–∏—Ç—å", "–†–∏—Å–æ–≤–∞—Ç—å/—É–∫—Ä–∞—à–∞—Ç—å/–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ", "–ë–µ–≥–∞—Ç—å/—Å–æ—Ä–µ–≤–Ω–æ–≤–∞—Ç—å—Å—è/–¥–≤–∏–∂–µ–Ω–∏–µ"]},
        {"id": "childhood.teen_dream", "stage": "childhood", "intent": "teen_dream", "type": "text",
         "text": "–ü–æ–¥—Ä–æ—Å—Ç–∫–æ–º (12‚Äì16) –∫–µ–º —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã—Ç—å –∏–ª–∏ —á–µ–º –∑–∞–Ω–∏–º–∞—Ç—å—Å—è?"},
        {"id": "childhood.first_success", "stage": "childhood", "intent": "first_success", "type": "text",
         "text": "–ö–∞–∫–æ–µ —Ä–∞–Ω–Ω–µ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ/—Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –≤—Å–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º?"},
        {"id": "childhood.family_role", "stage": "childhood", "intent": "family_role", "type": "single",
         "text": "–í —Å–µ–º—å–µ/–∫–ª–∞—Å—Å–µ —Ç—ã —á–∞—â–µ –±—ã–ª(–∞) –∫–µ–º?",
         "options": ["–õ–∏–¥–µ—Ä/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä", "–î—É—à–∞ –∫–æ–º–ø–∞–Ω–∏–∏/–∫–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä", "–£–º–Ω–∏–∫/–∞–Ω–∞–ª–∏—Ç–∏–∫",
                     "–¢–≤–æ—Ä—á–µ—Å–∫–∏–π/—ç—Å—Ç–µ—Ç", "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π/—Å–æ—Ä–µ–≤–Ω–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π", "–¢–∏—Ö–∏–π –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å"]},
        {"id": "childhood.child_aversion", "stage": "childhood", "intent": "child_aversion", "type": "text",
         "text": "–ß—Ç–æ –≤ –¥–µ—Ç—Å—Ç–≤–µ/—à–∫–æ–ª–µ –±—ã–ª–æ –ø—Ä—è–º —Ç—è–∂–µ–ª–æ –∏ —Ç—ã –∏–∑–±–µ–≥–∞–ª(–∞)? (1‚Äì2 –≤–µ—â–∏)"},
        {"id": "childhood.parent_expect", "stage": "childhood", "intent": "parent_expect", "type": "text",
         "text": "–ß—Ç–æ –æ—Ç —Ç–µ–±—è –æ–∂–∏–¥–∞–ª–∏ –≤–∑—Ä–æ—Å–ª—ã–µ (¬´–Ω–∞–¥–æ –±—ã—Ç—å‚Ä¶¬ª)? –ò –∫–∞–∫ —Ç—ã –∫ —ç—Ç–æ–º—É –æ—Ç–Ω–æ—Å–∏–ª—Å—è(–ª–∞—Å—å)?"},
        {"id": "childhood.child_energy", "stage": "childhood", "intent": "child_energy", "type": "text",
         "text": "–ì–¥–µ —Ç—ã —á—É–≤—Å—Ç–≤–æ–≤–∞–ª(–∞) —Å–µ–±—è ¬´–∂–∏–≤—ã–º(–æ–π)¬ª –≤ –¥–µ—Ç—Å—Ç–≤–µ —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ? (—Å–∏—Ç—É–∞—Ü–∏—è)"},
        {"id": "childhood.child_pride", "stage": "childhood", "intent": "child_pride", "type": "text",
         "text": "–ó–∞ —á—Ç–æ —Ç—ã —Å–æ–±–æ–π –≤ –¥–µ—Ç—Å—Ç–≤–µ —Ä–µ–∞–ª—å–Ω–æ –≥–æ—Ä–¥–∏–ª—Å—è(–ª–∞—Å—å)? (1 –ø—Ä–∏–º–µ—Ä)"},

        # =========================
        # 4) BEHAVIOR (–∫–∞–∫ –∂–∏–≤—ë—Ç —Å–µ–π—á–∞—Å)
        # =========================
        {"id": "behavior.free_time", "stage": "behavior", "intent": "free_time", "type": "text",
         "text": "–ï—Å–ª–∏ –µ—Å—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ 2 —á–∞—Å–∞ –±–µ–∑ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤ ‚Äî —á—Ç–æ —Ç—ã —á–∞—â–µ –≤—Å–µ–≥–æ –¥–µ–ª–∞–µ—à—å?"},
        {"id": "behavior.money_spend", "stage": "behavior", "intent": "money_spend", "type": "multi",
         "text": "–ù–∞ —á—Ç–æ —Ç—ã –∏–º–ø—É–ª—å—Å–∏–≤–Ω–æ —Ç—Ä–∞—Ç–∏—à—å –¥–µ–Ω—å–≥–∏/—Å–∏–ª—ã? (1‚Äì3)",
         "options": ["–ù–∞ –æ–±—É—á–µ–Ω–∏–µ/–∫—É—Ä—Å—ã/–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é", "–ù–∞ –ø—Ä–æ–µ–∫—Ç—ã/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã/—Ä–∞–±–æ—Ç—É", "–ù–∞ –∫—Ä–∞—Å–æ—Ç—É/–æ–¥–µ–∂–¥—É/–¥–æ–º/—É—é—Ç",
                     "–ù–∞ –ª—é–¥–µ–π/–ø–æ–¥–∞—Ä–∫–∏/—Å–µ–º—å—é", "–ù–∞ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è/–≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è", "–ù–∞ –∑–¥–æ—Ä–æ–≤—å–µ/—Å–ø–æ—Ä—Ç"]},
        {"id": "behavior.group_role_now", "stage": "behavior", "intent": "group_role_now", "type": "single",
         "column": "instrument",
         "text": "–í –≥—Ä—É–ø–ø–µ/–∫–æ–º–∞–Ω–¥–µ —Ç—ã –æ–±—ã—á–Ω–æ –∫—Ç–æ?",
         "options": ["–û–±—ä–µ–¥–∏–Ω—è—é –ª—é–¥–µ–π", "–ü—Ä–æ–¥–∞–≤–ª–∏–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç", "–ü—Ä–∏–¥—É–º—ã–≤–∞—é —Å–º—ã—Å–ª/–∏–¥–µ—é", "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É—é/–ø–æ—Ä—è–¥–æ–∫", "–î–µ–ª–∞—é –∫—Ä–∞—Å–∏–≤–æ/–∞—Ç–º–æ—Å—Ñ–µ—Ä—É", "–í–¥–æ—Ö–Ω–æ–≤–ª—è—é/–∑–∞–∂–∏–≥–∞—é"]},
        {"id": "behavior.long_focus", "stage": "behavior", "intent": "long_focus", "type": "text",
         "column": "perception",
         "text": "–ù–∞ —á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –¥–æ–ª–≥–æ –∏ –±–µ–∑ –Ω–∞—Å–∏–ª–∏—è –Ω–∞–¥ —Å–æ–±–æ–π?"},
        {"id": "behavior.fast_win", "stage": "behavior", "intent": "fast_win", "type": "text",
         "column": "instrument",
         "text": "–ß—Ç–æ —Ç—ã —É–º–µ–µ—à—å –¥–µ–ª–∞—Ç—å –±—ã—Å—Ç—Ä–æ –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∫–æ–≥–¥–∞ –Ω–∞–¥–æ ‚Äò—Å–æ–±—Ä–∞—Ç—å—Å—è –∏ —Å–¥–µ–ª–∞—Ç—å‚Äô? (1‚Äì3 –ø—Ä–∏–º–µ—Ä–∞)"},
        {"id": "behavior.teach_people", "stage": "behavior", "intent": "teach_people", "type": "text",
         "text": "–ï—Å–ª–∏ –±—ã —Ç—ã —É—á–∏–ª(–∞) –ª—é–¥–µ–π –æ–¥–Ω–æ–º—É –Ω–∞–≤—ã–∫—É, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ç—ã —Å–∏–ª—å–Ω—ã–π(–∞—è) ‚Äî —á—Ç–æ —ç—Ç–æ –±—ã–ª–æ –±—ã?"},

        # =========================
        # 5) ANTIPATTERN (–≥–¥–µ –ª–æ–º–∞–µ—Ç—Å—è —ç–Ω–µ—Ä–≥–∏—è)
        # =========================
        {"id": "antipattern.avoid", "stage": "antipattern", "intent": "avoid", "type": "text",
         "text": "–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —Ç—ã —Å—Ç–∞–±–∏–ª—å–Ω–æ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—à—å (–∏ –ø—Ä—è–º–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è–µ—à—å—Å—è)?"},
        {"id": "antipattern.hate_task", "stage": "antipattern", "intent": "hate_task", "type": "single",
         "text": "–ß—Ç–æ –¥–ª—è —Ç–µ–±—è —Å–∞–º–æ–µ ¬´–Ω–µ–ª—é–±–∏–º–æ–µ¬ª –∏–∑ —Å–ø–∏—Å–∫–∞?",
         "options": ["–†—É—Ç–∏–Ω–∞/–ø–æ—Ä—è–¥–æ–∫/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã", "–î–æ–ª–≥–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –Ω–∏ –æ —á—ë–º", "–ü—Ä–æ–¥–∞–∂–∏/–∑–∞—è–≤–ª—è—Ç—å –æ —Å–µ–±–µ",
                     "–£—á—ë–±–∞/–∑—É–±—Ä—ë–∂–∫–∞", "–§–∏–∑–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞", "–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã/–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ"]},
        {"id": "antipattern.energy_leak", "stage": "antipattern", "intent": "energy_leak", "type": "text",
         "text": "–ì–¥–µ —Ç—ã —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ ¬´—Å–ª–∏–≤–∞–µ—à—å¬ª —ç–Ω–µ—Ä–≥–∏—é —Å–µ–π—á–∞—Å? (–ª—é–¥–∏/–¥–µ–ª–∞/–º—ã—Å–ª–∏/—Ç–µ–ª–æ/—Ö–∞–æ—Å/–∫–æ–Ω—Ç—Ä–æ–ª—å ‚Äî –∫–∞–∫ —É —Ç–µ–±—è)"},
        {"id": "antipattern.perfection_trap", "stage": "antipattern", "intent": "perfection_trap", "type": "single",
         "text": "–ß—Ç–æ —á–∞—â–µ –º–µ—à–∞–µ—Ç —Ç–µ–±–µ –¥–≤–∏–≥–∞—Ç—å—Å—è –±—ã—Å—Ç—Ä–µ–µ?",
         "options": ["–•–æ—á—É –∏–¥–µ–∞–ª—å–Ω–æ ‚Äî –ø–æ—ç—Ç–æ–º—É —Ç—è–Ω—É", "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∏–¥–µ–π ‚Äî —Å–ª–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å", "–ù–µ—Ç –ª—é–¥–µ–π —Ä—è–¥–æ–º ‚Äî —Ç—è–∂–µ–ª–æ –æ–¥–Ω–æ–º—É(–æ–¥–Ω–æ–π)",
                     "–ù–µ—Ç —Å–º—ã—Å–ª–∞ ‚Äî –Ω–µ –≤–∫–ª—é—á–∞—é—Å—å", "–†—É—Ç–∏–Ω–∞ —É–±–∏–≤–∞–µ—Ç ‚Äî –≤—ã–∫–ª—é—á–∞—é—Å—å", "–°—Ç—Ä–∞—Ö –ø—Ä–æ—è–≤–ª—è—Ç—å—Å—è/–±—ã—Ç—å –≤–∏–¥–∏–º—ã–º(–æ–π)"]},
    ]

# ======================
# SCORING (–ª–µ–≥–∫–∏–π)
# ======================
POTS = ["–Ø–Ω—Ç–∞—Ä—å","–®—É–Ω–≥–∏—Ç","–¶–∏—Ç—Ä–∏–Ω","–ò–∑—É–º—Ä—É–¥","–†—É–±–∏–Ω","–ì—Ä–∞–Ω–∞—Ç","–°–∞–ø—Ñ–∏—Ä","–ì–µ–ª–∏–æ–¥–æ—Ä","–ê–º–µ—Ç–∏—Å—Ç"]

KEYWORDS = {
    # 7 ‚Äî –Ø–Ω—Ç–∞—Ä—å (–ø–æ—Ä—è–¥–æ–∫/—Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∞—Ü–∏—è/–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è/–º–µ—Ö–∞–Ω–∏–∑–º—ã/—É—á—ë—Ç)
    "–Ø–Ω—Ç–∞—Ä—å": [
        "–ø–æ—Ä—è–¥–æ–∫","—Å—Ç—Ä—É–∫—Ç—É—Ä","—Ä–µ–≥–ª–∞–º–µ–Ω—Ç","–¥–æ–∫—É–º–µ–Ω—Ç","—É—á–µ—Ç","—É—á—ë—Ç","–±—É—Ö–≥–∞–ª—Ç–µ—Ä",
        "—Å–∏—Å—Ç–µ–º","—Å–∏—Å—Ç–µ–º–∞—Ç","–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü","–ø—Ä–æ—Ü–µ—Å—Å","–ø—Ä–æ—Ü–µ–¥—É—Ä","–∏–Ω—Å—Ç—Ä—É–∫—Ü","—á–µ–∫–ª–∏—Å—Ç", "IT",
        "—Ç–∞–±–ª–∏—Ü","—ç–∫—Å–µ–ª—å","excel","crm","—Å—Ö–µ–º","–∞–ª–≥–æ—Ä–∏—Ç–º","–º–µ—Ö–∞–Ω–∏–∑–º","–ø–æ—á–∏–Ω–∫","—á–∏–Ω–∏—Ç—å",
        "–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å","–Ω–∞—Å—Ç—Ä–æ–π–∫","–æ–ø—Ç–∏–º–∏–∑–∞—Ü","–∞–¥–º–∏–Ω–∏—Å—Ç—Ä","–∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞","–∞—É–¥–∏—Ç",
        "–∫–æ–º—Ñ–æ—Ä—Ç","—É—é—Ç","–ø–ª–∞–Ω–∏—Ä–æ–≤","–ª–æ–≥–∏—Å—Ç–∏–∫",  # —è–Ω—Ç–∞—Ä—å –∫–∞–∫ ‚Äú–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –±—ã—Ç–∞/–º–µ—Ö–∞–Ω–∏–∫–∏‚Äù
        "–º–µ–¥–∏—Ü–∏–Ω–∞","–∑–¥–æ—Ä–æ–≤","–∫—Ä–æ–ø–æ—Ç–ª–∏–≤","–≤–Ω–∏–º–∞–Ω–∏–µ –∫ –¥–µ—Ç–∞–ª","–ø–µ—Ä—Ñ–µ–∫—Ü",  # –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è 3 —Ä—è–¥–∞
    ],

    # 9 ‚Äî –®—É–Ω–≥–∏—Ç (—Ç–µ–ª–æ/–Ω–∞–≥—Ä—É–∑–∫–∏/–≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å/–º–æ–Ω–æ—Ç–æ–Ω–Ω–∞—è —Ñ–∏–∑.—Ä–∞–±–æ—Ç–∞/–ø–æ—Ö–æ–¥—ã)
    "–®—É–Ω–≥–∏—Ç": [
        "—Ç–µ–ª–æ","—Å–ø–æ—Ä—Ç","–¥–≤–∏–∂","—Ç—Ä–µ–Ω","—Ñ–∏–∑","–≤—ã–Ω–æ—Å–ª–∏–≤","—Å–∏–ª–∞","—Å–∏–ª–æ–≤","–º—ã—à—Ü",
        "–Ω–∞–≥—Ä—É–∑–∫","–ø—É–ª—å—Å","–∫–∞—Ä–¥–∏–æ","–±–µ–≥","—Ö–æ–¥—å–±","—à–∞–≥","–ø–æ—Ö–æ–¥","–¥–ª–∏—Ç–µ–ª—å–Ω",
        "–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤","—Ä—É—á–Ω","–º–æ–Ω–æ—Ç–æ–Ω–Ω","—Ä—É—Ç–∏–Ω–Ω —Ñ–∏–∑","—Ç—è–∂–µ–ª","—É—Å—Ç–∞–ª","–≤–æ—Å—Å—Ç–∞–Ω–æ–≤",
        "–∑–¥–æ—Ä–æ–≤—å–µ","—Ä–µ–∂–∏–º","—Å–æ–Ω",
    ],

    # 3 ‚Äî –¶–∏—Ç—Ä–∏–Ω (–¥–µ–π—Å—Ç–≤–∏—è/–ø—Ä–∏–≤—ã—á–∫–∏/–¥–µ–Ω—å–≥–∏/—Ä–µ–∑—É–ª—å—Ç–∞—Ç/–ø—Ä–æ–¥–∞–∂–∏/—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
    "–¶–∏—Ç—Ä–∏–Ω": [
        "–¥–µ–Ω—å–≥","–¥–æ—Ö–æ–¥","–ø—Ä–∏–±—ã–ª","–≤—ã—Ä—É—á–∫","—Ä–µ–∑—É–ª—å—Ç–∞—Ç","—ç—Ñ—Ñ–µ–∫—Ç–∏–≤","–±—ã—Å—Ç—Ä–æ","—Å–∫–æ—Ä–æ—Å—Ç",
        "–≤—ã–≥–æ–¥","—Ü–∏—Ñ—Ä","–º–µ—Ç—Ä–∏–∫","kpi","–ø–ª–∞–Ω –ø—Ä–æ–¥–∞–∂","–≤–æ—Ä–æ–Ω–∫","–ø—Ä–æ–¥–∞–∂","–º–∞—Ä–∂–∏–Ω",
        "—É–ø—Ä–∞–≤–ª–µ–Ω –¥–µ–π—Å—Ç–≤","–ø—Ä–∏–≤—ã—á–∫","–¥–∏—Å—Ü–∏–ø–ª–∏–Ω","–∑–∞–¥–∞—á","–¥–µ–¥–ª–∞–π–Ω","—Å—Ä–æ–∫",
        "–æ—Ä–≥–∞–Ω–∏–∑","–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–∫","–ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–¥–∞–∂","–∫–æ–º–∞–Ω–¥–∞ –ø–æ –º–µ—Å—Ç–∞–º","—Ä–∞—Å–ø—Ä–µ–¥–µ–ª",
        "–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç","—É–ø—Ä–∞–≤–ª–µ–Ω –ø–µ—Ä—Å–æ–Ω–∞–ª","–∫–æ–Ω—Ç—Ä–æ–ª—å –∑–∞–¥–∞—á","–ø–∏–Ω–æ–∫","—É—Å–∫–æ—Ä",
        "–±–∏–∑–Ω–µ—Å","—Ä–æ—Å—Ç","–º–∞—Å—à—Ç–∞–±","–º–æ–Ω–µ—Ç–∏–∑","–∫–æ–º–º–µ—Ä—Ü","—Å–¥–µ–ª–∫", "—Ç–∞–Ω—Ü", "–≥–∏–±–∫", "—Ä–∞—Å—Ç—è–∂", "–ø–µ—Ä–≤", "–ª—É—á—à",
    ],

    # 6 ‚Äî –ì—Ä–∞–Ω–∞—Ç (—ç–º–æ—Ü–∏–∏/–ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å/–ø—Ä–∏–∑–Ω–∞–Ω–∏–µ/—Ç–µ–∞—Ç—Ä/–ø—É–±–ª–∏—á–Ω–æ—Å—Ç—å)
    "–ì—Ä–∞–Ω–∞—Ç": [
        "–ø–æ–ø—É–ª—è—Ä","–ø—Ä–∏–∑–Ω–∞–Ω","–≤–Ω–∏–º–∞–Ω–∏–µ","—Ö–∞—Ä–∏–∑–º","—ç–º–æ—Ü","—á—É–≤—Å—Ç–≤","—Ç–µ–∞—Ç—Ä","–¥—Ä–∞–º",
        "–∞–∫—Ç—ë—Ä","–∏–≥—Ä–∞","—Å—Ü–µ–Ω–∞","—à–æ—É","–ø—Ä–∞–∑–¥–Ω–∏–∫","–≤–µ—á–µ—Ä–∏–Ω","–∏–≤–µ–Ω—Ç","–º–µ—Ä–æ–ø—Ä–∏—è—Ç",
        "–º–∏–º–∏–∫","–∂–µ—Å—Ç","–ø–æ–¥–∞—á","–≤–∫—É—Å–Ω–æ —Ä–∞—Å—Å–∫–∞–∑","—Å—Ç–æ—Ä–∏—Å","—Ä–∏–ª—Å","reels","–≤–∏–¥–µ–æ", "—Ç—É—Å–∞",
        "—Å–æ—Ü—Å–µ—Ç","–∞—É–¥–∏—Ç–æ—Ä","–ª—é–¥–∏ –≤–æ–∫—Ä—É–≥","–≤–ø–µ—á–∞—Ç–ª–∏—Ç—å","—è—Ä–∫–æ","–∫—Ä–∞—Å–∏–≤–æ –ø–æ–∫–∞–∑–∞—Ç—å",
    ],

    # 4 ‚Äî –°–∞–ø—Ñ–∏—Ä (—Å–º—ã—Å–ª/–∏–¥–µ–∏/–¥—É—Ö–æ–≤–Ω–æ—Å—Ç—å/—Ñ–∏–ª–æ—Å–æ—Ñ–∏—è/–ø–æ–∏—Å–∫ –ø—É—Ç–∏)
    "–°–∞–ø—Ñ–∏—Ä": [
        "—Å–º—ã—Å–ª","–∏–¥–µ—è","–ø–æ—á–µ–º—É","–≥–ª—É–±–∏–Ω","—Ñ–∏–ª–æ—Å–æ—Ñ","–¥—É—Ö–æ–≤","—Ü–µ–Ω–Ω–æ—Å—Ç","–ø—É—Ç—å",
        "–ø–æ–∏—Å–∫","–ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á","–≤–µ—Ä–∞","–≤–Ω—É—Ç—Ä","–æ—Ç–≤–µ—Ç—ã","–æ—Å–æ–∑–Ω–∞–Ω","–º–µ–¥–∏—Ç–∞—Ü",
        "—Ç–∏—à–∏–Ω","—Å–æ–∑–µ—Ä—Ü","–∞—Å—Ç—Ä–æ–Ω–æ–º","—Ç–µ–æ—Ä–∏","–∫–æ–Ω—Ü–µ–ø—Ü","–∏–¥–µ–æ–ª–æ–≥",
        "–ø–æ—é—â–∏–µ —á–∞—à–∏","–∑–≤—É–∫ –ø—Ä–∏—Ä–æ–¥—ã","—Ñ–ª–æ–∞—Ç–∏–Ω–≥", "–º—É–∑",
    ],

    # 5 ‚Äî –ì–µ–ª–∏–æ–¥–æ—Ä (–∑–Ω–∞–Ω–∏—è + –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π/–ø–æ–ø—É–ª—è—Ä–∏–∑–∞—Ü–∏—è/—Å–æ–æ–±—â–µ—Å—Ç–≤–æ)
    "–ì–µ–ª–∏–æ–¥–æ—Ä": [
        "—É—á","–æ–±—É—á","–∑–Ω–∞–Ω","–∫—É—Ä—Å","—É—Ä–æ–∫","–æ–±—ä—è—Å–Ω","–Ω–∞—Å—Ç–∞–≤","—Ä–∞–∑–±–æ—Ä","–º–µ—Ç–æ–¥",
        "–ø–µ–¥–∞–≥–æ–≥","–ø—Ä–µ–ø–æ–¥","—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É—é –∑–Ω–∞–Ω–∏–µ","—Ç—Ä–µ–Ω–∏–Ω–≥","—Å–µ–º–∏–Ω–∞—Ä",
        "–ø—Ä–æ–¥–≤–∏–∂","–ø–æ–ø—É–ª—è—Ä–∏–∑","–∏–∑–≤–µ—Å—Ç–Ω","–ø—É–±–ª–∏—á–Ω","–∏–Ω—Ñ–æ—Å–æ–æ–±—â–µ—Å—Ç–≤","—Å–æ–æ–±—â–µ—Å—Ç–≤–æ", "—Å–≤—è–∑–∏", "–Ω–µ—Ç–≤–æ—Ä–∫",
        "–∏–¥–µ—è","–∏–¥–µ–æ–ª–æ–≥","—ç–∫—Å–ø–µ—Ä—Ç","–∫–æ–Ω—Ç–µ–Ω—Ç","–ª–µ–∫—Ü", "–≥–æ—Ç–æ–≤–∏—Ç—å", "–≤–∫—É—Å", "–∫—É—à–∞—Ç—å", "–†–µ—Ü–µ–ø—Ç", "–µ–¥–∞", "—Ä–µ—Å—Ç–æ—Ä–∞–Ω", "–∑–Ω–∞–∫–æ–º—Å—Ç–≤",
        "–≤–æ–∫–∞–ª","–ø–µ—Ç—å","–∫–∞—Ä–∞–æ–∫–µ",  # –∏–∑ —Ç–≤–æ–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äú—á—Ç–æ –Ω—Ä–∞–≤–∏—Ç—Å—è‚Äù
    ],

    # 2 ‚Äî –ò–∑—É–º—Ä—É–¥ (–≥–∞—Ä–º–æ–Ω–∏—è/–∫—Ä–∞—Å–æ—Ç–∞/—ç—Å—Ç–µ—Ç–∏–∫–∞/—É—é—Ç/—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ª—ë–≥–∫–æ—Å—Ç—å)
    "–ò–∑—É–º—Ä—É–¥": [
        "–∫—Ä–∞—Å–æ—Ç","—ç—Å—Ç–µ—Ç","—É—é—Ç","–¥–∏–∑–∞–π–Ω","–∞—Ç–º–æ—Å—Ñ–µ—Ä","—Å—Ç–∏–ª—å","–≥–∞—Ä–º–æ–Ω–∏",
        "–≤–Ω–µ—à–Ω–æ—Å—Ç","—Ñ–æ—Ç–æ","–æ–±—Ä–∞–∑","–Ω–∞—Ä—è–¥","–º–∞–∫–∏—è–∂","–Ω–∞–∫—Ä–∞—Å","—É–∫—Ä–∞—à",
        "–¥–æ–º","–∏–Ω—Ç–µ—Ä—å–µ—Ä","–∫–∞—Ä—Ç–∏–Ω–∫","–∫—Ä–∞—Å–∏–≤–æ","–ø—Ä–∏—è—Ç–Ω–æ", "—á—É–≤—Å—Ç–≤",
        "—ç–º–æ—Ü–∏–æ–Ω–∞–ª –≥–∞—Ä–º–æ–Ω–∏","–ª–µ–≥–∫–æ—Å—Ç","–∏–Ω—Ç–µ—Ä–µ—Å –∫ –∂–∏–∑–Ω–∏","–∫—Ä–∞—Å–∫–∏ –∂–∏–∑–Ω–∏","eq",
        "–ø—Å–∏—Ö–æ–ª–æ–≥","–¥—É—à–µ–≤–Ω","—Ç—ë–ø–ª–æ–µ –æ–±—â–µ–Ω–∏–µ",
    ],

    # 8 ‚Äî –†—É–±–∏–Ω (–∞–¥—Ä–µ–Ω–∞–ª–∏–Ω/—Ä–∏—Å–∫/—Å—ä—ë–º–∫–∏/—Ä–µ–∂–∏—Å—Å—É—Ä–∞/–≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è/—ç–º–æ-–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)
    "–†—É–±–∏–Ω": [
        "–¥—Ä–∞–π–≤","–∞–¥—Ä–µ–Ω–∞–ª","—Ä–∏—Å–∫","–ø—Ä–∏–∫–ª—é—á","–≤–ø–µ—á–∞—Ç","—ç–º–æ—Ü","—ç–∫—Å—Ç—Ä–∏–º",
        "—Å—Ü–µ–Ω–∞","–≤—ã—Å—Ç—É–ø","—à–æ—É","–∏–≤–µ–Ω—Ç","–º–µ—Ä–æ–ø—Ä–∏—è—Ç", "—Å–µ–∫—Å",
        "—Ä–µ–∂–∏—Å—Å","—Å—ä—ë–º–∫","—Å–Ω–∏–º–∞—Ç—å","–≤–∏–¥–µ–æ—Ä–æ–ª–∏–∫","–∫–æ–Ω—Ç–µ–Ω—Ç","–∫–ª–∏–ø","–∫–∞–º–µ—Ä–∞",
        "–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π","—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω –º–µ—Ä–æ–ø—Ä–∏—è—Ç",
    ],

    # 1 ‚Äî –ê–º–µ—Ç–∏—Å—Ç (–º—ã—à–ª–µ–Ω–∏–µ/–∞–Ω–∞–ª–∏–∑/–∏–Ω—Ç—É–∏—Ü–∏—è/—Ü–µ–ª—å/–≤—Ä–µ–º—è/—É–ø–∞–∫–æ–≤–∫–∞ –∏–¥–µ–∏)
    "–ê–º–µ—Ç–∏—Å—Ç": [
        "—Ü–µ–ª—å","—Å—Ç—Ä–∞—Ç–µ–≥","–≤–µ–∫—Ç–æ—Ä","–ø–ª–∞–Ω","—É–ø—Ä–∞–≤–ª–µ–Ω","–ª–∏–¥–µ—Ä","–ø—Ä–æ–µ–∫—Ç",
        "–∞–Ω–∞–ª–∏–∑","–ª–æ–≥–∏–∫","–º—ã—à–ª–µ–Ω","–≤–∞—Ä–∏–∞–Ω—Ç","—Ä–µ—à–µ–Ω–∏","—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç",
        "–ø—Ä–µ–¥–≤–∏–¥","–∏–Ω—Ç—É–∏—Ü","—è—Å–Ω–æ–∑–Ω–∞–Ω","–ø–µ—Ä–≤–∞—è –º—ã—Å–ª—å","—Å—Ä–∞–∑—É –ø–æ–Ω—è–ª", "—É–ø—Ä–∞–≤–ª", 
        "—É–ø–∞–∫–æ–≤","–ø—Ä–µ–ø–æ–¥–Ω–µ—Å—Ç–∏","—Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å","—Å–æ–±—Ä–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É", "–Ω—É–º–µ—Ä–æ–ª–æ–≥", "—ç–∑–æ—Ç–µ—Ä–∏–∫", "–º–∏—Å—Ç–∏–∫",
        "–ø–æ–¥—Å–æ–∑–Ω","—É–±–µ–∂–¥–µ–Ω","–ø–µ—Ä–µ–ø—Ä–æ—à","–ø–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –º—ã—à–ª–µ–Ω–∏–µ", "–ª–æ–≥–∏–∫", "—Ç–∞–π–Ω", "–∞—Å—Ç—Ä–æ–ª–æ–≥",
        "–≤—Ä–µ–º—è","—Ç–∞–π–º–∏–Ω–≥","—Ç–æ—á–Ω–æ—Å—Ç—å", "–∑–Ω–∞—Ç—å", "–∑–Ω–∞—é", "—á—É–≤—Å—Ç–≤", "–º—ã—Å–ª", "–º–∏—Å—Å–∏—è", "–ò–Ω—Ç—É–∏—Ü", "—Å–æ–∑–Ω",
    ],
}

COLUMNS = ["perception", "motivation", "instrument"]

COL_LABELS = {
    "perception": "–í–û–°–ü–†–ò–Ø–¢–ò–ï",
    "motivation": "–ú–û–¢–ò–í–ê–¶–ò–Ø",
    "instrument": "–ò–ù–°–¢–†–£–ú–ï–ù–¢",
}

def _hits(text: str, pot: str) -> int:
    t = (text or "").lower()
    return sum(1 for kw in KEYWORDS.get(pot, []) if kw in t)

def text_hits(text: str, pot: str) -> int:
    t = (text or "").lower()
    kws = KEYWORDS.get(pot, [])
    return sum(1 for kw in kws if kw in t)

def score_all(answers: dict):
    scores = {p: 0.0 for p in POTS}
    evidence = {p: [] for p in POTS}

    col_scores = {c: {p: 0.0 for p in POTS} for c in COLUMNS}  # NEW

    plan = question_plan()
    q_by_id = {q["id"]: q for q in plan}

    def add(p, v, note, qid=None):
        v = float(v)
        scores[p] += v
        evidence[p].append(note)

        # NEW: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º
        if qid and qid in q_by_id:
            col = q_by_id[qid].get("column")
            if col in col_scores:
                col_scores[col][p] += v

    # 1) keyword scoring
    for qid, ans in answers.items():
        if isinstance(ans, list):
            joined = " ".join([str(x) for x in ans])
            for p in POTS:
                h = text_hits(joined, p)
                if h:
                    add(p, 0.25 * h, f"{qid}: kw({p})", qid=qid)
        else:
            txt = str(ans or "")
            for p in POTS:
                h = text_hits(txt, p)
                if h:
                    add(p, 0.35 * h, f"{qid}: kw({p})", qid=qid)

    # 2) option-based bumps
    def bump_if(qid, option_to_pot, amount=0.9):
        a = answers.get(qid)
        if not a:
            return
        if isinstance(a, list):
            for x in a:
                p = option_to_pot.get(x)
                if p:
                    add(p, amount / max(1, len(a)), f"{qid}: option‚Üí{p}", qid=qid)
        else:
            p = option_to_pot.get(a)
            if p:
                add(p, amount, f"{qid}: option‚Üí{p}", qid=qid)

    bump_if("intake.priority_area", {
        "–†–µ–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ–ª–æ":"–ê–º–µ—Ç–∏—Å—Ç",
        "–î–µ–Ω—å–≥–∏/–¥–æ—Ö–æ–¥":"–¶–∏—Ç—Ä–∏–Ω",
        "–û—Ç–Ω–æ—à–µ–Ω–∏—è/–ª—é–¥–∏":"–ì—Ä–∞–Ω–∞—Ç",
        "–≠–Ω–µ—Ä–≥–∏—è/—Å–∏–ª—ã":"–®—É–Ω–≥–∏—Ç",
        "–°–º—ã—Å–ª/–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ":"–°–∞–ø—Ñ–∏—Ä",
    }, amount=0.8)

    bump_if("now.attention_first", {
        "–õ—é–¥–µ–π/—ç–º–æ—Ü–∏–∏":"–ì—Ä–∞–Ω–∞—Ç",
        "–°–º—ã—Å–ª/–∏–¥–µ—é/–ø–æ—á–µ–º—É —Ç–∞–∫":"–°–∞–ø—Ñ–∏—Ä",
        "–î–µ–Ω—å–≥–∏/–≤—ã–≥–æ–¥—É/—Ä–µ—Å—É—Ä—Å—ã":"–¶–∏—Ç—Ä–∏–Ω",
        "–†–∏—Å–∫–∏/—Å–∏—Å—Ç–µ–º—É/–ø–æ—Ä—è–¥–æ–∫":"–Ø–Ω—Ç–∞—Ä—å",
        "–ö—Ä–∞—Å–æ—Ç—É/–∞—Ç–º–æ—Å—Ñ–µ—Ä—É":"–ò–∑—É–º—Ä—É–¥",
    }, amount=1.0)

    bump_if("now.motivation_trigger", {
        "–¶–µ–ª—å/—Å—Ç—Ä–∞—Ç–µ–≥–∏—è/–≤–µ–∫—Ç–æ—Ä":"–ê–º–µ—Ç–∏—Å—Ç",
        "–õ—é–¥–∏/—Å–≤—è–∑—å/–≤–ª–∏—è–Ω–∏–µ":"–ì—Ä–∞–Ω–∞—Ç",
        "–ö—Ä–∞—Å–æ—Ç–∞/—É—é—Ç/—ç—Å—Ç–µ—Ç–∏–∫–∞":"–ò–∑—É–º—Ä—É–¥",
        "–°–º—ã—Å–ª/–∏–¥–µ—è/–≥–ª—É–±–∏–Ω–∞":"–°–∞–ø—Ñ–∏—Ä",
        "–î—Ä–∞–π–≤/—Å—Ü–µ–Ω–∞/—ç–º–æ—Ü–∏–∏":"–†—É–±–∏–Ω",
        "–î–µ–Ω—å–≥–∏/—Ä–µ–∑—É–ª—å—Ç–∞—Ç/—Å–∫–æ—Ä–æ—Å—Ç—å":"–¶–∏—Ç—Ä–∏–Ω",
    }, amount=1.0)

    bump_if("now.energy_fill", {
        "–û–±—â–µ–Ω–∏–µ –∏ –±–ª–∏–∑–∫–∏–µ –ª—é–¥–∏":"–ì—Ä–∞–Ω–∞—Ç",
        "–ö—Ä–∞—Å–∏–≤—ã–µ –º–µ—Å—Ç–∞/—ç—Å—Ç–µ—Ç–∏–∫–∞/—É—é—Ç":"–ò–∑—É–º—Ä—É–¥",
        "–¢–∏—à–∏–Ω–∞/—á—Ç–µ–Ω–∏–µ/–º—ã—Å–ª–∏":"–°–∞–ø—Ñ–∏—Ä",
        "–£—á—ë–±–∞/–æ–±—É—á–µ–Ω–∏–µ/–Ω–æ–≤—ã–µ –∑–Ω–∞–Ω–∏—è":"–ì–µ–ª–∏–æ–¥–æ—Ä",
        "–°–ø–æ—Ä—Ç/–¥–≤–∏–∂–µ–Ω–∏–µ/—Ç–µ–ª–æ":"–®—É–Ω–≥–∏—Ç",
        "–°—Ü–µ–Ω–∞/–∏–≤–µ–Ω—Ç—ã/–≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è":"–†—É–±–∏–Ω",
    }, amount=0.9)

    bump_if("childhood.child_play", {
        "–°—Ç—Ä–æ–∏—Ç—å/–æ—Ä–≥–∞–Ω–∏–∑–æ–≤—ã–≤–∞—Ç—å/—Ä—É–∫–æ–≤–æ–¥–∏—Ç—å":"–ê–º–µ—Ç–∏—Å—Ç",
        "–£—á–∏—Ç—å—Å—è/—á–∏—Ç–∞—Ç—å/–æ–±—ä—è—Å–Ω—è—Ç—å/":"–ì–µ–ª–∏–æ–¥–æ—Ä",
        "–í—ã—Å—Ç—É–ø–∞—Ç—å/–±—ã—Ç—å –∑–∞–º–µ—Ç–Ω—ã–º(–æ–π)":"–†—É–±–∏–Ω",
        "–î—Ä—É–∂–∏—Ç—å/–æ–±—â–∞—Ç—å—Å—è/–º–∏—Ä–∏—Ç—å":"–ì—Ä–∞–Ω–∞—Ç",
        "–†–∏—Å–æ–≤–∞—Ç—å/—É–∫—Ä–∞—à–∞—Ç—å/–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ":"–ò–∑—É–º—Ä—É–¥",
        "–ë–µ–≥–∞—Ç—å/—Å–æ—Ä–µ–≤–Ω–æ–≤–∞—Ç—å—Å—è/–¥–≤–∏–∂":"–®—É–Ω–≥–∏—Ç",
    }, amount=0.8)

    bump_if("childhood.child_play", {
        "–ö–æ–º–∞–Ω–¥–æ–≤–∞—Ç—å/–æ—Ä–≥–∞–Ω–∏–∑–æ–≤—ã–≤–∞—Ç—å":"–ê–º–µ—Ç–∏—Å—Ç",
        "–£—á–∏—Ç—å—Å—è/—á–∏—Ç–∞—Ç—å/–æ–±—ä—è—Å–Ω—è—Ç—å":"–ì–µ–ª–∏–æ–¥–æ—Ä",
        "–í—ã—Å—Ç—É–ø–∞—Ç—å/–±—ã—Ç—å –∑–∞–º–µ—Ç–Ω—ã–º(–æ–π)":"–†—É–±–∏–Ω",
        "–î—Ä—É–∂–∏—Ç—å/–æ–±—â–∞—Ç—å—Å—è/–º–∏—Ä–∏—Ç—å":"–ì—Ä–∞–Ω–∞—Ç",
        "–†–∏—Å–æ–≤–∞—Ç—å/—É–∫—Ä–∞—à–∞—Ç—å/–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ":"–ò–∑—É–º—Ä—É–¥",
        "–ë–µ–≥–∞—Ç—å/—Å–æ—Ä–µ–≤–Ω–æ–≤–∞—Ç—å—Å—è/–¥–≤–∏–∂–µ–Ω–∏–µ":"–®—É–Ω–≥–∏—Ç",
    }, amount=0.8)

    bump_if("behavior.group_role_now", {
        "–û–±—ä–µ–¥–∏–Ω—è—é –ª—é–¥–µ–π":"–ì—Ä–∞–Ω–∞—Ç",
        "–ü—Ä–æ–¥–∞–≤–ª–∏–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç":"–¶–∏—Ç—Ä–∏–Ω",
        "–ü—Ä–∏–¥—É–º—ã–≤–∞—é —Å–º—ã—Å–ª/–∏–¥–µ—é":"–°–∞–ø—Ñ–∏—Ä",
        "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É—é/–ø–æ—Ä—è–¥–æ–∫":"–Ø–Ω—Ç–∞—Ä—å",
        "–î–µ–ª–∞—é –∫—Ä–∞—Å–∏–≤–æ/–∞—Ç–º–æ—Å—Ñ–µ—Ä—É":"–ò–∑—É–º—Ä—É–¥",
        "–í–¥–æ—Ö–Ω–æ–≤–ª—è—é/–∑–∞–∂–∏–≥–∞—é":"–†—É–±–∏–Ω",
    }, amount=0.8)

    bump_if("behavior.decision_style", {
        "–ß–µ—Ä–µ–∑ –≤—ã–≥–æ–¥—É/—Ü–∏—Ñ—Ä—ã":"–¶–∏—Ç—Ä–∏–Ω",
        "–ß–µ—Ä–µ–∑ —á—É–≤—Å—Ç–≤–æ/–∏–Ω—Ç—É–∏—Ü–∏—é":"–ì—Ä–∞–Ω–∞—Ç",
        "–ß–µ—Ä–µ–∑ —Å–º—ã—Å–ª/—Ü–µ–Ω–Ω–æ—Å—Ç–∏":"–°–∞–ø—Ñ–∏—Ä",
        "–ß–µ—Ä–µ–∑ –ª—é–¥–µ–π/–æ—Ç–Ω–æ—à–µ–Ω–∏—è":"–ì—Ä–∞–Ω–∞—Ç",
        "–ß–µ—Ä–µ–∑ –ø–æ—Ä—è–¥–æ–∫/–ø—Ä–∞–≤–∏–ª–∞":"–Ø–Ω—Ç–∞—Ä—å",
    }, amount=0.8)

    bump_if("behavior.money_spend", {
        "–ù–∞ –æ–±—É—á–µ–Ω–∏–µ/–∫—É—Ä—Å—ã/–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é":"–ì–µ–ª–∏–æ–¥–æ—Ä",
        "–ù–∞ –ø—Ä–æ–µ–∫—Ç—ã/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã/—Ä–∞–±–æ—Ç—É":"–ê–º–µ—Ç–∏—Å—Ç",
        "–ù–∞ –∫—Ä–∞—Å–æ—Ç—É/–æ–¥–µ–∂–¥—É/–¥–æ–º/—É—é—Ç":"–ò–∑—É–º—Ä—É–¥",
        "–ù–∞ –ª—é–¥–µ–π/–ø–æ–¥–∞—Ä–∫–∏/—Å–µ–º—å—é":"–ì—Ä–∞–Ω–∞—Ç",
        "–ù–∞ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è/–≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è":"–†—É–±–∏–Ω",
        "–ù–∞ –∑–¥–æ—Ä–æ–≤—å–µ/—Å–ø–æ—Ä—Ç":"–®—É–Ω–≥–∏—Ç",
    }, amount=0.7)

    # 3) Anti-amber guard
    hate = str(answers.get("antipattern.hate_task","") or "").lower()
    if "—Ä—É—Ç–∏–Ω–∞/–ø–æ—Ä—è–¥–æ–∫/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã" in hate:
        scores["–Ø–Ω—Ç–∞—Ä—å"] -= 0.6
        evidence["–Ø–Ω—Ç–∞—Ä—å"].append("antipattern: dislikes routines ‚Üí —Å–Ω–∏–∑–∏–ª–∏ –Ø–Ω—Ç–∞—Ä—å")
        # –∫–æ–ª–æ–Ω–∫–∞–º —ç—Ç–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ

    # 4) clamp
    for p in POTS:
        if scores[p] < 0:
            scores[p] = 0.0

    return scores, evidence, col_scores

def vectors_without_labels(scores: dict):
    v = []
    if scores.get("–¶–∏—Ç—Ä–∏–Ω",0) >= 1.2:
        v.append("—Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –¥–µ–Ω—å–≥–∏ (—Å–∫–æ—Ä–æ—Å—Ç—å, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –≤—ã–≥–æ–¥–∞)")
    if scores.get("–ê–º–µ—Ç–∏—Å—Ç",0) >= 1.2:
        v.append("—Å—Ç—Ä–∞—Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (—Ü–µ–ª–∏, –ø–ª–∞–Ω, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)")
    if scores.get("–ì–µ–ª–∏–æ–¥–æ—Ä",0) >= 1.1:
        v.append("–∑–Ω–∞–Ω–∏—è –∏ –æ–±—É—á–µ–Ω–∏–µ (—Ä–∞–∑–±–æ—Ä, –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ, —Ä–∞–∑–≤–∏—Ç–∏–µ)")
    if scores.get("–°–∞–ø—Ñ–∏—Ä",0) >= 1.1:
        v.append("—Å–º—ã—Å–ª –∏ –≥–ª—É–±–∏–Ω–∞ (–∏–¥–µ–∏, —Ü–µ–Ω–Ω–æ—Å—Ç–∏, ‚Äò–ø–æ—á–µ–º—É‚Äô)") 
    if scores.get("–ì—Ä–∞–Ω–∞—Ç",0) >= 1.1:
        v.append("–ª—é–¥–∏ –∏ —Å–≤—è–∑—å (–ø–æ–¥–¥–µ—Ä–∂–∫–∞, –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ, –≤–ª–∏—è–Ω–∏–µ)")
    if scores.get("–ò–∑—É–º—Ä—É–¥",0) >= 1.1:
        v.append("—ç—Å—Ç–µ—Ç–∏–∫–∞ –∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ (–∫—Ä–∞—Å–æ—Ç–∞, —É—é—Ç, —Å—Ç–∏–ª—å)")
    if scores.get("–†—É–±–∏–Ω",0) >= 1.1:
        v.append("—Å—Ü–µ–Ω–∞ –∏ —ç–º–æ—Ü–∏–∏ (–ø—Ä–æ—è–≤–ª–µ–Ω–Ω–æ—Å—Ç—å, –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è)")
    if scores.get("–®—É–Ω–≥–∏—Ç",0) >= 1.1:
        v.append("—Ç–µ–ª–æ –∏ —ç–Ω–µ—Ä–≥–∏—è (–¥–≤–∏–∂–µ–Ω–∏–µ, –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å)")
    if scores.get("–Ø–Ω—Ç–∞—Ä—å",0) >= 1.4:
        v.append("—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —Å–∏—Å—Ç–µ–º–∞ (–ø–æ—Ä—è–¥–æ–∫, –ø—Ä–æ—Ü–µ—Å—Å—ã, —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã)")
    return v[:6]

# ======================
# SESSIONS STORAGE
# ======================
def session_path(session_id: str) -> Path:
    return SESSIONS_DIR / f"{session_id}.json"

def save_session(payload: dict):
    sid = payload["meta"]["session_id"]
    session_path(sid).write_text(json.dumps(payload, ensure_ascii=False, indent=2), encoding="utf-8")

def load_session(sid: str):
    p = session_path(sid)
    if not p.exists():
        return None
    return json.loads(p.read_text(encoding="utf-8"))

def list_sessions():
    out = []
    for p in sorted(SESSIONS_DIR.glob("*.json"), key=lambda x: x.stat().st_mtime, reverse=True):
        try:
            out.append(json.loads(p.read_text(encoding="utf-8")))
        except Exception:
            continue
    return out

# ======================
# STATE
# ======================
def init_state():
    st.session_state.setdefault("session_id", str(uuid.uuid4()))
    st.session_state.setdefault("q_index", 0)
    st.session_state.setdefault("answers", {})
    st.session_state.setdefault("event_log", [])
    st.session_state.setdefault("master_authed", False)
    st.session_state.setdefault("master_selected_session", None)
    st.session_state.setdefault("hybrid_qs", [])          # —Å–ø–∏—Å–æ–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
    st.session_state.setdefault("hybrid_answers", {})     # id -> answer
    st.session_state.setdefault("hybrid_turn", 0)         # —Å–∫–æ–ª—å–∫–æ —É–∂–µ —Å–ø—Ä–æ—Å–∏–ª–∏
    st.session_state.setdefault("hybrid_done", False)

def reset_diagnostic():
    # –Ω–æ–≤—ã–π session_id —á—Ç–æ–±—ã –Ω–µ –∑–∞–ª–∏–ø–∞–ª–æ –Ω–∞ ‚Äú–∑–∞–≤–µ—Ä—à–µ–Ω–æ‚Äù
    st.session_state["session_id"] = str(uuid.uuid4())
    st.session_state["q_index"] = 0
    st.session_state["answers"] = {}
    st.session_state["event_log"] = {}
    st.session_state["event_log"] = []

def is_nonempty(q, ans):
    if q["type"] == "multi":
        return isinstance(ans, list) and len(ans) > 0
    return bool(str(ans or "").strip())

def current_meta(answers: dict):
    name = str(answers.get("intake.ask_name","") or "").strip()
    request = str(answers.get("intake.ask_request","") or "").strip()
    contact = str(answers.get("intake.contact","") or "").strip()
    return name, request, contact

def build_payload(answers: dict, event_log: list, session_id: str):
    scores, evidence, col_scores = score_all(answers)
    name, request, contact = current_meta(answers)

    # --- TOP lists ---
    ranked = sorted(scores.items(), key=lambda x: float(x[1]), reverse=True)
    top3 = [{"pot": p, "score": float(s)} for p, s in ranked[:3]]
    top6 = [{"pot": p, "score": float(s)} for p, s in ranked[:6]]

    # --- excerpt (–∫–∞–∫ –≤ –º–∞—Å—Ç–µ—Ä-—Ç–∞–±–ª–∏—Ü–µ) ---
    important_keys = [
        "intake.ask_request",
        "intake.current_state",
        "intake.goal_3m",
        "now.easy_tasks",
        "now.praise_for",
        "now.best_result_example",
        "now.energy_fill",
        "behavior.group_role_now",
        "behavior.decision_style",
        "antipattern.avoid",
        "antipattern.hate_task",
        "antipattern.energy_leak",
    ]
    answers_excerpt = {k: answers.get(k) for k in important_keys if k in answers}

    # --- risks (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ, –±–µ–∑ AI) ---
    risks = []
    hate = str(answers.get("antipattern.hate_task", "") or "").lower()
    if "—Ä—É—Ç–∏–Ω–∞" in hate or "—Ä–µ–≥–ª–∞–º–µ–Ω—Ç" in hate or "–ø–æ—Ä—è–¥–æ–∫" in hate:
        risks.append("–Ω–µ –≤—ã–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä—É—Ç–∏–Ω—É/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã ‚Üí –Ω—É–∂–µ–Ω –¥–µ–ª–µ–≥–∞—Ç/—Å–∏—Å—Ç–µ–º–∞")
    if not str(answers.get("intake.current_state", "") or "").strip():
        risks.append("–Ω–µ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–æ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –∑–∞–±–∏—Ä–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é ‚Üí —Å—Ç–æ–∏—Ç —É—Ç–æ—á–Ω–∏—Ç—å –Ω–∞ —Å–æ–∑–≤–æ–Ω–µ")

    payload = {
        "meta": {
            "schema": "ai-neo.session.v7",
            "app_version": APP_VERSION,
            "timestamp": utcnow_iso(),
            "session_id": session_id,
            "name": name,
            "request": request,
            "contact": contact,
            "question_count": len(question_plan()),
            "answered_count": len(event_log),
        },
        "answers": answers,
        "scores": scores,
        "evidence": evidence,
        "col_scores": col_scores,
        "vectors_no_labels": vectors_without_labels(scores),
        "top3": top3,
        "top6": top6,
        "answers_excerpt": answers_excerpt,
        "risks": risks,
        "event_log": event_log,
    }
    return payload

# ======================
# CLIENT MINI REPORT
# ======================
def build_client_mini_report(payload: dict) -> str:
    name = payload.get("meta", {}).get("name") or "–¢—ã"
    request = payload.get("meta", {}).get("request") or "–∑–∞–ø—Ä–æ—Å"
    answers = payload.get("answers", {})
    scores = payload.get("scores", {})
    vectors = payload.get("vectors", [])

    energy_fill = answers.get("now.energy_fill", [])
    if isinstance(energy_fill, list) and energy_fill:
        fill_txt = ", ".join(energy_fill[:4])
    else:
        fill_txt = "‚Äî"

    leak = str(answers.get("antipattern.energy_leak", "") or "").strip() or "‚Äî"
    hate = str(answers.get("antipattern.hate_task", "") or "").strip() or "‚Äî"

    # –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ –≥–∏–ø–æ—Ç–µ–∑—ã "–Ω–µ–æ—á–µ–≤–∏–¥–Ω–æ–≥–æ"
    top = sorted(scores.items(), key=lambda x: x[1], reverse=True)[:3]
    top_names = [t[0] for t in top if t[1] > 0]
    # –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ ‚Äú—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ‚Äù –Ω–∞–º—ë–∫–∏ –±–µ–∑ –∫–∞–º–Ω–µ–π
    hints = []
    if "–ì—Ä–∞–Ω–∞—Ç" in top_names:
        hints.append("—Ç–≤–æ–π —Ä–æ—Å—Ç –∏–¥—ë—Ç —á–µ—Ä–µ–∑ –ª—é–¥–µ–π: –∫–æ–Ω—Ç–∞–∫—Ç, –≤–∏–¥–∏–º–æ—Å—Ç—å, —Å–æ–≤–º–µ—Å—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è")
    if "–ê–º–µ—Ç–∏—Å—Ç" in top_names:
        hints.append("—Ç–µ–±–µ –Ω—É–∂–µ–Ω —è—Å–Ω—ã–π –≤–µ–∫—Ç–æ—Ä: –∫–æ–≥–¥–∞ –µ—Å—Ç—å —Ü–µ–ª—å –∏ —Ä–∞–º–∫–∞ ‚Äî —Ç—ã —É—Å–∫–æ—Ä—è–µ—à—å—Å—è –≤ —Ä–∞–∑—ã")
    if "–°–∞–ø—Ñ–∏—Ä" in top_names:
        hints.append("–≤–∞–∂–µ–Ω —Å–º—ã—Å–ª: –µ—Å–ª–∏ –Ω–µ –≤–∏–¥–∏—à—å ‚Äò–∑–∞—á–µ–º‚Äô ‚Äî —ç–Ω–µ—Ä–≥–∏—è –ø–∞–¥–∞–µ—Ç, –¥–∞–∂–µ –µ—Å–ª–∏ –≤—Å—ë ‚Äò–ø—Ä–∞–≤–∏–ª—å–Ω–æ‚Äô")
    if "–¶–∏—Ç—Ä–∏–Ω" in top_names:
        hints.append("—Ç–µ–±—è –¥—Ä–∞–π–≤–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –º–µ—Ç—Ä–∏–∫–∏, —Å–∫–æ—Ä–æ—Å—Ç—å –∏ –æ—â—É—Ç–∏–º—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–∞—é—Ç —Ç–æ–ø–ª–∏–≤–æ")
    if "–†—É–±–∏–Ω" in top_names:
        hints.append("–ø—Ä–æ—è–≤–ª–µ–Ω–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–∞: —ç–º–æ—Ü–∏–∏/—Å—Ü–µ–Ω–∞/–≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è ‚Äî —ç—Ç–æ –Ω–µ ‚Äò–æ–ø—Ü–∏—è‚Äô, –∞ –ø–∏—Ç–∞–Ω–∏–µ")
    if not hints:
        hints.append("–ø–æ –æ—Ç–≤–µ—Ç–∞–º –≤–∏–¥–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π ‚Äî –Ω—É–∂–Ω–æ —á—É—Ç—å –±–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω—É")

    hint_txt = ";\n- ".join(hints)

    steps = [
        "–í—ã–±–µ—Ä–∏ –æ–¥–Ω—É —Ü–µ–ª—å –Ω–∞ 7 –¥–Ω–µ–π –∏ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –µ—ë –∫–∞–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—á—Ç–æ –±—É–¥–µ—Ç ‚Äò–≤–∏–¥–Ω–æ/–∏–∑–º–µ—Ä–∏–º–æ‚Äô).",
        "–°–¥–µ–ª–∞–π 2 –¥–µ–π—Å—Ç–≤–∏—è ‚Äò–Ω–∞ –ª—é–¥–µ–π‚Äô (–∫–æ–Ω—Ç–∞–∫—Ç/–∫–æ–ª–ª–∞–±/–∑–≤–æ–Ω–æ–∫/–ø–æ—Å—Ç/–≤—ã—Ö–æ–¥ –≤ —ç—Ñ–∏—Ä) ‚Äî –±–µ–∑ –∏–¥–µ–∞–ª–∞, –Ω–æ —Ä–µ–≥—É–ª—è—Ä–Ω–æ.",
        "–£–±–µ—Ä–∏ 1 —Å–ª–∏–≤ —ç–Ω–µ—Ä–≥–∏–∏: –¥–µ–ª–µ–≥–∏—Ä—É–π/–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–π/–æ–≥—Ä–∞–Ω–∏—á—å –≤—Ä–µ–º—è –Ω–∞ —Ç–æ, —á—Ç–æ –≤—ã–∂–∏–≥–∞–µ—Ç."
    ]

    vtxt = "\n".join([f"- {v}" for v in vectors]) if vectors else "- ‚Äî"

    return f"""
**{name}, –º–∏–Ω–∏-–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É: ‚Äú{request}‚Äù**

### –¢–≤–æ–π —Ç–µ–∫—É—â–∏–π –≤–µ–∫—Ç–æ—Ä (–±–µ–∑ —è—Ä–ª—ã–∫–æ–≤)
{vtxt}

### –ß—Ç–æ —Ç–µ–±—è –Ω–∞–ø–æ–ª–Ω—è–µ—Ç
**{fill_txt}**

### –ß—Ç–æ —Å–µ–π—á–∞—Å —Å–ª–∏–≤–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é
- **—Å–ª–∏–≤:** {leak}
- **—Å–∞–º–æ–µ –Ω–µ–ª—é–±–∏–º–æ–µ:** {hate}

### –ù–µ–æ—á–µ–≤–∏–¥–Ω–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞ (—Ç–æ, —á—Ç–æ —á–∞—Å—Ç–æ –Ω–µ –∑–∞–º–µ—á–∞—é—Ç)
- {hint_txt}

### 3 —à–∞–≥–∞ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 7 –¥–Ω–µ–π
1) {steps[0]}  
2) {steps[1]}  
3) {steps[2]}  

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å **–ø–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç + –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –¥–æ—Ä–æ–∂–Ω—É—é –∫–∞—Ä—Ç—É –Ω–∞ 6 –Ω–µ–¥–µ–ª—å**, –º–∞—Å—Ç–µ—Ä —Å–æ–±–µ—Ä—ë—Ç —Ç–æ—á–Ω—É—é —Å–≤—è–∑–∫—É ‚Äú—Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã ‚Üí —Ñ–æ—Ä–º–∞—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ ‚Üí –¥–µ–Ω—å–≥–∏/—ç–Ω–µ—Ä–≥–∏—è ‚Üí —Ä–∏—Å–∫–∏‚Äù.
""".strip()


# ======================
# INSIGHT TABLE (MASTER)
# ======================
def build_insight_table(payload: dict) -> dict:
    """
    –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞/LLM:
    - top3/top6 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤
    - vectors_no_labels (–¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –æ—Ç—á—ë—Ç–∞ –±–µ–∑ –∫–∞–º–Ω–µ–π)
    - col_scores (–í–û–°–ü–†–ò–Ø–¢–ò–ï/–ú–û–¢–ò–í–ê–¶–ò–Ø/–ò–ù–°–¢–†–£–ú–ï–ù–¢)
    - answers_excerpt (—Å–∂–∞—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã)
    - risks (—Ä–∏—Å–∫–∏/—Å–ª–∏–≤—ã)
    """
    meta = payload.get("meta", {})
    answers = payload.get("answers", {})
    scores = payload.get("scores", {}) or {}
    col_scores = payload.get("col_scores", {}) or {}

    # –í–µ–∫—Ç–æ—Ä—ã ‚Äî —É —Ç–µ–±—è –≤ payload —ç—Ç–æ –æ–±—ã—á–Ω–æ vectors_no_labels
    vectors = payload.get("vectors_no_labels", []) or payload.get("vectors_no_labels".replace("_no_labels", ""), [])
    if not vectors:
        vectors = payload.get("vectors_no_labels", []) or []

    ranked = sorted(scores.items(), key=lambda x: float(x[1]), reverse=True)
    top3 = [{"pot": p, "score": round(float(s), 2)} for p, s in ranked[:3]]
    top6 = [{"pot": p, "score": round(float(s), 2)} for p, s in ranked[:6]]

    # –°–∂–∞—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã
    keys = [
        "intake.ask_request",
        "intake.current_state",
        "intake.goal_3m",
        "now.easy_tasks",
        "now.praise_for",
        "now.best_result_example",
        "now.energy_fill",
        "behavior.group_role_now",
        "behavior.decision_style",
        "antipattern.avoid",
        "antipattern.hate_task",
        "antipattern.energy_leak",
    ]
    answers_excerpt = {k: answers.get(k) for k in keys if k in answers}

    # –†–∏—Å–∫–∏/—Å–ª–∏–≤—ã (–ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞)
    risks = []
    hate = str(answers.get("antipattern.hate_task", "") or "").lower()
    if any(x in hate for x in ["—Ä—É—Ç–∏–Ω–∞", "–ø–æ—Ä—è–¥–æ–∫", "—Ä–µ–≥–ª–∞–º–µ–Ω—Ç"]):
        risks.append("–Ω–µ –≤—ã–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä—É—Ç–∏–Ω—É/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã ‚Üí –Ω—É–∂–µ–Ω –¥–µ–ª–µ–≥–∞—Ç/—Å–∏—Å—Ç–µ–º–∞")
    if "–ø—Ä–æ–¥–∞–∂–∏" in hate:
        risks.append("—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂–∞–º/—Å–∞–º–æ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ ‚Üí –Ω—É–∂–Ω—ã –º—è–≥–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–æ—è–≤–ª–µ–Ω–Ω–æ—Å—Ç–∏")
    if "–∫–æ–Ω—Ñ–ª–∏–∫—Ç" in hate:
        risks.append("–∏–∑–±–µ–≥–∞–Ω–∏–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è ‚Üí –≤–∞–∂–Ω–æ —É—á–∏—Ç—å—Å—è –¥–µ—Ä–∂–∞—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã")

    return {
        "meta": meta,
        "vectors_no_labels": vectors,
        "top3": top3,
        "top6": top6,
        "scores": scores,
        "col_scores": col_scores,
        "answers_excerpt": answers_excerpt,
        "risks": risks,
    }
# ======================
# KNOWLEDGE SNIPPETS (simple local retrieval)
# ======================
def _read_knowledge_files():
    docs = []
    if not KNOWLEDGE_DIR.exists():
        return docs
    for p in sorted(KNOWLEDGE_DIR.glob("*.md")):
        try:
            txt = p.read_text(encoding="utf-8", errors="ignore")
            if txt.strip():
                docs.append({"path": str(p), "text": txt})
        except Exception:
            continue
    return docs

def _tokenize(s: str):
    s = (s or "").lower()
    s = re.sub(r"[^a-z–∞-—è0-9—ë]+", " ", s, flags=re.IGNORECASE)
    parts = [x for x in s.split() if len(x) >= 3]
    return parts

def get_knowledge_snippets(payload: dict, top_k: int = 6):
    """
    –û—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ–π retrieval –±–µ–∑ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –ë–î:
    - —Å–æ–±–∏—Ä–∞–µ–º query –∏–∑ –∑–∞–ø—Ä–æ—Å–∞+–≤–µ–∫—Ç–æ—Ä–æ–≤+–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
    - —Å—á–∏—Ç–∞–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Å–ª–æ–≤ –∏ –≤—ã–±–∏—Ä–∞–µ–º –ª—É—á—à–∏–µ –∫—É—Å–∫–∏
    """
    docs = _read_knowledge_files()
    if not docs:
        return []

    meta = payload.get("meta", {})
    answers = payload.get("answers", {})
    vectors = payload.get("vectors", [])

    query_text = " ".join([
        str(meta.get("request","") or ""),
        " ".join(vectors),
        str(answers.get("now.best_result_example","") or ""),
        str(answers.get("antipattern.energy_leak","") or ""),
        str(answers.get("now.praise_for","") or ""),
    ])

    qwords = set(_tokenize(query_text))
    if not qwords:
        return []

    scored = []
    for d in docs:
        text = d["text"]
        # –¥—Ä–æ–±–∏–º –Ω–∞ ‚Äú–∞–±–∑–∞—Ü—ã‚Äù
        chunks = [c.strip() for c in re.split(r"\n{2,}", text) if c.strip()]
        for c in chunks:
            words = set(_tokenize(c))
            inter = len(qwords.intersection(words))
            if inter <= 0:
                continue
            score = inter / max(20, len(words))
            scored.append({
                "source": d["path"],
                "score": round(score, 4),
                "excerpt": c[:1800]
            })

    scored.sort(key=lambda x: x["score"], reverse=True)
    return scored[:top_k]

# ======================
# OPENAI REPORT (MASTER)
# ======================
def build_report_system_prompt():
    return """
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –º–µ—Ç–æ–¥–∏–∫–µ –°–ü–ß/–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—ã (–º–∞—Ç—Ä–∏—Ü–∞ 3√ó3).

–ñ–Å–°–¢–ö–û:
- –ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏.
- –ù–µ –≤–æ–¥–∞. –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ.
- –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –æ—Ç—á—ë—Ç ‚Äî –ø–æ–Ω—è—Ç–Ω—ã–π, —Ç—ë–ø–ª—ã–π, –Ω–æ –±–µ–∑ —ç–∑–æ—Ç–µ—Ä–∏–∫–∏ –∏ –ø–∞—Ñ–æ—Å–∞.
- –ú–∞—Å—Ç–µ—Ä—Å–∫–∏–π –æ—Ç—á—ë—Ç ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω—ã–π, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π, —Å –≥–∏–ø–æ—Ç–µ–∑–∞–º–∏, –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏ –∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏.
- –ú–∞—Ç—Ä–∏—Ü–∞ 3√ó3 = 3 —Ä—è–¥–∞ √ó 3 —Å—Ç–æ–ª–±—Ü–∞:
  –°—Ç–æ–ª–±—Ü—ã: –í–æ—Å–ø—Ä–∏—è—Ç–∏–µ / –ú–æ—Ç–∏–≤–∞—Ü–∏—è / –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (–¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ü–µ–ª–µ–π)
  –†—è–¥—ã: 1 —Ä—è–¥ (—è–¥—Ä–æ/–ø—Ä–∏—Ä–æ–¥–∞/—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è), 2 —Ä—è–¥ (—ç–Ω–µ—Ä–≥–∏—è –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è/—Ö–æ–±–±–∏), 3 —Ä—è–¥ (—Ä–∏—Å–∫–∏/—Å–ª–∏–≤—ã/—á—Ç–æ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å)

–§–û–†–ú–ê–¢ –í–´–í–û–î–ê ‚Äî –°–¢–†–û–ì–û –¢–ê–ö (–¥–≤–µ —Å–µ–∫—Ü–∏–∏):
<<<CLIENT_REPORT>>>
...—Ç–µ–∫—Å—Ç...
<<<MASTER_REPORT>>>
...—Ç–µ–∫—Å—Ç...
""".strip()

def build_client_report_prompt():
    return """
–°–¥–µ–ª–∞–π CLIENT-–æ—Ç—á—ë—Ç (–¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞), 20‚Äì35 —Å—Ç—Ä–æ–∫.

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:
1) –ó–∞–≥–æ–ª–æ–≤–æ–∫: ‚Äú–¢–≤–æ—è –º–∞—Ç—Ä–∏—Ü–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ 3√ó3‚Äù
2) –ü–æ–∫–∞–∂–∏ –º–∞—Ç—Ä–∏—Ü—É 3√ó3 (–≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –≤–∏–¥–µ, –∞–∫–∫—É—Ä–∞—Ç–Ω–æ), —Å –∫–∞–º–Ω—è–º–∏.
3) –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä—è–¥–∞: 
   - ‚Äú–°—É–ø–µ—Ä-–ø—Ä–æ—è–≤–ª–µ–Ω–∏—è‚Äù (3 –º–∞—Ä–∫–µ—Ä–∞)
   - ‚Äú–†–∏—Å–∫–∏/—Å–ª–∏–≤ —ç–Ω–µ—Ä–≥–∏–∏‚Äù (2 –º–∞—Ä–∫–µ—Ä–∞)
4) –ë–ª–æ–∫ ‚Äú–ß—Ç–æ –≤–∫–ª—é—á–∞—Ç—å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å (–º–∏–∫—Ä–æ-–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞)‚Äù ‚Äî 5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π.
5) –ë–ª–æ–∫ ‚Äú–ß—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è —Ç–µ–±—è‚Äù ‚Äî 5 –∞–Ω—Ç–∏-–ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤.
6) –ú—è–≥–∫–∏–π CTA: ‚Äú–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ä–∞–∑–±–æ—Ä 60 –º–∏–Ω—É—Ç –∏ —Å–æ–±—Ä–∞—Ç—å –ª–∏—á–Ω—ã–π –ø–ª–∞–Ω –Ω–∞ 6 –Ω–µ–¥–µ–ª—å‚Äù.

–í–∞–∂–Ω–æ: –Ω–µ –ø—É–≥–∞–π, –Ω–µ —Å—Ç–∞–≤—å –¥–∏–∞–≥–Ω–æ–∑–æ–≤, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã.
""".strip()


def build_master_report_prompt():
    return """
–°–¥–µ–ª–∞–π MASTER-–æ—Ç—á—ë—Ç (–¥–ª—è –º–∞—Å—Ç–µ—Ä–∞). –°—Ç—Ä—É–∫—Ç—É—Ä–∞:

1) –ú–∞—Ç—Ä–∏—Ü–∞ 3√ó3 (–∫–∞–º–Ω–∏ –ø–æ –∫–ª–µ—Ç–∫–∞–º). 
2) –î–æ–º–∏–Ω–∏—Ä—É—é—â–∏–π —Ä—è–¥: –ø–æ—á–µ–º—É (–ø–æ –æ—Ç–≤–µ—Ç–∞–º/—Ç–∞–±–ª–∏—Ü–µ), –∫–∞–∫ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è.
3) –ü–æ–¥–∞–≤–ª–µ–Ω–Ω—ã–π —Ä—è–¥: –ø—Ä–∏–∑–Ω–∞–∫–∏, –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è, —á—Ç–æ –¥–µ–ª–∞—Ç—å.
4) –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã/—Å–º–µ—â–µ–Ω–∏—è:
   - ‚Äú–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ vs –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç‚Äù
   - ‚Äú–ú–æ—Ç–∏–≤–∞—Ü–∏—è vs –†–µ–∞–ª–∏–∑–∞—Ü–∏—è‚Äù
   - 3 —Ç–∏–ø–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è, –≥–¥–µ –∫–ª–∏–µ–Ω—Ç –∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç.
5) –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è/—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥ –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: 3 —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ + —Ä–∏—Å–∫–∏.
6) –ü–ª–∞–Ω –Ω–∞ 6 –Ω–µ–¥–µ–ª—å (–ø–æ –Ω–µ–¥–µ–ª—è–º):
   - —Ñ–æ–∫—É—Å –Ω–µ–¥–µ–ª–∏
   - 3 –∑–∞–¥–∞—á–∏
   - –º–µ—Ç—Ä–∏–∫–∞ —É—Å–ø–µ—Ö–∞
7) 8 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Å–µ—Å—Å–∏–∏ (–æ—á–µ–Ω—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ, –±—ã—Ç–æ–≤—ã–µ).
8) –ö–æ—Ä–æ—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –º–∞—Å—Ç–µ—Ä—É: ‚Äú–∫–∞–∫ –≤–µ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞‚Äù.

–ü–∏—à–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ.
""".strip()

def call_openai_for_reports(client, model: str, payload: dict):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (client_report_text, master_report_text)
    –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî —á–µ—Ä–µ–∑ –º–∞—Ä–∫–µ—Ä—ã <<<CLIENT_REPORT>>> –∏ <<<MASTER_REPORT>>>.
    """

    table = build_insight_table(payload)
    snips = get_knowledge_snippets(payload)

    sys = build_report_system_prompt()

    # ‚úÖ event_log ‚Äî —ç—Ç–æ LIST, –µ–≥–æ –º–æ–∂–Ω–æ —Å–ª–∞–π—Å–∏—Ç—å
    event_tail = (payload.get("event_log") or [])[-8:]

    user_payload = {
        "meta": payload.get("meta", {}),
        "request": payload.get("meta", {}).get("request"),
        "matrix_3x3_inputs": table,               # –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ/–∏–Ω—Å–∞–π—Ç—ã
        "knowledge_snippets": snips,              # –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –º–∞—Å—Ç–µ—Ä—É
        "event_log_tail": event_tail,             # ‚úÖ –≤–º–µ—Å—Ç–æ answers[-8:]
        "answers_excerpt": payload.get("answers_excerpt", {}),
        "top_scores": payload.get("scores", {}),
        "col_scores": payload.get("col_scores", {}),
        "top6": payload.get("top6", []),
        "risks": payload.get("risks", []),
    }

    prompt = (
        "–°—Ñ–æ—Ä–º–∏—Ä—É–π –¥–≤–∞ —Ç–µ–∫—Å—Ç–∞ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º.\n\n"
        "CLIENT INSTRUCTIONS:\n" + build_client_report_prompt() + "\n\n"
        "MASTER INSTRUCTIONS:\n" + build_master_report_prompt() + "\n\n"
        "INPUT DATA (json):\n" + json.dumps(user_payload, ensure_ascii=False)
    )

    r = client.responses.create(
        model=model,
        input=[
            {"role": "system", "content": sys},
            {"role": "user", "content": prompt},
        ],
    )

    out = getattr(r, "output_text", "") or ""
    if "<<<CLIENT_REPORT>>>" not in out or "<<<MASTER_REPORT>>>" not in out:
        return ("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –æ—Ç—á—ë—Ç (—Ñ–æ—Ä–º–∞—Ç).", out or "–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏.")

    client_part = out.split("<<<CLIENT_REPORT>>>", 1)[1].split("<<<MASTER_REPORT>>>", 1)[0].strip()
    master_part = out.split("<<<MASTER_REPORT>>>", 1)[1].strip()

    return client_part, master_part

# ======================
# UI: render question
# ======================
def ui_key_for_question(qid: str, session_id: str) -> str:
    # –∫–ª—é—á —É–Ω–∏–∫–∞–ª–µ–Ω –Ω–∞ –≤–æ–ø—Ä–æ—Å + —Å–µ—Å—Å–∏—é => —Ç–µ–∫—Å—Ç –ù–ï –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è
    return f"q_{session_id}_{qid}"

def render_question(q, session_id: str):
    st.markdown(f"### {q['text']}")
    st.caption("–ö–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É. –ú–æ–∂–Ω–æ 1‚Äì5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.")

    qid = q["id"]
    qtype = q["type"]
    opts = q.get("options", [])

    key = ui_key_for_question(qid, session_id)

    if qtype == "single":
        return st.radio("–í—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç:", opts, key=key) if opts else st.text_input("–û—Ç–≤–µ—Ç:", key=key)

    if qtype == "multi":
        return st.multiselect("–í—ã–±–µ—Ä–∏ 1‚Äì4:", opts, key=key) if opts else st.text_area("–û—Ç–≤–µ—Ç:", height=140, key=key)

    # text
    return st.text_area("–û—Ç–≤–µ—Ç:", height=150, key=key)
# ======================
# CLIENT FLOW
# ======================
from pathlib import Path
import json

CONFIG_PATH = Path("config.json")

DEFAULT_CONFIG = {
  "hybrid": {
    "enabled": True,
    "start_after_question_index": 38,
    "max_followup_questions": 8,
    "stop_if_confidence_over": 0.78,
    "min_gap_for_tie_break": 0.45,
    "max_same_intent_repeats": 1,
    "followup_intents_priority": [
      "columns_lock",
      "tie_break_top2",
      "anti_social_desirability",
      "shift_probe",
      "sensory_marker_check"
    ],
    "followup_style": {
      "use_options_when_possible": True,
      "options_count": 4,
      "allow_free_text": True
    }
  }
}

def load_config() -> dict:
    """–ß–∏—Ç–∞–µ—Ç config.json. –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç/–±–∏—Ç—ã–π ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç DEFAULT_CONFIG."""
    try:
        if CONFIG_PATH.exists():
            data = json.loads(CONFIG_PATH.read_text(encoding="utf-8"))
            # –º—è–≥–∫–∏–π merge: –µ—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ—Ç –≤ —Ñ–∞–π–ª–µ ‚Äî –¥–æ–±—å—ë–º –¥–µ—Ñ–æ–ª—Ç–∞–º–∏
            out = DEFAULT_CONFIG.copy()
            out.update(data or {})
            if "hybrid" in DEFAULT_CONFIG:
                out["hybrid"] = (DEFAULT_CONFIG["hybrid"] | (out.get("hybrid") or {}))
            return out
    except Exception:
        pass
    return DEFAULT_CONFIG

def render_client_flow():
    # 1) –±–∞–∑–æ–≤—ã–π –±–∞–Ω–∫
    plan = question_plan()
    base_total = len(plan)

    # 2) –∫–æ–Ω—Ñ–∏–≥ –≥–∏–±—Ä–∏–¥–∞
    cfg = load_config()
    hy = cfg.get("hybrid", {})
    hy_enabled = bool(hy.get("enabled", False))
    hy_start_after = int(hy.get("start_after_question_index", base_total))

    # 3) –∑–∞—â–∏—Ç–∞ session_state
    if "q_index" not in st.session_state:
        st.session_state["q_index"] = 0
    if st.session_state["q_index"] < 0:
        st.session_state["q_index"] = 0

    # –µ—Å–ª–∏ –±–∞–Ω–∫ –ø–æ–º–µ–Ω—è–ª—Å—è, –∞ –∏–Ω–¥–µ–∫—Å –æ—Å—Ç–∞–ª—Å—è —Å—Ç–∞—Ä—ã–π ‚Äî –Ω–µ –ø–∞–¥–∞–µ–º
    if st.session_state["q_index"] > base_total:
        st.session_state["q_index"] = base_total

    # 4) done-–ª–æ–≥–∏–∫–∞
    base_done = st.session_state["q_index"] >= base_total
    hybrid_done = bool(st.session_state.get("hybrid_done", False))
    done = base_done and (not hy_enabled or hybrid_done)

    # 5) —à–∞–ø–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    colA, colB = st.columns([3, 1])
    with colA:
        if st.session_state["q_index"] >= base_total:
            stage = "final"
            cur_num = base_total
        else:
            stage = plan[st.session_state["q_index"]].get("stage", "‚Äî")
            cur_num = st.session_state["q_index"] + 1
        st.caption(f"–•–æ–¥: –≤–æ–ø—Ä–æ—Å {cur_num} –∏–∑ {base_total} | —Ñ–∞–∑–∞: {stage}")

    with colB:
        if st.button("üîÑ –°–±—Ä–æ—Å–∏—Ç—å", use_container_width=True):
            reset_diagnostic()
            st.rerun()

    # 6) –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫
    if not done:
        # ---------- –ë–ê–ó–û–í–´–ï –í–û–ü–†–û–°–´ ----------
        if st.session_state["q_index"] < base_total:
            q = plan[st.session_state["q_index"]]
            ans = render_question(q, st.session_state["session_id"])

            c1, c2 = st.columns([1, 1])
            with c1:
                if st.button("–î–∞–ª–µ–µ ‚ûú", use_container_width=True):
                    if not is_nonempty(q, ans):
                        st.warning("–ó–∞–ø–æ–ª–Ω–∏ –æ—Ç–≤–µ—Ç.")
                    else:
                        st.session_state["answers"][q["id"]] = ans
                        st.session_state["event_log"].append({
                            "timestamp": utcnow_iso(),
                            "question_id": q["id"],
                            "question_text": q["text"],
                            "answer_type": q["type"],
                            "answer": ans
                        })
                        st.session_state["q_index"] += 1

                        # –µ—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞ –±–∞–∑—ã ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫ —Å–µ—Å—Å–∏–∏
                        if st.session_state["q_index"] >= base_total:
                            payload = build_payload(
                                st.session_state["answers"],
                                st.session_state["event_log"],
                                st.session_state["session_id"]
                            )
                            save_session(payload)

                        st.rerun()

            with c2:
                if st.button("–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ–π—á–∞—Å", use_container_width=True):
                    payload = build_payload(
                        st.session_state["answers"],
                        st.session_state["event_log"],
                        st.session_state["session_id"]
                    )
                    save_session(payload)

                    # —Ñ–æ—Ä—Å–∏—Ä—É–µ–º –∫–æ–Ω–µ—Ü –±–∞–∑—ã
                    st.session_state["q_index"] = base_total
                    # –µ—Å–ª–∏ –≥–∏–±—Ä–∏–¥ –≤—ã–∫–ª—é—á–µ–Ω ‚Äî —Å—á–∏—Ç–∞–µ–º –≤—Å—ë –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º
                    if not hy_enabled:
                        st.session_state["hybrid_done"] = True
                    st.rerun()

        # ---------- –ì–ò–ë–†–ò–î–ù–´–ô –ë–õ–û–ö (–ü–û–°–õ–ï –ë–ê–ó–´) ----------
        else:
            # –ë–∞–∑–∞ —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω–∞, –Ω–æ –≥–∏–±—Ä–∏–¥ –µ—â—ë –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω
            if hy_enabled and not hybrid_done:
                st.info("–ú—ã –ø–æ–ª—É—á–∏–ª–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —É—Ç–æ—á–Ω–∏–º –ø–∞—Ä—É –º–æ–º–µ–Ω—Ç–æ–≤ (–∫–æ—Ä–æ—Ç–∫–∏–π –±–ª–æ–∫).")

                # —Ç—É—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–≤–æ–π –≤—ã–∑–æ–≤ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
                # –Ω–∞–ø—Ä–∏–º–µ—Ä: q = build_hybrid_question(...)
                # ans = render_hybrid_question(...)
                # –∏ –ø–æ –∫–Ω–æ–ø–∫–µ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å hybrid_turn –∏ —Å—Ç–∞–≤–∏—Ç—å hybrid_done=True

                st.warning("–ì–∏–±—Ä–∏–¥–Ω—ã–π –±–ª–æ–∫ –≤–∫–ª—é—á—ë–Ω, –Ω–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –µ—â—ë –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω –≤ –∫–æ–¥–µ.")
                if st.button("–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≥–∏–±—Ä–∏–¥ –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å", use_container_width=True):
                    st.session_state["hybrid_done"] = True
                    st.rerun()
            else:
                # –≥–∏–±—Ä–∏–¥ –Ω–µ –Ω—É–∂–µ–Ω ‚Äî –≤—Å—ë
                st.session_state["hybrid_done"] = True
                st.rerun()

    # 7) —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω
    else:
        payload = build_payload(
            st.session_state["answers"],
            st.session_state["event_log"],
            st.session_state["session_id"]
        )
        try:
            save_session(payload)
        except Exception:
            pass

        st.success("–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úÖ")
        st.markdown("## –ú–∏–Ω–∏-–æ—Ç—á—ë—Ç (–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π)")
        st.markdown(build_client_mini_report(payload))

        with st.expander("–ü–æ–∫–∞–∑–∞—Ç—å –º–æ–∏ –æ—Ç–≤–µ—Ç—ã (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)"):
            st.json(payload.get("answers", {}))
# ======================
# MASTER PANEL
# ======================
def render_master_panel():
    st.subheader("üõ†Ô∏è –ú–∞—Å—Ç–µ—Ä-–ø–∞–Ω–µ–ª—å")

    # ---- auth
    if not st.session_state.get("master_authed", False):
        pwd = st.text_input("–ü–∞—Ä–æ–ª—å –º–∞—Å—Ç–µ—Ä–∞", type="password", key="master_pwd")
        if st.button("–í–æ–π—Ç–∏", use_container_width=True):
            if not MASTER_PASSWORD:
                st.error("MASTER_PASSWORD –Ω–µ –∑–∞–¥–∞–Ω –≤ secrets/env.")
            elif pwd == MASTER_PASSWORD:
                st.session_state["master_authed"] = True
                st.success("–û–∫ ‚úÖ")
                st.rerun()
            else:
                st.error("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å")
        st.stop()

    # ---- sessions
    sessions = list_sessions()
    if not sessions:
        st.info("–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π.")
        st.stop()

    labels, ids = [], []
    for s in sessions:
        sid = s.get("meta", {}).get("session_id", "")
        name = s.get("meta", {}).get("name", "‚Äî")
        req = s.get("meta", {}).get("request", "‚Äî")
        ts = s.get("meta", {}).get("timestamp", "‚Äî")
        labels.append(f"{name} | {req} | {ts} | {sid[:8]}")
        ids.append(sid)

    pick = st.selectbox("–°–µ—Å—Å–∏–∏:", labels, index=0, key="master_pick")
    chosen_id = ids[labels.index(pick)]

    selected_payload = load_session(chosen_id)
    if not selected_payload:
        st.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Å—Å–∏—é.")
        st.stop()

    # ---- header meta
    meta = selected_payload.get("meta", {})
    st.markdown(
        f"**–ò–º—è:** {meta.get('name','‚Äî')}\n\n"
        f"**–ö–æ–Ω—Ç–∞–∫—Ç:** {meta.get('contact','‚Äî')}\n\n"
        f"**–ó–∞–ø—Ä–æ—Å:** {meta.get('request','‚Äî')}\n\n"
        f"**–í–æ–ø—Ä–æ—Å–æ–≤:** {meta.get('question_count','‚Äî')} | **–û—Ç–≤–µ—Ç–æ–≤:** {meta.get('answered_count','‚Äî')}\n"
    )

    # ---- download json
    st.download_button(
        "‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å JSON (—Å–µ—Å—Å–∏—è)",
        data=json.dumps(selected_payload, ensure_ascii=False, indent=2).encode("utf-8"),
        file_name=f"session_{chosen_id[:8]}.json",
        mime="application/json",
        use_container_width=True
    )

    # ---- build table + snippets (ONLY INSIDE MASTER)
    with st.expander("üìå –¢–∞–±–ª–∏—Ü–∞ –∏–Ω—Å–∞–π—Ç–æ–≤ (–¥–ª—è –º–∞—Å—Ç–µ—Ä–∞)"):
        table = build_insight_table(selected_payload)
        st.json(table)
        col_scores = table.get("col_scores", {})
        if col_scores:
            st.markdown("### üß≠ –ö–æ–ª–æ–Ω–∫–∏ (–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ / –ú–æ—Ç–∏–≤–∞—Ü–∏—è / –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç)")
            for c_key in ["perception","motivation","instrument"]:
                cs = col_scores.get(c_key, {})
                top = sorted(cs.items(), key=lambda x: float(x[1]), reverse=True)[:3]
                st.write(f"**{COL_LABELS[c_key]}**: " + ", ".join([f"{p} ({float(v):.2f})" for p, v in top]))
        else:
            st.info("col_scores –ø—É—Å—Ç ‚Äî –∫–æ–ª–æ–Ω–∫–∏ –µ—â—ë –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã.")

    with st.expander("üìö Knowledge snippets (—á—Ç–æ –ø–æ–¥–º–µ—à–∞–ª–∏)"):
        snips = get_knowledge_snippets(selected_payload, top_k=6)
        if not snips:
            st.info("–ù–µ—Ç knowledge snippets. –ü—Ä–æ–≤–µ—Ä—å –ø–∞–ø–∫—É knowledge/ –∏ –Ω–∞–ª–∏—á–∏–µ .md —Ñ–∞–π–ª–æ–≤.")
        else:
            for s in snips:
                st.markdown(f"**{s['source']}** (score={s['score']})")
                st.code(s["excerpt"][:1200])

    # ---- generate report
    st.markdown("---")
    st.subheader("üß† AI-–æ—Ç—á—ë—Ç (–¥–ª—è –º–∞—Å—Ç–µ—Ä–∞)")

    model_in = st.text_input("–ú–æ–¥–µ–ª—å (–æ—Å—Ç–∞–≤—å –∫–∞–∫ –µ—Å—Ç—å)", value=DEFAULT_MODEL, key="master_model")

    if st.button("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å AI-–æ—Ç—á—ë—Ç", use_container_width=True):
        client = get_openai_client()
        if not client:
            st.error("–ù–µ—Ç OPENAI_API_KEY –≤ secrets/env")
        else:
            try:
                model = safe_model_name(model_in)
                cr, mr = call_openai_for_reports(client, model, selected_payload)

                st.markdown("### –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π AI-–æ—Ç—á—ë—Ç")
                st.write(cr)

                st.markdown("### –ú–∞—Å—Ç–µ—Ä—Å–∫–∏–π AI-–æ—Ç—á—ë—Ç")
                st.write(mr)

                # —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Å–µ—Å—Å–∏—é
                selected_payload["ai_client_report"] = cr
                selected_payload["ai_master_report"] = mr
                save_session(selected_payload)

                st.success("–ì–æ—Ç–æ–≤–æ ‚úÖ –û—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —Å–µ—Å—Å–∏–∏.")
            except Exception as e:
                st.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {e}")

    # ---- show saved reports
    if selected_payload.get("ai_client_report") or selected_payload.get("ai_master_report"):
        with st.expander("üóÇÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ AI-–æ—Ç—á—ë—Ç—ã"):
            if selected_payload.get("ai_client_report"):
                st.markdown("#### –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π")
                st.write(selected_payload["ai_client_report"])
            if selected_payload.get("ai_master_report"):
                st.markdown("#### –ú–∞—Å—Ç–µ—Ä—Å–∫–∏–π")
                st.write(selected_payload["ai_master_report"])


# ======================
# MAIN
# ======================
init_state()

st.title("üí† NEO –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ (MVP)")

tab1, tab2 = st.tabs(["üßë‚Äçüíº –ö–ª–∏–µ–Ω—Ç", "üõ†Ô∏è –ú–∞—Å—Ç–µ—Ä"])

with tab1:
    render_client_flow()

with tab2:
    render_master_panel()
