# app.py ‚Äî STABLE MVP (–±–µ–∑ –∑–∞–≤–∏—Å–∞–Ω–∏—è –æ—Ç API)
# –õ–æ–≥–∏–∫–∞: —ç—Ç–∞–ø—ã + —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π "–∂–∏–≤–æ–π" —Å—Ü–µ–Ω–∞—Ä–∏–π –Ω–∞ 30 —à–∞–≥–æ–≤
# –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ (radio/multi) + —Ç–µ–∫—Å—Ç. –ë–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤. –ë–µ–∑ OpenAI.

import json
import time
import streamlit as st


# -----------------------------
# Scenario (30 –≤–æ–ø—Ä–æ—Å–æ–≤)
# -----------------------------
SCENARIO = [
    # stage: intake (0-4)
    {"id": "q_name", "stage": "intake", "intent": "ask_name", "type": "text",
     "text": "–ö–∞–∫ –º–Ω–µ –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è? (–∏–º—è/–∫–∞–∫ —É–¥–æ–±–Ω–æ)"},
    {"id": "q_request", "stage": "intake", "intent": "ask_request", "type": "text",
     "text": "–° –∫–∞–∫–∏–º –∑–∞–ø—Ä–æ—Å–æ–º —Ç—ã –ø—Ä–∏—à—ë–ª(–ø—Ä–∏—à–ª–∞) –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É? –ß—Ç–æ —Ö–æ—á–µ—à—å –ø–æ–Ω—è—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å? (1‚Äì2 —Ñ—Ä–∞–∑—ã)"},
    {"id": "q_now_state", "stage": "intake", "intent": "current_state", "type": "text",
     "text": "–ï—Å–ª–∏ –∫–æ—Ä–æ—Ç–∫–æ: —á—Ç–æ —Å–µ–π—á–∞—Å –≤ –∂–∏–∑–Ω–∏ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ù–ï —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏–ª–∏ –∑–∞–±–∏—Ä–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é?"},
    {"id": "q_goal_3m", "stage": "intake", "intent": "goal_3m", "type": "text",
     "text": "–ü—Ä–µ–¥—Å—Ç–∞–≤—å: –ø—Ä–æ—à–ª–æ 3 –º–µ—Å—è—Ü–∞ –∏ —Å—Ç–∞–ª–æ –ª—É—á—à–µ. –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –±—ã –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å?"},
    {"id": "q_priority_area", "stage": "intake", "intent": "priority_area", "type": "single",
     "text": "–ß—Ç–æ –≤–∞–∂–Ω–µ–µ –≤—Å–µ–≥–æ –ø—Ä–æ—è—Å–Ω–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è?",
     "options": ["–î–µ–Ω—å–≥–∏/—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è", "–û—Ç–Ω–æ—à–µ–Ω–∏—è", "–ó–¥–æ—Ä–æ–≤—å–µ/—ç–Ω–µ—Ä–≥–∏—è", "–°–∞–º–æ–æ—Ü–µ–Ω–∫–∞/—Å–º—ã—Å–ª/–ø—É—Ç—å", "–î—Ä—É–≥–æ–µ"]},

    # stage: now (5-12) ‚Äî —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è (–≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ/–º–æ—Ç–∏–≤–∞—Ü–∏—è/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç)
    {"id": "q_easy_tasks", "stage": "now", "intent": "easy_tasks", "type": "text",
     "text": "–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —Ç–µ–±–µ –æ–±—ã—á–Ω–æ –¥–∞—é—Ç—Å—è –ª–µ–≥–∫–æ (–∫–∞–∫ –±—É–¥—Ç–æ —Å–∞–º–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è)?"},
    {"id": "q_praise_for", "stage": "now", "intent": "praise_for", "type": "text",
     "text": "–ó–∞ —á—Ç–æ —Ç–µ–±—è —á–∞—â–µ –≤—Å–µ–≥–æ —Ö–≤–∞–ª—è—Ç –ª—é–¥–∏? (1‚Äì3 –ø—É–Ω–∫—Ç–∞)"},
    {"id": "q_time_flow", "stage": "now", "intent": "time_flow", "type": "text",
     "text": "–í –∫–∞–∫–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ç—ã —Ç–µ—Ä—è–µ—à—å —Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏?"},
    {"id": "q_attention_first", "stage": "now", "intent": "attention_first", "type": "single",
     "text": "–ö–æ–≥–¥–∞ –ø–æ–ø–∞–¥–∞–µ—à—å –≤ –Ω–æ–≤—É—é —Å–∏—Ç—É–∞—Ü–∏—é, —á—Ç–æ —Ç—ã –∑–∞–º–µ—á–∞–µ—à—å –ø–µ—Ä–≤—ã–º?",
     "options": ["–õ—é–¥–µ–π/–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ/–æ—Ç–Ω–æ—à–µ–Ω–∏—è", "–°–º—ã—Å–ª/–∏–¥–µ—é/–ø–æ—á–µ–º—É —Ç–∞–∫", "–ü–æ—Ä—è–¥–æ–∫/—Å—Ç—Ä—É–∫—Ç—É—Ä—É/–¥–µ—Ç–∞–ª–∏",
                 "–î–µ–Ω—å–≥–∏/–≤—ã–≥–æ–¥—É/—Ä–µ–∑—É–ª—å—Ç–∞—Ç", "–ö—Ä–∞—Å–æ—Ç—É/–≤–∫—É—Å/—ç—Å—Ç–µ—Ç–∏–∫—É", "–î–≤–∏–∂–µ–Ω–∏–µ/—Ç–µ–ª–æ/–¥–µ–π—Å—Ç–≤–∏–µ"]},
    {"id": "q_best_result_example", "stage": "now", "intent": "best_result_example", "type": "text",
     "text": "–î–∞–π 1 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏–∑ –∂–∏–∑–Ω–∏: —Å–∏—Ç—É–∞—Ü–∏—è ‚Üí —á—Ç–æ —Ç—ã —Å–¥–µ–ª–∞–ª(–∞) ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Ç–æ, —á—Ç–æ —É —Ç–µ–±—è –ø–æ–ª—É—á–∞–µ—Ç—Å—è –ª—É—á—à–µ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞)."},
    {"id": "q_motivation_trigger", "stage": "now", "intent": "motivation_trigger", "type": "single",
     "text": "–ß—Ç–æ —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ —Ç–µ–±—è –∑–∞–≤–æ–¥–∏—Ç/–≤–∫–ª—é—á–∞–µ—Ç?",
     "options": ["–ò–¥–µ—è/—Å–º—ã—Å–ª/–≥–ª—É–±–∏–Ω–∞", "–õ—é–¥–∏/—Å–æ–æ–±—â–µ—Å—Ç–≤–∞/—Ä–æ–¥—Å—Ç–≤–æ", "–ö—Ä–∞—Å–æ—Ç–∞/–≥–∞—Ä–º–æ–Ω–∏—è/–∞—Ç–º–æ—Å—Ñ–µ—Ä–∞",
                 "–î—Ä–∞–π–≤/—Å—Ü–µ–Ω–∞/—ç–º–æ—Ü–∏–∏", "–î–µ–Ω—å–≥–∏/—Ä–µ–∑—É–ª—å—Ç–∞—Ç/—Å–∫–æ—Ä–æ—Å—Ç—å", "–°–∏—Å—Ç–µ–º–∞/–ø–æ—Ä—è–¥–æ–∫/—è—Å–Ω–æ—Å—Ç—å", "–¢–µ–ª–æ/–¥–≤–∏–∂–µ–Ω–∏–µ/—Å–ø–æ—Ä—Ç"]},
    {"id": "q_stress_pattern", "stage": "now", "intent": "stress_pattern", "type": "single",
     "text": "–ö–æ–≥–¥–∞ —Å—Ç—Ä–µ—Å—Å/–¥–∞–≤–ª–µ–Ω–∏–µ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–∞—â–µ –≤—Å–µ–≥–æ?",
     "options": ["–£—Ö–æ–∂—É –≤ –∫–æ–Ω—Ç—Ä–æ–ª—å –∏ –ø–æ—Ä—è–¥–æ–∫", "–°–ø–∞—Å–∞—é –≤—Å–µ—Ö/–¥–µ—Ä–∂—É –ª—é–¥–µ–π", "–°—Ç–∞–Ω–æ–≤–ª—é—Å—å —Ä–µ–∑–∫–∏–º(–æ–π) –∏ —É—Å–∫–æ—Ä—è—é—Å—å",
                 "–£—Ö–æ–∂—É –≤ –º—ã—Å–ª–∏/—Å–º—ã—Å–ª/–∞–Ω–∞–ª–∏–∑", "–ò—â—É –∫—Ä–∞—Å–æ—Ç—É/—É—é—Ç/–∏–∑–æ–ª—è—Ü–∏—é", "–£—Ö–æ–∂—É –≤ –¥–≤–∏–∂–µ–Ω–∏–µ/—Å–ø–æ—Ä—Ç/–¥–µ–ª–∞", "–ó–∞–º–∏—Ä–∞—é/–ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è"]},
    {"id": "q_energy_fill", "stage": "now", "intent": "energy_fill", "type": "multi",
     "text": "–ß—Ç–æ —Ç–µ–±—è —Ä–µ–∞–ª—å–Ω–æ –Ω–∞–ø–æ–ª–Ω—è–µ—Ç (–≤—ã–±–µ—Ä–∏ 1‚Äì3)?",
     "options": ["–û–±—â–µ–Ω–∏–µ –∏ –±–ª–∏–∑–∫–∏–µ –ª—é–¥–∏", "–¢–∏—à–∏–Ω–∞/—á—Ç–µ–Ω–∏–µ/–º—ã—Å–ª–∏", "–ö—Ä–∞—Å–∏–≤—ã–µ –º–µ—Å—Ç–∞/—ç—Å—Ç–µ—Ç–∏–∫–∞/—É—é—Ç",
                 "–î–≤–∏–∂–µ–Ω–∏–µ/—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏/—Ç–µ–ª–µ—Å–Ω–æ—Å—Ç—å", "–°–æ–∑–¥–∞–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É/—Å—Ç—Ä—É–∫—Ç—É—Ä—É", "–ó–∞–ø—É—Å–∫–∞—Ç—å –∏ –≤–µ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç—ã", "–£—á–∏—Ç—å—Å—è/–æ–±—ä—è—Å–Ω—è—Ç—å"]},

    # stage: childhood (13-19) ‚Äî –¥–µ—Ç—Å—Ç–≤–æ/–ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤–æ–µ
    {"id": "q_child_play", "stage": "childhood", "intent": "child_play", "type": "multi",
     "text": "–í –¥–µ—Ç—Å—Ç–≤–µ (–ø—Ä–∏–º–µ—Ä–Ω–æ 6‚Äì12) —á—Ç–æ –ª—é–±–∏–ª(–∞) –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ? (1‚Äì4 –≤–∞—Ä–∏–∞–Ω—Ç–∞)",
     "options": ["–û—Ä–≥–∞–Ω–∏–∑–æ–≤—ã–≤–∞—Ç—å/—Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞—Ç—å/—Å—Ç—Ä–æ–∏—Ç—å —Å–∏—Å—Ç–µ–º—ã", "–ü–æ–¥–≤–∏–∂–Ω—ã–µ –∏–≥—Ä—ã/—Å–ø–æ—Ä—Ç/–≥–æ–Ω—è—Ç—å",
                 "–í—ã—Å—Ç—É–ø–∞—Ç—å/–±—ã—Ç—å –∑–∞–º–µ—Ç–Ω—ã–º(–æ–π)", "–†–∏—Å–æ–≤–∞—Ç—å/—É–∫—Ä–∞—à–∞—Ç—å/–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ", "–û–±—â–∞—Ç—å—Å—è/–º–∏—Ä–∏—Ç—å/–∑–∞–±–æ—Ç–∏—Ç—å—Å—è",
                 "–ß–∏—Ç–∞—Ç—å/—É–∑–Ω–∞–≤–∞—Ç—å/–∑–∞–¥–∞–≤–∞—Ç—å ‚Äò–ø–æ—á–µ–º—É‚Äô", "–ü—Ä–∏–¥—É–º—ã–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞/—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏/–∏–≥—Ä—ã"]},
    {"id": "q_teen_dream", "stage": "childhood", "intent": "teen_dream", "type": "text",
     "text": "–ü–æ–¥—Ä–æ—Å—Ç–∫–æ–º (12‚Äì16) –∫–µ–º —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã—Ç—å –∏–ª–∏ —á–µ–º –∑–∞–Ω–∏–º–∞—Ç—å—Å—è?"},
    {"id": "q_first_success", "stage": "childhood", "intent": "first_success", "type": "text",
     "text": "–ö–∞–∫–æ–µ —Ä–∞–Ω–Ω–µ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ/—Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –≤—Å–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º?"},
    {"id": "q_family_role", "stage": "childhood", "intent": "family_role", "type": "single",
     "text": "–í —Å–µ–º—å–µ/–∫–ª–∞—Å—Å–µ —Ç—ã —á–∞—â–µ –±—ã–ª(–∞) –∫–µ–º?",
     "options": ["–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä/–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π", "–î—É—à–∞ –∫–æ–º–ø–∞–Ω–∏–∏/–∫–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä", "–£–º–Ω–∏–∫/–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å",
                 "–ö—Ä–∞—Å–æ—Ç–∞/—ç—Å—Ç–µ—Ç/—Ç–≤–æ—Ä–µ—Ü –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã", "–ë–æ–µ—Ü/–¥—Ä–∞–π–≤–µ—Ä/–¥–≤–∏–∂", "–õ–∏–¥–µ—Ä/—Å—Ç—Ä–∞—Ç–µ–≥", "–¢–∏—Ö–∏–π –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å"]},
    {"id": "q_child_aversion", "stage": "childhood", "intent": "child_aversion", "type": "text",
     "text": "–ê —á—Ç–æ –≤ –¥–µ—Ç—Å—Ç–≤–µ/—à–∫–æ–ª–µ –±—ã–ª–æ –ø—Ä—è–º —Ç—è–∂–µ–ª–æ/–Ω–µ —Ö–æ—Ç–µ–ª–æ—Å—å –∏ —Ç—ã –∏–∑–±–µ–≥–∞–ª(–∞)? (1‚Äì2 –≤–µ—â–∏)"},
    {"id": "q_parent_expect", "stage": "childhood", "intent": "parent_expect", "type": "text",
     "text": "–ß—Ç–æ –æ—Ç —Ç–µ–±—è ‚Äò–æ–∂–∏–¥–∞–ª–∏‚Äô –≤–∑—Ä–æ—Å–ª—ã–µ (–∫–∞–∫–∏–º(–æ–π) –Ω–∞–¥–æ –±—ã—Ç—å)? –ò –∫–∞–∫ —Ç—ã –∫ —ç—Ç–æ–º—É –æ—Ç–Ω–æ—Å–∏–ª—Å—è(–ª–∞—Å—å)?"},
    {"id": "q_child_energy", "stage": "childhood", "intent": "child_energy", "type": "single",
     "text": "–ì–¥–µ —Ç—ã —á—É–≤—Å—Ç–≤–æ–≤–∞–ª(–∞) —Å–µ–±—è ‚Äò–∂–∏–≤—ã–º(–æ–π)‚Äô –≤ –¥–µ—Ç—Å—Ç–≤–µ —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ?",
     "options": ["–ö–æ–≥–¥–∞ –ø–æ–º–æ–≥–∞–ª(–∞) –ª—é–¥—è–º", "–ö–æ–≥–¥–∞ –∏–∑—É—á–∞–ª(–∞) –∏ –ø–æ–Ω–∏–º–∞–ª(–∞)", "–ö–æ–≥–¥–∞ –¥–µ–ª–∞–ª(–∞) –∫—Ä–∞—Å–∏–≤–æ",
                 "–ö–æ–≥–¥–∞ –¥–≤–∏–≥–∞–ª—Å—è(–ª–∞—Å—å)/—Å–ø–æ—Ä—Ç", "–ö–æ–≥–¥–∞ —É–ø—Ä–∞–≤–ª—è–ª(–∞) –ø—Ä–æ—Ü–µ—Å—Å–æ–º", "–ö–æ–≥–¥–∞ –≤—Å—ë –±—ã–ª–æ –ø–æ –ø–æ–ª–æ—á–∫–∞–º"]},

    # stage: behavior (20-25) ‚Äî –ø–æ–≤–µ–¥–µ–Ω–∏–µ/—Ä–µ—Å—É—Ä—Å—ã/–¥–µ–Ω—å–≥–∏/–≤—Ä–µ–º—è
    {"id": "q_free_time", "stage": "behavior", "intent": "free_time", "type": "text",
     "text": "–ï—Å–ª–∏ –µ—Å—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ 2 —á–∞—Å–∞ –±–µ–∑ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤ ‚Äî —á—Ç–æ —Ç—ã —á–∞—â–µ –≤—Å–µ–≥–æ –¥–µ–ª–∞–µ—à—å?"},
    {"id": "q_money_spend", "stage": "behavior", "intent": "money_spend", "type": "multi",
     "text": "–ù–∞ —á—Ç–æ —Ç—ã –∏–º–ø—É–ª—å—Å–∏–≤–Ω–æ —Ç—Ä–∞—Ç–∏—à—å –¥–µ–Ω—å–≥–∏/—Å–∏–ª—ã? (1‚Äì3)",
     "options": ["–ù–∞ –ª—é–¥–µ–π/–ø–æ–¥–∞—Ä–∫–∏/—Å–µ–º—å—é", "–ù–∞ –æ–±—É—á–µ–Ω–∏–µ/–∫—É—Ä—Å—ã/–∫–Ω–∏–≥–∏", "–ù–∞ –∫—Ä–∞—Å–æ—Ç—É/–æ–¥–µ–∂–¥—É/–¥–æ–º/—É—é—Ç",
                 "–ù–∞ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è/–ø–æ–µ–∑–¥–∫–∏/–∏–≤–µ–Ω—Ç—ã", "–ù–∞ —Å–ø–æ—Ä—Ç/–∑–¥–æ—Ä–æ–≤—å–µ/—Ç–µ–ª–æ", "–ù–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã/—Å–µ—Ä–≤–∏—Å—ã/—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
                 "–ù–∞ –ø–æ—Ä—è–¥–æ–∫/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é/—Å–∏—Å—Ç–µ–º—ã"]},
    {"id": "q_group_role_now", "stage": "behavior", "intent": "group_role_now", "type": "single",
     "text": "–í –≥—Ä—É–ø–ø–µ/–∫–æ–º–∞–Ω–¥–µ —Ç—ã –æ–±—ã—á–Ω–æ –∫—Ç–æ?",
     "options": ["–û—Ä–≥–∞–Ω–∏–∑—É—é –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É—é", "–û–±—ä–µ–¥–∏–Ω—è—é –ª—é–¥–µ–π", "–ü—Ä–æ–¥–∞—é/–ø—Ä–æ–¥–∞–≤–ª–∏–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
                 "–°–æ–∑–¥–∞—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É/—ç—Å—Ç–µ—Ç–∏–∫—É", "–î–∞—é –∏–¥–µ–∏/—Å–º—ã—Å–ª—ã", "–û–±—É—á–∞—é/–æ–±—ä—è—Å–Ω—è—é", "–î–µ–ª–∞—é —Ä—É–∫–∞–º–∏/—Ç–µ–ª–æ–º/–¥–≤–∏–∂"]},
    {"id": "q_decision_style", "stage": "behavior", "intent": "decision_style", "type": "single",
     "text": "–ö–∞–∫ —Ç—ã –ø—Ä–∏–Ω–∏–º–∞–µ—à—å —Ä–µ—à–µ–Ω–∏—è —á–∞—â–µ –≤—Å–µ–≥–æ?",
     "options": ["–ß–µ—Ä–µ–∑ –ª—é–¥–µ–π/–æ—Ç–Ω–æ—à–µ–Ω–∏—è", "–ß–µ—Ä–µ–∑ —Å–º—ã—Å–ª/–∏–¥–µ—é", "–ß–µ—Ä–µ–∑ —Ü–∏—Ñ—Ä—ã/–≤—ã–≥–æ–¥—É", "–ß–µ—Ä–µ–∑ –ø–æ—Ä—è–¥–æ–∫/—Å—Ç—Ä—É–∫—Ç—É—Ä—É",
                 "–ß–µ—Ä–µ–∑ –æ—â—É—â–µ–Ω–∏–µ/–∫—Ä–∞—Å–æ—Ç—É/–≤–∫—É—Å", "–ß–µ—Ä–µ–∑ –¥–µ–π—Å—Ç–≤–∏–µ/–¥–≤–∏–∂–µ–Ω–∏–µ", "–ß–µ—Ä–µ–∑ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é/–ø–ª–∞–Ω"]},
    {"id": "q_long_focus", "stage": "behavior", "intent": "long_focus", "type": "text",
     "text": "–ù–∞ —á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –¥–æ–ª–≥–æ –∏ –±–µ–∑ –Ω–∞—Å–∏–ª–∏—è –Ω–∞–¥ —Å–æ–±–æ–π?"},
    {"id": "q_fast_win", "stage": "behavior", "intent": "fast_win", "type": "text",
     "text": "–ß—Ç–æ —Ç—ã —É–º–µ–µ—à—å –¥–µ–ª–∞—Ç—å –±—ã—Å—Ç—Ä–æ –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∫–æ–≥–¥–∞ –Ω–∞–¥–æ ‚Äò—Å–æ–±—Ä–∞—Ç—å—Å—è –∏ —Å–¥–µ–ª–∞—Ç—å‚Äô?"},

    # stage: antipattern (26-28)
    {"id": "q_avoid", "stage": "antipattern", "intent": "avoid", "type": "text",
     "text": "–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —Ç—ã —Å—Ç–∞–±–∏–ª—å–Ω–æ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—à—å (–∏ –ø—Ä—è–º–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è–µ—à—å—Å—è)?"},
    {"id": "q_hate_task", "stage": "antipattern", "intent": "hate_task", "type": "single",
     "text": "–ß—Ç–æ –¥–ª—è —Ç–µ–±—è —Å–∞–º–æ–µ ‚Äò–Ω–µ–ª—é–±–∏–º–æ–µ‚Äô –∏–∑ —Å–ø–∏—Å–∫–∞?",
     "options": ["–†—É—Ç–∏–Ω–∞/–ø–æ—Ä—è–¥–æ–∫/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã", "–ü—Ä–æ–¥–∞–∂–∏/–¥–∞–≤–∏—Ç—å –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç", "–ü—É–±–ª–∏—á–Ω–æ—Å—Ç—å/—Å—Ü–µ–Ω–∞/–±—ã—Ç—å –∑–∞–º–µ—Ç–Ω—ã–º(–æ–π)",
                 "–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑/–¥—É–º–∞—Ç—å –¥–æ–ª–≥–æ", "–û–±—É—á–∞—Ç—å/–æ–±—ä—è—Å–Ω—è—Ç—å –¥—Ä—É–≥–∏–º", "–ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ", "–¢–µ–ª–µ—Å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞/–¥–≤–∏–∂"]},
    {"id": "q_energy_leak", "stage": "antipattern", "intent": "energy_leak", "type": "text",
     "text": "–ì–¥–µ —Ç—ã —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ ‚Äò—Å–ª–∏–≤–∞–µ—à—å‚Äô —ç–Ω–µ—Ä–≥–∏—é —Å–µ–π—á–∞—Å? (–ª—é–¥–∏/–¥–µ–ª–∞/–º—ã—Å–ª–∏/—Ç–µ–ª–æ/—Ö–∞–æ—Å/–∫–æ–Ω—Ç—Ä–æ–ª—å ‚Äî –∫–∞–∫ —É —Ç–µ–±—è)?"},

    # stage: shifts (29-30) ‚Äî 2 –≤–æ–ø—Ä–æ—Å–∞ –Ω–∞ —Å–º–µ—â–µ–Ω–∏—è
    {"id": "q_shift_1", "stage": "shifts", "intent": "shift_1", "type": "single",
     "text": "–ë—ã–≤–∞–µ—Ç –ª–∏ —Ç–∞–∫: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –µ—Å—Ç—å, –∞ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏—è –ø–æ—á—Ç–∏ –Ω–µ—Ç?",
     "options": ["–î–∞, —á–∞—Å—Ç–æ", "–ò–Ω–æ–≥–¥–∞", "–†–µ–¥–∫–æ", "–ü–æ—á—Ç–∏ –Ω–∏–∫–æ–≥–¥–∞"]},
    {"id": "q_shift_2", "stage": "shifts", "intent": "shift_2", "type": "single",
     "text": "–ß—Ç–æ —á–∞—â–µ —Ä—É–∫–æ–≤–æ–¥–∏—Ç —Ç–≤–æ–∏–º–∏ —Ä–µ—à–µ–Ω–∏—è–º–∏?",
     "options": ["–•–æ—á—É/–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ", "–ù–∞–¥–æ/–¥–æ–ª–∂–µ–Ω(–∞)", "–ß—Ç–æ–±—ã –Ω–µ –æ—Å—É–¥–∏–ª–∏", "–ß—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å", "–ß—Ç–æ–±—ã –¥–æ–∫–∞–∑–∞—Ç—å"]},

    # stage: wrap (31-32) ‚Äî —Ñ–∏–Ω–∞–ª
    {"id": "q_wrap_1", "stage": "wrap", "intent": "wrap_1", "type": "text",
     "text": "–ï—Å–ª–∏ –æ—á–µ–Ω—å —á–µ—Å—Ç–Ω–æ: —á—Ç–æ —Ç—ã —Ö–æ—á–µ—à—å —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Å–µ–±–µ –¥–µ–ª–∞—Ç—å –±–æ–ª—å—à–µ (–±–µ–∑ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏–π)?"},
    {"id": "q_wrap_2", "stage": "wrap", "intent": "wrap_2", "type": "text",
     "text": "–ö–∞–∫–æ–π –æ–¥–∏–Ω –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ —Ç—ã –≥–æ—Ç–æ–≤(–∞) —Å–¥–µ–ª–∞—Ç—å —É–∂–µ –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ?"},
]


# -----------------------------
# State
# -----------------------------
def init_state():
    st.session_state.setdefault("i", 0)
    st.session_state.setdefault("history", [])
    st.session_state.setdefault("name", "")
    st.session_state.setdefault("request", "")
    st.session_state.setdefault("finished", False)


def reset():
    for k in list(st.session_state.keys()):
        del st.session_state[k]
    st.rerun()


def current_q():
    idx = st.session_state["i"]
    if idx >= len(SCENARIO):
        return None
    return SCENARIO[idx]


def validate(q, answer):
    # required always, –∫—Ä–æ–º–µ —Å–ª—É—á–∞–µ–≤ –∫–æ–≥–¥–∞ –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ options
    qtype = q.get("type", "text")
    opts = q.get("options") or []

    if qtype in ("single", "multi") and len(opts) < 2:
        qtype = "text"

    if qtype == "single":
        return isinstance(answer, str) and answer.strip() != ""
    if qtype == "multi":
        return isinstance(answer, list) and len(answer) > 0
    return isinstance(answer, str) and answer.strip() != ""


# -----------------------------
# UI
# -----------------------------
st.set_page_config(page_title="NEO –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (MVP)", page_icon="üß≠", layout="centered")
init_state()

st.title("–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ (MVP)")
st.caption("–§–æ—Ä–º–∞—Ç: –∂–∏–≤–æ–π —Ä–∞–∑–±–æ—Ä. –í–æ–ø—Ä–æ—Å—ã –∏–¥—É—Ç –ø–æ —ç—Ç–∞–ø–∞–º, –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤. –í –∫–æ–Ω—Ü–µ ‚Äî –∫–æ—Ä–æ—Ç–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –∏ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥.")

colA, colB = st.columns([1, 1])
with colA:
    if st.button("üîÑ –°–±—Ä–æ—Å–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É"):
        reset()
with colB:
    if st.button("‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ–π—á–∞—Å"):
        st.session_state["finished"] = True
        st.rerun()

q = current_q()

progress_total = 30
progress_now = min(st.session_state["i"] + 1, progress_total)
st.write(f"–•–æ–¥: –≤–æ–ø—Ä–æ—Å {progress_now} –∏–∑ {progress_total} | —Ñ–∞–∑–∞: {(q or {}).get('stage','wrap')}")

if st.session_state["finished"] or q is None:
    st.success("–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úÖ")
    st.markdown(f"**–ò–º—è:** {st.session_state.get('name') or '‚Äî'}")
    st.markdown(f"**–ó–∞–ø—Ä–æ—Å:** {st.session_state.get('request') or '‚Äî'}")

    st.markdown("### –ß—Ç–æ –¥–∞–ª—å—à–µ")
    st.write("‚Ä¢ –Ø –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª(–∞) —Ç–≤–æ—é —Ç–æ—á–∫—É –ê –∏ –∫–ª—é—á–µ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã –ø–æ —ç—Ç–∞–ø–∞–º.")
    st.write("‚Ä¢ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –º–∞—Å—Ç–µ—Ä—Å–∫–∞—è –≤–µ—Ä—Å–∏—è –æ—Ç—á—ë—Ç–∞ (–ø–æ–∑–∏—Ü–∏–∏, —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è, –¥–µ–Ω—å–≥–∏, –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π).")

    # –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç
    lines = []
    for item in st.session_state["history"]:
        lines.append(
            f"{item['stage']} | {item['intent']}\nQ: {item['q']}\nA: {item['a']}\n"
        )
    txt = "\n".join(lines)
    st.download_button("üì• –°–∫–∞—á–∞—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç (TXT)", data=txt.encode("utf-8"),
                       file_name="neo_transcript.txt", mime="text/plain")

    with st.expander("–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã (–ª–æ–≥)"):
        st.json(st.session_state["history"], expanded=False)

    st.stop()

# show question
st.markdown(f"## {q['text']}")

# IMPORTANT: unique key per turn so textarea doesn't keep previous answer
answer_key = f"answer_{q['id']}_{st.session_state['i']}"

with st.form("form", clear_on_submit=True):
    qtype = q.get("type", "text")
    opts = q.get("options") or []
    if qtype in ("single", "multi") and len(opts) < 2:
        qtype = "text"
        opts = []

    answer = None
    if qtype == "single":
        answer = st.radio("–í—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç:", opts, key=answer_key)
    elif qtype == "multi":
        answer = st.multiselect("–í—ã–±–µ—Ä–∏ 1‚Äì3 –≤–∞—Ä–∏–∞–Ω—Ç–∞:", opts, key=answer_key)
    else:
        answer = st.text_area("–û—Ç–≤–µ—Ç:", height=140, key=answer_key)

    submitted = st.form_submit_button("–î–∞–ª–µ–µ ‚ûú")

if submitted:
    if not validate(q, answer):
        st.error("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å (–∏–ª–∏ –≤—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç), —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.")
        st.stop()

    # save intake fields
    if q["intent"] == "ask_name":
        st.session_state["name"] = str(answer).strip()
    if q["intent"] == "ask_request":
        st.session_state["request"] = str(answer).strip()

    # save history
    st.session_state["history"].append({
        "turn": st.session_state["i"] + 1,
        "question_id": q["id"],
        "stage": q["stage"],
        "intent": q["intent"],
        "q": q["text"],
        "a": answer if isinstance(answer, str) else json.dumps(answer, ensure_ascii=False),
        "ts": int(time.time()),
    })

    st.session_state["i"] += 1

    # auto-finish at 30
    if st.session_state["i"] >= progress_total:
        st.session_state["finished"] = True

    st.rerun()
