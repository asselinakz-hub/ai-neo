import os
import re
import json
import uuid
from datetime import datetime, timezone
from pathlib import Path
import streamlit as st

# –í–ê–ñ–ù–û: set_page_config –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–∞–º—ã–º –ø–µ—Ä–≤—ã–º Streamlit-–≤—ã–∑–æ–≤–æ–º
st.set_page_config(
    page_title="NEO –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ (MVP)",
    page_icon="üí†",
    layout="centered",
)

# ======================
# CONFIG / PATHS
# ======================
APP_VERSION = "mvp-7.0-clean"

DATA_DIR = Path("data")
SESSIONS_DIR = DATA_DIR / "sessions"
SESSIONS_DIR.mkdir(parents=True, exist_ok=True)

KNOWLEDGE_DIR = Path("knowledge")  # –æ–∂–∏–¥–∞–µ–º ./knowledge/*.md

# Secrets / env
MASTER_PASSWORD = st.secrets.get("MASTER_PASSWORD", os.getenv("MASTER_PASSWORD", ""))
OPENAI_API_KEY = st.secrets.get("OPENAI_API_KEY", os.getenv("OPENAI_API_KEY", ""))
DEFAULT_MODEL = st.secrets.get("OPENAI_MODEL", os.getenv("OPENAI_MODEL", "gpt-4.1-mini"))

# ======================
# UTILS
# ======================
def utcnow_iso() -> str:
    return datetime.now(timezone.utc).isoformat().replace("+00:00", "Z")

def safe_model_name(model: str) -> str:
    # –µ—Å–ª–∏ –≤–≤–µ–¥—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—É—é –º–æ–¥–µ–ª—å, –º–æ–∂–Ω–æ ‚Äú–ø—Ä–∏–±–∏—Ç—å‚Äù –∫ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π
    m = (model or "").strip()
    if not m:
        return DEFAULT_MODEL
    if m.startswith("gpt-5"):
        return DEFAULT_MODEL
    return m

def get_openai_client():
    if not OPENAI_API_KEY:
        return None
    try:
        from openai import OpenAI
        return OpenAI(api_key=OPENAI_API_KEY)
    except Exception:
        return None

# ======================
# QUESTIONS (25)
# ======================
def question_plan():
    """
    –§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è (human + situational).
    –õ–æ–≥–∏–∫–∞: —Å–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–æ–≥—Ä–µ–≤+–∫–æ–Ω—Ç–µ–∫—Å—Ç -> –Ω–∞—Å—Ç–æ—è—â–µ–µ -> –±—ã—Å—Ç—Ä—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏ (3 —Å–µ–∫) ->
    –¥–µ—Ç—Å—Ç–≤–æ -> –ø–æ–≤–µ–¥–µ–Ω–∏–µ -> –∞–Ω—Ç–∏-–ø–∞—Ç—Ç–µ—Ä–Ω—ã.
    """
    return [
        # =========================
        # 0) INTAKE (–∫–æ–Ω—Ç–µ–∫—Å—Ç)
        # =========================
        {"id": "intake.ask_name", "stage": "intake", "intent": "ask_name", "type": "text",
         "text": "–ö–∞–∫ –º–Ω–µ –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è? (–∏–º—è/–∫–∞–∫ —É–¥–æ–±–Ω–æ)"},
        {"id": "intake.ask_request", "stage": "intake", "intent": "ask_request", "type": "text",
         "text": "–° –∫–∞–∫–∏–º –∑–∞–ø—Ä–æ—Å–æ–º —Ç—ã –ø—Ä–∏—à—ë–ª(–ø—Ä–∏—à–ª–∞)? –ß—Ç–æ —Ö–æ—á–µ—à—å –ø–æ–Ω—è—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å? (1‚Äì2 —Ñ—Ä–∞–∑—ã)"},
        {"id": "intake.contact", "stage": "intake", "intent": "contact", "type": "text",
         "text": "–û—Å—Ç–∞–≤—å —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email (–∫—É–¥–∞ –º–∞—Å—Ç–µ—Ä —Å–º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç). –ú–æ–∂–Ω–æ –æ–¥–Ω–æ –ø–æ–ª–µ."},
        {"id": "intake.current_state", "stage": "intake", "intent": "current_state", "type": "text",
         "text": "–ï—Å–ª–∏ –∫–æ—Ä–æ—Ç–∫–æ: —á—Ç–æ —Å–µ–π—á–∞—Å –≤ –∂–∏–∑–Ω–∏ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ù–ï —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏–ª–∏ –∑–∞–±–∏—Ä–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é?"},
        {"id": "intake.goal_3m", "stage": "intake", "intent": "goal_3m", "type": "text",
         "text": "–ü—Ä–µ–¥—Å—Ç–∞–≤—å: –ø—Ä–æ—à–ª–æ 3 –º–µ—Å—è—Ü–∞ –∏ —Å—Ç–∞–ª–æ –ª—É—á—à–µ. –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –±—ã –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å? (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ)"},
        {"id": "intake.priority_area", "stage": "intake", "intent": "priority_area", "type": "single",
         "column": "motivation",
         "text": "–ß—Ç–æ –≤–∞–∂–Ω–µ–µ –≤—Å–µ–≥–æ –ø—Ä–æ—è—Å–Ω–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è?",
         "options": ["–†–µ–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ–ª–æ", "–î–µ–Ω—å–≥–∏/–¥–æ—Ö–æ–¥", "–û—Ç–Ω–æ—à–µ–Ω–∏—è/–ª—é–¥–∏", "–≠–Ω–µ—Ä–≥–∏—è/—Å–∏–ª—ã", "–°–º—ã—Å–ª/–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"]},
        # =========================
        # 1) NOW (–Ω–∞—Å—Ç–æ—è—â–µ–µ)
        # =========================
        {"id": "now.easy_tasks", "stage": "now", "intent": "easy_tasks", "type": "text",
         "column": "instrument",
         "text": "–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —Ç–µ–±–µ –æ–±—ã—á–Ω–æ –¥–∞—é—Ç—Å—è –ª–µ–≥–∫–æ (–∫–∞–∫ –±—É–¥—Ç–æ —Å–∞–º–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è)?"},
        {"id": "now.praise_for", "stage": "now", "intent": "praise_for", "type": "text",
         "column": "instrument",
         "text": "–ó–∞ —á—Ç–æ —Ç–µ–±—è —á–∞—â–µ –≤—Å–µ–≥–æ —Ö–≤–∞–ª—è—Ç –ª—é–¥–∏? (1‚Äì3 –ø—É–Ω–∫—Ç–∞)"},
         {"id": "now.time_flow", "stage": "now", "intent": "time_flow", "type": "text",
         "column": "motivation",
         "text": "–í –∫–∞–∫–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ç—ã —Ç–µ—Ä—è–µ—à—å —Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏?"},
        {"id": "now.stress_pattern", "stage": "now", "intent": "stress_pattern", "type": "single",
         "text": "–ö–æ–≥–¥–∞ —Å—Ç—Ä–µ—Å—Å/–¥–∞–≤–ª–µ–Ω–∏–µ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–∞—â–µ –≤—Å–µ–≥–æ?",
         "options": ["–£—Å–∫–æ—Ä—è—é—Å—å –∏ —Å—Ç–∞–Ω–æ–≤–ª—é—Å—å —Ä–µ–∑–∫–æ–π(–∏–º)", "–£—Ö–æ–∂—É –≤ —Å–µ–±—è –∏ –º–æ–ª—á—É", "–ù–∞—á–∏–Ω–∞—é –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë", "–°—Ç–∞–Ω–æ–≤–ª—é—Å—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π(—ã–º)", "–ó–∞–º–∏—Ä–∞—é/–ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∏—Ä—É—é"]},
         {"id": "now.energy_fill", "stage": "now", "intent": "energy_fill", "type": "multi",
         "column": "motivation",
         "text": "–ß—Ç–æ —Ç–µ–±—è —Ä–µ–∞–ª—å–Ω–æ –Ω–∞–ø–æ–ª–Ω—è–µ—Ç (–≤—ã–±–µ—Ä–∏ 1‚Äì4)?",
         "options": ["–û–±—â–µ–Ω–∏–µ –∏ –±–ª–∏–∑–∫–∏–µ –ª—é–¥–∏", "–ö—Ä–∞—Å–∏–≤—ã–µ –º–µ—Å—Ç–∞/—ç—Å—Ç–µ—Ç–∏–∫–∞/—É—é—Ç", "–¢–∏—à–∏–Ω–∞/—á—Ç–µ–Ω–∏–µ/–º—ã—Å–ª–∏", "–£—á—ë–±–∞/–æ–±—É—á–µ–Ω–∏–µ/–Ω–æ–≤—ã–µ –∑–Ω–∞–Ω–∏—è", "–°–ø–æ—Ä—Ç/–¥–≤–∏–∂–µ–Ω–∏–µ/—Ç–µ–ª–æ", "–°—Ü–µ–Ω–∞/–∏–≤–µ–Ω—Ç—ã/–≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è"]},
          {"id": "now.best_result_example", "stage": "now", "intent": "best_result_example", "type": "text",
         "column": "instrument",
         "text": "–î–∞–π 1 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏–∑ –∂–∏–∑–Ω–∏: —Å–∏—Ç—É–∞—Ü–∏—è ‚Üí —á—Ç–æ —Ç—ã —Å–¥–µ–ª–∞–ª(–∞) ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Ç–æ, —á—Ç–æ —É —Ç–µ–±—è –ø–æ–ª—É—á–∞–µ—Ç—Å—è –ª—É—á—à–µ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞)."},
        {"id": "now.motivation_trigger", "stage": "now", "intent": "motivation_trigger", "type": "single",
         "column": "motivation",
         "text": "–ß—Ç–æ —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ —Ç–µ–±—è –∑–∞–≤–æ–¥–∏—Ç/–≤–∫–ª—é—á–∞–µ—Ç?",
         "options": ["–¶–µ–ª—å/—Å—Ç—Ä–∞—Ç–µ–≥–∏—è/–≤–µ–∫—Ç–æ—Ä", "–õ—é–¥–∏/—Å–≤—è–∑—å/–≤–ª–∏—è–Ω–∏–µ", "–ö—Ä–∞—Å–æ—Ç–∞/—É—é—Ç/—ç—Å—Ç–µ—Ç–∏–∫–∞", "–°–º—ã—Å–ª/–∏–¥–µ—è/–≥–ª—É–±–∏–Ω–∞", "–î—Ä–∞–π–≤/—Å—Ü–µ–Ω–∞/—ç–º–æ—Ü–∏–∏", "–î–µ–Ω—å–≥–∏/—Ä–µ–∑—É–ª—å—Ç–∞—Ç/—Å–∫–æ—Ä–æ—Å—Ç—å"]},
        # =========================
        # 2) SCENARIOS (–ø–µ—Ä–≤—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã)
        # =========================
        {"id": "now.attention_first", "stage": "now", "intent": "attention_first", "type": "single",
         "column": "perception",
         "text": "–ö–æ–≥–¥–∞ –ø–æ–ø–∞–¥–∞–µ—à—å –≤ –Ω–æ–≤—É—é —Å–∏—Ç—É–∞—Ü–∏—é, —á—Ç–æ —Ç—ã –∑–∞–º–µ—á–∞–µ—à—å –ø–µ—Ä–≤—ã–º?",
         "options": ["–õ—é–¥–µ–π/—ç–º–æ—Ü–∏–∏", "–°–º—ã—Å–ª/–∏–¥–µ—é/–ø–æ—á–µ–º—É —Ç–∞–∫", "–î–µ–Ω—å–≥–∏/–≤—ã–≥–æ–¥—É/—Ä–µ—Å—É—Ä—Å—ã", "–†–∏—Å–∫–∏/—Å–∏—Å—Ç–µ–º—É/–ø–æ—Ä—è–¥–æ–∫", "–ö—Ä–∞—Å–æ—Ç—É/–∞—Ç–º–æ—Å—Ñ–µ—Ä—É"]},
        {"id": "scn.listen_focus", "stage": "scenarios", "intent": "listen_focus", "type": "single",
         "text": "–ö–æ–≥–¥–∞ —Ç—ã —Å–ª—É—à–∞–µ—à—å —á–µ–ª–æ–≤–µ–∫–∞, —á—Ç–æ —Ç—ã –ª–æ–≤–∏—à—å –ø–µ—Ä–≤—ã–º?",
         "options": ["–≠–º–æ—Ü–∏—é/–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", "–°–º—ã—Å–ª/–º—ã—Å–ª—å", "–õ–æ–≥–∏–∫—É/—Å—Ç—Ä—É–∫—Ç—É—Ä—É", "–í—ã–≥–æ–¥—É/—Ä–µ—Å—É—Ä—Å—ã", "–ü–æ–¥–∞—á—É/–≤–∫—É—Å/—ç—Å—Ç–µ—Ç–∏–∫—É"]},
        {"id": "behavior.decision_style", "stage": "behavior", "intent": "decision_style", "type": "single",
         "column": "instrument",
         "text": "–ö–∞–∫ —Ç—ã –ø—Ä–∏–Ω–∏–º–∞–µ—à—å —Ä–µ—à–µ–Ω–∏—è —á–∞—â–µ –≤—Å–µ–≥–æ?",
         "options": ["–ß–µ—Ä–µ–∑ –≤—ã–≥–æ–¥—É/—Ü–∏—Ñ—Ä—ã", "–ß–µ—Ä–µ–∑ —á—É–≤—Å—Ç–≤–æ/–∏–Ω—Ç—É–∏—Ü–∏—é", "–ß–µ—Ä–µ–∑ —Å–º—ã—Å–ª/—Ü–µ–Ω–Ω–æ—Å—Ç–∏", "–ß–µ—Ä–µ–∑ –ª—é–¥–µ–π/–æ—Ç–Ω–æ—à–µ–Ω–∏—è", "–ß–µ—Ä–µ–∑ –ø–æ—Ä—è–¥–æ–∫/–ø—Ä–∞–≤–∏–ª–∞"]},
        {"id": "scn.project_start", "stage": "scenarios", "intent": "project_start", "type": "single",
         "text": "–¢–µ–±–µ –¥–∞–ª–∏ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç. –ß—Ç–æ —Ç—ã –¥–µ–ª–∞–µ—à—å –ø–µ—Ä–≤—ã–º —à–∞–≥–æ–º?",
         "options": ["–°—Ç–∞–≤–ª—é —Ü–µ–ª—å –∏ –ø–ª–∞–Ω", "–°–æ–±–∏—Ä–∞—é –ª—é–¥–µ–π/—Å–≤—è–∑–∏", "–ò—â—É —Å–º—ã—Å–ª/–∫–æ–Ω—Ü–µ–ø—Ü–∏—é",
                     "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É—é/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∏—Ä—É—é", "–î–µ–ª–∞—é –∫—Ä–∞—Å–∏–≤–æ/—É–ø–∞–∫–æ–≤—ã–≤–∞—é", "–î–∞–≤–ª—é –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç"]},
        {"id": "scn.conflict_style", "stage": "scenarios", "intent": "conflict_style", "type": "single",
         "text": "–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç/–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, —Ç—ã —á–∞—â–µ‚Ä¶",
         "options": ["–°–≥–ª–∞–∂–∏–≤–∞—é –∏ –æ–±—ä–µ–¥–∏–Ω—è—é", "–î–∞–≤–ª—é –∏ –ø—Ä–æ–±–∏–≤–∞—é", "–£—Ö–æ–∂—É –≤ –≥–ª—É–±–∏–Ω—É: ¬´–≤ —á—ë–º —Å–º—ã—Å–ª?¬ª",
                     "–°—Ç–∞–≤–ª—é —Ä–∞–º–∫–∏/–ø—Ä–∞–≤–∏–ª–∞", "–ü–µ—Ä–µ–≤–æ–∂—É –≤ —ç–º–æ—Ü–∏—é/—Å—Ü–µ–Ω—É", "–°—Ç–∞—Ä–∞—é—Å—å –±—ã—Å—Ç—Ä–æ –∑–∞–∫—Ä—ã—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ –¥–µ–ª—É"]},
        {"id": "scn.feedback_pain", "stage": "scenarios", "intent": "feedback_pain", "type": "single",
         "text": "–ß—Ç–æ —Ç–µ–±—è —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ –≤—ã–±–∏–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ —á—Ç–æ-—Ç–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è?",
         "options": ["–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞/–¥–µ–Ω–µ–≥", "–ù–µ—Ç —Å–º—ã—Å–ª–∞", "–õ—é–¥–∏ –Ω–µ –æ—Ç–∫–ª–∏–∫–∞—é—Ç—Å—è", "–ë–∞—Ä–¥–∞–∫/—Ö–∞–æ—Å", "–ù–µ –∫—Ä–∞—Å–∏–≤–æ/–Ω–µ —Ç–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç", "–ù–µ—Ç –¥—Ä–∞–π–≤–∞/—Å–∫—É—á–Ω–æ"]},
        {"id": "scn.ideal_day", "stage": "scenarios", "intent": "ideal_day", "type": "single",
         "text": "–ò–¥–µ–∞–ª—å–Ω—ã–π –¥–µ–Ω—å –¥–ª—è —Ç–µ–±—è ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ –≤ –Ω—ë–º –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ‚Ä¶",
         "options": ["–¶–µ–ª–µ–π –∏ –¥–≤–∏–∂–µ–Ω–∏—è –∫ –Ω–∏–º", "–õ—é–¥–µ–π –∏ –æ–±—â–µ–Ω–∏—è", "–ö—Ä–∞—Å–æ—Ç—ã –∏ —É—é—Ç–∞", "–°–º—ã—Å–ª–∞ –∏ –≥–ª—É–±–∏–Ω—ã",
                     "–≠–º–æ—Ü–∏–π –∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–π", "–†–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏ –¥–µ–Ω–µ–≥"]},

        # =========================
        # 3) CHILDHOOD (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏—Ä–æ–¥–Ω–æ–≥–æ)
        # =========================
        {"id": "childhood.child_play", "stage": "childhood", "intent": "child_play", "type": "multi",
         "text": "–í –¥–µ—Ç—Å—Ç–≤–µ (6‚Äì12) —á—Ç–æ —Ç—ã –ª—é–±–∏–ª(–∞) –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ? 1‚Äì3 –≤–∞—Ä–∏–∞–Ω—Ç–∞.",
         "options": ["–ö–æ–º–∞–Ω–¥–æ–≤–∞—Ç—å/–æ—Ä–≥–∞–Ω–∏–∑–æ–≤—ã–≤–∞—Ç—å", "–£—á–∏—Ç—å—Å—è/—á–∏—Ç–∞—Ç—å/–æ–±—ä—è—Å–Ω—è—Ç—å", "–í—ã—Å—Ç—É–ø–∞—Ç—å/–±—ã—Ç—å –∑–∞–º–µ—Ç–Ω—ã–º(–æ–π)",
                     "–î—Ä—É–∂–∏—Ç—å/–æ–±—â–∞—Ç—å—Å—è/–º–∏—Ä–∏—Ç—å", "–†–∏—Å–æ–≤–∞—Ç—å/—É–∫—Ä–∞—à–∞—Ç—å/–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ", "–ë–µ–≥–∞—Ç—å/—Å–æ—Ä–µ–≤–Ω–æ–≤–∞—Ç—å—Å—è/–¥–≤–∏–∂–µ–Ω–∏–µ"]},
        {"id": "childhood.teen_dream", "stage": "childhood", "intent": "teen_dream", "type": "text",
         "text": "–ü–æ–¥—Ä–æ—Å—Ç–∫–æ–º (12‚Äì16) –∫–µ–º —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã—Ç—å –∏–ª–∏ —á–µ–º –∑–∞–Ω–∏–º–∞—Ç—å—Å—è?"},
        {"id": "childhood.first_success", "stage": "childhood", "intent": "first_success", "type": "text",
         "text": "–ö–∞–∫–æ–µ —Ä–∞–Ω–Ω–µ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ/—Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –≤—Å–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º?"},
        {"id": "childhood.family_role", "stage": "childhood", "intent": "family_role", "type": "single",
         "text": "–í —Å–µ–º—å–µ/–∫–ª–∞—Å—Å–µ —Ç—ã —á–∞—â–µ –±—ã–ª(–∞) –∫–µ–º?",
         "options": ["–õ–∏–¥–µ—Ä/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä", "–î—É—à–∞ –∫–æ–º–ø–∞–Ω–∏–∏/–∫–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä", "–£–º–Ω–∏–∫/–∞–Ω–∞–ª–∏—Ç–∏–∫",
                     "–¢–≤–æ—Ä—á–µ—Å–∫–∏–π/—ç—Å—Ç–µ—Ç", "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π/—Å–æ—Ä–µ–≤–Ω–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π", "–¢–∏—Ö–∏–π –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å"]},
        {"id": "childhood.child_aversion", "stage": "childhood", "intent": "child_aversion", "type": "text",
         "text": "–ß—Ç–æ –≤ –¥–µ—Ç—Å—Ç–≤–µ/—à–∫–æ–ª–µ –±—ã–ª–æ –ø—Ä—è–º —Ç—è–∂–µ–ª–æ –∏ —Ç—ã –∏–∑–±–µ–≥–∞–ª(–∞)? (1‚Äì2 –≤–µ—â–∏)"},
        {"id": "childhood.parent_expect", "stage": "childhood", "intent": "parent_expect", "type": "text",
         "text": "–ß—Ç–æ –æ—Ç —Ç–µ–±—è –æ–∂–∏–¥–∞–ª–∏ –≤–∑—Ä–æ—Å–ª—ã–µ (¬´–Ω–∞–¥–æ –±—ã—Ç—å‚Ä¶¬ª)? –ò –∫–∞–∫ —Ç—ã –∫ —ç—Ç–æ–º—É –æ—Ç–Ω–æ—Å–∏–ª—Å—è(–ª–∞—Å—å)?"},
        {"id": "childhood.child_energy", "stage": "childhood", "intent": "child_energy", "type": "text",
         "text": "–ì–¥–µ —Ç—ã —á—É–≤—Å—Ç–≤–æ–≤–∞–ª(–∞) —Å–µ–±—è ¬´–∂–∏–≤—ã–º(–æ–π)¬ª –≤ –¥–µ—Ç—Å—Ç–≤–µ —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ? (—Å–∏—Ç—É–∞—Ü–∏—è)"},
        {"id": "childhood.child_pride", "stage": "childhood", "intent": "child_pride", "type": "text",
         "text": "–ó–∞ —á—Ç–æ —Ç—ã —Å–æ–±–æ–π –≤ –¥–µ—Ç—Å—Ç–≤–µ —Ä–µ–∞–ª—å–Ω–æ –≥–æ—Ä–¥–∏–ª—Å—è(–ª–∞—Å—å)? (1 –ø—Ä–∏–º–µ—Ä)"},

        # =========================
        # 4) BEHAVIOR (–∫–∞–∫ –∂–∏–≤—ë—Ç —Å–µ–π—á–∞—Å)
        # =========================
        {"id": "behavior.free_time", "stage": "behavior", "intent": "free_time", "type": "text",
         "text": "–ï—Å–ª–∏ –µ—Å—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ 2 —á–∞—Å–∞ –±–µ–∑ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤ ‚Äî —á—Ç–æ —Ç—ã —á–∞—â–µ –≤—Å–µ–≥–æ –¥–µ–ª–∞–µ—à—å?"},
        {"id": "behavior.money_spend", "stage": "behavior", "intent": "money_spend", "type": "multi",
         "text": "–ù–∞ —á—Ç–æ —Ç—ã –∏–º–ø—É–ª—å—Å–∏–≤–Ω–æ —Ç—Ä–∞—Ç–∏—à—å –¥–µ–Ω—å–≥–∏/—Å–∏–ª—ã? (1‚Äì3)",
         "options": ["–ù–∞ –æ–±—É—á–µ–Ω–∏–µ/–∫—É—Ä—Å—ã/–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é", "–ù–∞ –ø—Ä–æ–µ–∫—Ç—ã/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã/—Ä–∞–±–æ—Ç—É", "–ù–∞ –∫—Ä–∞—Å–æ—Ç—É/–æ–¥–µ–∂–¥—É/–¥–æ–º/—É—é—Ç",
                     "–ù–∞ –ª—é–¥–µ–π/–ø–æ–¥–∞—Ä–∫–∏/—Å–µ–º—å—é", "–ù–∞ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è/–≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è", "–ù–∞ –∑–¥–æ—Ä–æ–≤—å–µ/—Å–ø–æ—Ä—Ç"]},
        {"id": "behavior.group_role_now", "stage": "behavior", "intent": "group_role_now", "type": "single",
         "column": "instrument",
         "text": "–í –≥—Ä—É–ø–ø–µ/–∫–æ–º–∞–Ω–¥–µ —Ç—ã –æ–±—ã—á–Ω–æ –∫—Ç–æ?",
         "options": ["–û–±—ä–µ–¥–∏–Ω—è—é –ª—é–¥–µ–π", "–ü—Ä–æ–¥–∞–≤–ª–∏–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç", "–ü—Ä–∏–¥—É–º—ã–≤–∞—é —Å–º—ã—Å–ª/–∏–¥–µ—é", "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É—é/–ø–æ—Ä—è–¥–æ–∫", "–î–µ–ª–∞—é –∫—Ä–∞—Å–∏–≤–æ/–∞—Ç–º–æ—Å—Ñ–µ—Ä—É", "–í–¥–æ—Ö–Ω–æ–≤–ª—è—é/–∑–∞–∂–∏–≥–∞—é"]},
        {"id": "behavior.long_focus", "stage": "behavior", "intent": "long_focus", "type": "text",
         "column": "perception",
         "text": "–ù–∞ —á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –¥–æ–ª–≥–æ –∏ –±–µ–∑ –Ω–∞—Å–∏–ª–∏—è –Ω–∞–¥ —Å–æ–±–æ–π?"},
        {"id": "behavior.fast_win", "stage": "behavior", "intent": "fast_win", "type": "text",
         "column": "instrument",
         "text": "–ß—Ç–æ —Ç—ã —É–º–µ–µ—à—å –¥–µ–ª–∞—Ç—å –±—ã—Å—Ç—Ä–æ –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∫–æ–≥–¥–∞ –Ω–∞–¥–æ ‚Äò—Å–æ–±—Ä–∞—Ç—å—Å—è –∏ —Å–¥–µ–ª–∞—Ç—å‚Äô? (1‚Äì3 –ø—Ä–∏–º–µ—Ä–∞)"},
        {"id": "behavior.teach_people", "stage": "behavior", "intent": "teach_people", "type": "text",
         "text": "–ï—Å–ª–∏ –±—ã —Ç—ã —É—á–∏–ª(–∞) –ª—é–¥–µ–π –æ–¥–Ω–æ–º—É –Ω–∞–≤—ã–∫—É, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ç—ã —Å–∏–ª—å–Ω—ã–π(–∞—è) ‚Äî —á—Ç–æ —ç—Ç–æ –±—ã–ª–æ –±—ã?"},

        # =========================
        # 5) ANTIPATTERN (–≥–¥–µ –ª–æ–º–∞–µ—Ç—Å—è —ç–Ω–µ—Ä–≥–∏—è)
        # =========================
        {"id": "antipattern.avoid", "stage": "antipattern", "intent": "avoid", "type": "text",
         "text": "–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —Ç—ã —Å—Ç–∞–±–∏–ª—å–Ω–æ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—à—å (–∏ –ø—Ä—è–º–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è–µ—à—å—Å—è)?"},
        {"id": "antipattern.hate_task", "stage": "antipattern", "intent": "hate_task", "type": "single",
         "text": "–ß—Ç–æ –¥–ª—è —Ç–µ–±—è —Å–∞–º–æ–µ ¬´–Ω–µ–ª—é–±–∏–º–æ–µ¬ª –∏–∑ —Å–ø–∏—Å–∫–∞?",
         "options": ["–†—É—Ç–∏–Ω–∞/–ø–æ—Ä—è–¥–æ–∫/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã", "–î–æ–ª–≥–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –Ω–∏ –æ —á—ë–º", "–ü—Ä–æ–¥–∞–∂–∏/–∑–∞—è–≤–ª—è—Ç—å –æ —Å–µ–±–µ",
                     "–£—á—ë–±–∞/–∑—É–±—Ä—ë–∂–∫–∞", "–§–∏–∑–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞", "–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã/–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ"]},
        {"id": "antipattern.energy_leak", "stage": "antipattern", "intent": "energy_leak", "type": "text",
         "text": "–ì–¥–µ —Ç—ã —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ ¬´—Å–ª–∏–≤–∞–µ—à—å¬ª —ç–Ω–µ—Ä–≥–∏—é —Å–µ–π—á–∞—Å? (–ª—é–¥–∏/–¥–µ–ª–∞/–º—ã—Å–ª–∏/—Ç–µ–ª–æ/—Ö–∞–æ—Å/–∫–æ–Ω—Ç—Ä–æ–ª—å ‚Äî –∫–∞–∫ —É —Ç–µ–±—è)"},
        {"id": "antipattern.perfection_trap", "stage": "antipattern", "intent": "perfection_trap", "type": "single",
         "text": "–ß—Ç–æ —á–∞—â–µ –º–µ—à–∞–µ—Ç —Ç–µ–±–µ –¥–≤–∏–≥–∞—Ç—å—Å—è –±—ã—Å—Ç—Ä–µ–µ?",
         "options": ["–•–æ—á—É –∏–¥–µ–∞–ª—å–Ω–æ ‚Äî –ø–æ—ç—Ç–æ–º—É —Ç—è–Ω—É", "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∏–¥–µ–π ‚Äî —Å–ª–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å", "–ù–µ—Ç –ª—é–¥–µ–π —Ä—è–¥–æ–º ‚Äî —Ç—è–∂–µ–ª–æ –æ–¥–Ω–æ–º—É(–æ–¥–Ω–æ–π)",
                     "–ù–µ—Ç —Å–º—ã—Å–ª–∞ ‚Äî –Ω–µ –≤–∫–ª—é—á–∞—é—Å—å", "–†—É—Ç–∏–Ω–∞ —É–±–∏–≤–∞–µ—Ç ‚Äî –≤—ã–∫–ª—é—á–∞—é—Å—å", "–°—Ç—Ä–∞—Ö –ø—Ä–æ—è–≤–ª—è—Ç—å—Å—è/–±—ã—Ç—å –≤–∏–¥–∏–º—ã–º(–æ–π)"]},
    ]

# ======================
# SCORING (–ª–µ–≥–∫–∏–π)
# ======================
# ======================
# SCORING (v1.1 ‚Äî –ø–æ–¥ –Ω–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã)
# ======================
import re

POTS = ["–Ø–Ω—Ç–∞—Ä—å","–®—É–Ω–≥–∏—Ç","–¶–∏—Ç—Ä–∏–Ω","–ò–∑—É–º—Ä—É–¥","–†—É–±–∏–Ω","–ì—Ä–∞–Ω–∞—Ç","–°–∞–ø—Ñ–∏—Ä","–ì–µ–ª–∏–æ–¥–æ—Ä","–ê–º–µ—Ç–∏—Å—Ç"]

COLUMNS = ["perception", "motivation", "instrument"]

COL_LABELS = {
    "perception": "–í–û–°–ü–†–ò–Ø–¢–ò–ï",
    "motivation": "–ú–û–¢–ò–í–ê–¶–ò–Ø",
    "instrument": "–ò–ù–°–¢–†–£–ú–ï–ù–¢",
}

# ======================
# CANON (school text) ‚Äî ONLY FOR REPORT, NOT FOR SCORING
# ======================

def _s(x) -> str:
    return (str(x or "").strip())

POT_CANON = {
    "–°–∞–ø—Ñ–∏—Ä": {
        "perception": {
            "title": "–°–∞–ø—Ñ–∏—Ä ‚Äî 1 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ/–∞–Ω–∞–ª–∏–∑)",
            "lines": [
                "–ö–∞–Ω–∞–ª –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è: **–∑–≤—É–∫ / –≤–∏–±—Ä–∞—Ü–∏—è –∏–¥–µ–∏**. –í–æ—Å–ø—Ä–∏—è—Ç–∏–µ —á–µ—Ä–µ–∑ ¬´–ø—Ä–∏—Å–ª—É—à–∞—Ç—å—Å—è –∫ —Å–µ–±–µ¬ª.",
                "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç **—Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∏–¥–µ–∏/—Ç–µ–æ—Ä–∏–∏/—É–±–µ–∂–¥–µ–Ω–∏—è/–º—ã—à–ª–µ–Ω–∏—è**: ¬´–∑–≤—É—á–∏—Ç / –Ω–µ –∑–≤—É—á–∏—Ç¬ª, ¬´–≤ –Ω–æ—Ç—É / –Ω–µ –≤ –Ω–æ—Ç—É¬ª.",
                "–ß—É–≤—Å—Ç–≤—É–µ—Ç –¥–∏—Å–≥–∞—Ä–º–æ–Ω–∏—é —Å–º—ã—Å–ª–æ–≤ –∏ –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å, **–∫–∞–∫–∞—è –º—ã—Å–ª—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç** –∏ –∫–∞–∫ –µ—ë –∏—Å–ø—Ä–∞–≤–∏—Ç—å.",
                "–ü–∞–º—è—Ç—å: **–ª—É—á—à–µ –≤—Å–µ–≥–æ –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç —Ç–æ, —á—Ç–æ —Å–ª—ã—à–∏—Ç**. –õ—é–±–∏—Ç —Ç–∏—à–∏–Ω—É, –º–æ–∂–µ—Ç —É—Å—Ç–∞–≤–∞—Ç—å –æ—Ç —à—É–º–∞."
            ],
            "intuition": [
                "–ò–Ω—Ç—É–∏—Ü–∏—è: **—è—Å–Ω–æ—Å–ª—ã—à–∞–Ω–∏–µ** (—Å–ª—ã—à–∞—Ç—å —Å–µ–±—è/–¥—É—Ö).",
                "–í–∞–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –ª—É—á—à–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –≤ —Ç–∏—à–∏–Ω–µ/–Ω–∞ –ø—Ä–∏—Ä–æ–¥–µ: –º–µ–Ω—å—à–µ —à—É–º–∞ ‚Äî –ª—É—á—à–µ —Å–ª—ã—à–Ω–æ —Å–µ–±—è.",
            ],
        },
        "motivation": {
            "title": "–°–∞–ø—Ñ–∏—Ä ‚Äî 2 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (—Ü–µ–ª—å/–º–æ—Ç–∏–≤–∞—Ü–∏—è/–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)",
            "lines": [
                "–ö–ª—é—á–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å —Ü–µ–ª–∏: **—Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–º—ã—Å–ª–æ–≤, –∏–¥–µ–π, —Ñ–∏–ª–æ—Å–æ—Ñ–∏–π, –∫–æ–Ω—Ü–µ–ø—Ü–∏–π, –º–æ–¥–µ–ª–µ–π –º—ã—à–ª–µ–Ω–∏—è** (–∏/–∏–ª–∏ –º—É–∑—ã–∫–∏).",
                "–ó–∞—á–µ–º —Ç–≤–æ—Ä—é: **–∏–∑–æ–±—Ä–µ—Å—Ç–∏ –Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç, –∏–¥–µ—é, —Ç–µ–æ—Ä–∏—é**.",
                "–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: **–¥—É—Ö–æ–≤–Ω—ã–π –ø—Ä–æ–≤–æ–¥–Ω–∏–∫ / –≥—É—Ä—É / –ø–æ—ç—Ç / —Ñ–∏–ª–æ—Å–æ—Ñ**."
            ]
        },
        "instrument": {
            "title": "–°–∞–ø—Ñ–∏—Ä ‚Äî 3 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç/–∫–∞–∫ –¥–µ–ª–∞—é)",
            "lines": [
                "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: **—Å–º—ã—Å–ª–æ–≤–æ–µ –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏–µ** ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π –ø–∞–∑–ª —Å–º—ã—Å–ª–∞ –ø–æ–¥ –∑–∞–ø—Ä–æ—Å —á–µ–ª–æ–≤–µ–∫–∞.",
                "–°–ª—É—à–∞–µ—Ç —Å–∏—Ç—É–∞—Ü–∏—é ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç –Ω–µ–¥–æ—Å—Ç–∞—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é ‚Üí –¥–∞—ë—Ç —è—Å–Ω–æ—Å—Ç—å/–∏–¥–µ—é/–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ.",
                "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Å–º—ã—Å–ª–æ–≤, —Å–æ–∑–¥–∞–Ω–∏–µ –∏–¥–µ–π, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫."
            ]
        }
    },

    "–ì–µ–ª–∏–æ–¥–æ—Ä": {
        "perception": {
            "title": "–ì–µ–ª–∏–æ–¥–æ—Ä ‚Äî 1 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ/–∞–Ω–∞–ª–∏–∑)",
            "lines": [
                "–ö–∞–Ω–∞–ª –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è: **–≤–∫—É—Å –∏–¥–µ–∏**. –í–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ **–¥–∏–∞–ª–æ–≥, —Å–ø–æ—Ä, –ø—Ä–æ–≥–æ–≤–∞—Ä–∏–≤–∞–Ω–∏–µ**.",
                "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç **–∏–Ω—Ç–µ—Ä–µ—Å/–ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å —Å–º—ã—Å–ª–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞**: –∑–∞–π–¥—ë—Ç/–Ω–µ –∑–∞–π–¥—ë—Ç, —Å–º–µ—à–Ω–æ/–Ω–µ —Å–º–µ—à–Ω–æ, –±—É–¥–µ—Ç –ª–∏ —Å–ø—Ä–æ—Å.",
                "–ü–∞–º—è—Ç—å: –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç —á–µ—Ä–µ–∑ **–ø—Ä–æ–≥–æ–≤–∞—Ä–∏–≤–∞–Ω–∏–µ**, –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ, —Ä–∞—Å—Å–∫–∞–∑."
            ],
            "intuition": [
                "–ò–Ω—Ç—É–∏—Ü–∏—è –≤ –≥–æ–ª–æ—Å–µ: –æ–±—Å—É–∂–¥–∞–π/—Ä–∞—Å—Å—É–∂–¥–∞–π –≤—Å–ª—É—Ö ‚Äî —Ç–∞–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç.",
                "–ü—Ä–∞–∫—Ç–∏–∫–∞: –∑–∞–¥–∞—ë—à—å –≤–æ–ø—Ä–æ—Å ‚Üí –Ω–∞—á–∏–Ω–∞–µ—à—å —Ä–∞—Å—Å—É–∂–¥–∞—Ç—å –≤—Å–ª—É—Ö (–º–æ–∂–Ω–æ –æ–¥–∏–Ω) ‚Üí —á–µ—Ä–µ–∑ –≥–æ–ª–æ—Å –ø—Ä–∏—Ö–æ–¥–∏—Ç —è—Å–Ω–æ—Å—Ç—å."
            ]
        },
        "motivation": {
            "title": "–ì–µ–ª–∏–æ–¥–æ—Ä ‚Äî 2 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (—Ü–µ–ª—å/–º–æ—Ç–∏–≤–∞—Ü–∏—è/–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)",
            "lines": [
                "–ö–ª—é—á–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å —Ü–µ–ª–∏: **–ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å, –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ, —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π/—Å–º—ã—Å–ª–æ–≤**.",
                "–°–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: —Å—Ü–µ–Ω–∞/—Å–æ—Ü—Å–µ—Ç–∏/–æ—Ä–∞—Ç–æ—Ä—Å—Ç–≤–æ/–ø–µ–Ω–∏–µ ‚Äî –µ—Å–ª–∏ –Ω–µ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è, –º–æ–∂–µ—Ç ¬´–≤—ã–≥–æ–≤–∞—Ä–∏–≤–∞—Ç—å—Å—è¬ª –Ω–∞ –±–ª–∏–∑–∫–∏—Ö.",
                "–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: **—è—Ä–∫–∏–π –≥–æ–ª–æ—Å / –¥–∏–∫—Ç–æ—Ä / —Å–º—ã—Å–ª–æ–≤–æ–π –º–æ—Ç–∏–≤–∞—Ç–æ—Ä / –ø–µ–≤–µ—Ü / –æ—Ä–∞—Ç–æ—Ä**."
            ]
        },
        "instrument": {
            "title": "–ì–µ–ª–∏–æ–¥–æ—Ä ‚Äî 3 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç/–∫–∞–∫ –¥–µ–ª–∞—é)",
            "lines": [
                "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: **–ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ —Å–º—ã—Å–ª–æ–≤ –∏ –∑–Ω–∞–Ω–∏–π —á–µ—Ä–µ–∑ –≥–æ–ª–æ—Å**.",
                "–ù–∞–≤—ã–∫–∏: –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏, –ø–æ–≤—ã—à–µ–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ –∏–¥–µ–π, —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ —á–µ–ª–æ–≤–µ–∫–∞ —á–µ—Ä–µ–∑ —Ä–µ—á—å/–ø–æ–¥–∞—á—É.",
                "–ü–æ–º–æ–≥–∞–µ—Ç –¥–µ–ª–∞—Ç—å –¥—Ä—É–≥–∏—Ö –±–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω—ã–º–∏: —Ñ–∏—à–∫–∏ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏, –≤–æ–≤–ª–µ—á–µ–Ω–∏–µ, –∏–º–ø—Ä–æ–≤–∏–∑–∞—Ü–∏—è."
            ]
        }
    },

    "–ê–º–µ—Ç–∏—Å—Ç": {
        "perception": {
            "title": "–ê–º–µ—Ç–∏—Å—Ç ‚Äî 1 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ/–∞–Ω–∞–ª–∏–∑)",
            "lines": [
                "–ö–∞–Ω–∞–ª –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è: **–∑–∞–ø–∞—Ö / —Ö–∏–º–∏—è –∏–¥–µ–∏** (—è—Å–Ω–æ–∑–Ω–∞–Ω–∏–µ). ¬´–Ø –ø—Ä–æ—Å—Ç–æ –∑–Ω–∞—é¬ª.",
                "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç **—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–Ω–∞–Ω–∏–π/–º—ã—à–ª–µ–Ω–∏—è/–∏–¥–µ–∏** –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é, —Ü–µ–ª—å, –≤—Ä–µ–º—è.",
                "–í–∏–¥–∏—Ç —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–µ—à–µ–Ω–∏–π –≤–æ –≤—Ä–µ–º–µ–Ω–∏: –∫ —á–µ–º—É –ø—Ä–∏–≤–µ–¥—ë—Ç –ø—É—Ç—å –º—ã—à–ª–µ–Ω–∏—è, –∫–∞–∫ ¬´—É–ø–∞–∫–æ–≤–∞—Ç—å –∏–¥–µ—é¬ª, —á—Ç–æ–±—ã –µ—ë –∫—É–ø–∏–ª–∏.",
                "–ü–∞–º—è—Ç—å: —Å–∏–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å –Ω–∞ –∑–∞–ø–∞—Ö–∏, –æ–±–æ–Ω—è—Ç–µ–ª—å–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ."
            ],
            "intuition": [
                "–ò–Ω—Ç—É–∏—Ü–∏—è = –æ–±–æ–Ω—è–Ω–∏–µ (—Ç—Ä–µ—Ç–∏–π –≥–ª–∞–∑): —É –ª—é–±–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –µ—Å—Ç—å —Å–≤–æ–π ¬´–∑–∞–ø–∞—Ö¬ª.",
                "–ü—Ä–∞–∫—Ç–∏–∫–∞: –º–µ—Å—Ç–æ/–ª—é–¥–∏/—Ä–µ—à–µ–Ω–∏–µ ‚Äî –µ—Å–ª–∏ ¬´–∑–∞–ø–∞—Ö –Ω—Ä–∞–≤–∏—Ç—Å—è¬ª, –∑–Ω–∞—á–∏—Ç —Ç—É–¥–∞."
            ]
        },
        "motivation": {
            "title": "–ê–º–µ—Ç–∏—Å—Ç ‚Äî 2 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (—Ü–µ–ª—å/–º–æ—Ç–∏–≤–∞—Ü–∏—è/–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)",
            "lines": [
                "–ö–ª—é—á–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å —Ü–µ–ª–∏: **–ø—Ä–æ–¥–∞–∂–∞ —Å–º—ã—Å–ª–æ–≤, —Ç–∞–π–Ω–æ–µ –∑–Ω–∞–Ω–∏–µ, –≤–ª–∞—Å—Ç—å –Ω–∞–¥ –º—ã—à–ª–µ–Ω–∏–µ–º/–≤–Ω–∏–º–∞–Ω–∏–µ–º**.",
                "–ú–æ—Ç–∏–≤–∏—Ä—É–µ—Ç: –∑–Ω–∞–Ω–∏—è, —Å–µ–∫—Ä–µ—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –º–µ—Ö–∞–Ω–∏–∑–º—ã –≤–ª–∏—è–Ω–∏—è (–≤ —Å–≤–µ—Ç–ª–æ–º –∫–ª—é—á–µ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –º–µ–Ω—è—Ç—å –º—ã—à–ª–µ–Ω–∏–µ).",
                "–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: **–º–∏—Å—Ç–∏–∫–∞/–∏–Ω—Ç—Ä–∏–≥–∞/—Ç–∞–π–Ω—ã/—Å–∞–∫—Ä–∞–ª—å–Ω–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞** (—à–∫–æ–ª–∞ –∑–Ω–∞–Ω–∏–π, —ç–∑–æ—Ç–µ—Ä–∏–∫–∞ –∫–∞–∫ –æ–±–æ–ª–æ—á–∫–∞)."
            ]
        },
        "instrument": {
            "title": "–ê–º–µ—Ç–∏—Å—Ç ‚Äî 3 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç/–∫–∞–∫ –¥–µ–ª–∞—é)",
            "lines": [
                "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: **—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º—ã—à–ª–µ–Ω–∏–µ–º** ‚Äî —Å–ª–æ–≤–∞/—Å–º—ã—Å–ª—ã/—Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–µ—à–µ–Ω–∏–π.",
                "–í–æ—Ä–æ–Ω–∫–∏ –ø—Ä–æ–¥–∞–∂ –∏–¥–µ–π, —Ä–∞—Å–ø—É—Ç—ã–≤–∞–Ω–∏–µ —É–∑–ª–æ–≤ —É–±–µ–∂–¥–µ–Ω–∏–π, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –º—ã—à–ª–µ–Ω–∏—è –ø–æ–¥ —Ü–µ–ª—å.",
                "–°–∏–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç/—Å–ª–æ–≤–æ: –∫–æ–≥–¥–∞ –∏ –∫–∞–∫–∏–µ —Å–ª–æ–≤–∞ —Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é."
            ]
        }
    },

    "–ò–∑—É–º—Ä—É–¥": {
        "perception": {
            "title": "–ò–∑—É–º—Ä—É–¥ ‚Äî 1 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ/–∞–Ω–∞–ª–∏–∑)",
            "lines": [
                "–ö–∞–Ω–∞–ª –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è: **–≤–∏–∑—É–∞–ª + –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏–µ —ç–º–æ—Ü–∏–π** (—ç–º–ø–∞—Ç–∏—è).",
                "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —ç–º–æ—Ü–∏–∏: –≥–∞—Ä–º–æ–Ω–∏—è/–¥–∏—Å–≥–∞—Ä–º–æ–Ω–∏—è —ç–º–æ—Ü–∏–π, ¬´—ç–º–æ—Ü–∏–∏ –∫–∞–∫ –∫—Ä–∞—Å–∫–∏¬ª.",
                "–ü–∞–º—è—Ç—å: –≤–∏–∑—É–∞–ª—å–Ω–∞—è ‚Äî —á—Ç–æ–±—ã –∑–∞–ø–æ–º–Ω–∏—Ç—å, –Ω—É–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å (—Ü–≤–µ—Ç–∞, —Å–æ—á–µ—Ç–∞–Ω–∏—è)."
            ],
            "intuition": [
                "–ò–Ω—Ç—É–∏—Ü–∏—è —á–µ—Ä–µ–∑ —ç–º–æ—Ü–∏–∏: –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã ‚Üí –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —ç–º–æ—Ü–∏–∏ ‚Üí –≤—ã–±–∏—Ä–∞—Ç—å —Ç–∞–º, –≥–¥–µ –ø–æ–¥—ä—ë–º/–ø—Ä–∏—è—Ç–Ω–æ."
            ]
        },
        "motivation": {
            "title": "–ò–∑—É–º—Ä—É–¥ ‚Äî 2 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (—Ü–µ–ª—å/–º–æ—Ç–∏–≤–∞—Ü–∏—è/–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)",
            "lines": [
                "–ö–ª—é—á–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å —Ü–µ–ª–∏: **–∫—Ä–∞—Å–æ—Ç–∞, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –≥–∞—Ä–º–æ–Ω–∏—è, —Å—á–∞—Å—Ç—å–µ, –∏—Å—Ü–µ–ª–µ–Ω–∏–µ —ç–º–æ—Ü–∏–π**.",
                "–ú–æ—Ç–∏–≤–∏—Ä—É–µ—Ç: –¥–µ–ª–∞—Ç—å –ª—é–¥–µ–π —Å—á–∞—Å—Ç–ª–∏–≤–µ–µ, –¥–æ–±–∞–≤–ª—è—Ç—å –∫—Ä–∞—Å–∫–∏, —É–ª—É—á—à–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —Å–æ–∑–¥–∞–≤–∞—Ç—å —ç–∫–æ–ª–æ–≥–∏—é —ç–º–æ—Ü–∏–π.",
                "–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: –Ω–µ–∂–Ω–æ—Å—Ç—å/—Ä–æ–º–∞–Ω—Ç–∏–∑–º/—ç—Å—Ç–µ—Ç–∏–∫–∞, —á—É–≤—Å—Ç–≤–µ–Ω–Ω—ã–π –∫—Ä–∞—Å–∏–≤—ã–π –æ–±—Ä–∞–∑."
            ]
        },
        "instrument": {
            "title": "–ò–∑—É–º—Ä—É–¥ ‚Äî 3 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç/–∫–∞–∫ –¥–µ–ª–∞—é)",
            "lines": [
                "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: **—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏–µ** ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å/–ø–µ—Ä–µ–ª–∏–≤–∞—Ç—å —ç–º–æ—Ü–∏–∏, –∫—Ä–∞—Å–æ—Ç—É, –∞—Ç–º–æ—Å—Ñ–µ—Ä—É.",
                "–®–∞–±–ª–æ–Ω—ã –∫—Ä–∞—Å–æ—Ç—ã/—ç–º–æ—Ü–∏–π, —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∞—Ü–∏—è —ç–º–æ—Ü–∏–π, –æ–±—É—á–µ–Ω–∏–µ –∫—Ä–∞—Å–æ—Ç–µ/—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º —Å–∏—Å—Ç–µ–º–∞–º.",
                "–ü—Ä–∏–º–µ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: –Ω–µ–π—Ä–æ–≥—Ä–∞—Ñ–∏–∫–∞ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –º–µ—Ç–æ–¥–µ)."
            ]
        }
    },

    "–ì—Ä–∞–Ω–∞—Ç": {
        "perception": {
            "title": "–ì—Ä–∞–Ω–∞—Ç ‚Äî 1 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ/–∞–Ω–∞–ª–∏–∑)",
            "lines": [
                "–ö–∞–Ω–∞–ª –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è: **–º–∏–º–∏–∫–∞ / –≤—ã—Ä–∞–∂–µ–Ω–∏–µ —ç–º–æ—Ü–∏–π** (—Ç–µ–ª–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç —ç–º–æ—Ü–∏—é).",
                "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å –∫ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º—É –ø—Ä–æ–¥—É–∫—Ç—É: —Å–ø—Ä–æ—Å, –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å —ç–º–æ—Ü–∏–∏/–∫—Ä–∞—Å–æ—Ç—ã/–∏—Å–∫—É—Å—Å—Ç–≤–∞.",
                "–ü–∞–º—è—Ç—å: —ç–º–æ—Ü–∏–∏ –∏ —Ä–æ–ª–∏ ‚Äî —á—Ç–æ–±—ã –∑–∞–ø–æ–º–Ω–∏—Ç—å, –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å/–æ—Ç—ã–≥—Ä—ã–≤–∞—Ç—å."
            ],
            "intuition": [
                "–ò–Ω—Ç—É–∏—Ü–∏—è —á–µ—Ä–µ–∑ –º–∏–º–∏–∫—É/–∏–≥—Ä—É: –ø—Ä–æ–∏–≥—Ä–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π ‚Üí —Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –º–∏–º–∏—á–µ—Å–∫—É—é —Ä–µ–∞–∫—Ü–∏—é —Ç–µ–ª–∞."
            ]
        },
        "motivation": {
            "title": "–ì—Ä–∞–Ω–∞—Ç ‚Äî 2 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (—Ü–µ–ª—å/–º–æ—Ç–∏–≤–∞—Ü–∏—è/–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)",
            "lines": [
                "–ö–ª—é—á–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å —Ü–µ–ª–∏: **—ç–º–æ—Ü–∏–∏, —Ç–µ–∞—Ç—Ä, –∫—Ä–∞—Å–æ—Ç–∞, –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —ç–º–æ—Ü–∏–π**.",
                "–ì–¥–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å: –∞–∫—Ç—ë—Ä—Å—Ç–≤–æ, —Å—Ü–µ–Ω—ã, –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –∫—Ä–∞—Å–æ—Ç—ã/—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤.",
                "–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: —è—Ä–∫–∏–µ —Ä–æ–ª–∏, —ç–∫—Å–ø—Ä–µ—Å—Å–∏—è, –±—Ä–æ—Å–∫–∏–µ –æ–±—Ä–∞–∑—ã, —ç–º–æ—Ü–∏—è –≤ –∫–∞–¥—Ä–µ."
            ]
        },
        "instrument": {
            "title": "–ì—Ä–∞–Ω–∞—Ç ‚Äî 3 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç/–∫–∞–∫ –¥–µ–ª–∞—é)",
            "lines": [
                "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: **–º–∏–º–∏–∫–∞ / —Ä–æ–ª—å / –∞–∫—Ç—ë—Ä—Å–∫–∞—è –ø–æ–¥–∞—á–∞** ‚Äî –≤—ã—Ä–∞–∂–∞—Ç—å —ç–º–æ—Ü–∏—é –∏ –≤–æ–≤–ª–µ–∫–∞—Ç—å –ª—é–¥–µ–π.",
                "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤, —Å–±–æ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –≤–æ–∫—Ä—É–≥ —ç–º–æ—Ü–∏–π.",
                "–°–æ–∑–¥–∞—ë—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä—É–ø–ø—ã: —Ä—è–¥–æ–º ¬´—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Ö–æ—Ä–æ—à–æ¬ª."
            ]
        }
    },

    "–†—É–±–∏–Ω": {
        "perception": {
            "title": "–†—É–±–∏–Ω ‚Äî 1 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ/–∞–Ω–∞–ª–∏–∑)",
            "lines": [
                "–ö–∞–Ω–∞–ª –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è: **–≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫ / –≤–æ–∑–±—É–∂–¥–∞–µ—Ç‚Äì–Ω–µ –≤–æ–∑–±—É–∂–¥–∞–µ—Ç** (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã).",
                "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ–¥–∞–≤–∞–µ–º–æ—Å—Ç—å —ç–º–æ—Ü–∏–∏, –¥—Ä–∞–º—É, —Å—Ü–µ–Ω–∞—Ä–∏–∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∞–∫—Ü–∏–π.",
                "–ü–æ–Ω–∏–º–∞–µ—Ç, –≥–¥–µ —ç–º–æ—Ü–∏–π –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –≥–¥–µ –Ω—É–∂–Ω–æ —É—Å–∏–ª–∏—Ç—å."
            ],
            "intuition": [
                "–ò–Ω—Ç—É–∏—Ü–∏—è —á–µ—Ä–µ–∑ –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫: ¬´–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ¬ª –¥–∞—ë—Ç —Å–∏–ª—å–Ω—ã–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≤—Å–ø–ª–µ—Å–∫/–∞–¥—Ä–µ–Ω–∞–ª–∏–Ω/–∂–µ–ª–∞–Ω–∏–µ."
            ]
        },
        "motivation": {
            "title": "–†—É–±–∏–Ω ‚Äî 2 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (—Ü–µ–ª—å/–º–æ—Ç–∏–≤–∞—Ü–∏—è/–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)",
            "lines": [
                "–ö–ª—é—á–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å —Ü–µ–ª–∏: **—ç–º–æ—Ü–∏–∏, –∞–¥—Ä–µ–Ω–∞–ª–∏–Ω, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–º–æ—Ü–∏—è–º–∏, —Å–µ–∫—Å/–≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–µ –≤—Å–ø–ª–µ—Å–∫–∏**.",
                "–ì–¥–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å: —à–æ—É/–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è/—ç–∫—Å—Ç—Ä–∏–º/—Ä–µ–∂–∏—Å—Å—É—Ä–∞/–∫–∏–Ω–æ/–¥—Ä–∞–π–≤–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã.",
                "–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: —Å–≤–æ–±–æ–¥–∞, –¥—Ä–∞–π–≤, —Å–µ–∫—Å—É–∞–ª—å–Ω–æ—Å—Ç—å, –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è, —ç–∫—Å—Ç—Ä–∏–º."
            ]
        },
        "instrument": {
            "title": "–†—É–±–∏–Ω ‚Äî 3 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç/–∫–∞–∫ –¥–µ–ª–∞—é)",
            "lines": [
                "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: **–¥—Ä–∞–º–∞—Ç—É—Ä–≥–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–º–æ—Ü–∏—è–º–∏** (—Å–≤–æ–∏–º–∏ –∏ –∞—É–¥–∏—Ç–æ—Ä–∏–∏).",
                "–†–∞–±–æ—Ç–∞ —Å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Ç—Ä–∞–≤–º–∞–º–∏ (–∑–∞–º–µ—â–µ–Ω–∏–µ —ç–º–æ—Ü–∏–π), —Å—Ü–µ–Ω–∞—Ä–∏–∏ —ç–º–æ—Ü–∏–π —Ç–æ–ª–ø—ã, –ø—Ä–æ–¥–∞–∂–∏ —á–µ—Ä–µ–∑ —ç–º–æ—Ü–∏—é.",
                "–†–µ–∂–∏—Å—Å—É—Ä–∞/—à–æ—É/–≤–µ–±–∏–Ω–∞—Ä—ã/—Å—Ç–æ—Ä–∏—Å –∫–∞–∫ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥–∞—á–∞."
            ]
        }
    },

    "–Ø–Ω—Ç–∞—Ä—å": {
        "perception": {
            "title": "–Ø–Ω—Ç–∞—Ä—å ‚Äî 1 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ/–∞–Ω–∞–ª–∏–∑)",
            "lines": [
                "–ö–∞–Ω–∞–ª –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è: **–º–µ—Ö–∞–Ω–∏–∑–º / –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—â—É—â–µ–Ω–∏—è —Ç–µ–ª–∞ (–ñ–ö–¢)** ‚Äî –∫–æ–º—Ñ–æ—Ä—Ç/–¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç.",
                "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Ñ–∏–∑–∏–∫–∏: —Ç–µ–ª–æ –∫–∞–∫ –º–µ—Ö–∞–Ω–∏–∑–º, —Ç–µ—Ö–Ω–∏–∫–∞, —Å—Ö–µ–º—ã ‚Äî —á—Ç–æ —Å–ª–æ–º–∞–Ω–æ –∏ –∫–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å.",
                "–õ—é–±–∏—Ç –ø–æ—Ä—è–¥–æ–∫/—Å—Ç—Ä—É–∫—Ç—É—Ä—É: —á–∏—Å—Ç–æ/–≥—Ä—è–∑–Ω–æ, —Ä–∞–±–æ—Ç–∞–µ—Ç/–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.",
                "–ü–∞–º—è—Ç—å: –ª—É—á—à–µ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∞—Ü–∏—é ‚Äî –∫–æ–Ω—Å–ø–µ–∫—Ç—ã, —Ç–∞–±–ª–∏—Ü—ã, —Ä–∞–∑–∂—ë–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞."
            ],
            "intuition": [
                "–ò–Ω—Ç—É–∏—Ü–∏—è –≤ –∂–∏–≤–æ—Ç–µ: —Ç–µ–ª–æ –æ—Ç–≤–µ—á–∞–µ—Ç –∫–æ–º—Ñ–æ—Ä—Ç–æ–º/–¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç–æ–º.",
                "–ü—Ä–∞–∫—Ç–∏–∫–∞ –≤—ã–±–æ—Ä–∞: —Å—Ç–æ—è—Ç—å –Ω–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö (–ª–∏—Å—Ç–∫–∞—Ö) –∏ —Å—á–∏—Ç—ã–≤–∞—Ç—å —Ç–µ–ª–µ—Å–Ω—ã–π –æ—Ç–∫–ª–∏–∫."
            ]
        },
        "motivation": {
            "title": "–Ø–Ω—Ç–∞—Ä—å ‚Äî 2 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (—Ü–µ–ª—å/–º–æ—Ç–∏–≤–∞—Ü–∏—è/–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)",
            "lines": [
                "–ö–ª—é—á–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å —Ü–µ–ª–∏: **—Å–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤/—Å–∏—Å—Ç–µ–º** (—á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ ¬´–∫–∞–∫ —á–∞—Å—ã¬ª).",
                "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ: –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞ ¬´–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é¬ª, –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ/—Å–∏—Å—Ç–µ–º—ã.",
                "–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: —É—á—ë–Ω—ã–π/–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫/–∏–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å, –≤—Å—ë –ø–æ –ø–æ–ª–æ—á–∫–∞–º."
            ]
        },
        "instrument": {
            "title": "–Ø–Ω—Ç–∞—Ä—å ‚Äî 3 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç/–∫–∞–∫ –¥–µ–ª–∞—é)",
            "lines": [
                "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: **–º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–æ–µ –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏–µ** ‚Äî —Ä—É–∫–∏/—Å–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ/—Å–∏—Å—Ç–µ–º.",
                "–°–∏—Å—Ç–µ–º—ã –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤, –¥–µ—Ç–∞–ª–µ–π, –æ–±—É—á–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤.",
                "–ü—Ä–∏–º–µ—Ä: –º–∞—Å—Å–∞–∂/–æ—Å—Ç–µ–æ–ø–∞—Ç–∏—è/—Ä–∞–±–æ—Ç–∞ —Ä—É–∫–∞–º–∏ ‚Äî –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (–µ—Å–ª–∏ –≤ –º–µ—Ç–æ–¥–∏–∫–µ —Ç–∞–∫ —Ç—Ä–∞–∫—Ç—É–µ—Ç—Å—è)."
            ]
        }
    },

    "–®—É–Ω–≥–∏—Ç": {
        "perception": {
            "title": "–®—É–Ω–≥–∏—Ç ‚Äî 1 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ/–∞–Ω–∞–ª–∏–∑)",
            "lines": [
                "–ö–∞–Ω–∞–ª –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è: **—Ñ–æ—Ä–º–∞ / –ø–ª–æ—Ç–Ω–æ—Å—Ç—å / –º—ã—à—Ü—ã** (—Ä–µ–∞–∫—Ü–∏—è –º—ã—à—Ü: –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ/—Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ).",
                "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ä–º—É –∏ ¬´–æ—Ä–∏–≥–∏–Ω–∞–ª‚Äì–ø–æ–¥–¥–µ–ª–∫–∞¬ª, —Å–ø—Ä–æ—Å –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (—á—Ç–æ –∑–∞–π–¥—ë—Ç).",
                "–•–æ—Ä–æ—à–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º—ã—à–ª–µ–Ω–∏–µ (3D/–ª–∞–Ω–¥—à–∞—Ñ—Ç/—Ñ–æ—Ä–º–∞).",
                "–ü–∞–º—è—Ç—å: —á–µ—Ä–µ–∑ **—Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ** –∏ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ."
            ],
            "intuition": [
                "–ò–Ω—Ç—É–∏—Ü–∏—è –≤ –¥–µ–π—Å—Ç–≤–∏–∏/–º—ã—à—Ü–∞—Ö: —Ç–µ–ª–æ —Ç—è–Ω–µ—Ç —Ç—É–¥–∞, –≥–¥–µ ¬´–º–æ—ë¬ª, –∏ –ª–µ–Ω–∏—Ç—Å—è —Ç–∞–º, –≥–¥–µ –Ω–µ –ø—É—Ç—å.",
                "–ü—Ä–∞–∫—Ç–∏–∫–∞ –≤—ã–±–æ—Ä–∞: –∑–∞–∫—Ä—ã—Ç—å –≥–ª–∞–∑–∞, –ø—Ä–æ–∫—Ä—É—Ç–∏—Ç—å—Å—è –∏ –ø–æ–π—Ç–∏ —Ç—É–¥–∞, –∫—É–¥–∞ –≤–µ–¥—ë—Ç —Ç–µ–ª–æ."
            ]
        },
        "motivation": {
            "title": "–®—É–Ω–≥–∏—Ç ‚Äî 2 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (—Ü–µ–ª—å/–º–æ—Ç–∏–≤–∞—Ü–∏—è/–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)",
            "lines": [
                "–ö–ª—é—á–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å —Ü–µ–ª–∏: **—Å–æ–æ–±—â–µ—Å—Ç–≤–æ / –±–ª–∏–∑–∫–∏–π –∫—Ä—É–≥ / —Ñ–æ—Ä–º–∞/—Ñ–∏–∑–∏–∫–∞/–º–µ—Ö–∞–Ω–∏–∑–º—ã**.",
                "–°–æ–∑–¥–∞—ë—Ç –∫–æ–º—å—é–Ω–∏—Ç–∏: —Å–ø–æ—Ä—Ç, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, —Ç–µ–ª–µ—Å–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏, –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –≤–µ—â–µ–π.",
                "–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø—Ä–æ–≤–æ–¥–Ω–∏–∫ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–µ, —Ç–µ–ª–µ—Å–Ω–æ—Å—Ç—å, —Ñ–æ—Ä–º–∞, —Å–≤—è–∑—å —Å —Ä–æ–¥–æ–º/–ø—Ä–∏—Ä–æ–¥–æ–π."
            ]
        },
        "instrument": {
            "title": "–®—É–Ω–≥–∏—Ç ‚Äî 3 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç/–∫–∞–∫ –¥–µ–ª–∞—é)",
            "lines": [
                "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: **—Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ—Å—Ç–≤** –≤–æ–∫—Ä—É–≥ —Ç–µ–ª–µ—Å–Ω–æ–≥–æ/–º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–≥–æ, –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞.",
                "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤—ã—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ä–º—ã —Ç–µ–ª–∞, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ª—é–¥–µ–π.",
                "–°–∏–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç: –ª–∞–¥ –≤ –±–ª–∏–∑–∫–æ–º –∫—Ä—É–≥–µ (—Å–µ–º—å—è/–ø–∞—Ä—Ç–Ω—ë—Ä—ã) —á–µ—Ä–µ–∑ –æ–±—â–∏–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏."
            ]
        }
    },

    "–¶–∏—Ç—Ä–∏–Ω": {
        "perception": {
            "title": "–¶–∏—Ç—Ä–∏–Ω ‚Äî 1 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ/–∞–Ω–∞–ª–∏–∑)",
            "lines": [
                "–ö–∞–Ω–∞–ª –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è: **–∫–æ–∂–∞ / –¥–∏–Ω–∞–º–∏–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è**, —Ç–µ–ª–µ—Å–Ω—ã–µ –æ—â—É—â–µ–Ω–∏—è (–ø—Ä–∏—è—Ç–Ω–æ‚Äì–Ω–µ–ø—Ä–∏—è—Ç–Ω–æ).",
                "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç **—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤**: –¥–µ–Ω—å–≥–∏, –ª–æ–≥–∏—Å—Ç–∏–∫–∞, –¥–µ–π—Å—Ç–≤–∏—è, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏.",
                "–í–∏–¥–∏—Ç, —á—Ç–æ –ø—Ä–µ–¥–ø—Ä–∏–Ω—è—Ç—å, —á—Ç–æ–±—ã —É—Å–∏–ª–∏—Ç—å –¥–æ—Ö–æ–¥/–ø—Ä–∏–±—ã–ª—å, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å.",
            ],
            "intuition": [
                "–ò–Ω—Ç—É–∏—Ü–∏—è —á–µ—Ä–µ–∑ –∫–æ–∂—É: –ø—Ä–∏—è—Ç–Ω—ã–µ/–Ω–µ–ø—Ä–∏—è—Ç–Ω—ã–µ –æ—â—É—â–µ–Ω–∏—è, –º—É—Ä–∞—à–∫–∏.",
                "–ú–æ–∂–Ω–æ —Ç–µ–ª–µ—Å–Ω–æ –ø—Ä–æ—è–≤–∏—Ç—å—Å—è (–¥–≤–∏–∂–µ–Ω–∏–µ/—Ç–∞–Ω–µ—Ü) –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å, –∫–∞–∫ —Ç–µ–ª–æ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ."
            ]
        },
        "motivation": {
            "title": "–¶–∏—Ç—Ä–∏–Ω ‚Äî 2 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (—Ü–µ–ª—å/–º–æ—Ç–∏–≤–∞—Ü–∏—è/–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)",
            "lines": [
                "–ö–ª—é—á–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å —Ü–µ–ª–∏: **–¥–µ–Ω—å–≥–∏, –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç, –∏–∑–æ–±–∏–ª–∏–µ, –≤–ª–∞—Å—Ç—å –Ω–∞–¥ –º–∞—Ç–µ—Ä–∏–µ–π**.",
                "–ì–¥–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å: –±–∏–∑–Ω–µ—Å/—Ñ–∏–Ω–∞–Ω—Å—ã/–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ ‚Äî —Ç–∞–º, –≥–¥–µ –º–æ–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º —Ä–æ—Å—Ç–æ–º.",
                "–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å, —Å—Ç–∞—Ç—É—Å, –¥–µ–Ω—å–≥–∏, —Ä–æ—Å–∫–æ—à—å (–∏/–∏–ª–∏ —Ä–∞–∑–≤–∏—Ç–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ —Ç–µ–ª–∞)."
            ]
        },
        "instrument": {
            "title": "–¶–∏—Ç—Ä–∏–Ω ‚Äî 3 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç/–∫–∞–∫ –¥–µ–ª–∞—é)",
            "lines": [
                "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: **—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è–º–∏/–ø—Ä–∏–≤—ã—á–∫–∞–º–∏/—Ä–µ—Å—É—Ä—Å–∞–º–∏/–¥–µ–Ω—å–≥–∞–º–∏**.",
                "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è, –ª–æ–≥–∏—Å—Ç–∏–∫–∞, –ø—Ä–æ–¥–∞–∂–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏ –∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏ –¥—Ä—É–≥–∏—Ö –ª—é–¥–µ–π.",
                "¬´–°–∞–º—ã–µ –∑–∞–±–æ—Ç–ª–∏–≤—ã–µ¬ª: –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å, –æ–±–µ—Å–ø–µ—á–∏—Ç—å, —Ä–∞–∑–ª–æ–∂–∏—Ç—å –ø–æ –º–µ—Å—Ç–∞–º, –¥–∞—Ç—å —Å–∏—Å—Ç–µ–º–µ —Ä–∞–±–æ—Ç–∞—Ç—å."
            ]
        }
    },
}

def canon_cell(pot: str, col: str) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–≥–æ –∫–∞–Ω–æ–Ω. –ù–∏–∫–∞–∫–∏—Ö '—Å–∏–ª—å–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω' –æ—Ç –º–æ–¥–µ–ª–∏.
    """
    pot = _s(pot)
    col = _s(col)
    block = (POT_CANON.get(pot) or {}).get(col) or {}
    title = _s(block.get("title")) or f"{pot}"
    lines = block.get("lines") or []
    intuition = block.get("intuition") or []

    out = [f"**{title}**"]
    if lines:
        out += [f"- {x}" for x in lines if _s(x)]
    if intuition:
        out.append("")
        out.append("**–ò–Ω—Ç—É–∏—Ü–∏—è/—Ä–µ—à–µ–Ω–∏—è (–∫–∞–∫ –≤ —à–∫–æ–ª–µ):**")
        out += [f"- {x}" for x in intuition if _s(x)]
    if len(out) == 1:
        out.append("_–ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ._")
    return "\n".join(out)

def row_intro_school(row_id: str) -> str:
    row_id = _s(row_id)
    if row_id == "1":
        return "–≠—Ç–æ **—è–¥—Ä–æ**: —Ç–æ, –≥–¥–µ —Ç—ã —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ –∏ –≥–¥–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–¥—ë—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ."
    if row_id == "2":
        return "–≠—Ç–æ **—Ä—è–¥ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è**: —Ç–æ, —á—Ç–æ –ø–æ–¥–ø–∏—Ç—ã–≤–∞–µ—Ç —Ä–µ—Å—É—Ä—Å, –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç, —É—Å–∏–ª–∏–≤–∞–µ—Ç —è–¥—Ä–æ."
    if row_id == "3":
        return ("‚ö†Ô∏è –≠—Ç–æ **—Ä—è–¥ —Ä–∏—Å–∫–æ–≤**: **—ç—Ç–æ –ù–ï —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã**. "
                "–ò–∑ —ç—Ç–æ–≥–æ —Ä—è–¥–∞ –Ω–µ–ª—å–∑—è —Å—Ç—Ä–æ–∏—Ç—å –∂–∏–∑–Ω—å/—Ä–∞–±–æ—Ç—É ‚Äî —Ç—É—Ç –±—ã—Å—Ç—Ä–µ–µ —É—Å—Ç–∞—ë—à—å. "
                "–ó–∞–¥–∞—á–∞: **–º–∏–Ω–∏–º—É–º –≤—Ä–µ–º–µ–Ω–∏ / –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å / –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å**.")
    return "‚Äî"

def row_footer_school(row_id: str) -> str:
    row_id = _s(row_id)
    if row_id == "1":
        return "–§–æ–∫—É—Å: –æ–ø–∏—Ä–∞—Ç—å—Å—è –Ω–∞ —ç—Ç–æ—Ç —Ä—è–¥ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å—Ñ–µ—Ä—ã, —Ä–æ–ª–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏."
    if row_id == "2":
        return "–§–æ–∫—É—Å: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –ø–æ–¥–ø–∏—Ç–∫—É –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—É—é/—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É."
    if row_id == "3":
        return "–§–æ–∫—É—Å: –Ω–µ —Ç—è–Ω—É—Ç—å –Ω–∞ —Å–µ–±–µ; –≤—ã–Ω–µ—Å—Ç–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É, —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã, –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ."
    return ""

def matrix_markdown_table(m: dict) -> str:
    rows = (m or {}).get("rows", []) or []
    if not rows:
        return "‚Äî"
    header = "| –†—è–¥ | –í–æ—Å–ø—Ä–∏—è—Ç–∏–µ | –ú–æ—Ç–∏–≤–∞—Ü–∏—è | –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç |\n|---|---|---|---|\n"
    body = ""
    for r in rows:
        body += f"| {r.get('row','‚Äî')} | {r.get('perception','‚Äî')} | {r.get('motivation','‚Äî')} | {r.get('instrument','‚Äî')} |\n"
    return header + body


# ======================
# HARD GATE: forbid report without full answers
# ======================
def report_ready(payload: dict) -> tuple[bool, str]:
    payload = payload or {}
    answers = payload.get("answers", {}) or {}

    # –±–µ—Ä—ë–º —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ —Ç–≤–æ–µ–≥–æ question_plan()
    try:
        plan = question_plan()
    except Exception:
        plan = []

    required = []
    for q in (plan or []):
        qid = q.get("id")
        if not qid:
            continue
        # –∫–æ–Ω—Ç–∞–∫—Ç –º–æ–∂–Ω–æ –Ω–µ —Ç—Ä–µ–±–æ–≤–∞—Ç—å
        if qid == "intake.contact":
            continue
        required.append(qid)

    if not required:
        return False, "‚ö†Ô∏è –û—Ç—á—ë—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞."

    missing = []
    for qid in required:
        v = answers.get(qid)
        ok = False
        if isinstance(v, list):
            ok = len([x for x in v if _s(x)]) > 0
        else:
            ok = bool(_s(v))
        if not ok:
            missing.append(qid)

    if missing:
        return False, f"‚ö†Ô∏è –û—Ç—á—ë—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏. –û—Å—Ç–∞–ª–æ—Å—å: {len(missing)} –∏–∑ {len(required)}."
    return True, ""

# –í–µ—Å–∞ –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º: –≥–¥–µ –≤–æ–ø—Ä–æ—Å —Ä–µ–∞–ª—å–Ω–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π ‚Äî –≤–µ—Å –≤—ã—à–µ
Q_WEIGHTS = {
    # intake
    "intake.priority_area": 1.10,

    # now
    "now.easy_tasks": 0.85,
    "now.praise_for": 0.85,
    "now.time_flow": 0.80,
    "now.stress_pattern": 1.05,
    "now.energy_fill": 1.00,
    "now.best_result_example": 0.95,
    "now.motivation_trigger": 1.05,

    # scenarios
    "now.attention_first": 1.20,
    "scn.listen_focus": 1.10,
    "scn.project_start": 1.15,
    "scn.conflict_style": 1.05,

    # antipattern
    "antipattern.avoid": 0.80,
    "antipattern.hate_task": 1.00,
    "antipattern.energy_leak": 0.85,
    "antipattern.perfection_trap": 1.05,
}

def _norm(text: str) -> str:
    t = (text or "").lower().replace("—ë", "–µ")
    t = re.sub(r"[^a-z–∞-—è0-9\s]+", " ", t, flags=re.IGNORECASE)
    t = re.sub(r"\s+", " ", t).strip()
    return t

# –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã ‚Äî "–∫–∞–∫ –≥–æ–≤–æ—Ä–∏—Ç —á–µ–ª–æ–≤–µ–∫"
# (—Å—Ç–µ–º—ã/—á–∞—Å—Ç–∏ —Å–ª–æ–≤ ‚Äî —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã –ª–æ–≤–∏—Ç—å —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º—ã)
KEYWORDS = {
    "–Ø–Ω—Ç–∞—Ä—å": [
        "–ø–æ—Ä—è–¥", "—Å–∏—Å—Ç–µ–º", "—Å—Ç—Ä—É–∫—Ç—É—Ä", "—Ä–µ–≥–ª–∞–º–µ–Ω—Ç", "–ø—Ä–∞–≤–∏–ª", "–ø—Ä–æ—Ü–µ—Å—Å", "–∏–Ω—Å—Ç—Ä—É–∫—Ü",
        "—Ç–∞–±–ª–∏—Ü", "–¥–æ–∫—É–º–µ–Ω—Ç", "—É—á–µ—Ç", "–∫–æ–Ω—Ç—Ä–æ–ª", "–¥–µ–¥–ª–∞–π–Ω", "–ø–ª–∞–Ω–∏—Ä", "–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü",
        "—á–µ–∫–ª–∏—Å—Ç", "—à–∞–≥–∏", "–∞–ª–≥–æ—Ä–∏—Ç–º", "—Å—Ö–µ–º", "–ø–æ–¥—Ä—è–¥", "–ø–æ –ø–æ–ª–æ—á–∫", "–ø–æ –ø–ª–∞–Ω—É",
        "—Ö–∞–æ—Å", "–±–∞—Ä–¥–∞–∫", "—Ä–∞–∑–±—Ä–æ—Å", "–¥–∏—Å—Ü–∏–ø–ª–∏–Ω"
    ],
    "–®—É–Ω–≥–∏—Ç": [
        "—Ç–µ–ª–æ", "—ç–Ω–µ—Ä–≥", "—Å–∏–ª", "—É—Å—Ç–∞–ª", "—Å–æ–Ω", "–∑–¥–æ—Ä–æ–≤", "–≤–æ—Å—Å—Ç–∞–Ω–æ–≤", "–≤—ã–Ω–æ—Å–ª–∏–≤",
        "–¥–≤–∏–∂", "—Å–ø–æ—Ä—Ç", "—Ç—Ä–µ–Ω", "–Ω–∞–≥—Ä—É–∑", "—Ä–µ–∂–∏–º", "–ø–∏—Ç–∞–Ω–∏", "—Å–æ–Ω–ª–∏–≤", "–±–æ–ª",
        "—Å–ª–∞–±–æ—Å—Ç", "—Ä–µ—Å—É—Ä—Å", "–Ω–µ—Ä–≤", "—Å—Ç—Ä–µ—Å—Å —Ç–µ–ª–æ–º"
    ],
    "–¶–∏—Ç—Ä–∏–Ω": [
        "–¥–µ–Ω—å–≥", "–¥–æ—Ö–æ–¥", "—Ä–µ–∑—É–ª—å—Ç", "—ç—Ñ—Ñ–µ–∫—Ç", "–ø—Ä–∏–±—ã–ª", "–≤—ã–≥–æ–¥", "–º–æ–Ω–µ—Ç",
        "–ø—Ä–æ–¥–∞–∂", "–∫–ª–∏–µ–Ω—Ç", "–∑–∞—è–≤–∫", "–∫–æ–Ω–≤–µ—Ä—Å", "—Ü–µ–Ω–∞", "—Å—Ç–æ–∏–º", "–º–∞—Ä–∂–∏–Ω",
        "—Å–¥–µ–ª–∫", "–±—ã—Å—Ç—Ä", "—Å–∫–æ—Ä–æ—Å—Ç", "–ø–ª–∞–Ω –ø—Ä–æ–¥–∞–∂", "—Ä–æ—Å—Ç", "—Ü–∏—Ñ—Ä", "–º–µ—Ç—Ä–∏–∫",
        "–¥–æ—Å—Ç–∏–≥", "–ø–æ–±–µ–¥", "—Ü–µ–ª—å –≤ —Ü–∏—Ñ—Ä–∞—Ö"
    ],
    "–ò–∑—É–º—Ä—É–¥": [
        "–∫—Ä–∞—Å–æ—Ç", "—ç—Å—Ç–µ—Ç", "—É—é—Ç", "–∞—Ç–º–æ—Å—Ñ–µ—Ä", "–≥–∞—Ä–º–æ–Ω", "—Å—Ç–∏–ª—å", "–≤–∫—É—Å", "—É–ø–∞–∫–æ–≤",
        "–≤–∏–∑—É–∞–ª", "–¥–∏–∑–∞–π–Ω", "—Å–µ—Ä–≤–∏—Å", "–∫–æ–º—Ñ–æ—Ä—Ç", "–ø—Ä–∏—è—Ç–Ω", "–∫–∞—á–µ—Å—Ç–≤–æ", "–º—è–≥–∫",
        "–±–µ—Ä–µ–∂–Ω", "–ø–ª–∞–≤–Ω", "—Ç–æ–Ω–∫–æ", "–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤", "–≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â"
    ],
    "–†—É–±–∏–Ω": [
        "–¥—Ä–∞–π–≤", "—ç–º–æ—Ü", "—Å—Ü–µ–Ω–∞", "–≤–ø–µ—á–∞—Ç", "–∏–≤–µ–Ω—Ç", "–¥–≤–∏–∂—É—Ö", "–∞–¥—Ä–µ–Ω–∞–ª",
        "–ø—Ä–æ—è–≤–ª", "–≤–∏–¥–∏–º", "–ø—É–±–ª–∏—á–Ω", "—ç—Ñ–∏—Ä", "–∫–∞–º–µ—Ä–∞", "–≥–æ–ª–æ—Å", "–≤—ã—Å—Ç—É–ø",
        "—Ö–∞—Ä–∏–∑–º", "—è—Ä–∫–æ", "—Å–º–µ–ª–æ", "—Ä–∏—Å–∫–æ–≤", "–∑–∞–∂–∏–≥–∞", "—Ö–æ—á—É –≥—Ä–æ–º–∫–æ", "–Ω–µ —Ö–æ—á—É –ø—Ä—è—Ç–∞—Ç—å—Å—è"
    ],
    "–ì—Ä–∞–Ω–∞—Ç": [
        "–ª—é–¥", "–æ–±—â–µ–Ω", "—Å–≤—è–∑", "–∫–æ–Ω—Ç–∞–∫—Ç", "–æ—Ç–Ω–æ—à–µ–Ω", "–ø–æ–¥–¥–µ—Ä–∂", "—Å–µ–º—å",
        "–∫–æ–º–∞–Ω–¥", "–≤–º–µ—Å—Ç–µ", "—Å–æ–æ–±—â–µ", "–∞—É–¥–∏—Ç–æ—Ä", "–Ω–µ—Ç–≤–æ—Ä–∫", "–∑–Ω–∞–∫–æ–º",
        "–æ–±—ä–µ–¥–∏–Ω", "–º–∏—Ä–∏—Ç—å", "—ç–º–ø–∞—Ç", "—á—É–≤—Å—Ç–≤", "–¥—Ä—É–∂", "–≤–ª–∏—è–Ω–∏–µ —á–µ—Ä–µ–∑ –ª—é–¥–µ–π"
    ],
    "–°–∞–ø—Ñ–∏—Ä": [
        "—Å–º—ã—Å–ª", "–∑–∞—á–µ–º", "–ø–æ—á–µ–º—É", "–≥–ª—É–±", "—Ü–µ–Ω–Ω–æ—Å—Ç", "–∏–¥–µ—è", "–º–∏—Å—Å–∏",
        "–æ—Å–æ–∑–Ω–∞–Ω", "–≤–Ω—É—Ç—Ä–µ–Ω", "–∏—Å—Ç–∏–Ω", "–ø—É—Ç—å", "–ø–æ–∏—Å–∫ —Å–µ–±—è", "—Ñ–∏–ª–æ—Å–æ—Ñ",
        "—Ä–µ—Ñ–ª–µ–∫—Å", "—Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è", "–ø–æ–Ω—è—Ç—å", "–≤–Ω—É—Ç—Ä–∏", "—á—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç"
    ],
    "–ì–µ–ª–∏–æ–¥–æ—Ä": [
        "–æ–±—É—á", "—É—á–∏—Ç—å—Å—è", "–∑–Ω–∞–Ω", "—Ä–∞–∑–±–æ—Ä", "–æ–±—ä—è—Å–Ω", "–º–µ—Ç–æ–¥", "—Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∞—Ü –∑–Ω–∞–Ω–∏–π",
        "–Ω–∞—Å—Ç–∞–≤", "—É—á–∏—Ç–µ–ª", "–∫–æ–Ω—Å–ø–µ–∫—Ç", "–∫–Ω–∏–≥–∞", "–∫—É—Ä—Å", "—É—Ä–æ–∫", "–ø—Ä–∞–∫—Ç–∏–∫",
        "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", "–∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å", "–∏–Ω—Å—Ç—Ä—É–∫—Ü", "–æ–±—É—á–∞—Ç—å", "–ø—Ä–µ–ø–æ–¥–∞–≤", "—Ä–∞–∑–ª–æ–∂–∏—Ç—å"
    ],
    "–ê–º–µ—Ç–∏—Å—Ç": [
        "—Ü–µ–ª—å", "–≤–µ–∫—Ç–æ—Ä", "—Å—Ç—Ä–∞—Ç–µ–≥", "—É–ø—Ä–∞–≤–ª", "–ª–∏–¥–µ—Ä", "–ø—Ä–æ–µ–∫—Ç", "–ø–ª–∞–Ω",
        "–æ—Ä–≥–∞–Ω–∏–∑", "–≤–∏–¥–µ–Ω –ø—É—Ç—å", "—Ä–µ—à–µ–Ω", "–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç", "–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω",
        "–º–∞—Å—à—Ç–∞–±", "—Å–∏—Å—Ç–µ–º–∞ —Ä–µ—à–µ–Ω–∏–π", "–¥–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞", "–∫—É–¥–∞ –∏–¥—Ç–∏", "–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω",
        "–∑–∞–ø—É—Å–∫", "—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø—É—Å–∫–∞", "—Ä—É–∫–æ–≤–æ–¥–∏—Ç—å", "–≤–µ—Å—Ç–∏"
    ],
}

# –ë—ã—Å—Ç—Ä—ã–µ ‚Äú—Å–º—ã—Å–ª–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã‚Äù, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –±–µ–∑ ‚Äú—Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã—Ö —Å–ª–æ–≤‚Äù
SEMANTIC_HINTS = {
    "–†—É–±–∏–Ω": ["–±–æ—é—Å—å –∫–∞–º–µ—Ä—ã", "—Å—Ç—Ä–∞—Ö –ø—Ä–æ—è–≤", "—Å—Ç—Ä–∞—à–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç—å", "–≤—ã–π—Ç–∏ –≤ —ç—Ñ–∏—Ä", "–º–µ–Ω—è —É–≤–∏–¥—è—Ç", "—Å—Ç—ã–¥–Ω–æ", "–ø—É–±–ª–∏—á–Ω–æ"],
    "–¶–∏—Ç—Ä–∏–Ω": ["–Ω–µ –º–æ–≥—É –ø—Ä–æ–¥–∞–≤–∞—Ç—å", "–Ω–µ –∑–Ω–∞—é —Ü–µ–Ω—É", "–∫–∞–∫ –º–æ–Ω–µ—Ç–∏–∑", "–∫–∞–∫ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å", "–∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–µ—Ç", "–Ω–µ—Ç –∑–∞—è–≤–æ–∫"],
    "–ê–º–µ—Ç–∏—Å—Ç": ["–Ω–µ –∑–Ω–∞—é —Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å", "–Ω–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏", "–Ω–µ –ø–æ–Ω–∏–º–∞—é –ø–ª–∞–Ω", "–∫—É–¥–∞ –¥–≤–∏–≥–∞—Ç—å—Å—è", "–Ω–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–µ–π—Å—Ç–≤–∏–π"],
    "–°–∞–ø—Ñ–∏—Ä": ["–Ω–µ –ø–æ–Ω–∏–º–∞—é –∫—Ç–æ —è", "–Ω–µ –ø–æ–Ω–∏–º–∞—é —á–µ–≥–æ —Ö–æ—á—É", "–≤ —á–µ–º —Å–º—ã—Å–ª", "–ø–æ—Ç–µ—Ä—è–ª–∞—Å—å", "–Ω–µ—Ç –æ—â—É—â–µ–Ω–∏—è –ø—É—Ç–∏"],
    "–ì—Ä–∞–Ω–∞—Ç": ["–Ω–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏", "–æ–¥–Ω–∞", "–Ω–µ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏—è", "–Ω–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤", "–Ω–µ —Å –∫–µ–º", "–Ω–µ –ø–æ–Ω–∏–º–∞—é –∞—É–¥–∏—Ç–æ—Ä–∏—é"],
    "–ò–∑—É–º—Ä—É–¥": ["–Ω–µ –º–æ–≥—É —É–ø–∞–∫–æ–≤–∞—Ç—å", "–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç", "–Ω–µ—Ç —ç—Å—Ç–µ—Ç–∏–∫–∏", "–Ω–µ –º–æ–≥—É –∫—Ä–∞—Å–∏–≤–æ", "—Ö–æ—á—É –∫—Ä–∞—Å–∏–≤–æ"],
    "–Ø–Ω—Ç–∞—Ä—å": ["–±–∞—Ä–¥–∞–∫", "—Ö–∞–æ—Å", "–≤—Å–µ —Ä–∞–∑–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è", "–Ω–µ –º–æ–≥—É —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å", "–Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–æ—Ä—è–¥–∫–∞"],
    "–®—É–Ω–≥–∏—Ç": ["–Ω–µ—Ç —Å–∏–ª", "—É—Å—Ç–∞–ª–∞", "–≤—ã–≥–æ—Ä–∞—é", "—Å–æ–Ω–ª–∏–≤–æ—Å—Ç—å", "—Å–ª–∞–±–æ—Å—Ç—å", "—Ç–µ–ª–æ –Ω–µ —Ç—è–Ω–µ—Ç"],
    "–ì–µ–ª–∏–æ–¥–æ—Ä": ["–º–æ–≥—É –æ–±—ä—è—Å–Ω–∏—Ç—å", "–ª—é–±–ª—é –æ–±—É—á–∞—Ç—å", "—Ö–æ—á—É —É—á–∏—Ç—å—Å—è", "–ª—é–±–ª—é —Ä–∞–∑–±–∏—Ä–∞—Ç—å", "—Ö–æ—á—É –º–µ—Ç–æ–¥"],
}

def text_hits(text: str, pot: str) -> int:
    t = _norm(text)
    if not t:
        return 0
    kws = KEYWORDS.get(pot, [])
    hits = sum(1 for kw in kws if kw in t)

    # —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ (—Ñ—Ä–∞–∑—ã)
    hints = SEMANTIC_HINTS.get(pot, [])
    hits += sum(2 for ph in hints if ph in t)  # —Ñ—Ä–∞–∑–∞ = —Å–∏–ª—å–Ω–µ–µ, —á–µ–º —Å–ª–æ–≤–æ
    return hits

def score_all(answers: dict):
    scores = {p: 0.0 for p in POTS}
    evidence = {p: [] for p in POTS}
    col_scores = {c: {p: 0.0 for p in POTS} for c in COLUMNS}

    plan = question_plan()
    q_by_id = {q["id"]: q for q in plan}

    def add(p, v, note, qid=None):
        v = float(v)
        scores[p] += v
        evidence[p].append(note)

        if qid and qid in q_by_id:
            col = q_by_id[qid].get("column")
            if col in col_scores:
                col_scores[col][p] += v

    # 1) Keyword / phrase scoring (–ø–æ–¥ –æ—Ç–≤–µ—Ç—ã —á–µ–ª–æ–≤–µ–∫–∞)
    for qid, ans in answers.items():
        wq = float(Q_WEIGHTS.get(qid, 0.75))
        if isinstance(ans, list):
            joined = " ".join([str(x) for x in ans])
            for p in POTS:
                h = text_hits(joined, p)
                if h:
                    add(p, wq * (0.22 * h), f"{qid}: kw({p})*{h}", qid=qid)
        else:
            txt = str(ans or "")
            for p in POTS:
                h = text_hits(txt, p)
                if h:
                    add(p, wq * (0.30 * h), f"{qid}: kw({p})*{h}", qid=qid)

    # 2) Option-based bumps (—Å–∞–º—ã–µ —Ç–æ—á–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã)
    def bump_if(qid, option_to_pots, amount=1.0):
        a = answers.get(qid)
        if not a:
            return
        wq = float(Q_WEIGHTS.get(qid, 1.0))

        def apply_one(opt, share=1.0):
            pots = option_to_pots.get(opt)
            if not pots:
                return
            # pots –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π, —Å–ø–∏—Å–∫–æ–º –∏–ª–∏ dict pot->weight
            if isinstance(pots, str):
                add(pots, wq * amount * share, f"{qid}: opt‚Üí{pots}", qid=qid)
            elif isinstance(pots, list):
                per = (wq * amount * share) / max(1, len(pots))
                for pp in pots:
                    add(pp, per, f"{qid}: opt‚Üí{pp}", qid=qid)
            elif isinstance(pots, dict):
                s = sum(abs(float(v)) for v in pots.values()) or 1.0
                for pp, vv in pots.items():
                    add(pp, wq * amount * share * (float(vv) / s), f"{qid}: opt‚Üí{pp}({vv})", qid=qid)

        if isinstance(a, list):
            per = 1.0 / max(1, len(a))
            for x in a:
                apply_one(x, share=per)
        else:
            apply_one(a, share=1.0)

    # ---- intake.priority_area
    bump_if("intake.priority_area", {
        "–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏ –¥–µ–ª–æ": {"–ê–º–µ—Ç–∏—Å—Ç": 1.0, "–°–∞–ø—Ñ–∏—Ä": 0.35},
        "–î–µ–Ω—å–≥–∏ –∏ –¥–æ—Ö–æ–¥": {"–¶–∏—Ç—Ä–∏–Ω": 1.0},
        "–û—Ç–Ω–æ—à–µ–Ω–∏—è –∏ –ª—é–¥–∏": {"–ì—Ä–∞–Ω–∞—Ç": 1.0},
        "–≠–Ω–µ—Ä–≥–∏—è –∏ —Å–∏–ª—ã": {"–®—É–Ω–≥–∏—Ç": 1.0},
        "–°–º—ã—Å–ª –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": {"–°–∞–ø—Ñ–∏—Ä": 1.0, "–ê–º–µ—Ç–∏—Å—Ç": 0.35},
    }, amount=1.15)

    # ---- now.stress_pattern
    bump_if("now.stress_pattern", {
        "–ù–∞—á–∏–Ω–∞—é –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –±—ã—Å—Ç—Ä–µ–µ –∏ –∂—ë—Å—Ç—á–µ": {"–¶–∏—Ç—Ä–∏–Ω": 0.8, "–ê–º–µ—Ç–∏—Å—Ç": 0.5, "–†—É–±–∏–Ω": 0.25},
        "–£—Ö–æ–∂—É –≤ —Å–µ–±—è –∏ –¥–∏—Å—Ç–∞–Ω—Ü–∏—Ä—É—é—Å—å": {"–°–∞–ø—Ñ–∏—Ä": 0.85, "–ì–µ–ª–∏–æ–¥–æ—Ä": 0.25},
        "–ù–∞—á–∏–Ω–∞—é –≤—Å—ë –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å": {"–Ø–Ω—Ç–∞—Ä—å": 1.0, "–ê–º–µ—Ç–∏—Å—Ç": 0.35},
        "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Ä–µ–∞–≥–∏—Ä—É—é –∏ –≤–æ–≤–ª–µ–∫–∞—é—Å—å": {"–ì—Ä–∞–Ω–∞—Ç": 0.55, "–†—É–±–∏–Ω": 0.65},
        "–ó–∞–º–∏—Ä–∞—é –∏ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—é –¥–µ–π—Å—Ç–≤–∏—è": {"–°–∞–ø—Ñ–∏—Ä": 0.45, "–®—É–Ω–≥–∏—Ç": 0.35, "–Ø–Ω—Ç–∞—Ä—å": 0.25},
    }, amount=1.0)

    # ---- now.energy_fill
    bump_if("now.energy_fill", {
        "–û–±—â–µ–Ω–∏–µ –∏ –±–ª–∏–∑–∫–∏–µ –ª—é–¥–∏": {"–ì—Ä–∞–Ω–∞—Ç": 1.0},
        "–ö—Ä–∞—Å–æ—Ç–∞, —ç—Å—Ç–µ—Ç–∏–∫–∞, —É—é—Ç": {"–ò–∑—É–º—Ä—É–¥": 1.0},
        "–¢–∏—à–∏–Ω–∞, —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è, –≥–ª—É–±–∏–Ω–∞": {"–°–∞–ø—Ñ–∏—Ä": 1.0},
        "–û–±—É—á–µ–Ω–∏–µ –∏ –Ω–æ–≤—ã–µ –∑–Ω–∞–Ω–∏—è": {"–ì–µ–ª–∏–æ–¥–æ—Ä": 1.0},
        "–î–≤–∏–∂–µ–Ω–∏–µ –∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å": {"–®—É–Ω–≥–∏—Ç": 1.0},
        "–≠–º–æ—Ü–∏–∏, —Å—Ü–µ–Ω–∞, –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è": {"–†—É–±–∏–Ω": 1.0},
    }, amount=1.05)

    # ---- now.motivation_trigger
    bump_if("now.motivation_trigger", {
        "–Ø—Å–Ω–∞—è —Ü–µ–ª—å –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": {"–ê–º–µ—Ç–∏—Å—Ç": 1.0},
        "–õ—é–¥–∏, –∫–æ–Ω—Ç–∞–∫—Ç, –≤–ª–∏—è–Ω–∏–µ": {"–ì—Ä–∞–Ω–∞—Ç": 1.0},
        "–ö—Ä–∞—Å–æ—Ç–∞ –∏ –≥–∞—Ä–º–æ–Ω–∏—è": {"–ò–∑—É–º—Ä—É–¥": 1.0},
        "–°–º—ã—Å–ª –∏ –≥–ª—É–±–∏–Ω–∞ –∏–¥–µ–∏": {"–°–∞–ø—Ñ–∏—Ä": 1.0},
        "–î—Ä–∞–π–≤, —ç–º–æ—Ü–∏–∏, —Å—Ü–µ–Ω–∞": {"–†—É–±–∏–Ω": 1.0},
        "–†–µ–∑—É–ª—å—Ç–∞—Ç, –¥–µ–Ω—å–≥–∏, —Å–∫–æ—Ä–æ—Å—Ç—å": {"–¶–∏—Ç—Ä–∏–Ω": 1.0},
    }, amount=1.05)

    # ---- attention_first (perception)
    bump_if("now.attention_first", {
        "–õ—é–¥–µ–π –∏ –∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–µ": {"–ì—Ä–∞–Ω–∞—Ç": 1.0},
        "–°–º—ã—Å–ª –∏ —Å—É—Ç—å –ø—Ä–æ–∏—Å—Ö–æ–¥—è—â–µ–≥–æ": {"–°–∞–ø—Ñ–∏—Ä": 1.0},
        "–í–æ–∑–º–æ–∂–Ω—É—é –≤—ã–≥–æ–¥—É –∏ —Ä–µ—Å—É—Ä—Å—ã": {"–¶–∏—Ç—Ä–∏–Ω": 1.0},
        "–†–∏—Å–∫–∏, –ø—Ä–∞–≤–∏–ª–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É": {"–Ø–Ω—Ç–∞—Ä—å": 1.0},
        "–ê—Ç–º–æ—Å—Ñ–µ—Ä—É –∏ —ç—Å—Ç–µ—Ç–∏–∫—É": {"–ò–∑—É–º—Ä—É–¥": 1.0},
    }, amount=1.15)

    # ---- listen_focus (perception)
    bump_if("scn.listen_focus", {
        "–≠–º–æ—Ü–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ": {"–ì—Ä–∞–Ω–∞—Ç": 0.8, "–†—É–±–∏–Ω": 0.35},
        "–°–º—ã—Å–ª –ø–æ–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫": {"–°–∞–ø—Ñ–∏—Ä": 1.0},
        "–õ–æ–≥–∏–∫—É –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É": {"–Ø–Ω—Ç–∞—Ä—å": 0.55, "–ì–µ–ª–∏–æ–¥–æ—Ä": 0.55},
        "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫—É—é –≤—ã–≥–æ–¥—É": {"–¶–∏—Ç—Ä–∏–Ω": 1.0},
        "–ú–∞–Ω–µ—Ä—É –ø–æ–¥–∞—á–∏ –∏ –≤–∫—É—Å": {"–ò–∑—É–º—Ä—É–¥": 0.75, "–†—É–±–∏–Ω": 0.25},
    }, amount=1.05)

    # ---- project_start (instrument)
    bump_if("scn.project_start", {
        "–°—Ç–∞–≤–ª—é —Ü–µ–ª—å –∏ –ø–ª–∞–Ω": {"–ê–º–µ—Ç–∏—Å—Ç": 0.8, "–Ø–Ω—Ç–∞—Ä—å": 0.35},
        "–°–æ–±–∏—Ä–∞—é –ª—é–¥–µ–π –∏ —Å–≤—è–∑–∏": {"–ì—Ä–∞–Ω–∞—Ç": 1.0},
        "–ò—â—É —Å–º—ã—Å–ª –∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏—é": {"–°–∞–ø—Ñ–∏—Ä": 0.8, "–ì–µ–ª–∏–æ–¥–æ—Ä": 0.25},
        "–ù–∞–≤–æ–∂—É –ø–æ—Ä—è–¥–æ–∫ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É": {"–Ø–Ω—Ç–∞—Ä—å": 1.0},
        "–î–µ–ª–∞—é –∫—Ä–∞—Å–∏–≤–æ –∏ —É–ø–∞–∫–æ–≤—ã–≤–∞—é": {"–ò–∑—É–º—Ä—É–¥": 1.0},
        "–î–∞–≤–ª—é –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç": {"–¶–∏—Ç—Ä–∏–Ω": 0.9, "–ê–º–µ—Ç–∏—Å—Ç": 0.25},
    }, amount=1.10)

    # ---- conflict_style
    bump_if("scn.conflict_style", {
        "–°–≥–ª–∞–∂–∏–≤–∞—é –∏ –æ–±—ä–µ–¥–∏–Ω—è—é": {"–ì—Ä–∞–Ω–∞—Ç": 1.0},
        "–î–∞–≤–ª—é –∏ –ø—Ä–æ–±–∏–≤–∞—é": {"–¶–∏—Ç—Ä–∏–Ω": 0.75, "–†—É–±–∏–Ω": 0.35, "–ê–º–µ—Ç–∏—Å—Ç": 0.25},
        "–£—Ö–æ–∂—É –≤ –∞–Ω–∞–ª–∏–∑ –∏ –ø–æ–∏—Å–∫ —Å–º—ã—Å–ª–∞": {"–°–∞–ø—Ñ–∏—Ä": 1.0},
        "–°—Ç–∞–≤–ª—é —Ä–∞–º–∫–∏ –∏ –ø—Ä–∞–≤–∏–ª–∞": {"–Ø–Ω—Ç–∞—Ä—å": 1.0},
        "–ü–µ—Ä–µ–≤–æ–∂—É –≤ —ç–º–æ—Ü–∏—é –∏–ª–∏ —Å—Ü–µ–Ω—É": {"–†—É–±–∏–Ω": 1.0},
        "–ó–∞–∫—Ä—ã–≤–∞—é –≤–æ–ø—Ä–æ—Å –±—ã—Å—Ç—Ä–æ –∏ –ø–æ –¥–µ–ª—É": {"–¶–∏—Ç—Ä–∏–Ω": 0.85, "–Ø–Ω—Ç–∞—Ä—å": 0.25},
    }, amount=1.0)

    # ---- antipattern.hate_task (–≤–∞–∂–Ω–æ: —Ç—É—Ç –Ω–µ –ø—Ä–∏–±–∞–≤–ª—è–µ–º, –∞ –º—è–≥–∫–æ ‚Äú—à—Ç—Ä–∞—Ñ—É–µ–º‚Äù —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ç–∏–ø)
    hate = str(answers.get("antipattern.hate_task","") or "").strip()
    if hate:
        # —à—Ç—Ä–∞—Ñ—ã –Ω–µ–±–æ–ª—å—à–∏–µ, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω—É
        if hate == "–†—É—Ç–∏–Ω–∞ –∏ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã":
            scores["–Ø–Ω—Ç–∞—Ä—å"] = max(0.0, scores["–Ø–Ω—Ç–∞—Ä—å"] - 0.55)
            evidence["–Ø–Ω—Ç–∞—Ä—å"].append("hate_task: —Ä—É—Ç–∏–Ω–∞/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã ‚Üí -–Ø–Ω—Ç–∞—Ä—å")
        elif hate == "–ü—Ä–æ–¥–∞–∂–∏ –∏ —Å–∞–º–æ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è":
            scores["–¶–∏—Ç—Ä–∏–Ω"] = max(0.0, scores["–¶–∏—Ç—Ä–∏–Ω"] - 0.35)
            scores["–†—É–±–∏–Ω"] = max(0.0, scores["–†—É–±–∏–Ω"] - 0.20)
            evidence["–¶–∏—Ç—Ä–∏–Ω"].append("hate_task: –ø—Ä–æ–¥–∞–∂–∏ ‚Üí -–¶–∏—Ç—Ä–∏–Ω")
            evidence["–†—É–±–∏–Ω"].append("hate_task: —Å–∞–º–æ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è ‚Üí -–†—É–±–∏–Ω")
        elif hate == "–§–∏–∑–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞":
            scores["–®—É–Ω–≥–∏—Ç"] = max(0.0, scores["–®—É–Ω–≥–∏—Ç"] - 0.35)
            evidence["–®—É–Ω–≥–∏—Ç"].append("hate_task: —Ñ–∏–∑–Ω–∞–≥—Ä—É–∑–∫–∞ ‚Üí -–®—É–Ω–≥–∏—Ç")
        elif hate == "–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ":
            scores["–ì—Ä–∞–Ω–∞—Ç"] = max(0.0, scores["–ì—Ä–∞–Ω–∞—Ç"] - 0.20)
            scores["–Ø–Ω—Ç–∞—Ä—å"] = max(0.0, scores["–Ø–Ω—Ç–∞—Ä—å"] - 0.15)
            evidence["–ì—Ä–∞–Ω–∞—Ç"].append("hate_task: –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã ‚Üí -–ì—Ä–∞–Ω–∞—Ç")
            evidence["–Ø–Ω—Ç–∞—Ä—å"].append("hate_task: –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ ‚Üí -–Ø–Ω—Ç–∞—Ä—å")
        elif hate == "–£—á—ë–±–∞ –±–µ–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏":
            scores["–ì–µ–ª–∏–æ–¥–æ—Ä"] = max(0.0, scores["–ì–µ–ª–∏–æ–¥–æ—Ä"] - 0.20)
            evidence["–ì–µ–ª–∏–æ–¥–æ—Ä"].append("hate_task: —É—á–µ–±–∞ –±–µ–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏ ‚Üí -–ì–µ–ª–∏–æ–¥–æ—Ä")

    # ---- perfection_trap (—ç—Ç–æ —Å–∫–æ—Ä–µ–µ –º–∞—Ä–∫–µ—Ä –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞, –Ω–æ —Å–ª–µ–≥–∫–∞ —É—Å–∏–ª–∏–º/–ø–æ–¥—Å–≤–µ—Ç–∏–º)
    bump_if("antipattern.perfection_trap", {
        "–•–æ—á—É –∏–¥–µ–∞–ª—å–Ω–æ ‚Äî –ø–æ—ç—Ç–æ–º—É —Ç—è–Ω—É": {"–°–∞–ø—Ñ–∏—Ä": 0.55, "–Ø–Ω—Ç–∞—Ä—å": 0.35, "–ê–º–µ—Ç–∏—Å—Ç": 0.25},
        "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∏–¥–µ–π ‚Äî —Å–ª–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å": {"–ê–º–µ—Ç–∏—Å—Ç": 0.55, "–°–∞–ø—Ñ–∏—Ä": 0.35},
        "–ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ª—é–¥–µ–π ‚Äî —Ç—è–∂–µ–ª–æ –æ–¥–Ω–æ–º—É(–æ–¥–Ω–æ–π)": {"–ì—Ä–∞–Ω–∞—Ç": 0.75},
        "–ù–µ—Ç —Å–º—ã—Å–ª–∞ ‚Äî –Ω–µ –≤–∫–ª—é—á–∞—é—Å—å": {"–°–∞–ø—Ñ–∏—Ä": 0.85},
        "–†—É—Ç–∏–Ω–∞ —É–±–∏–≤–∞–µ—Ç –º–æ—Ç–∏–≤–∞—Ü–∏—é": {"–†—É–±–∏–Ω": 0.45, "–ò–∑—É–º—Ä—É–¥": 0.25},
        "–°—Ç—Ä–∞—Ö –ø—Ä–æ—è–≤–ª—è—Ç—å—Å—è –∏ –±—ã—Ç—å –≤–∏–¥–∏–º—ã–º(–æ–π)": {"–†—É–±–∏–Ω": 0.85, "–ì—Ä–∞–Ω–∞—Ç": 0.25},
    }, amount=0.85)

    # 3) clamp
    for p in POTS:
        if scores[p] < 0:
            scores[p] = 0.0

    return scores, evidence, col_scores

def vectors_without_labels(scores: dict):
    v = []
    if scores.get("–¶–∏—Ç—Ä–∏–Ω", 0) >= 1.35:
        v.append("—Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –¥–µ–Ω—å–≥–∏ (—Å–∫–æ—Ä–æ—Å—Ç—å, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –≤—ã–≥–æ–¥–∞)")
    if scores.get("–ê–º–µ—Ç–∏—Å—Ç", 0) >= 1.30:
        v.append("—Ü–µ–ª—å –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–≤–µ–∫—Ç–æ—Ä, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, –ª–∏–¥–µ—Ä—Å—Ç–≤–æ)")
    if scores.get("–ì–µ–ª–∏–æ–¥–æ—Ä", 0) >= 1.20:
        v.append("–∑–Ω–∞–Ω–∏—è –∏ –æ–±—É—á–µ–Ω–∏–µ (—Ä–∞–∑–±–æ—Ä, –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ, –º–µ—Ç–æ–¥)")
    if scores.get("–°–∞–ø—Ñ–∏—Ä", 0) >= 1.20:
        v.append("—Å–º—ã—Å–ª –∏ –≥–ª—É–±–∏–Ω–∞ (—Ü–µ–Ω–Ω–æ—Å—Ç–∏, ‚Äò–∑–∞—á–µ–º‚Äô, —Å—É—Ç—å)")
    if scores.get("–ì—Ä–∞–Ω–∞—Ç", 0) >= 1.20:
        v.append("–ª—é–¥–∏ –∏ —Å–≤—è–∑—å (–∫–æ–Ω—Ç–∞–∫—Ç, –ø–æ–¥–¥–µ—Ä–∂–∫–∞, –≤–ª–∏—è–Ω–∏–µ)")
    if scores.get("–ò–∑—É–º—Ä—É–¥", 0) >= 1.15:
        v.append("—ç—Å—Ç–µ—Ç–∏–∫–∞ –∏ –≥–∞—Ä–º–æ–Ω–∏—è (–∫—Ä–∞—Å–æ—Ç–∞, –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞, –≤–∫—É—Å)")
    if scores.get("–†—É–±–∏–Ω", 0) >= 1.15:
        v.append("–ø—Ä–æ—è–≤–ª–µ–Ω–Ω–æ—Å—Ç—å –∏ —ç–º–æ—Ü–∏–∏ (—Å—Ü–µ–Ω–∞, –¥—Ä–∞–π–≤, –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è)")
    if scores.get("–®—É–Ω–≥–∏—Ç", 0) >= 1.15:
        v.append("—Ç–µ–ª–æ –∏ —Ä–µ—Å—É—Ä—Å (—ç–Ω–µ—Ä–≥–∏—è, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å)")
    if scores.get("–Ø–Ω—Ç–∞—Ä—å", 0) >= 1.35:
        v.append("–ø–æ—Ä—è–¥–æ–∫ –∏ —Å–∏—Å—Ç–µ–º–∞ (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –ø—Ä–æ—Ü–µ—Å—Å—ã, –ø—Ä–∞–≤–∏–ª–∞)")
    return v[:6]
    
def top_n_from_map(d: dict, n=3):
    items = sorted((d or {}).items(), key=lambda x: float(x[1]), reverse=True)
    return [p for p, v in items if float(v) > 0][:n]

ROW_NAMES = ["1", "2", "3"]
COLS = ["perception", "motivation", "instrument"]

def build_matrix_3x3_unique(scores: dict, col_scores: dict) -> dict:
    """
    –°–æ–±–∏—Ä–∞–µ—Ç –º–∞—Ç—Ä–∏—Ü—É 3√ó3 –ë–ï–ó –ø–æ–≤—Ç–æ—Ä–æ–≤ –∫–∞–º–Ω–µ–π.
    –ò–¥–µ—è:
    - –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–∏ –±–µ—Ä—ë–º —Ä–µ–π—Ç–∏–Ω–≥ –∏–∑ col_scores (–µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî fallback –Ω–∞ scores)
    - –ó–∞–ø–æ–ª–Ω—è–µ–º 1 —Ä—è–¥: –ª—É—á—à–∏–µ (—è–¥—Ä–æ)
    - 2 —Ä—è–¥: —Å–ª–µ–¥—É—é—â–∏–µ (—Å–æ—Ü —Å–ª–æ–π)
    - 3 —Ä—è–¥: –æ—Å—Ç–∞–≤—à–∏–µ—Å—è (—Ä–∏—Å–∫–∏/–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å)
    """

    # 1) –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–∏
    col_rank = {}
    for c in COLS:
        src = (col_scores or {}).get(c) or {}
        if not src:
            src = scores or {}
        col_rank[c] = sorted(src.items(), key=lambda x: float(x[1]), reverse=True)

    used = set()
    rows = []

    # helper: –≤–∑—è—Ç—å –ª—É—á—à–∏–π –∫–∞–º–µ–Ω—å, –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—â—ë –Ω–µ—Ç
    def pick_best(col, start_index=0):
        ranked = col_rank[col]
        for p, v in ranked[start_index:]:
            if p not in used:
                used.add(p)
                return p
        # –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –≤—Å—ë –∑–∞–Ω—è—Ç–æ ‚Äî fallback: –ª—é–±–æ–π –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –∏–∑ POTS
        for p in POTS:
            if p not in used:
                used.add(p)
                return p
        return "‚Äî"

    # 2) 1 —Ä—è–¥ (—è–¥—Ä–æ) ‚Äî —Å–∞–º—ã–µ —Å–∏–ª—å–Ω—ã–µ –ø–æ –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–µ
    r1 = {
        "row": "1",
        "perception": pick_best("perception"),
        "motivation": pick_best("motivation"),
        "instrument": pick_best("instrument"),
    }
    rows.append(r1)

    # 3) 2 —Ä—è–¥ ‚Äî —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ —Å–∏–ª–µ (–±–µ—Ä—ë–º —Å–æ —Å–º–µ—â–µ–Ω–∏–µ–º –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ)
    # –º–æ–∂–Ω–æ –º—è–≥–∫–æ —Å–¥–≤–∏–≥–∞—Ç—å –∏–Ω–¥–µ–∫—Å, —á—Ç–æ–±—ã –Ω–µ –±—Ä–∞—Ç—å —Å–Ω–æ–≤–∞ —Ç–µ—Ö –∂–µ ‚Äú—Ç–æ–ø–æ–≤‚Äù
    r2 = {
        "row": "2",
        "perception": pick_best("perception", start_index=1),
        "motivation": pick_best("motivation", start_index=1),
        "instrument": pick_best("instrument", start_index=1),
    }
    rows.append(r2)

    # 4) 3 —Ä—è–¥ ‚Äî –æ—Å—Ç–∞–≤—à–∏–µ—Å—è
    r3 = {
        "row": "3",
        "perception": pick_best("perception", start_index=2),
        "motivation": pick_best("motivation", start_index=2),
        "instrument": pick_best("instrument", start_index=2),
    }
    rows.append(r3)

    return {"rows": rows}

def matrix_markdown_table(m: dict) -> str:
    rows = (m or {}).get("rows", [])
    if not rows:
        return ""

    header = "| –†—è–¥ | –í–æ—Å–ø—Ä–∏—è—Ç–∏–µ | –ú–æ—Ç–∏–≤–∞—Ü–∏—è | –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç |\n|---|---|---|---|\n"
    body = ""
    for r in rows:
        body += (
            f"| {r.get('row','‚Äî')} "
            f"| {r.get('perception','‚Äî')} "
            f"| {r.get('motivation','‚Äî')} "
            f"| {r.get('instrument','‚Äî')} |\n"
        )
    return header + body

# ======================
# SESSIONS STORAGE
# ======================
def session_path(session_id: str) -> Path:
    return SESSIONS_DIR / f"{session_id}.json"

def save_session(payload: dict):
    sid = payload["meta"]["session_id"]
    session_path(sid).write_text(json.dumps(payload, ensure_ascii=False, indent=2), encoding="utf-8")

def load_session(sid: str):
    p = session_path(sid)
    if not p.exists():
        return None
    return json.loads(p.read_text(encoding="utf-8"))

def list_sessions():
    out = []
    for p in sorted(SESSIONS_DIR.glob("*.json"), key=lambda x: x.stat().st_mtime, reverse=True):
        try:
            out.append(json.loads(p.read_text(encoding="utf-8")))
        except Exception:
            continue
    return out

# ======================
# STATE
# ======================
def init_state():
    st.session_state.setdefault("session_id", str(uuid.uuid4()))
    st.session_state.setdefault("q_index", 0)
    st.session_state.setdefault("answers", {})
    st.session_state.setdefault("event_log", [])
    st.session_state.setdefault("master_authed", False)
    st.session_state.setdefault("master_selected_session", None)
    st.session_state.setdefault("hybrid_qs", [])          # —Å–ø–∏—Å–æ–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
    st.session_state.setdefault("hybrid_answers", {})     # id -> answer
    st.session_state.setdefault("hybrid_turn", 0)         # —Å–∫–æ–ª—å–∫–æ —É–∂–µ —Å–ø—Ä–æ—Å–∏–ª–∏
    st.session_state.setdefault("hybrid_done", False)

def reset_diagnostic():
    # –Ω–æ–≤—ã–π session_id —á—Ç–æ–±—ã –Ω–µ –∑–∞–ª–∏–ø–∞–ª–æ –Ω–∞ ‚Äú–∑–∞–≤–µ—Ä—à–µ–Ω–æ‚Äù
    st.session_state["session_id"] = str(uuid.uuid4())
    st.session_state["q_index"] = 0
    st.session_state["answers"] = {}
    st.session_state["event_log"] = {}
    st.session_state["event_log"] = []

def is_nonempty(q, ans):
    if q["type"] == "multi":
        return isinstance(ans, list) and len(ans) > 0
    return bool(str(ans or "").strip())

def current_meta(answers: dict):
    name = str(answers.get("intake.ask_name","") or "").strip()
    request = str(answers.get("intake.ask_request","") or "").strip()
    contact = str(answers.get("intake.contact","") or "").strip()
    return name, request, contact

def build_payload(answers: dict, event_log: list, session_id: str):
    scores, evidence, col_scores = score_all(answers)
    name, request, contact = current_meta(answers)

    # --- TOP lists ---
    ranked = sorted(scores.items(), key=lambda x: float(x[1]), reverse=True)
    top3 = [{"pot": p, "score": float(s)} for p, s in ranked[:3]]
    top6 = [{"pot": p, "score": float(s)} for p, s in ranked[:6]]

    # --- excerpt (–∫–∞–∫ –≤ –º–∞—Å—Ç–µ—Ä-—Ç–∞–±–ª–∏—Ü–µ) ---
    important_keys = [
        "intake.ask_request",
        "intake.current_state",
        "intake.goal_3m",
        "now.easy_tasks",
        "now.praise_for",
        "now.best_result_example",
        "now.energy_fill",
        "behavior.group_role_now",
        "behavior.decision_style",
        "antipattern.avoid",
        "antipattern.hate_task",
        "antipattern.energy_leak",
    ]
    answers_excerpt = {k: answers.get(k) for k in important_keys if k in answers}

    # --- risks (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ, –±–µ–∑ AI) ---
    risks = []
    hate = str(answers.get("antipattern.hate_task", "") or "").lower()
    if "—Ä—É—Ç–∏–Ω–∞" in hate or "—Ä–µ–≥–ª–∞–º–µ–Ω—Ç" in hate or "–ø–æ—Ä—è–¥–æ–∫" in hate:
        risks.append("–Ω–µ –≤—ã–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä—É—Ç–∏–Ω—É/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã ‚Üí –Ω—É–∂–µ–Ω –¥–µ–ª–µ–≥–∞—Ç/—Å–∏—Å—Ç–µ–º–∞")
    if not str(answers.get("intake.current_state", "") or "").strip():
        risks.append("–Ω–µ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–æ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –∑–∞–±–∏—Ä–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é ‚Üí —Å—Ç–æ–∏—Ç —É—Ç–æ—á–Ω–∏—Ç—å –Ω–∞ —Å–æ–∑–≤–æ–Ω–µ")

    payload = {
        "meta": {
            "schema": "ai-neo.session.v7",
            "app_version": APP_VERSION,
            "timestamp": utcnow_iso(),
            "session_id": session_id,
            "name": name,
            "request": request,
            "contact": contact,
            "question_count": len(question_plan()),
            "answered_count": len(event_log),
        },
        "answers": answers,
        "scores": scores,
        "evidence": evidence,
        "col_scores": col_scores,
        "vectors_no_labels": vectors_without_labels(scores),
        "top3": top3,
        "top6": top6,
        "answers_excerpt": answers_excerpt,
        "risks": risks,
        "event_log": event_log,
    }
    return payload

# ======================
# CLIENT MINI REPORT (SCHOOL STYLE, CANON ONLY)
# ======================
def build_client_mini_report(payload: dict) -> str:
    payload = payload or {}

    ok, msg = report_ready(payload)
    if not ok:
        return msg

    meta = payload.get("meta", {}) or {}
    name = _s(meta.get("name")) or "–¢—ã"
    request = _s(meta.get("request")) or "—Ç–≤–æ–π –∑–∞–ø—Ä–æ—Å"

    answers = payload.get("answers", {}) or {}
    scores = payload.get("scores", {}) or {}
    vectors = payload.get("vectors", []) or []

    # –º–∞—Ç—Ä–∏—Ü–∞ –≥–æ—Ç–æ–≤–∞—è –∏–ª–∏ —Å–æ–±–∏—Ä–∞–µ–º
    matrix = payload.get("matrix") or {}
    rows = (matrix or {}).get("rows") or []

    if not rows:
        col_scores = payload.get("col_scores") or {}
        if "build_matrix_3x3_unique" in globals():
            matrix = build_matrix_3x3_unique(scores, col_scores)
        elif "build_matrix_3x3" in globals():
            matrix = build_matrix_3x3(scores, col_scores)
        else:
            matrix = {"rows": []}
        rows = (matrix or {}).get("rows") or []

    if not rows:
        return "‚ö†Ô∏è –ú–∞—Ç—Ä–∏—Ü–∞ –Ω–µ —Å–æ–±—Ä–∞–Ω–∞: –ø—Ä–æ–≤–µ—Ä—å scoring –∏ —Å–±–æ—Ä–∫—É matrix –ø–µ—Ä–µ–¥ –æ—Ç—á—ë—Ç–æ–º."

    # –∫–æ–Ω—Ç–µ–∫—Å—Ç (–ø–æ —à–∫–æ–ª–µ ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ—Ä–æ—Ç–∫–æ)
    energy_fill = answers.get("now.energy_fill", [])
    fill_txt = ", ".join([_s(x) for x in (energy_fill or []) if _s(x)][:4]) or "‚Äî"
    leak = _s(answers.get("antipattern.energy_leak")) or "‚Äî"
    hate = _s(answers.get("antipattern.hate_task")) or "‚Äî"
    avoid = _s(answers.get("antipattern.avoid")) or "‚Äî"

    vtxt = "\n".join([f"- {v}" for v in (vectors or [])[:6]]) if vectors else "- ‚Äî"
    matrix_table = matrix_markdown_table({"rows": rows})

    COLS = [("perception", "–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ (1 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª)"),
            ("motivation", "–ú–æ—Ç–∏–≤–∞—Ü–∏—è/—Ü–µ–ª—å (2 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª)"),
            ("instrument", "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (3 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª)")]

    blocks = []
    for r in rows:
        row_id = _s(r.get("row")) or "‚Äî"
        b = [f"## –†—è–¥ {row_id}", row_intro_school(row_id)]

        for col, label in COLS:
            pot = _s(r.get(col))
            if pot and pot != "‚Äî":
                b.append(f"### {pot} ‚Äî {label}\n{canon_cell(pot, col)}")

        footer = row_footer_school(row_id)
        if footer:
            b.append(f"**–í—ã–≤–æ–¥ –ø–æ —Ä—è–¥—É:** {footer}")

        blocks.append("\n\n".join(b))

    # –≥–∏–ø–æ—Ç–µ–∑–∞ ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ –æ—Ç–≤–µ—Ç–∞–º, –±–µ–∑ ‚Äú–∫–∞–º–Ω–µ–π‚Äù
    trap = _s(answers.get("antipattern.perfection_trap")) or "‚Äî"
    stress = _s(answers.get("now.stress_pattern")) or "‚Äî"
    hyp = []
    if trap != "‚Äî":
        hyp.append(f"- –¢–æ—Ä–º–æ–∂–µ–Ω–∏–µ —á–∞—Å—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–∞—Ç—Ç–µ—Ä–Ω: **{trap}**.")
    if hate != "‚Äî":
        hyp.append(f"- –°–∏–ª—å–Ω–æ–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –≤—ã–∑—ã–≤–∞–µ—Ç –∑–æ–Ω–∞: **{hate}** (—ç—Ç–æ –≤–∞–∂–Ω–æ –æ–±—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫—É/—Å—Ç—Ä—É–∫—Ç—É—Ä—É).")
    if avoid != "‚Äî":
        hyp.append(f"- –ï—Å—Ç—å –æ—Ç–∫–ª–∞–¥—ã–≤–∞–Ω–∏–µ: **{avoid}** ‚Äî –∏–∑-–∑–∞ —ç—Ç–æ–≥–æ —Ç–µ—Ä—è–µ—Ç—Å—è —Ç–µ–º–ø.")
    if stress != "‚Äî":
        hyp.append(f"- –ü–æ–¥ –¥–∞–≤–ª–µ–Ω–∏–µ–º –≤–∫–ª—é—á–∞–µ—Ç—Å—è —Å—Ü–µ–Ω–∞—Ä–∏–π: **{stress}**.")
    hypothesis = "\n".join(hyp) if hyp else "- ‚Äî"

    return f"""
**{name}, –º–∏–Ω–∏-–æ—Ç—á—ë—Ç –ø–æ –∑–∞–ø—Ä–æ—Å—É: ‚Äú{request}‚Äù**

## –ú–∞—Ç—Ä–∏—Ü–∞ 3√ó3
{matrix_table}

## –í–µ–∫—Ç–æ—Ä (–∫—Ä–∞—Ç–∫–æ)
{vtxt}

## –ö–æ–Ω—Ç–µ–∫—Å—Ç —ç–Ω–µ—Ä–≥–∏–∏ (–ø–æ –æ—Ç–≤–µ—Ç–∞–º)
- –ß—Ç–æ –Ω–∞–ø–æ–ª–Ω—è–µ—Ç: **{fill_txt}**
- –ì–¥–µ —Å–ª–∏–≤–∞–µ—Ç—Å—è: **{leak}**
- –ß—Ç–æ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—à—å: **{avoid}**
- –ß—Ç–æ —Å–∞–º–æ–µ –Ω–µ–ª—é–±–∏–º–æ–µ: **{hate}**

---

{chr(10).join(blocks)}

---

## –ì–ª–∞–≤–Ω–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞ (–±–µ–∑ —Ñ–∞–Ω—Ç–∞–∑–∏–π, —Ç–æ–ª—å–∫–æ –ø–æ –æ—Ç–≤–µ—Ç–∞–º)
{hypothesis}

–ü–æ–ª–Ω—ã–π –º–∞—Å—Ç–µ—Ä-—Ä–∞–∑–±–æ—Ä = —Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ—â–µ–Ω–∏–π + –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –∂–∏–∑–Ω–∏ + —Å–≤—è–∑–∫–∞ ¬´—Å—Ñ–µ—Ä–∞ ‚Üí —Ü–µ–ª—å ‚Üí –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç¬ª.
""".strip()

# ======================
# INSIGHT TABLE (MASTER)
# ======================
def build_insight_table(payload: dict) -> dict:
    """
    –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞/LLM:
    - top3/top6 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤
    - vectors_no_labels (–¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –æ—Ç—á—ë—Ç–∞ –±–µ–∑ –∫–∞–º–Ω–µ–π)
    - col_scores (–í–û–°–ü–†–ò–Ø–¢–ò–ï/–ú–û–¢–ò–í–ê–¶–ò–Ø/–ò–ù–°–¢–†–£–ú–ï–ù–¢)
    - answers_excerpt (—Å–∂–∞—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã)
    - risks (—Ä–∏—Å–∫–∏/—Å–ª–∏–≤—ã)
    """
    meta = payload.get("meta", {})
    answers = payload.get("answers", {})
    scores = payload.get("scores", {}) or {}
    col_scores = payload.get("col_scores", {}) or {}

    # –í–µ–∫—Ç–æ—Ä—ã ‚Äî —É —Ç–µ–±—è –≤ payload —ç—Ç–æ –æ–±—ã—á–Ω–æ vectors_no_labels
    vectors = payload.get("vectors_no_labels", []) or payload.get("vectors_no_labels".replace("_no_labels", ""), [])
    if not vectors:
        vectors = payload.get("vectors_no_labels", []) or []

    ranked = sorted(scores.items(), key=lambda x: float(x[1]), reverse=True)
    top3 = [{"pot": p, "score": round(float(s), 2)} for p, s in ranked[:3]]
    top6 = [{"pot": p, "score": round(float(s), 2)} for p, s in ranked[:6]]

    # –°–∂–∞—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã
    keys = [
        "intake.ask_request",
        "intake.current_state",
        "intake.goal_3m",
        "now.easy_tasks",
        "now.praise_for",
        "now.best_result_example",
        "now.energy_fill",
        "behavior.group_role_now",
        "behavior.decision_style",
        "antipattern.avoid",
        "antipattern.hate_task",
        "antipattern.energy_leak",
    ]
    answers_excerpt = {k: answers.get(k) for k in keys if k in answers}

    # –†–∏—Å–∫–∏/—Å–ª–∏–≤—ã (–ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞)
    risks = []
    hate = str(answers.get("antipattern.hate_task", "") or "").lower()
    if any(x in hate for x in ["—Ä—É—Ç–∏–Ω–∞", "–ø–æ—Ä—è–¥–æ–∫", "—Ä–µ–≥–ª–∞–º–µ–Ω—Ç"]):
        risks.append("–Ω–µ –≤—ã–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä—É—Ç–∏–Ω—É/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã ‚Üí –Ω—É–∂–µ–Ω –¥–µ–ª–µ–≥–∞—Ç/—Å–∏—Å—Ç–µ–º–∞")
    if "–ø—Ä–æ–¥–∞–∂–∏" in hate:
        risks.append("—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂–∞–º/—Å–∞–º–æ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ ‚Üí –Ω—É–∂–Ω—ã –º—è–≥–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–æ—è–≤–ª–µ–Ω–Ω–æ—Å—Ç–∏")
    if "–∫–æ–Ω—Ñ–ª–∏–∫—Ç" in hate:
        risks.append("–∏–∑–±–µ–≥–∞–Ω–∏–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è ‚Üí –≤–∞–∂–Ω–æ —É—á–∏—Ç—å—Å—è –¥–µ—Ä–∂–∞—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã")

    return {
        "meta": meta,
        "vectors_no_labels": vectors,
        "top3": top3,
        "top6": top6,
        "scores": scores,
        "col_scores": col_scores,
        "answers_excerpt": answers_excerpt,
        "risks": risks,
    }
# ======================
# KNOWLEDGE SNIPPETS (simple local retrieval)
# ======================
def _read_knowledge_files():
    docs = []
    if not KNOWLEDGE_DIR.exists():
        return docs
    for p in sorted(KNOWLEDGE_DIR.glob("*.md")):
        try:
            txt = p.read_text(encoding="utf-8", errors="ignore")
            if txt.strip():
                docs.append({"path": str(p), "text": txt})
        except Exception:
            continue
    return docs

def _tokenize(s: str):
    s = (s or "").lower()
    s = re.sub(r"[^a-z–∞-—è0-9—ë]+", " ", s, flags=re.IGNORECASE)
    parts = [x for x in s.split() if len(x) >= 3]
    return parts

def get_knowledge_snippets(payload: dict, top_k: int = 6):
    """
    –û—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ–π retrieval –±–µ–∑ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –ë–î:
    - —Å–æ–±–∏—Ä–∞–µ–º query –∏–∑ –∑–∞–ø—Ä–æ—Å–∞+–≤–µ–∫—Ç–æ—Ä–æ–≤+–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
    - —Å—á–∏—Ç–∞–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Å–ª–æ–≤ –∏ –≤—ã–±–∏—Ä–∞–µ–º –ª—É—á—à–∏–µ –∫—É—Å–∫–∏
    """
    docs = _read_knowledge_files()
    if not docs:
        return []

    meta = payload.get("meta", {})
    answers = payload.get("answers", {})
    vectors = payload.get("vectors", [])

    query_text = " ".join([
        str(meta.get("request","") or ""),
        " ".join(vectors),
        str(answers.get("now.best_result_example","") or ""),
        str(answers.get("antipattern.energy_leak","") or ""),
        str(answers.get("now.praise_for","") or ""),
    ])

    qwords = set(_tokenize(query_text))
    if not qwords:
        return []

    scored = []
    for d in docs:
        text = d["text"]
        # –¥—Ä–æ–±–∏–º –Ω–∞ ‚Äú–∞–±–∑–∞—Ü—ã‚Äù
        chunks = [c.strip() for c in re.split(r"\n{2,}", text) if c.strip()]
        for c in chunks:
            words = set(_tokenize(c))
            inter = len(qwords.intersection(words))
            if inter <= 0:
                continue
            score = inter / max(20, len(words))
            scored.append({
                "source": d["path"],
                "score": round(score, 4),
                "excerpt": c[:1800]
            })

    scored.sort(key=lambda x: x["score"], reverse=True)
    return scored[:top_k]

def run_self_test_cases():
    """
    9 —ç—Ç–∞–ª–æ–Ω–Ω—ã—Ö –∫–µ–π—Å–æ–≤: –æ—Ç–≤–µ—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —è–∑—ã–∫–æ–º (–±–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã—Ö —Å–ª–æ–≤ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ).
    –û–∂–∏–¥–∞–µ–º: top-1 –∏–ª–∏ —Ö–æ—Ç—è –±—ã top-2 —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å expected.
    """
    cases = []

    # 1) –Ø–Ω—Ç–∞—Ä—å ‚Äî –ø–æ—Ä—è–¥–æ–∫/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã/—Å–∏—Å—Ç–µ–º–∞
    cases.append({
        "expected": "–Ø–Ω—Ç–∞—Ä—å",
        "answers": {
            "now.easy_tasks": "–ù–∞–≤–æ–∂—É –ø–æ—Ä—è–¥–æ–∫ –≤ —Ö–∞–æ—Å–µ: —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è, —Ç–∞–±–ª–∏—Ü—ã, –¥–µ–¥–ª–∞–π–Ω—ã, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è.",
            "now.best_result_example": "–°–æ–±—Ä–∞–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å: –∫—Ç–æ —á—Ç–æ –¥–µ–ª–∞–µ—Ç, —Å—Ä–æ–∫–∏, –∫–æ–Ω—Ç—Ä–æ–ª—å, —Ç–µ–ø–µ—Ä—å –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Å–±–æ–µ–≤.",
            "behavior.decision_style": "–ß–µ—Ä–µ–∑ –ø–æ—Ä—è–¥–æ–∫/–ø—Ä–∞–≤–∏–ª–∞",
            "now.attention_first": "–†–∏—Å–∫–∏/—Å–∏—Å—Ç–µ–º—É/–ø–æ—Ä—è–¥–æ–∫",
            "antipattern.hate_task": "–î–æ–ª–≥–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –Ω–∏ –æ —á—ë–º",
        }
    })

    # 2) –®—É–Ω–≥–∏—Ç ‚Äî —Ç–µ–ª–æ/–¥–≤–∏–∂–µ–Ω–∏–µ/–≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å
    cases.append({
        "expected": "–®—É–Ω–≥–∏—Ç",
        "answers": {
            "now.easy_tasks": "–ú–Ω–µ –ø—Ä–æ—â–µ —Å–¥–µ–ª–∞—Ç—å, —á–µ–º –æ–±—Å—É–∂–¥–∞—Ç—å. –î–≤–∏–≥–∞—Ç—å—Å—è, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è, –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å.",
            "now.energy_fill": ["–°–ø–æ—Ä—Ç/–¥–≤–∏–∂–µ–Ω–∏–µ/—Ç–µ–ª–æ"],
            "behavior.money_spend": ["–ù–∞ –∑–¥–æ—Ä–æ–≤—å–µ/—Å–ø–æ—Ä—Ç"],
            "scn.ideal_day": "–¶–µ–ª–µ–π –∏ –¥–≤–∏–∂–µ–Ω–∏—è –∫ –Ω–∏–º",
            "antipattern.hate_task": "–£—á—ë–±–∞/–∑—É–±—Ä—ë–∂–∫–∞",
        }
    })

    # 3) –¶–∏—Ç—Ä–∏–Ω ‚Äî –¥–µ–Ω—å–≥–∏/—Ä–µ–∑—É–ª—å—Ç–∞—Ç/–≤—ã–≥–æ–¥–∞
    cases.append({
        "expected": "–¶–∏—Ç—Ä–∏–Ω",
        "answers": {
            "intake.ask_request": "–•–æ—á—É —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ—Ö–æ–¥ –∏ –±—ã—Å—Ç—Ä–µ–µ –≤—ã–π—Ç–∏ –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.",
            "now.motivation_trigger": "–î–µ–Ω—å–≥–∏/—Ä–µ–∑—É–ª—å—Ç–∞—Ç/—Å–∫–æ—Ä–æ—Å—Ç—å",
            "behavior.decision_style": "–ß–µ—Ä–µ–∑ –≤—ã–≥–æ–¥—É/—Ü–∏—Ñ—Ä—ã",
            "scn.feedback_pain": "–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞/–¥–µ–Ω–µ–≥",
            "now.best_result_example": "–ü–æ–¥–Ω—è–ª –ø—Ä–æ–¥–∞–∂–∏: –ø–µ—Ä–µ—Å–æ–±—Ä–∞–ª –æ—Ñ—Ñ–µ—Ä, –∫–æ–Ω–≤–µ—Ä—Å–∏—è –≤—ã—Ä–æ—Å–ª–∞, –≤—ã—Ä—É—á–∫–∞ –ø–æ–¥–Ω—è–ª–∞—Å—å.",
        }
    })

    # 4) –ò–∑—É–º—Ä—É–¥ ‚Äî —ç—Å—Ç–µ—Ç–∏–∫–∞/–≥–∞—Ä–º–æ–Ω–∏—è/—É—é—Ç
    cases.append({
        "expected": "–ò–∑—É–º—Ä—É–¥",
        "answers": {
            "now.energy_fill": ["–ö—Ä–∞—Å–∏–≤—ã–µ –º–µ—Å—Ç–∞/—ç—Å—Ç–µ—Ç–∏–∫–∞/—É—é—Ç"],
            "now.attention_first": "–ö—Ä–∞—Å–æ—Ç—É/–∞—Ç–º–æ—Å—Ñ–µ—Ä—É",
            "scn.project_start": "–î–µ–ª–∞—é –∫—Ä–∞—Å–∏–≤–æ/—É–ø–∞–∫–æ–≤—ã–≤–∞—é",
            "behavior.money_spend": ["–ù–∞ –∫—Ä–∞—Å–æ—Ç—É/–æ–¥–µ–∂–¥—É/–¥–æ–º/—É—é—Ç"],
            "antipattern.hate_task": "–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã/–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ",
        }
    })

    # 5) –†—É–±–∏–Ω ‚Äî —Å—Ü–µ–Ω–∞/—ç–º–æ—Ü–∏–∏/–¥—Ä–∞–π–≤
    cases.append({
        "expected": "–†—É–±–∏–Ω",
        "answers": {
            "now.energy_fill": ["–°—Ü–µ–Ω–∞/–∏–≤–µ–Ω—Ç—ã/–≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è"],
            "scn.ideal_day": "–≠–º–æ—Ü–∏–π –∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–π",
            "scn.conflict_style": "–ü–µ—Ä–µ–≤–æ–∂—É –≤ —ç–º–æ—Ü–∏—é/—Å—Ü–µ–Ω—É",
            "now.stress_pattern": "–°—Ç–∞–Ω–æ–≤–ª—é—Å—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π(—ã–º)",
            "antipattern.hate_task": "–†—É—Ç–∏–Ω–∞/–ø–æ—Ä—è–¥–æ–∫/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã",
        }
    })

    # 6) –ì—Ä–∞–Ω–∞—Ç ‚Äî –ª—é–¥–∏/—Å–≤—è–∑—å/–∑–∞–±–æ—Ç–∞/–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ
    cases.append({
        "expected": "–ì—Ä–∞–Ω–∞—Ç",
        "answers": {
            "now.attention_first": "–õ—é–¥–µ–π/—ç–º–æ—Ü–∏–∏",
            "now.energy_fill": ["–û–±—â–µ–Ω–∏–µ –∏ –±–ª–∏–∑–∫–∏–µ –ª—é–¥–∏"],
            "behavior.group_role_now": "–û–±—ä–µ–¥–∏–Ω—è—é –ª—é–¥–µ–π",
            "scn.conflict_style": "–°–≥–ª–∞–∂–∏–≤–∞—é –∏ –æ–±—ä–µ–¥–∏–Ω—è—é",
            "now.praise_for": "–ó–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É, —É–º–µ–Ω–∏–µ —Å–ª—ã—à–∞—Ç—å, —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤—è–∑—å.",
        }
    })

    # 7) –°–∞–ø—Ñ–∏—Ä ‚Äî —Å–º—ã—Å–ª/–≥–ª—É–±–∏–Ω–∞/–ø–æ—á–µ–º—É
    cases.append({
        "expected": "–°–∞–ø—Ñ–∏—Ä",
        "answers": {
            "now.attention_first": "–°–º—ã—Å–ª/–∏–¥–µ—é/–ø–æ—á–µ–º—É —Ç–∞–∫",
            "now.time_flow": "–ö–æ–≥–¥–∞ —Ä–∞–∑–±–∏—Ä–∞—é, –ø–æ—á–µ–º—É –≤—Å—ë —É—Å—Ç—Ä–æ–µ–Ω–æ –∏–º–µ–Ω–Ω–æ —Ç–∞–∫, –∏ –∫–∞–∫ —ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –ª—é–¥–µ–π.",
            "scn.listen_focus": "–°–º—ã—Å–ª/–º—ã—Å–ª—å",
            "scn.feedback_pain": "–ù–µ—Ç —Å–º—ã—Å–ª–∞",
            "antipattern.perfection_trap": "–ù–µ—Ç —Å–º—ã—Å–ª–∞ ‚Äî –Ω–µ –≤–∫–ª—é—á–∞—é—Å—å",
        }
    })

    # 8) –ì–µ–ª–∏–æ–¥–æ—Ä ‚Äî –∑–Ω–∞–Ω–∏—è/–æ–±—É—á–µ–Ω–∏–µ/–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
    cases.append({
        "expected": "–ì–µ–ª–∏–æ–¥–æ—Ä",
        "answers": {
            "now.time_flow": "–ö–æ–≥–¥–∞ —É—á—É—Å—å –∏ –æ–±—ä—è—Å–Ω—è—é –¥—Ä—É–≥–∏–º: –º–æ–≥—É —Ä–∞–∑–∂–µ–≤–∞—Ç—å —Å–ª–æ–∂–Ω–æ–µ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.",
            "behavior.money_spend": ["–ù–∞ –æ–±—É—á–µ–Ω–∏–µ/–∫—É—Ä—Å—ã/–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é"],
            "now.praise_for": "–ó–∞ —Ç–æ, —á—Ç–æ –æ–±—É—á–∞—é, —Å–∏—Å—Ç–µ–º–Ω–æ –æ–±—ä—è—Å–Ω—è—é –∏ –¥–∞—é —è—Å–Ω–æ—Å—Ç—å.",
            "scn.project_start": "–ò—â—É —Å–º—ã—Å–ª/–∫–æ–Ω—Ü–µ–ø—Ü–∏—é",
            "antipattern.hate_task": "–§–∏–∑–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞",
        }
    })

    # 9) –ê–º–µ—Ç–∏—Å—Ç ‚Äî —Ü–µ–ª—å/–≤–µ–∫—Ç–æ—Ä/—Å—Ç—Ä–∞—Ç–µ–≥–∏—è/—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    cases.append({
        "expected": "–ê–º–µ—Ç–∏—Å—Ç",
        "answers": {
            "now.motivation_trigger": "–¶–µ–ª—å/—Å—Ç—Ä–∞—Ç–µ–≥–∏—è/–≤–µ–∫—Ç–æ—Ä",
            "scn.project_start": "–°—Ç–∞–≤–ª—é —Ü–µ–ª—å –∏ –ø–ª–∞–Ω",
            "now.best_result_example": "–°–æ–±—Ä–∞–ª–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã, —ç—Ç–∞–ø—ã, –º–µ—Ç—Ä–∏–∫–∏ ‚Äî –∫–æ–º–∞–Ω–¥–∞ –ø–æ—à–ª–∞ –±—ã—Å—Ç—Ä–µ–µ.",
            "behavior.decision_style": "–ß–µ—Ä–µ–∑ –ø–æ—Ä—è–¥–æ–∫/–ø—Ä–∞–≤–∏–ª–∞",
            "scn.feedback_pain": "–ë–∞—Ä–¥–∞–∫/—Ö–∞–æ—Å",
        }
    })

    results = []
    for i, c in enumerate(cases, start=1):
        scores, evidence, col_scores = score_all(c["answers"])
        ranked = sorted(scores.items(), key=lambda x: float(x[1]), reverse=True)[:3]
        results.append({
            "case": i,
            "expected": c["expected"],
            "top1": ranked[0][0] if ranked else "‚Äî",
            "top2": ranked[1][0] if len(ranked) > 1 else "‚Äî",
            "top3": ranked[2][0] if len(ranked) > 2 else "‚Äî",
            "score_top1": float(ranked[0][1]) if ranked else 0.0
        })

    return results


# --- UI –∫–Ω–æ–ø–∫–∞ –≤ –º–∞—Å—Ç–µ—Ä-–ø–∞–Ω–µ–ª–∏ ---
st.markdown("---")
st.subheader("üß™ Self-test —Ç–æ—á–Ω–æ—Å—Ç–∏ —Å–∫–æ—Ä–∏–Ω–≥–∞ (9 —ç—Ç–∞–ª–æ–Ω–Ω—ã—Ö –∫–µ–π—Å–æ–≤)")
if st.button("–ó–∞–ø—É—Å—Ç–∏—Ç—å Self-test", use_container_width=True):
    rows = run_self_test_cases()
    ok_top1 = sum(1 for r in rows if r["expected"] == r["top1"])
    ok_top2 = sum(1 for r in rows if r["expected"] in [r["top1"], r["top2"]])

    st.write(f"‚úÖ –ü–æ–ø–∞–¥–∞–Ω–∏–µ –≤ Top-1: **{ok_top1}/9**")
    st.write(f"‚úÖ –ü–æ–ø–∞–¥–∞–Ω–∏–µ –≤ Top-2: **{ok_top2}/9**")
    st.table(rows)

# ======================
# OPENAI REPORT (MASTER)
# ======================
def build_report_system_prompt():
    return """
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –º–µ—Ç–æ–¥–∏–∫–µ –°–ü–ß/–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—ã (–º–∞—Ç—Ä–∏—Ü–∞ 3√ó3).

–ñ–Å–°–¢–ö–û:
- –ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏.
- –ù–µ –≤–æ–¥–∞. –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ.
- –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –æ—Ç—á—ë—Ç ‚Äî –ø–æ–Ω—è—Ç–Ω—ã–π, —Ç—ë–ø–ª—ã–π, –Ω–æ –±–µ–∑ —ç–∑–æ—Ç–µ—Ä–∏–∫–∏ –∏ –ø–∞—Ñ–æ—Å–∞.
- –ú–∞—Å—Ç–µ—Ä—Å–∫–∏–π –æ—Ç—á—ë—Ç ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω—ã–π, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π, —Å –≥–∏–ø–æ—Ç–µ–∑–∞–º–∏, –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏ –∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏.
- –ú–∞—Ç—Ä–∏—Ü–∞ 3√ó3 = 3 —Ä—è–¥–∞ √ó 3 —Å—Ç–æ–ª–±—Ü–∞:
  –°—Ç–æ–ª–±—Ü—ã: –í–æ—Å–ø—Ä–∏—è—Ç–∏–µ / –ú–æ—Ç–∏–≤–∞—Ü–∏—è / –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (–¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ü–µ–ª–µ–π)
  –†—è–¥—ã: 1 —Ä—è–¥ (—è–¥—Ä–æ/–ø—Ä–∏—Ä–æ–¥–∞/—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è), 2 —Ä—è–¥ (—ç–Ω–µ—Ä–≥–∏—è –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è/—Ö–æ–±–±–∏), 3 —Ä—è–¥ (—Ä–∏—Å–∫–∏/—Å–ª–∏–≤—ã/—á—Ç–æ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å)

–§–û–†–ú–ê–¢ –í–´–í–û–î–ê ‚Äî –°–¢–†–û–ì–û –¢–ê–ö (–¥–≤–µ —Å–µ–∫—Ü–∏–∏):
<<<CLIENT_REPORT>>>
...—Ç–µ–∫—Å—Ç...
<<<MASTER_REPORT>>>
...—Ç–µ–∫—Å—Ç...
""".strip()

def build_client_report_prompt():
    return """
–°–¥–µ–ª–∞–π CLIENT-–æ—Ç—á—ë—Ç (–¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞) ‚Äî –¥–ª–∏–Ω–Ω—ã–π, —Å–∏–ª—å–Ω—ã–π, ‚Äú—É–∑–Ω–∞–≤–∞–µ–º—ã–π‚Äù.
–û–±—ä—ë–º: 60‚Äì120 —Å—Ç—Ä–æ–∫.

–í–ê–ñ–ù–û:
- –ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏.
- –ò—Å–ø–æ–ª—å–∑—É–π –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞–º–Ω–µ–π (—ç—Ç–æ –º–æ–∂–Ω–æ –∏ –Ω—É–∂–Ω–æ).
- –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –æ—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞ –∏ –ù–ï —Ü–∏—Ç–∏—Ä—É–π –∏—Ö (‚Äú—Ç—ã –ø–∏—Å–∞–ª/—Ç—ã —Å–∫–∞–∑–∞–ª–∞‚Äù) ‚Äî —Ç–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è.
- –ù–ï –¥–∞–≤–∞–π –∑–∞–¥–∞–Ω–∏–π, –ø—Ä–∞–∫—Ç–∏–∫, –¥–Ω–µ–≤–Ω–∏–∫–æ–≤, –º–∏–∫—Ä–æ-—à–∞–≥–æ–≤, ‚Äú—Å–¥–µ–ª–∞–π –≤–æ—Ç —ç—Ç–æ‚Äù.
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∏–µ/–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∏ –¥–∏–∞–≥–Ω–æ–∑—ã.
- –¢–æ–Ω: —É–≤–µ—Ä–µ–Ω–Ω—ã–π, —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–π, –±–µ–∑ —ç–∑–æ—Ç–µ—Ä–∏–∫–∏ –∏ –ø–∞—Ñ–æ—Å–∞, –Ω–æ —Å –≥–ª—É–±–∏–Ω–æ–π.

–°–¢–†–£–ö–¢–£–†–ê (—Å—Ç—Ä–æ–≥–æ –ø–æ –±–ª–æ–∫–∞–º):

1) –ó–∞–≥–æ–ª–æ–≤–æ–∫: ‚Äú–¢–≤–æ—è –º–∞—Ç—Ä–∏—Ü–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ 3√ó3 (–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç)‚Äù
   + —Å—Ç—Ä–æ–∫–∞ ‚Äú–ó–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: <request>‚Äù

2) –ë–ª–æ–∫ ‚Äú–ú–∞—Ç—Ä–∏—Ü–∞ 3√ó3‚Äù
   - –ø–æ–∫–∞–∂–∏ 3 —Ä—è–¥–∞ √ó 3 —Å—Ç–æ–ª–±—Ü–∞ (–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ / –ú–æ—Ç–∏–≤–∞—Ü–∏—è / –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç)
   - –≤ –∫–∞–∂–¥–æ–π —è—á–µ–π–∫–µ —É–∫–∞–∂–∏ –∫–∞–º–µ–Ω—å
   - –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Ç–µ–∫—Å—Ç–æ–º, –º–æ–∂–Ω–æ —Ç–∞–±–ª–∏—Ü–µ–π –≤ markdown

3) –ë–ª–æ–∫ ‚Äú–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Ä—è–¥–æ–≤‚Äù
   –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä—è–¥–∞ (1/2/3):
   - ‚Äú–°—É—Ç—å —Ä—è–¥–∞‚Äù (2‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è): –ø–µ—Ä–≤—ã–π —Ä—è–¥ - —ç—Ç–æ –µ–≥–æ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã, –µ–≥–æ —Å—É—Ç—å, –≤—Ç–æ—Ä–æ–π —Ä—è–¥ - —Ä—è–¥ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è/—Ö–æ–±–±–∏, —Å–æ—Ü–∏–∞–ª—å–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Ç—Å–≤–∏–µ
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–º–Ω—è –≤ —ç—Ç–æ–º —Ä—è–¥—É:
       ‚Ä¢ ‚Äú–ö–∞–∫ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –∂–∏–∑–Ω–∏‚Äù (4‚Äì7 –º–∞—Ä–∫–µ—Ä–æ–≤)
       ‚Ä¢ ‚Äú–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã‚Äù (3‚Äì5 –º–∞—Ä–∫–µ—Ä–æ–≤)
       ‚Ä¢ ‚Äú–¢–µ–Ω–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞/—Ä–∏—Å–∫–∏‚Äù (3‚Äì5 –º–∞—Ä–∫–µ—Ä–æ–≤)
   (–í–∞–∂–Ω–æ: –≤—Å—ë –ø–∏—Å–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã —á–µ–ª–æ–≤–µ–∫ —É–∑–Ω–∞–≤–∞–ª —Å–µ–±—è.)

4) –ë–ª–æ–∫ ‚Äú–ì–ª–∞–≤–Ω–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞: –ø–æ—á–µ–º—É –ø–æ —Ç–≤–æ–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è‚Äù
   - –î–∞–π 1‚Äì2 —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–∞ (–∫–æ–Ω—Ñ–ª–∏–∫—Ç, —Å–º–µ—â–µ–Ω–∏–µ, –ª–æ–≤—É—à–∫–∞)
   - –û–±—ä—è—Å–Ω–∏ ‚Äú—á—Ç–æ –∏–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç‚Äù –∏ ‚Äú–ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —Ç–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–æ‚Äù
   - –ü–∏—à–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, –Ω–æ –±–µ–∑ —Å–æ–≤–µ—Ç–æ–≤ –∏ –∑–∞–¥–∞–Ω–∏–π

5) –ë–ª–æ–∫ ‚Äú–ü–æ—á–µ–º—É —ç—Ç–æ –Ω–µ —Ä–µ—à–∞–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ —Å–∏–ª–æ–π –≤–æ–ª–∏‚Äù
   - 6‚Äì10 —Å—Ç—Ä–æ–∫, –ª–æ–≥–∏—á–Ω–æ, –±–µ–∑ –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–∏–∏

6) –ë–ª–æ–∫ ‚Äú–ß—Ç–æ –¥–∞—Å—Ç –ø–æ–ª–Ω—ã–π —Ä–∞–∑–±–æ—Ä —Å –º–∞—Å—Ç–µ—Ä–æ–º‚Äù
   - 5‚Äì7 –º–∞—Ä–∫–µ—Ä–æ–≤: —á—Ç–æ –∏–º–µ–Ω–Ω–æ –º–∞—Å—Ç–µ—Ä —É—Ç–æ—á–Ω—è–µ—Ç/–ø—Ä–æ–≤–µ—Ä—è–µ—Ç/—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç
   - 1 –∫–æ—Ä–æ—Ç–∫–∏–π –∞–±–∑–∞—Ü-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ: ‚Äú–ø–æ–ª–Ω—ã–π –º–∞—Å—Ç–µ—Ä-–æ—Ç—á—ë—Ç + –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è 60 –º–∏–Ω—É—Ç‚Äù
   - CTA –º—è–≥–∫–∏–π, –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è, –Ω–æ —á—Ç–æ–±—ã —Ö–æ—Ç–µ–ª–æ—Å—å.

–î–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–º–∏ –º–æ–∂–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:
- matrix_3x3_inputs (top6, col_scores, risks, excerpts)
- event_log_tail (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–≤–µ—Ç—ã)
- knowledge_snippets (–∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –æ–ø–æ—Ä—É, –Ω–æ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–π –∫–ª–∏–µ–Ω—Ç—É –∏—Å—Ç–æ—á–Ω–∏–∫–∏)
""".strip()


def build_master_report_prompt():
    return """
–°–¥–µ–ª–∞–π MASTER-–æ—Ç—á—ë—Ç (–¥–ª—è –º–∞—Å—Ç–µ—Ä–∞). –°—Ç—Ä—É–∫—Ç—É—Ä–∞:

1) –ú–∞—Ç—Ä–∏—Ü–∞ 3√ó3 (–∫–∞–º–Ω–∏ –ø–æ –∫–ª–µ—Ç–∫–∞–º). 
2) –î–æ–º–∏–Ω–∏—Ä—É—é—â–∏–π —Ä—è–¥: –ø–æ—á–µ–º—É (–ø–æ –æ—Ç–≤–µ—Ç–∞–º/—Ç–∞–±–ª–∏—Ü–µ), –∫–∞–∫ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è.
3) –ü–æ–¥–∞–≤–ª–µ–Ω–Ω—ã–π —Ä—è–¥: –ø—Ä–∏–∑–Ω–∞–∫–∏, –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è, —á—Ç–æ –¥–µ–ª–∞—Ç—å.
4) –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã/—Å–º–µ—â–µ–Ω–∏—è:
   - ‚Äú–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ vs –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç‚Äù
   - ‚Äú–ú–æ—Ç–∏–≤–∞—Ü–∏—è vs –†–µ–∞–ª–∏–∑–∞—Ü–∏—è‚Äù
   - 3 —Ç–∏–ø–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è, –≥–¥–µ –∫–ª–∏–µ–Ω—Ç –∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç.
5) –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è/—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥ –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: 3 —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ + —Ä–∏—Å–∫–∏.
6) –ü–ª–∞–Ω –Ω–∞ 6 –Ω–µ–¥–µ–ª—å (–ø–æ –Ω–µ–¥–µ–ª—è–º):
   - —Ñ–æ–∫—É—Å –Ω–µ–¥–µ–ª–∏
   - 3 –∑–∞–¥–∞—á–∏
   - –º–µ—Ç—Ä–∏–∫–∞ —É—Å–ø–µ—Ö–∞
7) 8 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Å–µ—Å—Å–∏–∏ (–æ—á–µ–Ω—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ, –±—ã—Ç–æ–≤—ã–µ).
8) –ö–æ—Ä–æ—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –º–∞—Å—Ç–µ—Ä—É: ‚Äú–∫–∞–∫ –≤–µ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞‚Äù.

–ü–∏—à–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ.
""".strip()

def call_openai_for_reports(client, model: str, payload: dict):
    table = build_insight_table(payload)
    snips = get_knowledge_snippets(payload)

    # NEW: –º–∞—Ç—Ä–∏—Ü–∞ 3√ó3
    scores = payload.get("scores", {}) or {}
    col_scores = payload.get("col_scores", {}) or {}
    matrix = build_matrix_3x3_unique(scores, col_scores)
    matrix_md = matrix_markdown_table(matrix)

    sys = build_report_system_prompt()

    user_payload = {
        "meta": payload.get("meta", {}),
        "request": payload.get("meta", {}).get("request"),
        "matrix_3x3": matrix,          # –º–∞—à–∏–Ω–Ω—ã–π –≤–∏–¥
        "matrix_3x3_md": matrix_md,    # –≥–æ—Ç–æ–≤–∞—è —Ç–∞–±–ª–∏—á–∫–∞ markdown
        "matrix_3x3_inputs": table,    # —Ç–≤–æ–π –∏–Ω—Å–∞–π—Ç-–æ–±—ä–µ–∫—Ç (top6/col_scores/risks)
        "knowledge_snippets": snips,
        "event_log_tail": (payload.get("event_log", []) or [])[-8:],
        "top_scores": scores,
    }

    prompt = (
        "–°—Ñ–æ—Ä–º–∏—Ä—É–π –¥–≤–∞ —Ç–µ–∫—Å—Ç–∞ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º.\n\n"
        "CLIENT INSTRUCTIONS:\n" + build_client_report_prompt() + "\n\n"
        "MASTER INSTRUCTIONS:\n" + build_master_report_prompt() + "\n\n"
        "INPUT DATA (json):\n" + json.dumps(user_payload, ensure_ascii=False)
    )

    r = client.responses.create(
        model=model,
        input=[
            {"role": "system", "content": sys},
            {"role": "user", "content": prompt},
        ],
    )

    out = getattr(r, "output_text", "") or ""
    if "<<<CLIENT_REPORT>>>" not in out or "<<<MASTER_REPORT>>>" not in out:
        return ("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –æ—Ç—á—ë—Ç (—Ñ–æ—Ä–º–∞—Ç).", out or "–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏.")

    client_part = out.split("<<<CLIENT_REPORT>>>", 1)[1].split("<<<MASTER_REPORT>>>", 1)[0].strip()
    master_part = out.split("<<<MASTER_REPORT>>>", 1)[1].strip()
    return client_part, master_part

# ======================
# UI: render question
# ======================
def ui_key_for_question(qid: str, session_id: str) -> str:
    # –∫–ª—é—á —É–Ω–∏–∫–∞–ª–µ–Ω –Ω–∞ –≤–æ–ø—Ä–æ—Å + —Å–µ—Å—Å–∏—é => —Ç–µ–∫—Å—Ç –ù–ï –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è
    return f"q_{session_id}_{qid}"

def render_question(q, session_id: str):
    st.markdown(f"### {q['text']}")
    st.caption("–ö–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É. –ú–æ–∂–Ω–æ 1‚Äì5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.")

    qid = q["id"]
    qtype = q["type"]
    opts = q.get("options", [])

    key = ui_key_for_question(qid, session_id)

    if qtype == "single":
        return st.radio("–í—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç:", opts, key=key) if opts else st.text_input("–û—Ç–≤–µ—Ç:", key=key)

    if qtype == "multi":
        return st.multiselect("–í—ã–±–µ—Ä–∏ 1‚Äì4:", opts, key=key) if opts else st.text_area("–û—Ç–≤–µ—Ç:", height=140, key=key)

    # text
    return st.text_area("–û—Ç–≤–µ—Ç:", height=150, key=key)
# ======================
# CLIENT FLOW
# ======================
from pathlib import Path
import json

CONFIG_PATH = Path("config.json")

DEFAULT_CONFIG = {
  "hybrid": {
    "enabled": True,
    "start_after_question_index": 38,
    "max_followup_questions": 8,
    "stop_if_confidence_over": 0.78,
    "min_gap_for_tie_break": 0.45,
    "max_same_intent_repeats": 1,
    "followup_intents_priority": [
      "columns_lock",
      "tie_break_top2",
      "anti_social_desirability",
      "shift_probe",
      "sensory_marker_check"
    ],
    "followup_style": {
      "use_options_when_possible": True,
      "options_count": 4,
      "allow_free_text": True
    }
  }
}

def load_config() -> dict:
    """–ß–∏—Ç–∞–µ—Ç config.json. –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç/–±–∏—Ç—ã–π ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç DEFAULT_CONFIG."""
    try:
        if CONFIG_PATH.exists():
            data = json.loads(CONFIG_PATH.read_text(encoding="utf-8"))
            # –º—è–≥–∫–∏–π merge: –µ—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ—Ç –≤ —Ñ–∞–π–ª–µ ‚Äî –¥–æ–±—å—ë–º –¥–µ—Ñ–æ–ª—Ç–∞–º–∏
            out = DEFAULT_CONFIG.copy()
            out.update(data or {})
            if "hybrid" in DEFAULT_CONFIG:
                out["hybrid"] = (DEFAULT_CONFIG["hybrid"] | (out.get("hybrid") or {}))
            return out
    except Exception:
        pass
    return DEFAULT_CONFIG

def render_client_flow():
    # 1) –±–∞–∑–æ–≤—ã–π –±–∞–Ω–∫
    plan = question_plan()
    base_total = len(plan)

    # 2) –∫–æ–Ω—Ñ–∏–≥ –≥–∏–±—Ä–∏–¥–∞
    cfg = load_config()
    hy = cfg.get("hybrid", {})
    hy_enabled = bool(hy.get("enabled", False))
    hy_start_after = int(hy.get("start_after_question_index", base_total))

    # 3) –∑–∞—â–∏—Ç–∞ session_state
    if "q_index" not in st.session_state:
        st.session_state["q_index"] = 0
    if st.session_state["q_index"] < 0:
        st.session_state["q_index"] = 0

    # –µ—Å–ª–∏ –±–∞–Ω–∫ –ø–æ–º–µ–Ω—è–ª—Å—è, –∞ –∏–Ω–¥–µ–∫—Å –æ—Å—Ç–∞–ª—Å—è —Å—Ç–∞—Ä—ã–π ‚Äî –Ω–µ –ø–∞–¥–∞–µ–º
    if st.session_state["q_index"] > base_total:
        st.session_state["q_index"] = base_total

    # 4) done-–ª–æ–≥–∏–∫–∞
    base_done = st.session_state["q_index"] >= base_total
    hybrid_done = bool(st.session_state.get("hybrid_done", False))
    done = base_done and (not hy_enabled or hybrid_done)

    # 5) —à–∞–ø–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    colA, colB = st.columns([3, 1])
    with colA:
        if st.session_state["q_index"] >= base_total:
            stage = "final"
            cur_num = base_total
        else:
            stage = plan[st.session_state["q_index"]].get("stage", "‚Äî")
            cur_num = st.session_state["q_index"] + 1
        st.caption(f"–•–æ–¥: –≤–æ–ø—Ä–æ—Å {cur_num} –∏–∑ {base_total} | —Ñ–∞–∑–∞: {stage}")

    with colB:
        if st.button("üîÑ –°–±—Ä–æ—Å–∏—Ç—å", use_container_width=True):
            reset_diagnostic()
            st.rerun()

    # 6) –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫
    if not done:
        # ---------- –ë–ê–ó–û–í–´–ï –í–û–ü–†–û–°–´ ----------
        if st.session_state["q_index"] < base_total:
            q = plan[st.session_state["q_index"]]
            ans = render_question(q, st.session_state["session_id"])

            c1, c2 = st.columns([1, 1])
            with c1:
                if st.button("–î–∞–ª–µ–µ ‚ûú", use_container_width=True):
                    if not is_nonempty(q, ans):
                        st.warning("–ó–∞–ø–æ–ª–Ω–∏ –æ—Ç–≤–µ—Ç.")
                    else:
                        st.session_state["answers"][q["id"]] = ans
                        st.session_state["event_log"].append({
                            "timestamp": utcnow_iso(),
                            "question_id": q["id"],
                            "question_text": q["text"],
                            "answer_type": q["type"],
                            "answer": ans
                        })
                        st.session_state["q_index"] += 1

                        # –µ—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞ –±–∞–∑—ã ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫ —Å–µ—Å—Å–∏–∏
                        if st.session_state["q_index"] >= base_total:
                            payload = build_payload(
                                st.session_state["answers"],
                                st.session_state["event_log"],
                                st.session_state["session_id"]
                            )
                            save_session(payload)

                        st.rerun()

            with c2:
                if st.button("–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ–π—á–∞—Å", use_container_width=True):
                    payload = build_payload(
                        st.session_state["answers"],
                        st.session_state["event_log"],
                        st.session_state["session_id"]
                    )
                    save_session(payload)

                    # —Ñ–æ—Ä—Å–∏—Ä—É–µ–º –∫–æ–Ω–µ—Ü –±–∞–∑—ã
                    st.session_state["q_index"] = base_total
                    # –µ—Å–ª–∏ –≥–∏–±—Ä–∏–¥ –≤—ã–∫–ª—é—á–µ–Ω ‚Äî —Å—á–∏—Ç–∞–µ–º –≤—Å—ë –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º
                    if not hy_enabled:
                        st.session_state["hybrid_done"] = True
                    st.rerun()

        # ---------- –ì–ò–ë–†–ò–î–ù–´–ô –ë–õ–û–ö (–ü–û–°–õ–ï –ë–ê–ó–´) ----------
        else:
            # –ë–∞–∑–∞ —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω–∞, –Ω–æ –≥–∏–±—Ä–∏–¥ –µ—â—ë –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω
            if hy_enabled and not hybrid_done:
                st.info("–ú—ã –ø–æ–ª—É—á–∏–ª–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —É—Ç–æ—á–Ω–∏–º –ø–∞—Ä—É –º–æ–º–µ–Ω—Ç–æ–≤ (–∫–æ—Ä–æ—Ç–∫–∏–π –±–ª–æ–∫).")

                # —Ç—É—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–≤–æ–π –≤—ã–∑–æ–≤ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
                # –Ω–∞–ø—Ä–∏–º–µ—Ä: q = build_hybrid_question(...)
                # ans = render_hybrid_question(...)
                # –∏ –ø–æ –∫–Ω–æ–ø–∫–µ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å hybrid_turn –∏ —Å—Ç–∞–≤–∏—Ç—å hybrid_done=True

                st.warning("–ì–∏–±—Ä–∏–¥–Ω—ã–π –±–ª–æ–∫ –≤–∫–ª—é—á—ë–Ω, –Ω–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –µ—â—ë –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω –≤ –∫–æ–¥–µ.")
                if st.button("–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≥–∏–±—Ä–∏–¥ –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å", use_container_width=True):
                    st.session_state["hybrid_done"] = True
                    st.rerun()
            else:
                # –≥–∏–±—Ä–∏–¥ –Ω–µ –Ω—É–∂–µ–Ω ‚Äî –≤—Å—ë
                st.session_state["hybrid_done"] = True
                st.rerun()

    # 7) —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω
    else:
        payload = build_payload(
            st.session_state["answers"],
            st.session_state["event_log"],
            st.session_state["session_id"]
        )
        try:
            save_session(payload)
        except Exception:
            pass

        # === –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ì–û–¢–û–í–ù–û–°–¢–ò –û–¢–ß–Å–¢–ê ===
        ok, msg = report_ready(payload)
        if not ok:
            st.warning(msg)
            st.stop()

        st.success("–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")

        # –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Å–µ—Å—Å–∏—é
        try:
            save_session(payload)
        except Exception:
            pass

        # 1) –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∂–µ–º –º–∞—Ç—Ä–∏—Ü—É (—á—Ç–æ–±—ã —Å—Ä–∞–∑—É ‚Äú–≤–∞—É‚Äù)
        scores = payload.get("scores", {}) or {}
        col_scores = payload.get("col_scores", {}) or {}
        m = build_matrix_3x3_unique(scores, col_scores)

        st.markdown("## –¢–≤–æ—è –º–∞—Ç—Ä–∏—Ü–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ 3√ó3 (–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ)")
        st.markdown(matrix_markdown_table(m))

        # 2) –î–∞–ª—å—à–µ ‚Äî –±–æ–ª—å—à–æ–π AI-–æ—Ç—á—ë—Ç (–∞–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è 1 —Ä–∞–∑ –∏ –∫—ç—à –≤ JSON)
        # –ë–µ—Ä—ë–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é (–µ—Å–ª–∏ —É–∂–µ –≥–µ–Ω–µ—Ä–∏–ª–∏)
        saved = load_session(payload["meta"]["session_id"]) or payload
        ai_client = saved.get("ai_client_report")

        if not ai_client:
            st.markdown("## –¢–≤–æ–π —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –æ—Ç—á—ë—Ç")
            client = get_openai_client()
            if not client:
                st.warning("AI-–æ—Ç—á—ë—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –Ω–µ –Ω–∞–π–¥–µ–Ω OPENAI_API_KEY.")
                # fallback –Ω–∞ –º–∏–Ω–∏-–æ—Ç—á—ë—Ç
                st.markdown(build_client_mini_report(payload))
            else:
                with st.spinner("–ì–æ—Ç–æ–≤–ª—é —Ç–≤–æ–π –æ—Ç—á—ë—Ç‚Ä¶"):
                    model = safe_model_name(DEFAULT_MODEL)
                    cr, mr = call_openai_for_reports(client, model, payload)

                    # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–µ—Å—Å–∏—é, —á—Ç–æ–±—ã –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
                    saved["ai_client_report"] = cr
                    # –º–∞—Å—Ç–µ—Ä—Å–∫–∏–π —Ç–æ–∂–µ –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å, –Ω–æ –∫–ª–∏–µ–Ω—Ç—É –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
                    saved["ai_master_report"] = mr
                    try:
                        save_session(saved)
                    except Exception:
                        pass

                    st.markdown(cr)
        else:
            st.markdown("## –¢–≤–æ–π —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –æ—Ç—á—ë—Ç")
            st.markdown(ai_client)

        with st.expander("–ü–æ–∫–∞–∑–∞—Ç—å –º–æ–∏ –æ—Ç–≤–µ—Ç—ã (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)"):
            st.json(payload.get("answers", {}))
# ======================
# MASTER PANEL
# ======================
def render_master_panel():
    st.subheader("üõ†Ô∏è –ú–∞—Å—Ç–µ—Ä-–ø–∞–Ω–µ–ª—å")

    # ---- auth
    if not st.session_state.get("master_authed", False):
        pwd = st.text_input("–ü–∞—Ä–æ–ª—å –º–∞—Å—Ç–µ—Ä–∞", type="password", key="master_pwd")
        if st.button("–í–æ–π—Ç–∏", use_container_width=True):
            if not MASTER_PASSWORD:
                st.error("MASTER_PASSWORD –Ω–µ –∑–∞–¥–∞–Ω –≤ secrets/env.")
            elif pwd == MASTER_PASSWORD:
                st.session_state["master_authed"] = True
                st.success("–û–∫ ‚úÖ")
                st.rerun()
            else:
                st.error("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å")
        st.stop()

    # ---- sessions
    sessions = list_sessions()
    if not sessions:
        st.info("–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π.")
        st.stop()

    labels, ids = [], []
    for s in sessions:
        sid = s.get("meta", {}).get("session_id", "")
        name = s.get("meta", {}).get("name", "‚Äî")
        req = s.get("meta", {}).get("request", "‚Äî")
        ts = s.get("meta", {}).get("timestamp", "‚Äî")
        labels.append(f"{name} | {req} | {ts} | {sid[:8]}")
        ids.append(sid)

    pick = st.selectbox("–°–µ—Å—Å–∏–∏:", labels, index=0, key="master_pick")
    chosen_id = ids[labels.index(pick)]

    selected_payload = load_session(chosen_id)
    if not selected_payload:
        st.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Å—Å–∏—é.")
        st.stop()

    # ---- header meta
    meta = selected_payload.get("meta", {})
    st.markdown(
        f"**–ò–º—è:** {meta.get('name','‚Äî')}\n\n"
        f"**–ö–æ–Ω—Ç–∞–∫—Ç:** {meta.get('contact','‚Äî')}\n\n"
        f"**–ó–∞–ø—Ä–æ—Å:** {meta.get('request','‚Äî')}\n\n"
        f"**–í–æ–ø—Ä–æ—Å–æ–≤:** {meta.get('question_count','‚Äî')} | **–û—Ç–≤–µ—Ç–æ–≤:** {meta.get('answered_count','‚Äî')}\n"
    )

    # ---- download json
    st.download_button(
        "‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å JSON (—Å–µ—Å—Å–∏—è)",
        data=json.dumps(selected_payload, ensure_ascii=False, indent=2).encode("utf-8"),
        file_name=f"session_{chosen_id[:8]}.json",
        mime="application/json",
        use_container_width=True
    )

    # ---- build table + snippets (ONLY INSIDE MASTER)
    with st.expander("üìå –¢–∞–±–ª–∏—Ü–∞ –∏–Ω—Å–∞–π—Ç–æ–≤ (–¥–ª—è –º–∞—Å—Ç–µ—Ä–∞)"):
        table = build_insight_table(selected_payload)
        st.json(table)
        col_scores = table.get("col_scores", {})
        if col_scores:
            st.markdown("### üß≠ –ö–æ–ª–æ–Ω–∫–∏ (–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ / –ú–æ—Ç–∏–≤–∞—Ü–∏—è / –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç)")
            for c_key in ["perception","motivation","instrument"]:
                cs = col_scores.get(c_key, {})
                top = sorted(cs.items(), key=lambda x: float(x[1]), reverse=True)[:3]
                st.write(f"**{COL_LABELS[c_key]}**: " + ", ".join([f"{p} ({float(v):.2f})" for p, v in top]))
        else:
            st.info("col_scores –ø—É—Å—Ç ‚Äî –∫–æ–ª–æ–Ω–∫–∏ –µ—â—ë –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã.")

    with st.expander("üìö Knowledge snippets (—á—Ç–æ –ø–æ–¥–º–µ—à–∞–ª–∏)"):
        snips = get_knowledge_snippets(selected_payload, top_k=6)
        if not snips:
            st.info("–ù–µ—Ç knowledge snippets. –ü—Ä–æ–≤–µ—Ä—å –ø–∞–ø–∫—É knowledge/ –∏ –Ω–∞–ª–∏—á–∏–µ .md —Ñ–∞–π–ª–æ–≤.")
        else:
            for s in snips:
                st.markdown(f"**{s['source']}** (score={s['score']})")
                st.code(s["excerpt"][:1200])

    # ---- generate report
    st.markdown("---")
    st.subheader("üß† AI-–æ—Ç—á—ë—Ç (–¥–ª—è –º–∞—Å—Ç–µ—Ä–∞)")

    model_in = st.text_input("–ú–æ–¥–µ–ª—å (–æ—Å—Ç–∞–≤—å –∫–∞–∫ –µ—Å—Ç—å)", value=DEFAULT_MODEL, key="master_model")

    if st.button("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å AI-–æ—Ç—á—ë—Ç", use_container_width=True):
        client = get_openai_client()
        if not client:
            st.error("–ù–µ—Ç OPENAI_API_KEY –≤ secrets/env")
        else:
            try:
                model = safe_model_name(model_in)
                cr, mr = call_openai_for_reports(client, model, selected_payload)

                st.markdown("### –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π AI-–æ—Ç—á—ë—Ç")
                st.write(cr)

                st.markdown("### –ú–∞—Å—Ç–µ—Ä—Å–∫–∏–π AI-–æ—Ç—á—ë—Ç")
                st.write(mr)

                # —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Å–µ—Å—Å–∏—é
                selected_payload["ai_client_report"] = cr
                selected_payload["ai_master_report"] = mr
                save_session(selected_payload)

                st.success("–ì–æ—Ç–æ–≤–æ ‚úÖ –û—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —Å–µ—Å—Å–∏–∏.")
            except Exception as e:
                st.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {e}")

    # ---- show saved reports
    if selected_payload.get("ai_client_report") or selected_payload.get("ai_master_report"):
        with st.expander("üóÇÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ AI-–æ—Ç—á—ë—Ç—ã"):
            if selected_payload.get("ai_client_report"):
                st.markdown("#### –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π")
                st.write(selected_payload["ai_client_report"])
            if selected_payload.get("ai_master_report"):
                st.markdown("#### –ú–∞—Å—Ç–µ—Ä—Å–∫–∏–π")
                st.write(selected_payload["ai_master_report"])


# ======================
# MAIN
# ======================
init_state()

st.title("üí† NEO –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–≤ (MVP)")

tab1, tab2 = st.tabs(["üßë‚Äçüíº –ö–ª–∏–µ–Ω—Ç", "üõ†Ô∏è –ú–∞—Å—Ç–µ—Ä"])

with tab1:
    render_client_flow()

with tab2:
    render_master_panel()
